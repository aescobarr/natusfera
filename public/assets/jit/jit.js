!function(){/*
  File: Core.js
  
  Description:
  
  Provides common utility functions and the Class object used internally by the library.
  
  Also provides the <TreeUtil> object for manipulating JSON tree structures
  
  Some parts of this Script are based on Mootools core: <http://mootools.net>
  
  Author: 
  
  Nicolas Garcia Belmonte
  
  Copyright: 
  
  Copyright 2008-2009 by Nicolas Garcia Belmonte.
  
  Homepage: 
  
  <http://thejit.org>
  
  Version: 
  
  1.1.0a

  License: 
  
  BSD License
 
> Redistribution and use in source and binary forms, with or without
> modification, are permitted provided that the following conditions are met:
>      * Redistributions of source code must retain the above copyright
>        notice, this list of conditions and the following disclaimer.
>      * Redistributions in binary form must reproduce the above copyright
>        notice, this list of conditions and the following disclaimer in the
>        documentation and/or other materials provided with the distribution.
>      * Neither the name of the organization nor the
>        names of its contributors may be used to endorse or promote products
>        derived from this software without specific prior written permission.
>
>  THIS SOFTWARE IS PROVIDED BY Nicolas Garcia Belmonte ``AS IS'' AND ANY
>  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
>  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
>  DISCLAIMED. IN NO EVENT SHALL Nicolas Garcia Belmonte BE LIABLE FOR ANY
>  DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
>  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
>  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
>  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
>  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
>  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
function $empty(){}function $extend(original,extended){for(var key in extended||{})original[key]=extended[key];return original}function $lambda(value){return"function"==typeof value?value:function(){return value}}function $splat(obj){var type=$type(obj);return type?"array"!=type?[obj]:obj:[]}function $each(iterable,fn){var type=$type(iterable);if("object"==type)for(var key in iterable)fn(iterable[key],key);else for(var i=0;i<iterable.length;i++)fn(iterable[i],i)}function $merge(){for(var mix={},i=0,l=arguments.length;l>i;i++){var object=arguments[i];if("object"==$type(object))for(var key in object){var op=object[key],mp=mix[key];mix[key]=mp&&"object"==$type(op)&&"object"==$type(mp)?$merge(mp,op):$unlink(op)}}return mix}function $unlink(object){var unlinked;switch($type(object)){case"object":unlinked={};for(var p in object)unlinked[p]=$unlink(object[p]);break;case"array":unlinked=[];for(var i=0,l=object.length;l>i;i++)unlinked[i]=$unlink(object[i]);break;default:return object}return unlinked}function $rgbToHex(srcArray,array){if(srcArray.length<3)return null;if(4==srcArray.length&&0==srcArray[3]&&!array)return"transparent";for(var hex=[],i=0;3>i;i++){var bit=(srcArray[i]-0).toString(16);hex.push(1==bit.length?"0"+bit:bit)}return array?hex:"#"+hex.join("")}function $destroy(elem){$clean(elem),elem.parentNode&&elem.parentNode.removeChild(elem),elem.clearAttributes&&elem.clearAttributes()}function $clean(elem){for(var ch=elem.childNodes,i=0;i<ch.length;i++)$destroy(ch[i])}function $addEvent(obj,type,fn){obj.addEventListener?obj.addEventListener(type,fn,!1):obj.attachEvent("on"+type,fn)}function $hasClass(obj,klass){return(" "+obj.className+" ").indexOf(" "+klass+" ")>-1}function $addClass(obj,klass){$hasClass(obj,klass)||(obj.className=obj.className+" "+klass)}function $removeClass(obj,klass){obj.className=obj.className.replace(new RegExp("(^|\\s)"+klass+"(?:\\s|$)"),"$1")}function $get(id){return document.getElementById(id)}var $time=Date.now||function(){return+new Date},$type=function(elem){return $type.s.call(elem).match(/^\[object\s(.*)\]$/)[1].toLowerCase()};$type.s=Object.prototype.toString;var Class=function(properties){properties=properties||{};var klass=function(){if(this.constructor=klass,Class.prototyping)return this;var instance=this.initialize?this.initialize.apply(this,arguments):this;return instance};for(var mutator in Class.Mutators)properties[mutator]&&(properties=Class.Mutators[mutator](properties,properties[mutator]),delete properties[mutator]);return $extend(klass,this),klass.constructor=Class,klass.prototype=properties,klass};Class.Mutators={Extends:function(self,klass){Class.prototyping=klass.prototype;var subclass=new klass;return delete subclass.parent,subclass=Class.inherit(subclass,self),delete Class.prototyping,subclass},Implements:function(self,klasses){return $each($splat(klasses),function(klass){Class.prototying=klass,$extend(self,"function"==$type(klass)?new klass:klass),delete Class.prototyping}),self}},$extend(Class,{inherit:function(object,properties){var caller=arguments.callee.caller;for(var key in properties){var override=properties[key],previous=object[key],type=$type(override);previous&&"function"==type?override!=previous&&(caller?(override.__parent=previous,object[key]=override):Class.override(object,key,override)):object[key]="object"==type?$merge(previous,override):override}return caller&&(object.parent=function(){return arguments.callee.caller.__parent.apply(this,arguments)}),object},override:function(object,name,method){var parent=Class.prototyping;parent&&object[name]!=parent[name]&&(parent=null);var override=function(){var previous=this.parent;this.parent=parent?parent[name]:object[name];var value=method.apply(this,arguments);return this.parent=previous,value};object[name]=override}}),Class.prototype.implement=function(){var proto=this.prototype;return $each(Array.prototype.slice.call(arguments||[]),function(properties){Class.inherit(proto,properties)}),this},this.TreeUtil={prune:function(tree,maxLevel){this.each(tree,function(elem,i){i==maxLevel&&elem.children&&(delete elem.children,elem.children=[])})},getParent:function(tree,id){if(tree.id==id)return!1;var ch=tree.children;if(ch&&ch.length>0)for(var i=0;i<ch.length;i++){if(ch[i].id==id)return tree;var ans=this.getParent(ch[i],id);if(ans)return ans}return!1},getSubtree:function(tree,id){if(tree.id==id)return tree;for(var i=0,ch=tree.children;i<ch.length;i++){var t=this.getSubtree(ch[i],id);if(null!=t)return t}return null},getLeaves:function(node,maxLevel){var leaves=[],levelsToShow=maxLevel||Number.MAX_VALUE;return this.each(node,function(elem,i){levelsToShow>i&&(!elem.children||0==elem.children.length)&&leaves.push({node:elem,level:levelsToShow-i})}),leaves},eachLevel:function(tree,initLevel,toLevel,action){if(toLevel>=initLevel){action(tree,initLevel);for(var i=0,ch=tree.children;i<ch.length;i++)this.eachLevel(ch[i],initLevel+1,toLevel,action)}},each:function(tree,action){this.eachLevel(tree,0,Number.MAX_VALUE,action)},loadSubtrees:function(tree,controller){var maxLevel=controller.request&&controller.levelsToShow,leaves=this.getLeaves(tree,maxLevel),len=leaves.length,selectedNode={};0==len&&controller.onComplete();for(var i=0,counter=0;len>i;i++){var leaf=leaves[i],id=leaf.node.id;selectedNode[id]=leaf.node,controller.request(id,leaf.level,{onComplete:function(nodeId,tree){var ch=tree.children;selectedNode[nodeId].children=ch,++counter==len&&controller.onComplete()}})}}},this.Canvas=function(){function hasCanvas(){return hasCanvas.t=hasCanvas.t||typeof HTMLCanvasElement,"function"==hasCanvas.t||"object"==hasCanvas.t}function create(tag,prop,styles){var elem=document.createElement(tag);return function(obj,prop){if(prop)for(var p in prop)obj[p]=prop[p];return arguments.callee}(elem,prop)(elem.style,styles),"canvas"==tag&&!hasCanvas()&&G_vmlCanvasManager&&(elem=G_vmlCanvasManager.initElement(document.body.appendChild(elem))),elem}function get(id){return document.getElementById(id)}function translateToCenter(canvas,ctx,w,h){var width=w?w-canvas.width:canvas.width,height=h?h-canvas.height:canvas.height;ctx.translate(width/2,height/2)}var config={injectInto:"id",width:200,height:200,backgroundColor:"#333333",styles:{fillStyle:"#000000",strokeStyle:"#000000"},backgroundCanvas:!1};return function(id,opt){var ctx,bkctx,mainContainer,labelContainer,canvas,bkcanvas;if(arguments.length<1)throw"Arguments missing";var idLabel=id+"-label",idCanvas=id+"-canvas",idBCanvas=id+"-bkcanvas";opt=$merge(config,opt||{});var dim={width:opt.width,height:opt.height};mainContainer=create("div",{id:id},$merge(dim,{position:"relative"})),labelContainer=create("div",{id:idLabel},{overflow:"visible",position:"absolute",top:0,left:0,width:dim.width+"px",height:0});var dimPos={position:"absolute",top:0,left:0,width:dim.width+"px",height:dim.height+"px"};canvas=create("canvas",$merge({id:idCanvas},dim),dimPos);var bc=opt.backgroundCanvas;bc&&(bkcanvas=create("canvas",$merge({id:idBCanvas},dim),dimPos),mainContainer.appendChild(bkcanvas)),mainContainer.appendChild(canvas),mainContainer.appendChild(labelContainer),get(opt.injectInto).appendChild(mainContainer),ctx=canvas.getContext("2d"),translateToCenter(canvas,ctx);var st=opt.styles;for(var s in st)ctx[s]=st[s];if(bc){bkctx=bkcanvas.getContext("2d");var st=bc.styles;for(var s in st)bkctx[s]=st[s];translateToCenter(bkcanvas,bkctx),bc.impl.init(bkcanvas,bkctx),bc.impl.plot(bkcanvas,bkctx)}return{id:id,getCtx:function(){return ctx},getElement:function(){return mainContainer},resize:function(width,height){canvas.width=width,canvas.height=height,canvas.style.width=width+"px",canvas.style.height=height+"px",bc&&(bkcanvas.width=width,bkcanvas.height=height,bkcanvas.style.width=width+"px",bkcanvas.style.height=height+"px"),translateToCenter(canvas,ctx);var st=opt.styles;for(var s in st)ctx[s]=st[s];if(bc){var st=bc.styles;for(var s in st)bkctx[s]=st[s];translateToCenter(bkcanvas,bkctx),bc.impl.init(bkcanvas,bkctx),bc.impl.plot(bkcanvas,bkctx)}},getSize:function(){return{width:canvas.width,height:canvas.height}},path:function(type,action){ctx.beginPath(),action(ctx),ctx[type](),ctx.closePath()},clear:function(){var size=this.getSize();ctx.clearRect(-size.width/2,-size.height/2,size.width,size.height)},clearRectangle:function(top,right,bottom,left){if(hasCanvas())ctx.clearRect(left,top,Math.abs(right-left),Math.abs(bottom-top));else{var f0=ctx.fillStyle;ctx.fillStyle=opt.backgroundColor,ctx.fillRect(left,top,Math.abs(right-left),Math.abs(bottom-top)),ctx.fillStyle=f0}}}}}(),this.Polar=function(theta,rho){this.theta=theta,this.rho=rho},Polar.prototype={getc:function(simple){return this.toComplex(simple)},getp:function(){return this},set:function(v){v=v.getp(),this.theta=v.theta,this.rho=v.rho},setc:function(x,y){this.rho=Math.sqrt(x*x+y*y),this.theta=Math.atan2(y,x),this.theta<0&&(this.theta+=2*Math.PI)},setp:function(theta,rho){this.theta=theta,this.rho=rho},clone:function(){return new Polar(this.theta,this.rho)},toComplex:function(simple){var x=Math.cos(this.theta)*this.rho,y=Math.sin(this.theta)*this.rho;return simple?{x:x,y:y}:new Complex(x,y)},add:function(polar){return new Polar(this.theta+polar.theta,this.rho+polar.rho)},scale:function(number){return new Polar(this.theta,this.rho*number)},equals:function(c){return this.theta==c.theta&&this.rho==c.rho},$add:function(polar){return this.theta=this.theta+polar.theta,this.rho+=polar.rho,this},$madd:function(polar){return this.theta=(this.theta+polar.theta)%(2*Math.PI),this.rho+=polar.rho,this},$scale:function(number){return this.rho*=number,this},interpolate:function(elem,delta){var sum,pi=Math.PI,pi2=2*pi,ch=function(t){return 0>t?t%pi2+pi2:t%pi2},tt=this.theta,et=elem.theta;sum=Math.abs(tt-et)>pi?tt>et?ch(et+(tt-pi2-et)*delta):ch(et-pi2+(tt-(et-pi2))*delta):ch(et+(tt-et)*delta);var r=(this.rho-elem.rho)*delta+elem.rho;return{theta:sum,rho:r}}};var $P=function(a,b){return new Polar(a,b)};Polar.KER=$P(0,0),this.Complex=function(x,y){this.x=x,this.y=y},Complex.prototype={getc:function(){return this},getp:function(simple){return this.toPolar(simple)},set:function(c){c=c.getc(!0),this.x=c.x,this.y=c.y},setc:function(x,y){this.x=x,this.y=y},setp:function(theta,rho){this.x=Math.cos(theta)*rho,this.y=Math.sin(theta)*rho},clone:function(){return new Complex(this.x,this.y)},toPolar:function(simple){var rho=this.norm(),atan=Math.atan2(this.y,this.x);return 0>atan&&(atan+=2*Math.PI),simple?{theta:atan,rho:rho}:new Polar(atan,rho)},norm:function(){return Math.sqrt(this.squaredNorm())},squaredNorm:function(){return this.x*this.x+this.y*this.y},add:function(pos){return new Complex(this.x+pos.x,this.y+pos.y)},prod:function(pos){return new Complex(this.x*pos.x-this.y*pos.y,this.y*pos.x+this.x*pos.y)},conjugate:function(){return new Complex(this.x,-this.y)},scale:function(factor){return new Complex(this.x*factor,this.y*factor)},equals:function(c){return this.x==c.x&&this.y==c.y},$add:function(pos){return this.x+=pos.x,this.y+=pos.y,this},$prod:function(pos){var x=this.x,y=this.y;return this.x=x*pos.x-y*pos.y,this.y=y*pos.x+x*pos.y,this},$conjugate:function(){return this.y=-this.y,this},$scale:function(factor){return this.x*=factor,this.y*=factor,this},$div:function(pos){var x=this.x,y=this.y,sq=pos.squaredNorm();return this.x=x*pos.x+y*pos.y,this.y=y*pos.x-x*pos.y,this.$scale(1/sq)}};var $C=function(a,b){return new Complex(a,b)};Complex.KER=$C(0,0),this.Graph=new Class({initialize:function(opt){var innerOptions={complex:!1,Node:{}};this.opt=$merge(innerOptions,opt||{}),this.nodes={}},getNode:function(id){return this.hasNode(id)?this.nodes[id]:!1},getAdjacence:function(id,id2){var adjs=[];return this.hasNode(id)&&this.hasNode(id2)&&this.nodes[id].adjacentTo({id:id2})&&this.nodes[id2].adjacentTo({id:id})?(adjs.push(this.nodes[id].getAdjacency(id2)),adjs.push(this.nodes[id2].getAdjacency(id)),adjs):!1},addNode:function(obj){return this.nodes[obj.id]||(this.nodes[obj.id]=new Graph.Node($extend({id:obj.id,name:obj.name,data:obj.data},this.opt.Node),this.opt.complex)),this.nodes[obj.id]},addAdjacence:function(obj,obj2,data){var adjs=[];this.hasNode(obj.id)||this.addNode(obj),this.hasNode(obj2.id)||this.addNode(obj2),obj=this.nodes[obj.id],obj2=this.nodes[obj2.id];for(var i in this.nodes)this.nodes[i].id==obj.id&&(this.nodes[i].adjacentTo(obj2)||adjs.push(this.nodes[i].addAdjacency(obj2,data))),this.nodes[i].id==obj2.id&&(this.nodes[i].adjacentTo(obj)||adjs.push(this.nodes[i].addAdjacency(obj,data)));return adjs},removeNode:function(id){if(this.hasNode(id)){var node=this.nodes[id];for(var i=0 in node.adjacencies){var adj=node.adjacencies[i];this.removeAdjacence(id,adj.nodeTo.id)}delete this.nodes[id]}},removeAdjacence:function(id1,id2){this.hasNode(id1)&&this.nodes[id1].removeAdjacency(id2),this.hasNode(id2)&&this.nodes[id2].removeAdjacency(id1)},hasNode:function(id){return id in this.nodes}}),Graph.Node=new Class({initialize:function(opt,complex){var innerOptions={id:"",name:"",data:{},adjacencies:{},selected:!1,drawn:!1,exist:!1,angleSpan:{begin:0,end:0},alpha:1,startAlpha:1,endAlpha:1,pos:complex&&$C(0,0)||$P(0,0),startPos:complex&&$C(0,0)||$P(0,0),endPos:complex&&$C(0,0)||$P(0,0)};$extend(this,$extend(innerOptions,opt))},adjacentTo:function(node){return node.id in this.adjacencies},getAdjacency:function(id){return this.adjacencies[id]},addAdjacency:function(node,data){var adj=new Graph.Adjacence(this,node,data);return this.adjacencies[node.id]=adj},removeAdjacency:function(id){delete this.adjacencies[id]}}),Graph.Adjacence=function(nodeFrom,nodeTo,data){this.nodeFrom=nodeFrom,this.nodeTo=nodeTo,this.data=data||{},this.alpha=1,this.startAlpha=1,this.endAlpha=1},Graph.Util={filter:function(param){if(!param||"string"!=$type(param))return function(){return!0};var props=param.split(" ");return function(elem){for(var i=0;i<props.length;i++)if(elem[props[i]])return!1;return!0}},getNode:function(graph,id){return graph.getNode(id)},eachNode:function(graph,action,flags){var filter=this.filter(flags);for(var i in graph.nodes)filter(graph.nodes[i])&&action(graph.nodes[i])},eachAdjacency:function(node,action,flags){var adj=node.adjacencies,filter=this.filter(flags);for(var id in adj)filter(adj[id])&&action(adj[id],id)},computeLevels:function(graph,id,startDepth,flags){startDepth=startDepth||0;var filter=this.filter(flags);this.eachNode(graph,function(elem){elem._flag=!1,elem._depth=-1},flags);var root=graph.getNode(id);root._depth=startDepth;for(var queue=[root];0!=queue.length;){var node=queue.pop();node._flag=!0,this.eachAdjacency(node,function(adj){var n=adj.nodeTo;0==n._flag&&filter(n)&&(n._depth<0&&(n._depth=node._depth+1+startDepth),queue.unshift(n))},flags)}},eachBFS:function(graph,id,action,flags){var filter=this.filter(flags);this.clean(graph);for(var queue=[graph.getNode(id)];0!=queue.length;){var node=queue.pop();node._flag=!0,action(node,node._depth),this.eachAdjacency(node,function(adj){var n=adj.nodeTo;0==n._flag&&filter(n)&&(n._flag=!0,queue.unshift(n))},flags)}},eachLevel:function(node,levelBegin,levelEnd,action,flags){var d=node._depth,filter=this.filter(flags),that=this;levelEnd=levelEnd===!1?Number.MAX_VALUE-d:levelEnd,function loopLevel(node,levelBegin,levelEnd){var d=node._depth;d>=levelBegin&&levelEnd>=d&&filter(node)&&action(node,d),levelEnd>d&&that.eachAdjacency(node,function(adj){var n=adj.nodeTo;n._depth>d&&loopLevel(n,levelBegin,levelEnd)})}(node,levelBegin+d,levelEnd+d)},eachSubgraph:function(node,action,flags){this.eachLevel(node,0,!1,action,flags)},eachSubnode:function(node,action,flags){this.eachLevel(node,1,1,action,flags)},anySubnode:function(node,cond,flags){var flag=!1;cond=cond||$lambda(!0);var c="string"==$type(cond)?function(n){return n[cond]}:cond;return this.eachSubnode(node,function(elem){c(elem)&&(flag=!0)},flags),flag},getSubnodes:function(node,level,flags){var ans=[];if(level=level||0,"array"==$type(level))var levelStart=level[0],levelEnd=level[1];else var levelStart=level,levelEnd=Number.MAX_VALUE-node._depth;return this.eachLevel(node,levelStart,levelEnd,function(n){ans.push(n)},flags),ans},getParents:function(node){var ans=[];return this.eachAdjacency(node,function(adj){var n=adj.nodeTo;n._depth<node._depth&&ans.push(n)}),ans},clean:function(graph){this.eachNode(graph,function(elem){elem._flag=!1})}},Graph.Op={options:{type:"nothing",duration:2e3,hideLabels:!0,fps:30},removeNode:function(node,opt){var viz=this.viz,options=$merge(this.options,viz.controller,opt),n=$splat(node);switch(options.type){case"nothing":for(var i=0;i<n.length;i++)viz.graph.removeNode(n[i]);break;case"replot":this.removeNode(n,{type:"nothing"}),viz.fx.clearLabels(),viz.refresh(!0);break;case"fade:seq":case"fade":for(var that=this,i=0;i<n.length;i++){var nodeObj=viz.graph.getNode(n[i]);nodeObj.endAlpha=0}viz.fx.animate($merge(options,{modes:["fade:nodes"],onComplete:function(){that.removeNode(n,{type:"nothing"}),viz.fx.clearLabels(),viz.reposition(),viz.fx.animate($merge(options,{modes:["linear"]}))}}));break;case"fade:con":for(var that=this,i=0;i<n.length;i++){var nodeObj=viz.graph.getNode(n[i]);nodeObj.endAlpha=0,nodeObj.ignore=!0}viz.reposition(),viz.fx.animate($merge(options,{modes:["fade:nodes","linear"],onComplete:function(){that.removeNode(n,{type:"nothing"})}}));break;case"iter":var that=this;viz.fx.sequence({condition:function(){return 0!=n.length},step:function(){that.removeNode(n.shift(),{type:"nothing"}),viz.fx.clearLabels()},onComplete:function(){options.onComplete()},duration:Math.ceil(options.duration/n.length)});break;default:this.doError()}},removeEdge:function(vertex,opt){var viz=this.viz,options=$merge(this.options,viz.controller,opt),v="string"==$type(vertex[0])?[vertex]:vertex;switch(options.type){case"nothing":for(var i=0;i<v.length;i++)viz.graph.removeAdjacence(v[i][0],v[i][1]);break;case"replot":this.removeEdge(v,{type:"nothing"}),viz.refresh(!0);break;case"fade:seq":case"fade":for(var that=this,i=0;i<v.length;i++){var adjs=viz.graph.getAdjacence(v[i][0],v[i][1]);adjs&&(adjs[0].endAlpha=0,adjs[1].endAlpha=0)}viz.fx.animate($merge(options,{modes:["fade:vertex"],onComplete:function(){that.removeEdge(v,{type:"nothing"}),viz.reposition(),viz.fx.animate($merge(options,{modes:["linear"]}))}}));break;case"fade:con":for(var that=this,i=0;i<v.length;i++){var adjs=viz.graph.getAdjacence(v[i][0],v[i][1]);adjs&&(adjs[0].endAlpha=0,adjs[0].ignore=!0,adjs[1].endAlpha=0,adjs[1].ignore=!0)}viz.reposition(),viz.fx.animate($merge(options,{modes:["fade:vertex","linear"],onComplete:function(){that.removeEdge(v,{type:"nothing"})}}));break;case"iter":var that=this;viz.fx.sequence({condition:function(){return 0!=v.length},step:function(){that.removeEdge(v.shift(),{type:"nothing"}),viz.fx.clearLabels()},onComplete:function(){options.onComplete()},duration:Math.ceil(options.duration/v.length)});break;default:this.doError()}},sum:function(json,opt){var viz=this.viz,options=$merge(this.options,viz.controller,opt),root=viz.root;switch(viz.root=opt.id||viz.root,options.type){case"nothing":var graph=viz.construct(json),GUtil=Graph.Util;GUtil.eachNode(graph,function(elem){GUtil.eachAdjacency(elem,function(adj){viz.graph.addAdjacence(adj.nodeFrom,adj.nodeTo,adj.data)})});break;case"replot":viz.refresh(!0),this.sum(json,{type:"nothing"}),viz.refresh(!0);break;case"fade:seq":case"fade":case"fade:con":var GUtil=Graph.Util,graph=viz.construct(json),fadeEdges=this.preprocessSum(graph),modes=fadeEdges?["fade:nodes","fade:vertex"]:["fade:nodes"];viz.reposition(),"fade:con"!=options.type?viz.fx.animate($merge(options,{modes:["linear"],onComplete:function(){viz.fx.animate($merge(options,{modes:modes,onComplete:function(){options.onComplete()}}))}})):(GUtil.eachNode(viz.graph,function(elem){elem.id!=root&&elem.pos.getp().equals(Polar.KER)&&(elem.pos.set(elem.endPos),elem.startPos.set(elem.endPos))}),viz.fx.animate($merge(options,{modes:["linear"].concat(modes)})));break;default:this.doError()}},morph:function(json,opt){var viz=this.viz,options=$merge(this.options,viz.controller,opt),root=viz.root;switch(viz.root=opt.id||viz.root,options.type){case"nothing":var graph=viz.construct(json),GUtil=Graph.Util;GUtil.eachNode(graph,function(elem){GUtil.eachAdjacency(elem,function(adj){viz.graph.addAdjacence(adj.nodeFrom,adj.nodeTo,adj.data)})}),GUtil.eachNode(viz.graph,function(elem){GUtil.eachAdjacency(elem,function(adj){graph.getAdjacence(adj.nodeFrom.id,adj.nodeTo.id)||viz.graph.removeAdjacence(adj.nodeFrom.id,adj.nodeTo.id)}),graph.hasNode(elem.id)||viz.graph.removeNode(elem.id)});break;case"replot":viz.refresh(!0),this.morph(json,{type:"nothing"}),viz.fx.clearLabels(),viz.refresh(!0);break;case"fade:seq":case"fade":case"fade:con":var GUtil=Graph.Util,graph=viz.construct(json),fadeEdges=this.preprocessSum(graph);GUtil.eachNode(viz.graph,function(elem){graph.hasNode(elem.id)||(elem.alpha=1,elem.startAlpha=1,elem.endAlpha=0,elem.ignore=!0)}),GUtil.eachNode(viz.graph,function(elem){elem.ignore||GUtil.eachAdjacency(elem,function(adj){if(!adj.nodeFrom.ignore&&!adj.nodeTo.ignore){var nodeFrom=graph.getNode(adj.nodeFrom.id),nodeTo=graph.getNode(adj.nodeTo.id);if(!nodeFrom.adjacentTo(nodeTo)){var adjs=viz.graph.getAdjacence(nodeFrom.id,nodeTo.id);fadeEdges=!0,adjs[0].alpha=1,adjs[0].startAlpha=1,adjs[0].endAlpha=0,adjs[0].ignore=!0,adjs[1].alpha=1,adjs[1].startAlpha=1,adjs[1].endAlpha=0,adjs[1].ignore=!0}}})});var modes=fadeEdges?["fade:nodes","fade:vertex"]:["fade:nodes"];viz.reposition(),GUtil.eachNode(viz.graph,function(elem){elem.id!=root&&elem.pos.getp().equals(Polar.KER)&&(elem.pos.set(elem.endPos),elem.startPos.set(elem.endPos))}),viz.fx.animate($merge(options,{modes:["polar"].concat(modes),onComplete:function(){GUtil.eachNode(viz.graph,function(elem){elem.ignore&&viz.graph.removeNode(elem.id)}),GUtil.eachNode(viz.graph,function(elem){GUtil.eachAdjacency(elem,function(adj){adj.ignore&&viz.graph.removeAdjacence(adj.nodeFrom.id,adj.nodeTo.id)})}),options.onComplete()}}));break;default:this.doError()}},preprocessSum:function(graph){var viz=this.viz,GUtil=Graph.Util;GUtil.eachNode(graph,function(elem){if(!viz.graph.hasNode(elem.id)){viz.graph.addNode(elem);var n=viz.graph.getNode(elem.id);n.alpha=0,n.startAlpha=0,n.endAlpha=1}});var fadeEdges=!1;return GUtil.eachNode(graph,function(elem){GUtil.eachAdjacency(elem,function(adj){var nodeFrom=viz.graph.getNode(adj.nodeFrom.id),nodeTo=viz.graph.getNode(adj.nodeTo.id);if(!nodeFrom.adjacentTo(nodeTo)){var adjs=viz.graph.addAdjacence(nodeFrom,nodeTo,adj.data);nodeFrom.startAlpha==nodeFrom.endAlpha&&nodeTo.startAlpha==nodeTo.endAlpha&&(fadeEdges=!0,adjs[0].alpha=0,adjs[0].startAlpha=0,adjs[0].endAlpha=1,adjs[1].alpha=0,adjs[1].startAlpha=0,adjs[1].endAlpha=1)}})}),fadeEdges}},Graph.Plot={Interpolator:{moebius:function(elem,delta,vector){if(1>=delta||vector.norm()<=1){var x=vector.x,y=vector.y,ans=elem.startPos.getc().moebiusTransformation(vector);elem.pos.setc(ans.x,ans.y),vector.x=x,vector.y=y}},linear:function(elem,delta){var from=elem.startPos.getc(!0),to=elem.endPos.getc(!0);elem.pos.setc((to.x-from.x)*delta+from.x,(to.y-from.y)*delta+from.y)},"fade:nodes":function(elem,delta){if(1>=delta&&elem.endAlpha!=elem.alpha){var from=elem.startAlpha,to=elem.endAlpha;elem.alpha=from+(to-from)*delta}},"fade:vertex":function(elem,delta){var adjs=elem.adjacencies;for(var id in adjs)this["fade:nodes"](adjs[id],delta)},polar:function(elem,delta){var from=elem.startPos.getp(!0),to=elem.endPos.getp(),ans=to.interpolate(from,delta);elem.pos.setp(ans.theta,ans.rho)}},labelsHidden:!1,labelContainer:!1,labels:{},getLabelContainer:function(){return this.labelContainer?this.labelContainer:this.labelContainer=document.getElementById(this.viz.config.labelContainer)},getLabel:function(id){return id in this.labels&&null!=this.labels[id]?this.labels[id]:this.labels[id]=document.getElementById(id)},hideLabels:function(hide){var container=this.getLabelContainer();container.style.display=hide?"none":"",this.labelsHidden=hide},clearLabels:function(){for(var id in this.labels)this.viz.graph.hasNode(id)||(this.disposeLabel(id),delete this.labels[id])},disposeLabel:function(id){var elem=this.getLabel(id);elem&&elem.parentNode&&elem.parentNode.removeChild(elem)},hideLabel:function(node,flag){node=$splat(node);var lab,st=flag?"":"none",that=this;$each(node,function(n){(lab=that.getLabel(n.id))&&(lab.style.display=st)})},sequence:function(options){var that=this;options=$merge({condition:$lambda(!1),step:$empty,onComplete:$empty,duration:200},options||{});var interval=setInterval(function(){options.condition()?options.step():(clearInterval(interval),options.onComplete()),that.viz.refresh(!0)},options.duration)},animate:function(opt,versor){var that=this,viz=this.viz,graph=viz.graph,GUtil=Graph.Util;opt=$merge(viz.controller,opt||{}),opt.hideLabels&&this.hideLabels(!0),this.animation.setOptions($merge(opt,{$animating:!1,compute:function(delta){var vector=versor?versor.scale(-delta):null;GUtil.eachNode(graph,function(node){for(var i=0;i<opt.modes.length;i++)that.Interpolator[opt.modes[i]](node,delta,vector)}),that.plot(opt,this.$animating),this.$animating=!0},complete:function(){GUtil.eachNode(graph,function(node){node.startPos.set(node.pos),node.startAlpha=node.alpha}),opt.hideLabels&&that.hideLabels(!1),that.plot(opt),opt.onComplete(),opt.onAfterCompute()}})).start()},plot:function(opt,animating){var viz=this.viz,aGraph=viz.graph,canvas=viz.canvas,id=viz.root,that=this,ctx=canvas.getCtx(),GUtil=Graph.Util;opt=opt||this.viz.controller,opt.clearCanvas&&canvas.clear();var T=!!aGraph.getNode(id).visited;GUtil.eachNode(aGraph,function(node){GUtil.eachAdjacency(node,function(adj){var nodeTo=adj.nodeTo;!!nodeTo.visited===T&&node.drawn&&nodeTo.drawn&&(!animating&&opt.onBeforePlotLine(adj),ctx.save(),ctx.globalAlpha=Math.min(Math.min(node.alpha,nodeTo.alpha),adj.alpha),that.plotLine(adj,canvas,animating),ctx.restore(),!animating&&opt.onAfterPlotLine(adj))}),ctx.save(),node.drawn&&(ctx.globalAlpha=node.alpha,!animating&&opt.onBeforePlotNode(node),that.plotNode(node,canvas,animating),!animating&&opt.onAfterPlotNode(node)),!that.labelsHidden&&opt.withLabels&&(node.drawn&&ctx.globalAlpha>=.95?that.plotLabel(canvas,node,opt):that.hideLabel(node,!1)),ctx.restore(),node.visited=!T})},plotLabel:function(canvas,node,controller){var id=node.id,tag=this.getLabel(id);if(!tag&&!(tag=document.getElementById(id))){tag=document.createElement("div");var container=this.getLabelContainer();container.appendChild(tag),tag.id=id,tag.className="node",tag.style.position="absolute",controller.onCreateLabel(tag,node),this.labels[node.id]=tag}this.placeLabel(tag,node,controller)},plotNode:function(node,canvas,animating){var nconfig=this.node,data=node.data,cond=nconfig.overridable&&data,width=cond&&data.$lineWidth||nconfig.lineWidth,color=cond&&data.$color||nconfig.color,ctx=canvas.getCtx();ctx.lineWidth=width,ctx.fillStyle=color,ctx.strokeStyle=color;var f=node.data&&node.data.$type||nconfig.type;this.nodeTypes[f].call(this,node,canvas,animating)},plotLine:function(adj,canvas,animating){var econfig=this.edge,data=adj.data,cond=econfig.overridable&&data,width=cond&&data.$lineWidth||econfig.lineWidth,color=cond&&data.$color||econfig.color,ctx=canvas.getCtx();ctx.lineWidth=width,ctx.fillStyle=color,ctx.strokeStyle=color;var f=adj.data&&adj.data.$type||econfig.type;this.edgeTypes[f].call(this,adj,canvas,animating)},fitsInCanvas:function(pos,canvas){var size=canvas.getSize();return pos.x>=size.width||pos.x<0||pos.y>=size.height||pos.y<0?!1:!0}};var Loader={construct:function(json){var isGraph="array"==$type(json),ans=new Graph(this.graphOptions);return isGraph?function(ans,json){for(var getNode=function(id){for(var w=0;w<json.length;w++)if(json[w].id==id)return json[w]},i=0;i<json.length;i++){ans.addNode(json[i]);for(var j=0,adj=json[i].adjacencies;j<adj.length;j++){var data,node=adj[j];"string"!=typeof adj[j]&&(data=node.data,node=node.nodeTo),ans.addAdjacence(json[i],getNode(node),data)}}}(ans,json):function(ans,json){ans.addNode(json);for(var i=0,ch=json.children;i<ch.length;i++)ans.addAdjacence(json,ch[i]),arguments.callee(ans,ch[i])}(ans,json),ans},loadJSON:function(json,i){this.json=json,this.graph=this.construct(json),this.root="array"!=$type(json)?json.id:json[i?i:0].id}};this.Trans={linear:function(p){return p}},function(){var makeTrans=function(transition,params){return params=$splat(params),$extend(transition,{easeIn:function(pos){return transition(pos,params)},easeOut:function(pos){return 1-transition(1-pos,params)},easeInOut:function(pos){return.5>=pos?transition(2*pos,params)/2:(2-transition(2*(1-pos),params))/2}})},transitions={Pow:function(p,x){return Math.pow(p,x[0]||6)},Expo:function(p){return Math.pow(2,8*(p-1))},Circ:function(p){return 1-Math.sin(Math.acos(p))},Sine:function(p){return 1-Math.sin((1-p)*Math.PI/2)},Back:function(p,x){return x=x[0]||1.618,Math.pow(p,2)*((x+1)*p-x)},Bounce:function(p){for(var value,a=0,b=1;1;a+=b,b/=2)if(p>=(7-4*a)/11){value=b*b-Math.pow((11-6*a-11*p)/4,2);break}return value},Elastic:function(p,x){return Math.pow(2,10*--p)*Math.cos(20*p*Math.PI*(x[0]||1)/3)}};$each(transitions,function(val,key){Trans[key]=makeTrans(val)}),$each(["Quad","Cubic","Quart","Quint"],function(elem,i){Trans[elem]=makeTrans(function(p){return Math.pow(p,[i+2])})})}();var Animation=new Class({initalize:function(options){this.setOptions(options)},setOptions:function(options){var opt={duration:2500,fps:40,transition:Trans.Quart.easeInOut,compute:$empty,complete:$empty};return this.opt=$merge(opt,options||{}),this},getTime:function(){return $time()},step:function(){var time=this.getTime(),opt=this.opt;if(time<this.time+opt.duration){var delta=opt.transition((time-this.time)/opt.duration);opt.compute(delta)}else this.timer=clearInterval(this.timer),opt.compute(1),opt.complete()},start:function(){return this.time=0,this.startTimer(),this},startTimer:function(){var that=this,opt=this.opt;return this.timer?!1:(this.time=this.getTime()-this.time,this.timer=setInterval(function(){that.step()},Math.round(1e3/opt.fps)),!0)}});this.ST=function(){function getNodesToHide(node){node=node||this.clickedNode;var Geom=this.geom,GUtil=Graph.Util,graph=this.graph,canvas=this.canvas,level=node._depth,nodeArray=[];GUtil.eachNode(graph,function(n){n._depth<=level&&n.exist&&!n.selected&&nodeArray.push(n)});var leafLevel=Geom.getRightLevelToShow(node,canvas);return GUtil.eachLevel(node,leafLevel,leafLevel,function(n){n.exist&&!n.selected&&nodeArray.push(n)}),nodeArray}function getNodesToShow(node){var nodeArray=[],GUtil=Graph.Util;return node=node||this.clickedNode,GUtil.eachLevel(this.clickedNode,0,this.config.levelsToShow,function(n){n.drawn&&!GUtil.anySubnode(n,"drawn")&&nodeArray.push(n)}),nodeArray}function getLCA(node){function findLCA(n,m){for(;p[n]!=p[m];){var noden=graph.getNode(n),nodem=graph.getNode(m);n._depth>m._depth?n=p[n]:m=p[m]}for(;n!=m;){var noden=graph.getNode(n),nodem=graph.getNode(m);n._depth>m._depth?n=GUtil.getParents(noden)[0].id:m=GUtil.getParents(nodem)[0].id}return n}if(0==nodesInPath.length)return lca=node?node.id:!1,void 0;var GUtil=Graph.Util,graph=this.graph,root=this.root,treeDepth=0;GUtil.eachNode(graph,function(n){treeDepth=n._depth>treeDepth?n._depth:treeDepth});var nr=Math.sqrt(treeDepth),p={};!function dfs(n){if(n._depth<nr)p[n.id]=root;else{var par=GUtil.getParents(n)[0].id;p[n.id]=n._depth%nr?p[par]:par}GUtil.eachSubnode(n,dfs)}(graph.getNode(root)),lca=root;for(var i=0;i<nodesInPath.length;i++)lca=findLCA(lca,nodesInPath[i])}var lca,nodesInPath=[];return new Class({Implements:Loader,initialize:function(canvas,controller){var innerController={onBeforeCompute:$empty,onAfterCompute:$empty,onCreateLabel:$empty,onPlaceLabel:$empty,onComplete:$empty,onBeforePlotNode:$empty,onAfterPlotNode:$empty,onBeforePlotLine:$empty,onAfterPlotLine:$empty,request:!1},config={orientation:"left",labelContainer:canvas.id+"-label",levelsToShow:2,subtreeOffset:8,siblingOffset:5,levelDistance:30,withLabels:!0,clearCanvas:!0,Node:{overridable:!1,type:"rectangle",color:"#ccb",lineWidth:1,height:20,width:90,dim:15,align:"center"},Edge:{overridable:!1,type:"line",color:"#ccc",dim:15,lineWidth:1},duration:700,fps:25,transition:Trans.Quart.easeInOut};this.controller=this.config=$merge(config,innerController,controller),this.canvas=canvas,this.graphOptions={complex:!0},this.graph=new Graph(this.graphOptions),this.fx=new ST.Plot(this),this.op=new ST.Op(this),this.group=new ST.Group(this),this.geom=new ST.Geom(this),this.clickedNode=null},plot:function(){this.fx.plot(this.controller)},switchPosition:function(pos,onComplete){var Geom=this.geom,Plot=this.fx,that=this;Plot.busy||(Plot.busy=!0,this.contract({onComplete:function(){Geom.switchOrientation(pos),that.compute("endPos",!1),Plot.busy=!1,that.onClick(that.clickedNode.id,onComplete)}},pos))},addNodeInPath:function(id){nodesInPath.push(id)
},clearNodesInPath:function(){nodesInPath.length=0},refresh:function(){this.reposition(),this.select(this.clickedNode&&this.clickedNode.id||this.root)},reposition:function(){Graph.Util.computeLevels(this.graph,this.root,0,"ignore"),this.geom.setRightLevelToShow(this.clickedNode,this.canvas),Graph.Util.eachNode(this.graph,function(n){n.exist&&(n.drawn=!0)}),this.compute("endPos")},compute:function(property,computeLevels){var prop=property||"startPos",node=this.graph.getNode(this.root);$extend(node,{drawn:!0,exist:!0,selected:!0}),!computeLevels&&"_depth"in node||Graph.Util.computeLevels(this.graph,this.root,0,"ignore"),getLCA.call(this,this.clickedNode),this.computePositions(node,$C(0,0),prop)},computePositions:function(node,initialPos,property,contracted){var GUtil=Graph.Util,geom=this.geom,contracted=3==arguments.length||contracted;lca&&node.id==lca&&contracted&&(contracted=!1),node[property]=initialPos;var ch=[];if(GUtil.eachSubnode(node,function(n){ch.push(n)}),ch.length>0){var baseHeight=geom.getBaseSize(node,contracted),prevBaseSize=geom.getBaseSize(ch[0],contracted,"available"),subtreeOffset=1==ch.length?this.config.subtreeOffset:baseHeight-prevBaseSize,firstPos=ch[0][property]=geom.getFirstPos(node,initialPos,subtreeOffset);this.computePositions(ch[0],firstPos,property,contracted);for(var i=1;i<ch.length;i++){var leaf=!GUtil.anySubnode(ch[i],"exist")||!GUtil.anySubnode(ch[i-1],"exist"),nextBaseSize=geom.getBaseSize(ch[i],contracted,"available"),siblingOffset=leaf?(geom.getSize(ch[i],!0)+geom.getSize(ch[i-1],!0))/2:(prevBaseSize+nextBaseSize)/2;firstPos=geom.nextPosition(firstPos,siblingOffset),prevBaseSize=nextBaseSize,this.computePositions(ch[i],firstPos,property,contracted)}}},requestNodes:function(node,onComplete){var handler=$merge(this.controller,onComplete),lev=this.config.levelsToShow,GUtil=Graph.Util;if(handler.request){var leaves=[],d=node._depth;GUtil.eachLevel(node,0,lev,function(n){n.drawn&&!GUtil.anySubnode(n)&&(leaves.push(n),n._level=lev-(n._depth-d))}),this.group.requestNodes(leaves,handler)}else handler.onComplete()},contract:function(onComplete,switched){var orn=this.config.orientation,Geom=this.geom,Group=this.group;switched&&Geom.switchOrientation(switched);var nodes=getNodesToHide.call(this);switched&&Geom.switchOrientation(orn),Group.contract(nodes,$merge(this.controller,onComplete))},move:function(node,onComplete){this.compute("endPos",!1);var move=onComplete.Move,offset={x:move.offsetX,y:move.offsetY};this.geom.translate(node.endPos.add(offset).$scale(-1),"endPos"),this.fx.animate($merge(this.controller,{modes:["linear"]},onComplete))},expand:function(node,onComplete){var nodeArray=getNodesToShow.call(this,node);this.group.expand(nodeArray,$merge(this.controller,onComplete))},selectPath:function(node){function path(node){if(null!=node&&!node.selected){node.selected=!0,$each(that.group.getSiblings([node])[node.id],function(n){n.exist=!0,n.drawn=!0});var parents=GUtil.getParents(node);parents=parents.length>0?parents[0]:null,path(parents)}}var GUtil=Graph.Util,that=this;GUtil.eachNode(this.graph,function(n){n.selected=!1});for(var i=0,ns=[node.id].concat(nodesInPath);i<ns.length;i++)path(this.graph.getNode(ns[i]))},addSubtree:function(subtree,method,onComplete){"replot"==method?this.op.sum(subtree,$extend({type:"replot"},onComplete||{})):"animate"==method&&this.op.sum(subtree,$extend({type:"fade:seq"},onComplete||{}))},removeSubtree:function(id,removeRoot,method,onComplete){var node=this.graph.getNode(id),subids=[];Graph.Util.eachLevel(node,+!removeRoot,!1,function(n){subids.push(n.id)}),"replot"==method?this.op.removeNode(subids,$extend({type:"replot"},onComplete||{})):"animate"==method&&this.op.removeNode(subids,$extend({type:"fade:seq"},onComplete||{}))},select:function(id,onComplete){var group=this.group,geom=this.geom,node=this.graph.getNode(id),canvas=this.canvas;this.graph.getNode(this.root);var complete=$merge(this.controller,onComplete),that=this;complete.onBeforeCompute(node),this.selectPath(node),this.clickedNode=node,this.requestNodes(node,{onComplete:function(){group.hide(group.prepare(getNodesToHide.call(that)),complete),geom.setRightLevelToShow(node,canvas),that.compute("pos"),Graph.Util.eachNode(that.graph,function(n){var pos=n.pos.getc(!0);n.startPos.setc(pos.x,pos.y),n.endPos.setc(pos.x,pos.y),n.visited=!1}),that.geom.translate(node.endPos.scale(-1),["pos","startPos","endPos"]),group.show(getNodesToShow.call(that)),that.plot(),complete.onAfterCompute(that.clickedNode),complete.onComplete()}})},onClick:function(id,options){var canvas=this.canvas,that=this,Geom=(this.fx,Graph.Util,this.geom),innerController={Move:{offsetX:0,offsetY:0},onBeforeRequest:$empty,onBeforeContract:$empty,onBeforeMove:$empty,onBeforeExpand:$empty},complete=$merge(this.controller,innerController,options);if(!this.busy){this.busy=!0;var node=this.graph.getNode(id);this.selectPath(node,this.clickedNode),this.clickedNode=node,complete.onBeforeCompute(node),complete.onBeforeRequest(node),this.requestNodes(node,{onComplete:function(){complete.onBeforeContract(node),that.contract({onComplete:function(){Geom.setRightLevelToShow(node,canvas),complete.onBeforeMove(node),that.move(node,{Move:complete.Move,onComplete:function(){complete.onBeforeExpand(node),that.expand(node,{onComplete:function(){that.busy=!1,complete.onAfterCompute(id),complete.onComplete()}})}})}})}})}}})}(),ST.Op=new Class({Implements:Graph.Op,initialize:function(viz){this.viz=viz}}),ST.Group=new Class({initialize:function(viz){this.viz=viz,this.canvas=viz.canvas,this.config=viz.config,this.animation=new Animation,this.nodes=null,this.siblings=null,this.bbs=null},requestNodes:function(nodes,controller){var counter=0,len=nodes.length,nodeSelected={},complete=function(){controller.onComplete()},viz=this.viz;0==len&&complete();for(var i=0;len>i;i++)nodeSelected[nodes[i].id]=nodes[i],controller.request(nodes[i].id,nodes[i]._level,{onComplete:function(nodeId,data){data&&data.children&&(data.id=nodeId,viz.op.sum(data,{type:"nothing"})),++counter==len&&(Graph.Util.computeLevels(viz.graph,viz.root,0),complete())}})},contract:function(nodes,controller){Graph.Util,this.viz;var that=this;nodes=this.prepare(nodes),this.animation.setOptions($merge(controller,{$animating:!1,compute:function(delta){1==delta&&(delta=.99),that.plotStep(1-delta,controller,this.$animating),this.$animating="contract"},complete:function(){that.hide(nodes,controller)}})).start()},hide:function(nodes,controller){for(var GUtil=Graph.Util,i=(this.viz,0);i<nodes.length;i++){GUtil.eachLevel(nodes[i],1,!1,function(elem){elem.exist&&$extend(elem,{drawn:!1,exist:!1})})}controller.onComplete()},expand:function(nodes,controller){var that=this;Graph.Util,this.show(nodes),this.animation.setOptions($merge(controller,{$animating:!1,compute:function(delta){that.plotStep(delta,controller,this.$animating),this.$animating="expand"},complete:function(){that.plotStep(void 0,controller,!1),controller.onComplete()}})).start()},show:function(nodes){var GUtil=Graph.Util,config=this.config;this.prepare(nodes),$each(nodes,function(n){GUtil.eachLevel(n,0,config.levelsToShow,function(n){n.exist&&(n.drawn=!0)})})},prepare:function(nodes){return this.nodes=this.getNodesWithChildren(nodes),this.siblings=this.getSiblings(this.nodes),this.bbs=this.getBoundingBoxes(this.nodes),this.nodes},getNodesWithChildren:function(nodes){for(var ans=[],GUtil=Graph.Util,i=0;i<nodes.length;i++)GUtil.anySubnode(nodes[i],"exist")&&ans.push(nodes[i]);return ans},plotStep:function(delta,controller,animating){for(var viz=this.viz,canvas=viz.canvas,ctx=canvas.getCtx(),bbs=this.bbs,siblings=this.siblings,nodes=this.nodes,i=0;i<nodes.length;i++){ctx.save();var node=nodes[i],bb=bbs[i];canvas.clearRectangle(bb.top,bb.right,bb.bottom,bb.left),viz.fx.plotSubtree(node,controller,delta,animating),ctx.restore(),$each(siblings[node.id],function(elem){viz.fx.plotNode(elem,canvas,!1)})}},getSiblings:function(nodes){var siblings={},GUtil=Graph.Util;return $each(nodes,function(n){var par=GUtil.getParents(n);if(0==par.length)siblings[n.id]=[n];else{var ans=[];GUtil.eachSubnode(par[0],function(sn){ans.push(sn)}),siblings[n.id]=ans}}),siblings},getBoundingBoxes:function(nodes){var bbs=[],geom=this.viz.geom;return $each(nodes,function(n){bbs.push(geom.getBoundingBox(n))}),bbs}}),ST.Geom=new Class({initialize:function(viz){this.viz=viz,this.config=viz.config,this.node=viz.config.Node,this.edge=viz.config.Edge},translate:function(pos,prop){prop=$splat(prop),Graph.Util.eachNode(this.viz.graph,function(elem){$each(prop,function(p){elem[p].$add(pos)})})},switchOrientation:function(){var args=arguments;if(args.length>0)this.config.orientation=args[0];else{var s=this.dispatch("bottom","top","left","right");this.config.orientation=s}},dispatch:function(){var args=arguments,len=args.length,s=this.config.orientation,val=function(a){return"function"==typeof a?a():a};if(2==len)return"top"==s||"bottom"==s?val(args[0]):val(args[1]);if(4==len)switch(s){case"top":return val(args[0]);case"right":return val(args[1]);case"bottom":return val(args[2]);case"left":return val(args[3])}},getSize:function(n,invert){var node=this.node,data=n.data,cond=this.node.overridable,siblingOffset=this.config.siblingOffset,w=(cond&&data.$width||node.width)+siblingOffset,h=(cond&&data.$height||node.height)+siblingOffset;return invert?this.dispatch(w,h):this.dispatch(h,w)},getMaxSiblingWidthAndHeight:function(node){var dim=this.node,GUtil=Graph.Util,graph=this.viz.graph,level=node._depth;if(this.node.overridable){var w=-1,h=-1;return GUtil.eachNode(graph,function(n){if(n._depth==level){var dw=n.data.$width||dim.width,dh=n.data.$height||dim.height;w=dw>w?dw:w,h=dh>h?dh:h}}),{width:w,height:h}}return this.node},getBoundingBox:function(node){var dim=this.node;node.pos,this.config.siblingOffset,Graph.Util;var calc=function(level,n){if(0===level||!Graph.Util.anySubnode(n,"exist")){calc.boundary=calc.boundary||{w:-1,h:-1};var w=n.data.$width||dim.width,h=n.data.$height||dim.height,b=calc.boundary;return b.w=w>b.w?w:b.w,b.h=h>b.h?h:b.h,calc.leaf=calc.leaf&&calc.leaf._depth>n._depth?calc.leaf:n,!0}return!1},baseSize=this.getTreeBaseSize(node,Number.MAX_VALUE,calc),b=calc.boundary,leaf=calc.leaf,root=node,rw=root.data.$width||dim.width,rh=root.data.$height||dim.height;if("left"==dim.align)return this.dispatch({left:root.pos.x-baseSize/2,bottom:leaf.pos.y+b.h,top:root.pos.y+rh,right:root.pos.x+baseSize/2},{left:leaf.pos.x,bottom:root.pos.y+baseSize/2,top:root.pos.y-baseSize/2,right:root.pos.x},{left:root.pos.x-baseSize/2,bottom:root.pos.y,top:leaf.pos.y-b.h,right:root.pos.x+baseSize/2},{left:root.pos.x+rw,bottom:root.pos.y+baseSize/2,top:root.pos.y-baseSize/2,right:leaf.pos.x+b.w});if("center"==dim.align)return this.dispatch({left:root.pos.x-baseSize/2,bottom:leaf.pos.y+b.h/2,top:root.pos.y+rh/2,right:root.pos.x+baseSize/2},{left:leaf.pos.x-b.w/2,bottom:root.pos.y+baseSize/2,top:root.pos.y-baseSize/2,right:root.pos.x-rw/2},{left:root.pos.x-baseSize/2,bottom:root.pos.y-rh/2,top:leaf.pos.y-b.h/2,right:root.pos.x+baseSize/2},{left:root.pos.x+rw/2,bottom:root.pos.y+baseSize/2,top:root.pos.y-baseSize/2,right:leaf.pos.x+b.w/2});if("right"==dim.align)return this.dispatch({left:root.pos.x-baseSize/2,bottom:leaf.pos.y,top:root.pos.y,right:root.pos.x+baseSize/2},{left:leaf.pos.x-b.w,bottom:root.pos.y+baseSize/2,top:root.pos.y-baseSize/2,right:root.pos.x},{left:root.pos.x-baseSize/2,bottom:root.pos.y-rh,top:leaf.pos.y-b.h,right:root.pos.x+baseSize/2},{left:root.pos.x,bottom:root.pos.y+baseSize/2,top:root.pos.y-baseSize/2,right:leaf.pos.x+b.w});throw"align: not implemented"},getBaseSize:function(node,contracted,type){return contracted?"available"==type?this.getSize(node,!0):this.getTreeBaseSize(node,1,function(level,node){return 0===level&&node.exist}):this.getTreeBaseSize(node,Number.MAX_VALUE,function(level,n){return 0===level||!Graph.Util.anySubnode(n,"exist")})},getTreeBaseSize:function(node,level,leaf){var size=this.getSize(node,!0),baseHeight=0,that=this;return leaf(level,node)?size:0===level?0:(Graph.Util.eachSubnode(node,function(elem){baseHeight+=that.getTreeBaseSize(elem,level-1,leaf)}),(size>baseHeight?size:baseHeight)+this.config.subtreeOffset)},getEdge:function(node,type){var $C=function(a,b){return function(){return node.pos.add(new Complex(a,b))}},dim=this.node,cond=this.node.overridable,data=node.data,w=cond&&data.$width||dim.width,h=cond&&data.$height||dim.height;if("begin"==type){if("center"==dim.align)return this.dispatch($C(0,h/2),$C(-w/2,0),$C(0,-h/2),$C(w/2,0));if("left"==dim.align)return this.dispatch($C(0,h),$C(0,0),$C(0,0),$C(w,0));if("right"==dim.align)return this.dispatch($C(0,0),$C(-w,0),$C(0,-h),$C(0,0));throw"align: not implemented"}if("end"==type){if("center"==dim.align)return this.dispatch($C(0,-h/2),$C(w/2,0),$C(0,h/2),$C(-w/2,0));if("left"==dim.align)return this.dispatch($C(0,0),$C(w,0),$C(0,h),$C(0,0));if("right"==dim.align)return this.dispatch($C(0,-h),$C(0,0),$C(0,0),$C(-w,0));throw"align: not implemented"}},getScaledTreePosition:function(node,scale){var dim=this.node,cond=this.node.overridable,data=node.data,w=cond&&data.$width||dim.width,h=cond&&data.$height||dim.height,$C=function(a,b){return function(){return node.pos.add(new Complex(a,b)).$scale(1-scale)}};if("left"==dim.align)return this.dispatch($C(0,h),$C(0,0),$C(0,0),$C(w,0));if("center"==dim.align)return this.dispatch($C(0,h/2),$C(-w/2,0),$C(0,-h/2),$C(w/2,0));if("right"==dim.align)return this.dispatch($C(0,0),$C(-w,0),$C(0,-h),$C(0,0));throw"align: not implemented"},treeFitsInCanvas:function(node,canvas,level){var csize=canvas.getSize(node),size=this.dispatch(csize.width,csize.height),baseSize=this.getTreeBaseSize(node,level,function(level,node){return 0===level||!Graph.Util.anySubnode(node)});return size>baseSize},getFirstPos:function(node,initialPos,baseHeight){var $C=function(a,b){return function(){return new Complex(a,b)}},msize=this.getMaxSiblingWidthAndHeight(node),nSize={data:{$width:msize.width,$height:msize.height}},size=this.getSize(nSize)+this.config.levelDistance,factor=-baseHeight/2+this.config.subtreeOffset/2;return this.dispatch($C(initialPos.x+factor,initialPos.y+size),$C(initialPos.x-size,initialPos.y+factor),$C(initialPos.x+factor,initialPos.y-size),$C(initialPos.x+size,initialPos.y+factor))},nextPosition:function(firstPos,siblingOffset){var $C=function(a,b){return function(){return new Complex(a,b)}};return this.dispatch($C(firstPos.x+siblingOffset,firstPos.y),$C(firstPos.x,firstPos.y+siblingOffset),$C(firstPos.x+siblingOffset,firstPos.y),$C(firstPos.x,firstPos.y+siblingOffset))},setRightLevelToShow:function(node,canvas){var level=this.getRightLevelToShow(node,canvas),fx=this.viz.fx;Graph.Util.eachLevel(node,0,this.config.levelsToShow,function(n){var d=n._depth-node._depth;d>level?(n.drawn=!1,n.exist=!1,fx.hideLabel(n,!1)):n.exist=!0}),node.drawn=!0},getRightLevelToShow:function(node,canvas){for(var level=this.config.levelsToShow;!this.treeFitsInCanvas(node,canvas,level)&&level>1;)level--;return level}}),ST.Plot=new Class({Implements:Graph.Plot,initialize:function(viz){this.viz=viz,this.config=viz.config,this.node=this.config.Node,this.edge=this.config.Edge,this.animation=new Animation,this.nodeTypes=new ST.Plot.NodeTypes,this.edgeTypes=new ST.Plot.EdgeTypes},plotSubtree:function(node,opt,scale,animating){var viz=this.viz,canvas=viz.canvas;if(scale=Math.min(Math.max(.001,scale),1),scale>=0){node.drawn=!1;var ctx=canvas.getCtx(),diff=viz.geom.getScaledTreePosition(node,scale);ctx.translate(diff.x,diff.y),ctx.scale(scale,scale)}this.plotTree(node,!scale,opt,animating),scale>=0&&(node.drawn=!0)},plotTree:function(node,plotLabel,opt,animating){var that=this,viz=this.viz,canvas=viz.canvas,ctx=canvas.getCtx();Graph.Util.eachSubnode(node,function(elem){if(elem.exist){if(elem.drawn){var adj=node.getAdjacency(elem.id);!animating&&opt.onBeforePlotLine(adj),ctx.globalAlpha=Math.min(node.alpha,elem.alpha),that.plotLine(adj,canvas,animating),!animating&&opt.onAfterPlotLine(adj)}that.plotTree(elem,plotLabel,opt,animating)}}),node.drawn?(ctx.globalAlpha=node.alpha,!animating&&opt.onBeforePlotNode(node),this.plotNode(node,canvas,animating),!animating&&opt.onAfterPlotNode(node),plotLabel&&ctx.globalAlpha>=.95?this.plotLabel(canvas,node,opt):this.hideLabel(node,!1)):this.hideLabel(node,!0)},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),dim=this.node,canvas=this.viz.canvas,w=dim.overridable&&node.data.$width||dim.width,h=dim.overridable&&node.data.$height||dim.height,radius=canvas.getSize();if("center"==dim.align)var labelPos={x:Math.round(pos.x-w/2+radius.width/2),y:Math.round(pos.y-h/2+radius.height/2)};else if("left"==dim.align){var orn=this.config.orientation;if("bottom"==orn||"top"==orn)var labelPos={x:Math.round(pos.x-w/2+radius.width/2),y:Math.round(pos.y+radius.height/2)};else var labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y-h/2+radius.height/2)}}else{if("right"!=dim.align)throw"align: not implemented";var orn=this.config.orientation;if("bottom"==orn||"top"==orn)var labelPos={x:Math.round(pos.x-w/2+radius.width/2),y:Math.round(pos.y-h+radius.height/2)};else var labelPos={x:Math.round(pos.x-w+radius.width/2),y:Math.round(pos.y-h/2+radius.height/2)}}var style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display=this.fitsInCanvas(labelPos,canvas)?"":"none",controller.onPlaceLabel(tag,node)},getAlignedPos:function(pos,width,height){var nconfig=this.node;if("center"==nconfig.align)var square={x:pos.x-width/2,y:pos.y-height/2};else if("left"==nconfig.align){var orn=this.config.orientation;if("bottom"==orn||"top"==orn)var square={x:pos.x-width/2,y:pos.y};else var square={x:pos.x,y:pos.y-height/2}}else{if("right"!=nconfig.align)throw"align: not implemented";var orn=this.config.orientation;if("bottom"==orn||"top"==orn)var square={x:pos.x-width/2,y:pos.y-height};else var square={x:pos.x-width,y:pos.y-height/2}}return square}}),ST.Plot.NodeTypes=new Class({none:function(){},circle:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,cond=nconfig.overridable&&data,dim=cond&&data.$dim||nconfig.dim,algnPos=this.getAlignedPos(pos,2*dim,2*dim);canvas.path("fill",function(context){context.arc(algnPos.x+dim,algnPos.y+dim,dim,0,2*Math.PI,!0)})},square:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,cond=nconfig.overridable&&data,dim=cond&&data.$dim||nconfig.dim,algnPos=this.getAlignedPos(pos,dim,dim);canvas.getCtx().fillRect(algnPos.x,algnPos.y,dim,dim)},ellipse:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,cond=nconfig.overridable&&data,width=(cond&&data.$width||nconfig.width)/2,height=(cond&&data.$height||nconfig.height)/2,algnPos=this.getAlignedPos(pos,2*width,2*height),ctx=canvas.getCtx();ctx.save(),ctx.scale(width/height,height/width),canvas.path("fill",function(context){context.arc((algnPos.x+width)*(height/width),(algnPos.y+height)*(width/height),height,0,2*Math.PI,!0)}),ctx.restore()},rectangle:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,cond=nconfig.overridable&&data,width=cond&&data.$width||nconfig.width,height=cond&&data.$height||nconfig.height,algnPos=this.getAlignedPos(pos,width,height);canvas.getCtx().fillRect(algnPos.x,algnPos.y,width,height)}}),ST.Plot.EdgeTypes=new Class({none:function(){},line:function(adj,canvas){var begin=this.viz.geom.getEdge(adj.nodeFrom,"begin"),end=this.viz.geom.getEdge(adj.nodeTo,"end");canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.lineTo(end.x,end.y)})},"quadratic:begin":function(adj,canvas){var orn=this.config.orientation,data=adj.data,econfig=this.edge,begin=this.viz.geom.getEdge(adj.nodeFrom,"begin"),end=this.viz.geom.getEdge(adj.nodeTo,"end"),cond=econfig.overridable&&data,dim=cond&&data.$dim||econfig.dim;switch(orn){case"left":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(begin.x+dim,begin.y,end.x,end.y)});break;case"right":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(begin.x-dim,begin.y,end.x,end.y)});break;case"top":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(begin.x,begin.y+dim,end.x,end.y)});break;case"bottom":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(begin.x,begin.y-dim,end.x,end.y)})}},"quadratic:end":function(adj,canvas){var orn=this.config.orientation,data=adj.data,econfig=this.edge,begin=this.viz.geom.getEdge(adj.nodeFrom,"begin"),end=this.viz.geom.getEdge(adj.nodeTo,"end"),cond=econfig.overridable&&data,dim=cond&&data.$dim||econfig.dim;switch(orn){case"left":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(end.x-dim,end.y,end.x,end.y)});break;case"right":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(end.x+dim,end.y,end.x,end.y)});break;case"top":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(end.x,end.y-dim,end.x,end.y)});break;case"bottom":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.quadraticCurveTo(end.x,end.y+dim,end.x,end.y)})}},bezier:function(adj,canvas){var data=adj.data,econfig=this.edge,orn=this.config.orientation,begin=this.viz.geom.getEdge(adj.nodeFrom,"begin"),end=this.viz.geom.getEdge(adj.nodeTo,"end"),cond=econfig.overridable&&data,dim=cond&&data.$dim||econfig.dim;switch(orn){case"left":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.bezierCurveTo(begin.x+dim,begin.y,end.x-dim,end.y,end.x,end.y)});break;case"right":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.bezierCurveTo(begin.x-dim,begin.y,end.x+dim,end.y,end.x,end.y)});break;case"top":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.bezierCurveTo(begin.x,begin.y+dim,end.x,end.y-dim,end.x,end.y)});break;case"bottom":canvas.path("stroke",function(ctx){ctx.moveTo(begin.x,begin.y),ctx.bezierCurveTo(begin.x,begin.y-dim,end.x,end.y+dim,end.x,end.y)})}},arrow:function(adj,canvas){var node=adj.nodeFrom,child=adj.nodeTo,data=adj.data,econfig=this.edge,cond=econfig.overridable&&data,edgeDim=cond&&data.$dim||econfig.dim;if(cond&&data.$direction&&data.$direction.length>1){var nodeHash={};nodeHash[node.id]=node,nodeHash[child.id]=child;var sense=data.$direction;node=nodeHash[sense[0]],child=nodeHash[sense[1]]}var posFrom=this.viz.geom.getEdge(node,"begin"),posTo=this.viz.geom.getEdge(child,"end"),vect=new Complex(posTo.x-posFrom.x,posTo.y-posFrom.y);vect.$scale(edgeDim/vect.norm());var intermediatePoint=new Complex(posTo.x-vect.x,posTo.y-vect.y),normal=new Complex(-vect.y/2,vect.x/2),v1=intermediatePoint.add(normal),v2=intermediatePoint.$add(normal.$scale(-1));canvas.path("stroke",function(context){context.moveTo(posFrom.x,posFrom.y),context.lineTo(posTo.x,posTo.y)}),canvas.path("fill",function(context){context.moveTo(v1.x,v1.y),context.lineTo(v2.x,v2.y),context.lineTo(posTo.x,posTo.y)})}});var AngularWidth={setAngularWidthForNodes:function(){var config=this.config.Node,overridable=config.overridable,dim=config.dim;Graph.Util.eachBFS(this.graph,this.root,function(elem,i){var diamValue=overridable&&elem.data&&elem.data.$aw||dim;elem._angularWidth=diamValue/i},"ignore")},setSubtreesAngularWidth:function(){var that=this;Graph.Util.eachNode(this.graph,function(elem){that.setSubtreeAngularWidth(elem)},"ignore")},setSubtreeAngularWidth:function(elem){var that=this,nodeAW=elem._angularWidth,sumAW=0;Graph.Util.eachSubnode(elem,function(child){that.setSubtreeAngularWidth(child),sumAW+=child._treeAngularWidth},"ignore"),elem._treeAngularWidth=Math.max(nodeAW,sumAW)},computeAngularWidths:function(){this.setAngularWidthForNodes(),this.setSubtreesAngularWidth()}};this.RGraph=new Class({Implements:[Loader,AngularWidth],initialize:function(canvas,controller){var config={labelContainer:canvas.id+"-label",interpolation:"linear",levelDistance:100,withLabels:!0,Node:{overridable:!1,type:"circle",dim:3,color:"#ccb",width:5,height:5,lineWidth:1},Edge:{overridable:!1,type:"line",color:"#ccb",lineWidth:1},fps:40,duration:2500,transition:Trans.Quart.easeInOut,clearCanvas:!0},innerController={onBeforeCompute:$empty,onAfterCompute:$empty,onCreateLabel:$empty,onPlaceLabel:$empty,onComplete:$empty,onBeforePlotLine:$empty,onAfterPlotLine:$empty,onBeforePlotNode:$empty,onAfterPlotNode:$empty};this.controller=this.config=$merge(config,innerController,controller),this.graphOptions={complex:!1,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions),this.fx=new RGraph.Plot(this),this.op=new RGraph.Op(this),this.json=null,this.canvas=canvas,this.root=null,this.busy=!1,this.parent=!1},refresh:function(){this.compute(),this.plot()},reposition:function(){this.compute("endPos")},plot:function(){this.fx.plot()},compute:function(property){var prop=property||["pos","startPos","endPos"],node=this.graph.getNode(this.root);node._depth=0,Graph.Util.computeLevels(this.graph,this.root,0,"ignore"),this.computeAngularWidths(),this.computePositions(prop)},computePositions:function(property){var propArray=$splat(property);this.graph;for(var GUtil=Graph.Util,root=this.graph.getNode(this.root),parent=this.parent,config=this.config,i=0;i<propArray.length;i++)root[propArray[i]]=$P(0,0);root.angleSpan={begin:0,end:2*Math.PI},root._rel=1,GUtil.eachBFS(this.graph,this.root,function(elem){var angleSpan=elem.angleSpan.end-elem.angleSpan.begin,rho=(elem._depth+1)*config.levelDistance,angleInit=elem.angleSpan.begin,totalAngularWidths=0,subnodes=[];GUtil.eachSubnode(elem,function(sib){totalAngularWidths+=sib._treeAngularWidth,subnodes.push(sib)},"ignore"),parent&&parent.id==elem.id&&subnodes.length>0&&subnodes[0].dist&&subnodes.sort(function(a,b){return(a.dist>=b.dist)-(a.dist<=b.dist)});for(var k=0;k<subnodes.length;k++){var child=subnodes[k];if(!child._flag){child._rel=child._treeAngularWidth/totalAngularWidths;for(var angleProportion=child._rel*angleSpan,theta=angleInit+angleProportion/2,i=0;i<propArray.length;i++)child[propArray[i]]=$P(theta,rho);child.angleSpan={begin:angleInit,end:angleInit+angleProportion},angleInit+=angleProportion}}},"ignore")},getNodeAndParentAngle:function(id){var theta=!1,n=this.graph.getNode(id),ps=Graph.Util.getParents(n),p=ps.length>0?ps[0]:!1;if(p){var posParent=p.pos.getc(),posChild=n.pos.getc(),newPos=posParent.add(posChild.scale(-1));theta=Math.atan2(newPos.y,newPos.x),0>theta&&(theta+=2*Math.PI)}return{parent:p,theta:theta}},tagChildren:function(par,id){if(par.angleSpan){var adjs=[];Graph.Util.eachAdjacency(par,function(elem){adjs.push(elem.nodeTo)},"ignore");for(var len=adjs.length,i=0;len>i&&id!=adjs[i].id;i++);for(var j=(i+1)%len,k=0;id!=adjs[j].id;j=(j+1)%len)adjs[j].dist=k++}},onClick:function(id,opt){if(this.root!=id&&!this.busy){this.busy=!0,this.root=id,that=this,this.controller.onBeforeCompute(this.graph.getNode(id));var obj=this.getNodeAndParentAngle(id);this.tagChildren(obj.parent,id),this.parent=obj.parent,this.compute("endPos");var thetaDiff=obj.theta-obj.parent.endPos.theta;Graph.Util.eachNode(this.graph,function(elem){elem.endPos.set(elem.endPos.getp().add($P(thetaDiff,0)))});var mode=this.config.interpolation;opt=$merge({onComplete:$empty},opt||{}),this.fx.animate($merge({hideLabels:!0,modes:[mode]},opt,{onComplete:function(){that.busy=!1,opt.onComplete()}}))}}}),RGraph.Op=new Class({Implements:Graph.Op,initialize:function(viz){this.viz=viz}}),RGraph.Plot=new Class({Implements:Graph.Plot,initialize:function(viz){this.viz=viz,this.config=viz.config,this.node=viz.config.Node,this.edge=viz.config.Edge,this.animation=new Animation,this.nodeTypes=new RGraph.Plot.NodeTypes,this.edgeTypes=new RGraph.Plot.EdgeTypes},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,radius=canvas.getSize(),labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display=this.fitsInCanvas(labelPos,canvas)?"":"none",controller.onPlaceLabel(tag,node)}}),RGraph.Plot.NodeTypes=new Class({none:function(){},circle:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;canvas.path("fill",function(context){context.arc(pos.x,pos.y,nodeDim,0,2*Math.PI,!0)})},square:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim,nodeDim2=2*nodeDim;canvas.getCtx().fillRect(pos.x-nodeDim,pos.y-nodeDim,nodeDim2,nodeDim2)},rectangle:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,width=nconfig.overridable&&data&&data.$width||nconfig.width,height=nconfig.overridable&&data&&data.$height||nconfig.height;canvas.getCtx().fillRect(pos.x-width/2,pos.y-height/2,width,height)},triangle:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim,c1x=pos.x,c1y=pos.y-nodeDim,c2x=c1x-nodeDim,c2y=pos.y+nodeDim,c3x=c1x+nodeDim,c3y=c2y;canvas.path("fill",function(ctx){ctx.moveTo(c1x,c1y),ctx.lineTo(c2x,c2y),ctx.lineTo(c3x,c3y)})},star:function(node,canvas){var pos=node.pos.getc(!0),nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim,ctx=canvas.getCtx(),pi5=Math.PI/5;ctx.save(),ctx.translate(pos.x,pos.y),ctx.beginPath(),ctx.moveTo(nodeDim,0);for(var i=0;9>i;i++)ctx.rotate(pi5),0==i%2?ctx.lineTo(.200811*(nodeDim/.525731),0):ctx.lineTo(nodeDim,0);ctx.closePath(),ctx.fill(),ctx.restore()}}),RGraph.Plot.EdgeTypes=new Class({none:function(){},line:function(adj,canvas){var pos=adj.nodeFrom.pos.getc(!0),posChild=adj.nodeTo.pos.getc(!0);canvas.path("stroke",function(context){context.moveTo(pos.x,pos.y),context.lineTo(posChild.x,posChild.y)})},arrow:function(adj,canvas){var node=adj.nodeFrom,child=adj.nodeTo,data=adj.data,econfig=this.edge,cond=econfig.overridable&&data,edgeDim=cond&&data.$dim||14;if(cond&&data.$direction&&data.$direction.length>1){var nodeHash={};nodeHash[node.id]=node,nodeHash[child.id]=child;var sense=data.$direction;node=nodeHash[sense[0]],child=nodeHash[sense[1]]}var posFrom=node.pos.getc(!0),posTo=child.pos.getc(!0),vect=new Complex(posTo.x-posFrom.x,posTo.y-posFrom.y);vect.$scale(edgeDim/vect.norm());var intermediatePoint=new Complex(posTo.x-vect.x,posTo.y-vect.y),normal=new Complex(-vect.y/2,vect.x/2),v1=intermediatePoint.add(normal),v2=intermediatePoint.$add(normal.$scale(-1));canvas.path("stroke",function(context){context.moveTo(posFrom.x,posFrom.y),context.lineTo(posTo.x,posTo.y)}),canvas.path("fill",function(context){context.moveTo(v1.x,v1.y),context.lineTo(v2.x,v2.y),context.lineTo(posTo.x,posTo.y)})}}),Complex.prototype.moebiusTransformation=function(c){var num=this.add(c),den=c.$conjugate().$prod(this);return den.x++,num.$div(den)},Graph.Util.getClosestNodeToOrigin=function(graph,prop,flags){return this.getClosestNodeToPos(graph,Polar.KER,prop,flags)},Graph.Util.getClosestNodeToPos=function(graph,pos,prop,flags){var node=null;prop=prop||"pos",pos=pos&&pos.getc(!0)||Complex.KER;var distance=function(a,b){var d1=a.x-b.x,d2=a.y-b.y;return d1*d1+d2*d2};return this.eachNode(graph,function(elem){node=null==node||distance(elem[prop].getc(!0),pos)<distance(node[prop].getc(!0),pos)?elem:node},flags),node},Graph.Util.moebiusTransformation=function(graph,pos,prop,startPos,flags){this.eachNode(graph,function(elem){for(var i=0;i<prop.length;i++){var p=pos[i].scale(-1),property=startPos?startPos:prop[i];elem[prop[i]].set(elem[property].getc().moebiusTransformation(p))}},flags)},this.Hypertree=new Class({Implements:[Loader,AngularWidth],initialize:function(canvas,controller){var config={labelContainer:canvas.id+"-label",withLabels:!0,Node:{overridable:!1,type:"circle",dim:7,color:"#ccb",width:5,height:5,lineWidth:1,transform:!0},Edge:{overridable:!1,type:"hyperline",color:"#ccb",lineWidth:1},clearCanvas:!0,fps:40,duration:1500,transition:Trans.Quart.easeInOut},innerController={onBeforeCompute:$empty,onAfterCompute:$empty,onCreateLabel:$empty,onPlaceLabel:$empty,onComplete:$empty,onBeforePlotLine:$empty,onAfterPlotLine:$empty,onBeforePlotNode:$empty,onAfterPlotNode:$empty};this.controller=this.config=$merge(config,innerController,controller),this.graphOptions={complex:!1,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions),this.fx=new Hypertree.Plot(this),this.op=new Hypertree.Op(this),this.json=null,this.canvas=canvas,this.root=null,this.busy=!1},refresh:function(reposition){reposition?(this.reposition(),Graph.Util.eachNode(this.graph,function(node){node.startPos.rho=node.pos.rho=node.endPos.rho,node.startPos.theta=node.pos.theta=node.endPos.theta
})):this.compute(),this.plot()},reposition:function(){this.compute("endPos");var vector=this.graph.getNode(this.root).pos.getc().scale(-1);Graph.Util.moebiusTransformation(this.graph,[vector],["endPos"],"endPos","ignore"),Graph.Util.eachNode(this.graph,function(node){node.ignore&&(node.endPos.rho=node.pos.rho,node.endPos.theta=node.pos.theta)})},plot:function(){this.fx.plot()},compute:function(property){var prop=property||["pos","startPos"],node=this.graph.getNode(this.root);node._depth=0,Graph.Util.computeLevels(this.graph,this.root,0,"ignore"),this.computeAngularWidths(),this.computePositions(prop)},computePositions:function(property){var propArray=$splat(property),aGraph=this.graph,GUtil=Graph.Util,root=this.graph.getNode(this.root);this.config;for(var size=this.canvas.getSize(),scale=Math.min(size.width,size.height)/2,i=0;i<propArray.length;i++)root[propArray[i]]=$P(0,0);root.angleSpan={begin:0,end:2*Math.PI},root._rel=1;var edgeLength=function(){var depth=0;GUtil.eachNode(aGraph,function(node){depth=node._depth>depth?node._depth:depth,node._scale=scale},"ignore");for(var i=.51;1>=i;i+=.01){var valSeries=function(a,n){return(1-Math.pow(a,n))/(1-a)}(i,depth+1);if(valSeries>=2)return i-.01}return.5}();GUtil.eachBFS(this.graph,this.root,function(elem){for(var angleSpan=elem.angleSpan.end-elem.angleSpan.begin,angleInit=elem.angleSpan.begin,totalAngularWidths=function(element){var total=0;return GUtil.eachSubnode(element,function(sib){total+=sib._treeAngularWidth},"ignore"),total}(elem),i=1,rho=0,lenAcum=edgeLength,depth=elem._depth;depth+1>=i;i++)rho+=lenAcum,lenAcum*=edgeLength;GUtil.eachSubnode(elem,function(child){if(!child._flag){child._rel=child._treeAngularWidth/totalAngularWidths;for(var angleProportion=child._rel*angleSpan,theta=angleInit+angleProportion/2,i=0;i<propArray.length;i++)child[propArray[i]]=$P(theta,rho);child.angleSpan={begin:angleInit,end:angleInit+angleProportion},angleInit+=angleProportion}},"ignore")},"ignore")},onClick:function(id,opt){var pos=this.graph.getNode(id).pos.getc(!0);this.move(pos,opt)},move:function(pos,opt){var versor=$C(pos.x,pos.y);if(this.busy===!1&&versor.norm()<1){var GUtil=Graph.Util;this.busy=!0;var root=GUtil.getClosestNodeToPos(this.graph,versor),that=this;GUtil.computeLevels(this.graph,root.id,0),this.controller.onBeforeCompute(root),versor.norm()<1&&(opt=$merge({onComplete:$empty},opt||{}),this.fx.animate($merge({modes:["moebius"],hideLabels:!0},opt,{onComplete:function(){that.busy=!1,opt.onComplete()}}),versor))}}}),Hypertree.Op=new Class({Implements:Graph.Op,initialize:function(viz){this.viz=viz}}),Hypertree.Plot=new Class({Implements:Graph.Plot,initialize:function(viz){this.viz=viz,this.config=viz.config,this.node=this.config.Node,this.edge=this.config.Edge,this.animation=new Animation,this.nodeTypes=new Hypertree.Plot.NodeTypes,this.edgeTypes=new Hypertree.Plot.EdgeTypes},hyperline:function(adj,canvas){var node=adj.nodeFrom,child=adj.nodeTo;adj.data;var pos=node.pos.getc(),posChild=child.pos.getc(),centerOfCircle=this.computeArcThroughTwoPoints(pos,posChild),size=canvas.getSize(),scale=Math.min(size.width,size.height)/2;if(centerOfCircle.a>1e3||centerOfCircle.b>1e3||centerOfCircle.ratio>1e3)canvas.path("stroke",function(ctx){ctx.moveTo(pos.x*scale,pos.y*scale),ctx.lineTo(posChild.x*scale,posChild.y*scale)});else{var angleBegin=Math.atan2(posChild.y-centerOfCircle.y,posChild.x-centerOfCircle.x),angleEnd=Math.atan2(pos.y-centerOfCircle.y,pos.x-centerOfCircle.x),sense=this.sense(angleBegin,angleEnd);canvas.getCtx(),canvas.path("stroke",function(ctx){ctx.arc(centerOfCircle.x*scale,centerOfCircle.y*scale,centerOfCircle.ratio*scale,angleBegin,angleEnd,sense)})}},computeArcThroughTwoPoints:function(p1,p2){var aDen=p1.x*p2.y-p1.y*p2.x,bDen=aDen,sq1=p1.squaredNorm(),sq2=p2.squaredNorm();if(0==aDen)return{x:0,y:0,ratio:1001};var a=(p1.y*sq2-p2.y*sq1+p1.y-p2.y)/aDen,b=(p2.x*sq1-p1.x*sq2+p2.x-p1.x)/bDen,x=-a/2,y=-b/2,squaredRatio=(a*a+b*b)/4-1;if(0>squaredRatio)return{x:0,y:0,ratio:1001};var ratio=Math.sqrt(squaredRatio),out={x:x,y:y,ratio:ratio,a:a,b:b};return out},sense:function(angleBegin,angleEnd){return angleEnd>angleBegin?angleBegin+Math.PI>angleEnd?!1:!0:angleEnd+Math.PI>angleBegin?!0:!1},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,radius=canvas.getSize(),scale=node._scale,labelPos={x:Math.round(pos.x*scale+radius.width/2),y:Math.round(pos.y*scale+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display="",controller.onPlaceLabel(tag,node)}}),Hypertree.Plot.NodeTypes=new Class({none:function(){},circle:function(node,canvas){var nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim,p=node.pos.getc(),pos=p.scale(node._scale),prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim;prod>=nodeDim/4&&canvas.path("fill",function(context){context.arc(pos.x,pos.y,prod,0,2*Math.PI,!0)})},square:function(node,canvas){var nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim,p=node.pos.getc(),pos=p.scale(node._scale),prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim,nodeDim2=2*prod;prod>=nodeDim/4&&canvas.getCtx().fillRect(pos.x-prod,pos.y-prod,nodeDim2,nodeDim2)},rectangle:function(node,canvas){var nconfig=this.node,data=node.data,width=nconfig.overridable&&data&&data.$width||nconfig.width,height=nconfig.overridable&&data&&data.$height||nconfig.height,p=node.pos.getc(),pos=p.scale(node._scale),prod=1-p.squaredNorm();width=nconfig.transform?width*prod:width,height=nconfig.transform?height*prod:height,prod>=.25&&canvas.getCtx().fillRect(pos.x-width/2,pos.y-height/2,width,height)},triangle:function(node,canvas){var nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim,p=node.pos.getc(),pos=p.scale(node._scale),prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim;if(prod>=nodeDim/4){var c1x=pos.x,c1y=pos.y-prod,c2x=c1x-prod,c2y=pos.y+prod,c3x=c1x+prod,c3y=c2y;canvas.path("fill",function(ctx){ctx.moveTo(c1x,c1y),ctx.lineTo(c2x,c2y),ctx.lineTo(c3x,c3y)})}},star:function(node,canvas){var nconfig=this.node,data=node.data,nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim,p=node.pos.getc(),pos=p.scale(node._scale),prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim;if(prod>=nodeDim/4){var ctx=canvas.getCtx(),pi5=Math.PI/5;ctx.save(),ctx.translate(pos.x,pos.y),ctx.beginPath(),ctx.moveTo(nodeDim,0);for(var i=0;9>i;i++)ctx.rotate(pi5),0==i%2?ctx.lineTo(.200811*(prod/.525731),0):ctx.lineTo(prod,0);ctx.closePath(),ctx.fill(),ctx.restore()}}}),Hypertree.Plot.EdgeTypes=new Class({none:function(){},line:function(adj,canvas){var s=adj.nodeFrom._scale,pos=adj.nodeFrom.pos.getc(!0),posChild=adj.nodeTo.pos.getc(!0);canvas.path("stroke",function(context){context.moveTo(pos.x*s,pos.y*s),context.lineTo(posChild.x*s,posChild.y*s)})},hyperline:function(adj,canvas){this.hyperline(adj,canvas)}}),this.TM={layout:{orientation:"h",vertical:function(){return"v"==this.orientation},horizontal:function(){return"h"==this.orientation},change:function(){this.orientation=this.vertical()?"h":"v"}},innerController:{onBeforeCompute:$empty,onAfterCompute:$empty,onComplete:$empty,onCreateElement:$empty,onDestroyElement:$empty,request:!1},config:{orientation:"h",titleHeight:13,rootId:"infovis",offset:4,levelsToShow:3,addLeftClickHandler:!1,addRightClickHandler:!1,selectPathOnHover:!1,Color:{allow:!1,minValue:-100,maxValue:100,minColorValue:[255,0,50],maxColorValue:[0,255,50]},Tips:{allow:!1,offsetX:20,offsetY:20,onShow:$empty}},initialize:function(controller){if(this.tree=null,this.shownTree=null,this.controller=this.config=$merge(this.config,this.innerController,controller),this.rootId=this.config.rootId,this.layout.orientation=this.config.orientation,this.config.Tips.allow&&document.body){var tip=document.createElement("div");tip.id="_tooltip",tip.className="tip";var style=tip.style;style.position="absolute",style.display="none",style.zIndex=13e3,document.body.appendChild(tip),this.tip=tip}var that=this,fn=function(){that.empty(),window.CollectGarbage&&window.CollectGarbage(),delete fn};window.addEventListener?window.addEventListener("unload",fn,!1):window.attachEvent("onunload",fn)},each:function(f){!function rec(elem){if(elem){var ch=elem.childNodes,len=ch.length;if(len>0&&f.apply(this,[elem,1===len,ch[0],ch[1]]),len>1)for(var chi=ch[1].childNodes,i=0;i<chi.length;i++)rec(chi[i])}}($get(this.rootId).firstChild)},toStyle:function(obj){var ans="";for(var s in obj)ans+=s+":"+obj[s]+";";return ans},leaf:function(tree){return 0==tree.children},createBox:function(json,coord,html){if(this.leaf(json))var box=this.leafBox(json,coord);else var box=this.headBox(json,coord)+this.bodyBox(html,coord);return this.contentBox(json,coord,box)},plot:function(json){var coord=json.coord,html="";if(this.leaf(json))return this.createBox(json,coord,null);for(var i=0,ch=json.children;i<ch.length;i++)html+=this.plot(ch[i]);return this.createBox(json,coord,html)},headBox:function(json,coord){var config=this.config,offst=config.offset,c={height:config.titleHeight+"px",width:coord.width-offst+"px",left:offst/2+"px"};return'<div class="head" style="'+this.toStyle(c)+'">'+json.name+"</div>"},bodyBox:function(html,coord){var config=this.config,th=config.titleHeight,offst=config.offset,c={width:coord.width-offst+"px",height:coord.height-offst-th+"px",top:th+offst/2+"px",left:offst/2+"px"};return'<div class="body" style="'+this.toStyle(c)+'">'+html+"</div>"},contentBox:function(json,coord,html){var c={};for(var i in coord)c[i]=coord[i]+"px";return'<div class="content" style="'+this.toStyle(c)+'" id="'+json.id+'">'+html+"</div>"},leafBox:function(json,coord){var config=this.config,backgroundColor=config.Color.allow&&this.setColor(json),offst=config.offset,width=coord.width-offst,height=coord.height-offst,c={top:offst/2+"px",height:height+"px",width:width+"px",left:offst/2+"px"};return backgroundColor&&(c["background-color"]=backgroundColor),'<div class="leaf" style="'+this.toStyle(c)+'">'+json.name+"</div>"},setColor:function(json){var c=this.config.Color,maxcv=c.maxColorValue,mincv=c.minColorValue,maxv=c.maxValue,minv=c.minValue,diff=maxv-minv,x=json.data.$color-0,comp=function(i,x){return Math.round((maxcv[i]-mincv[i])/diff*(x-minv)+mincv[i])};return $rgbToHex([comp(0,x),comp(1,x),comp(2,x)])},enter:function(elem){this.view(elem.parentNode.id)},onLeftClick:function(elem){this.enter(elem)},out:function(){var parent=TreeUtil.getParent(this.tree,this.shownTree.id);parent&&(this.controller.request&&TreeUtil.prune(parent,this.config.levelsToShow),this.view(parent.id))},onRightClick:function(){this.out()},view:function(id){var config=this.config,that=this,post={onComplete:function(){that.loadTree(id),$get(config.rootId).focus()}};if(this.controller.request){var TUtil=TreeUtil;TUtil.loadSubtrees(TUtil.getSubtree(this.tree,id),$merge(this.controller,post))}else post.onComplete()},resetPath:function(tree){function getParent(c){var p=c.parentNode;return p&&p.id!=root&&p}function toggleInPath(elem,remove){if(elem){var container=$get(elem.id);if(container)for(var parent=getParent(container);parent;){var elem=parent.childNodes[0];$hasClass(elem,"in-path")?(void 0==remove||remove)&&$removeClass(elem,"in-path"):remove||$addClass(elem,"in-path"),parent=getParent(parent)}}}var root=this.rootId,previous=this.resetPath.previous;this.resetPath.previous=tree||!1,toggleInPath(previous,!0),toggleInPath(tree,!1)},initializeElements:function(){var cont=this.controller,that=this,ff=$lambda(!1),tipsAllow=cont.Tips.allow;this.each(function(content,isLeaf,elem1,elem2){var tree=TreeUtil.getSubtree(that.tree,content.id);cont.onCreateElement(content,tree,isLeaf,elem1,elem2),cont.addRightClickHandler&&(elem1.oncontextmenu=ff),(cont.addLeftClickHandler||cont.addRightClickHandler)&&$addEvent(elem1,"mouseup",function(e){var rightClick=3==e.which||2==e.button;rightClick?cont.addRightClickHandler&&that.onRightClick():cont.addLeftClickHandler&&that.onLeftClick(elem1),e.preventDefault?e.preventDefault():e.returnValue=!1}),(cont.selectPathOnHover||tipsAllow)&&($addEvent(elem1,"mouseover",function(){cont.selectPathOnHover&&(isLeaf?$addClass(elem1,"over-leaf"):($addClass(elem1,"over-head"),$addClass(content,"over-content")),content.id&&that.resetPath(tree)),tipsAllow&&cont.Tips.onShow(that.tip,tree,isLeaf,elem1)}),$addEvent(elem1,"mouseout",function(){cont.selectPathOnHover&&(isLeaf?$removeClass(elem1,"over-leaf"):($removeClass(elem1,"over-head"),$removeClass(content,"over-content")),that.resetPath()),tipsAllow&&(that.tip.style.display="none")}),tipsAllow&&$addEvent(elem1,"mousemove",function(e,win){var tip=that.tip;win=win||window,e=e||win.event;var doc=win.document;doc=doc.html||doc.body;var page={x:e.pageX||e.clientX+doc.scrollLeft,y:e.pageY||e.clientY+doc.scrollTop};tip.style.display="";var win={height:document.body.clientHeight,width:document.body.clientWidth},obj={width:tip.offsetWidth,height:tip.offsetHeight},style=tip.style,x=cont.Tips.offsetX,y=cont.Tips.offsetY;style.top=(page.y+y+obj.height>win.height?page.y-obj.height-y:page.y+y)+"px",style.left=(page.x+obj.width+x>win.width?page.x-obj.width-x:page.x+x)+"px"}))})},destroyElements:function(){if(this.controller.onDestroyElement!=$empty){var cont=this.controller,that=this;this.each(function(content,isLeaf,elem1,elem2){cont.onDestroyElement(content,TreeUtil.getSubtree(that.tree,content.id),isLeaf,elem1,elem2)})}},empty:function(){this.destroyElements(),$clean($get(this.rootId))},loadTree:function(id){this.empty(),this.loadJSON(TreeUtil.getSubtree(this.tree,id))}},TM.SliceAndDice=new Class({Implements:TM,loadJSON:function(json){this.controller.onBeforeCompute(json);var container=$get(this.rootId),config=this.config,width=container.offsetWidth,height=container.offsetHeight,p={coord:{top:0,left:0,width:width,height:height+config.titleHeight+config.offset}};null==this.tree&&(this.tree=json),this.shownTree=json,this.compute(p,json,this.layout.orientation),container.innerHTML=this.plot(json),this.initializeElements(),this.controller.onAfterCompute(json)},compute:function(par,json,orientation){var config=this.config,coord=par.coord,offst=config.offset,width=coord.width-offst,height=coord.height-offst-config.titleHeight,pdata=par.data,fact=pdata&&"$area"in pdata?json.data.$area/pdata.$area:1,horizontal="h"==orientation;if(horizontal){orientation="v";var size=Math.round(width*fact),otherSize=height,dim="height",pos="top",pos2="left"}else{orientation="h";var otherSize=Math.round(height*fact),size=width,dim="width",pos="left",pos2="top"}json.coord={width:size,height:otherSize,top:0,left:0};var offsetSize=0,tm=this;$each(json.children,function(elem){tm.compute(json,elem,orientation),elem.coord[pos]=offsetSize,elem.coord[pos2]=0,offsetSize+=Math.floor(elem.coord[dim])})}}),TM.Area=new Class({loadJSON:function(json){this.controller.onBeforeCompute(json);var container=$get(this.rootId),width=container.offsetWidth,height=container.offsetHeight,offst=this.config.offset,offwdth=width-offst,offhght=height-offst-this.config.titleHeight;json.coord={height:height,width:width,top:0,left:0};var coord=$merge(json.coord,{width:offwdth,height:offhght});this.compute(json,coord),container.innerHTML=this.plot(json),null==this.tree&&(this.tree=json),this.shownTree=json,this.initializeElements(),this.controller.onAfterCompute(json)},computeDim:function(tail,initElem,w,coord,comp){if(1==tail.length+initElem.length){var l=1==tail.length?tail:initElem;return this.layoutLast(l,w,coord),void 0}if(tail.length>=2&&0==initElem.length&&(initElem=[tail[0]],tail=tail.slice(1)),0==tail.length)return initElem.length>0&&this.layoutRow(initElem,w,coord),void 0;var c=tail[0];if(comp(initElem,w)>=comp([c].concat(initElem),w))this.computeDim(tail.slice(1),initElem.concat([c]),w,coord,comp);else{var newCoords=this.layoutRow(initElem,w,coord);this.computeDim(tail,[],newCoords.dim,newCoords,comp)}},worstAspectRatio:function(ch,w){if(!ch||0==ch.length)return Number.MAX_VALUE;for(var areaSum=0,maxArea=0,minArea=Number.MAX_VALUE,i=0;i<ch.length;i++){var area=ch[i]._area;areaSum+=area,minArea=area>minArea?minArea:area,maxArea=maxArea>area?maxArea:area}var sqw=w*w,sqAreaSum=areaSum*areaSum;return Math.max(sqw*maxArea/sqAreaSum,sqAreaSum/(sqw*minArea))},avgAspectRatio:function(ch,w){if(!ch||0==ch.length)return Number.MAX_VALUE;for(var arSum=0,i=0;i<ch.length;i++){var area=ch[i]._area,h=area/w;arSum+=w>h?w/h:h/w}return arSum/ch.length},layoutLast:function(ch,w,coord){ch[0].coord=coord}}),TM.Squarified=new Class({Implements:[TM,TM.Area],compute:function(json,coord){coord.width>=coord.height&&this.layout.horizontal()||this.layout.change();var ch=json.children,config=this.config;if(ch.length>0){this.processChildrenLayout(json,ch,coord);for(var i=0;i<ch.length;i++){var chcoord=ch[i].coord,offst=config.offset,height=chcoord.height-(config.titleHeight+offst),width=chcoord.width-offst,coord={width:width,height:height,top:0,left:0};this.compute(ch[i],coord)}}},processChildrenLayout:function(par,ch,coord){for(var parentArea=coord.width*coord.height,totalChArea=0,chArea=[],i=0;i<ch.length;i++)chArea[i]=parseFloat(ch[i].data.$area),totalChArea+=chArea[i];for(var i=0;i<chArea.length;i++)ch[i]._area=parentArea*chArea[i]/totalChArea;var minimumSideValue=this.layout.horizontal()?coord.height:coord.width;ch.sort(function(a,b){return(a._area<=b._area)-(a._area>=b._area)});var initElem=[ch[0]],tail=ch.slice(1);this.squarify(tail,initElem,minimumSideValue,coord)},squarify:function(tail,initElem,w,coord){this.computeDim(tail,initElem,w,coord,this.worstAspectRatio)},layoutRow:function(ch,w,coord){return this.layout.horizontal()?this.layoutV(ch,w,coord):this.layoutH(ch,w,coord)},layoutV:function(ch,w,coord){var totalArea=0;$each(ch,function(elem){totalArea+=elem._area});for(var width=totalArea/w,top=0,i=0;i<ch.length;i++){var h=ch[i]._area/width;ch[i].coord={height:h,width:width,top:coord.top+(w-h-top),left:coord.left},top+=h}var ans={height:coord.height,width:coord.width-width,top:coord.top,left:coord.left+width};return ans.dim=Math.min(ans.width,ans.height),ans.dim!=ans.height&&this.layout.change(),ans},layoutH:function(ch,w,coord){var totalArea=0;$each(ch,function(elem){totalArea+=elem._area});for(var height=totalArea/w,top=coord.height-height,left=0,i=0;i<ch.length;i++)ch[i].coord={height:height,width:ch[i]._area/height,top:top,left:coord.left+left},left+=ch[i].coord.width;var ans={height:coord.height-height,width:coord.width,top:coord.top,left:coord.left};return ans.dim=Math.min(ans.width,ans.height),ans.dim!=ans.width&&this.layout.change(),ans}}),TM.Strip=new Class({Implements:[TM,TM.Area],compute:function(json,coord){var ch=json.children,config=this.config;if(ch.length>0){this.processChildrenLayout(json,ch,coord);for(var i=0;i<ch.length;i++){var chcoord=ch[i].coord,offst=config.offset,height=chcoord.height-(config.titleHeight+offst),width=chcoord.width-offst,coord={width:width,height:height,top:0,left:0};this.compute(ch[i],coord)}}},processChildrenLayout:function(par,ch,coord){var area=coord.width*coord.height,dataValue=parseFloat(par.data.$area);$each(ch,function(elem){elem._area=area*parseFloat(elem.data.$area)/dataValue});var side=this.layout.horizontal()?coord.width:coord.height,initElem=[ch[0]],tail=ch.slice(1);this.stripify(tail,initElem,side,coord)},stripify:function(tail,initElem,w,coord){this.computeDim(tail,initElem,w,coord,this.avgAspectRatio)},layoutRow:function(ch,w,coord){return this.layout.horizontal()?this.layoutH(ch,w,coord):this.layoutV(ch,w,coord)},layoutV:function(ch,w,coord){var totalArea=0;$each(ch,function(elem){totalArea+=elem._area});for(var width=totalArea/w,top=0,i=0;i<ch.length;i++){var h=ch[i]._area/width;ch[i].coord={height:h,width:width,top:coord.top+(w-h-top),left:coord.left},top+=h}var ans={height:coord.height,width:coord.width-width,top:coord.top,left:coord.left+width,dim:w};return ans},layoutH:function(ch,w,coord){var totalArea=0;$each(ch,function(elem){totalArea+=elem._area});for(var height=totalArea/w,top=coord.height-height,left=0,i=0;i<ch.length;i++)ch[i].coord={height:height,width:ch[i]._area/height,top:top,left:coord.left+left},left+=ch[i].coord.width;var ans={height:coord.height-height,width:coord.width,top:coord.top,left:coord.left,dim:w};return ans}})}();