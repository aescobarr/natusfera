!function($){function setupMap(options){var wrapper=$('<div id="latLonSelector"></div>');if("undefined"==typeof options.mapDiv){var mapDiv=$("<div></div>").css(options.mapCSS);$(wrapper).append(mapDiv)}else var mapDiv=options.mapDiv;$(wrapper).css(options.wrapperCSS),$(mapDiv).addClass("latLonSelectorMap"),$("body").append(wrapper);var controls=$('<div id="latLonSelectorControls"></div>');$(controls).css({"text-align":"right"});var button=$('<a id="latLonSelectorSearchButton" href="#">'+I18n.t("search")+"</a>");$(button).css(options.buttonCSS),$(button).click(function(){var input=getCurrentInput();return $.fn.latLonSelector.lookup($(input).val()),!1});var clear=$('<a href="#">'+I18n.t("clear")+"</a>").css({"margin-right":"1em"});$(clear).click(function(){var input=getCurrentInput();$.fn.latLonSelector.updateFormLatLon("",""),$(input).val("");var scaleField=findFormField(input,"map_scale");return"undefined"!=typeof scaleField&&$(scaleField).val(""),setExact(!1),getMarker().setMap(null),$.fn.latLonSelector.setAccuracy(null),$.fn.latLonSelector.updateFormAccuracy(null),!1});var close=$('<a href="#">'+options.closeText+"</a>").css(options.closeCSS);if($(close).click(function(){return $.fn.latLonSelector.hideMap(),!1}),$(controls).append(button,clear,close),$(wrapper).prepend(controls),"undefined"!=typeof options.map)var map=$.fn.latLonSelector._map=options.map;else var map=$.fn.latLonSelector._map=new google.maps.Map($(mapDiv).get(0),{zoom:1,center:new google.maps.LatLng(0,0),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1});$(document.body).mousedown(function(e){var $target=$(e.target);0!=$target.parents("#latLonSelector").length||$target.hasClass("latLonSelectorInput")||$target.hasClass("latLonSelectorButton")||$.fn.latLonSelector.hideMap()}),google.maps.event.addListener(map,"click",handleMapClick),google.maps.event.addListener(map,"zoom_changed",function(){$.fn.latLonSelector._currentInput._lastScale=map.getZoom(),$.fn.latLonSelector.updateFormScale(map.getZoom())}),"undefined"!=typeof options.marker?$.fn.latLonSelector._exactMarker=options.marker:($.fn.latLonSelector._exactMarker=new google.maps.Marker(new google.maps.LatLng(0,0)),$.fn.latLonSelector._exactMarker.setDraggable(!0)),$.fn.latLonSelector._exactMarker.setMap($.fn.latLonSelector._map);var marker=$.fn.latLonSelector._exactMarker;google.maps.event.clearListeners(marker,"dragend"),google.maps.event.addListener(marker,"dragend",function(e){$(findFormField($.fn.latLonSelector._currentInput,"positioning_method")).val("manual"),$(findFormField($.fn.latLonSelector._currentInput,"positioning_device")).val("manual"),$.fn.latLonSelector.updateFormLatLon(e.latLng.lat(),e.latLng.lng()),$.fn.latLonSelector._circle&&($.fn.latLonSelector._circle.setCenter(this.getPosition()),$.fn.latLonSelector._circle.getEditable()||($.fn.latLonSelector.setAccuracy(null),$.fn.latLonSelector.updateFormAccuracy(null)))}),google.maps.event.addListener(marker,"click",function(){return $.fn.latLonSelector.toggleEditAccuracy(),!1}),"undefined"!=typeof options.approxMarker?$.fn.latLonSelector._approxMarker=options.approxMarker:($.fn.latLonSelector._approxMarker=new google.maps.Marker(new google.maps.LatLng(0,0)),$.fn.latLonSelector._approxMarker.setDraggable(!0)),$.fn.latLonSelector._approxMarker.setMap($.fn.latLonSelector._map),$.fn.latLonSelector._approxMarker.setVisible(!1);var dataControls=$('<div id="latLonSelectorDataControls"></div>');$(dataControls).css({color:"#888",clear:"left"}),$(dataControls).append($('<input id="latLonSelectorExactFlag" type="checkbox"/>').click(function(){setExact(this.checked),getMarker({exact:this.checked})}).hide(),$('<label for="latLonSelectorExactFlag">'+I18n.t("exact_location")+"</label>").hide()),$(wrapper).append(dataControls)}function setup(input,options){if($(input).data("latLonSelectorOptions",options),$(input).addClass("latLonSelectorInput"),"undefined"!=typeof options.buttonImgPath){$(input).width($(input).width()-26),$(input).css({"margin-right":"10px","vertical-align":"middle"});var button=$('<img src="'+options.buttonImgPath+'">');$(button).addClass("latLonSelectorButton"),button.css({"vertical-align":"middle"}),$(button).insertAfter(input),$(button).click(function(){return 0==$("#latLonSelector:visible").length?$(input).get(0).focus():$.fn.latLonSelector.hideMap(input),!1})}$(input).focus(function(){return 0==$("#latLonSelector:visible").length?$.fn.latLonSelector.showMap(input):$.fn.latLonSelector._currentInput!=input&&$.fn.latLonSelector.showMap(input),!1}),$(input).keypress(function(e){if(13==e.which){try{$.fn.latLonSelector.lookup($(input).val())}catch(e){logMessage(e)}return!1}});var accuracyField=findFormField(input,"positional_accuracy");accuracyField&&$(accuracyField).change(function(){var acc=parseInt($(this).val());$.fn.latLonSelector.setAccuracy($(this).val()),acc?$.fn.latLonSelector.editAccuracy():$.fn.latLonSelector.stopEditAccuracy(),$.fn.latLonSelector.updateFormAccuracy($(this).val(),{positioningMethod:"manual",positioningDevice:"manual"})});var latitudeField=findFormField(input,"latitude"),longitudeField=findFormField(input,"longitude"),f=function(){if(""==$(latitudeField).val()||null==$(latitudeField).val()||""==$(longitudeField).val()||null==$(longitudeField).val())return getMarker().setMap(null),$.fn.latLonSelector._circle&&$.fn.latLonSelector._circle.setMap(null),void 0;var point=new google.maps.LatLng($(latitudeField).val(),$(longitudeField).val());accuracyField&&accuracyField.change(),getMarker().setPosition(point),$.fn.latLonSelector._map.setCenter(point),$.fn.latLonSelector._circle&&$.fn.latLonSelector._circle.setCenter(point)};$(latitudeField).change(f),$(longitudeField).change(f)}function findFormField(context,name,options){var options=$.extend({},options),tagName=options.tagName?options.tagName:"input",field=$(context).parent().find(tagName+'[name="'+name+'"]:first');return 0==$(field).length&&(field=$(context).parent().find(tagName+'[name*="['+name+']"]:first')),0==$(field).length&&(field=$(context).parents(".observation:first").find(tagName+'[name="'+name+'"]:first')),0==$(field).length&&(field=$(context).parents(".observation:first").find(tagName+'[name*="['+name+']"]:first')),0==$(field).length&&(field=$(context).parents("form").find(tagName+'[name="'+name+'"]:first')),0==$(field).length&&(field=$(context).parents("form").find(tagName+'[name*="['+name+']"]:first')),field}function logMessage(){if("undefined"==typeof console)return alert("Console not defined!"),alert.apply(null,arguments);try{return console.log.apply(null,arguments)}catch(e){alert.apply("An error occurred while logging an error.  This was too meta to handle so I crashed: "+e)}return!1}function handleMapClick(e){var map=$.fn.latLonSelector._map,marker=($.fn.latLonSelector._currentInput,getMarker({exact:!0})),point=e.latLng;if(marker.setPosition(point),$.fn.latLonSelector.updateFormLatLon(point.lat(),point.lng()),$(findFormField($.fn.latLonSelector._currentInput,"positioning_method")).val("manual"),$(findFormField($.fn.latLonSelector._currentInput,"positioning_device")).val("manual"),$.fn.latLonSelector._circle&&$.fn.latLonSelector._circle.setCenter(marker.getPosition()),!$.fn.latLonSelector._circle||!$.fn.latLonSelector._circle.getEditable()){var accuracy=$.fn.latLonSelector.boundsToAccuracy(map.getBounds())/10;$.fn.latLonSelector.setAccuracy(accuracy),$.fn.latLonSelector.updateFormAccuracy(accuracy)}}function getMarker(){return $.fn.latLonSelector._exactMarker.setVisible(!0),$.fn.latLonSelector._exactMarker}function getGeocoder(){return"undefined"==typeof $.fn.latLonSelector._geocoder&&($.fn.latLonSelector._geocoder=new google.maps.Geocoder),$.fn.latLonSelector._geocoder}function getCurrentInput(){return $.fn.latLonSelector._currentInput}function setExact(isExact){if("undefined"==typeof isExact)var isExact=!0;return $("#latLonSelector").find("#latLonSelectorExactFlag").get(0).checked=isExact,$.fn.latLonSelector.updateFormExact(isExact),!1}$.fn.latLonSelector=function(options){var options=$.extend({},$.fn.latLonSelector.defaults,options);$.fn.latLonSelector._options=options,0==$("#latLonSelector").length&&setupMap(options),$(this).each(function(){setup(this,options)}),"undefined"!=typeof options.mapDiv&&($.fn.latLonSelector.showMap($(this).get(0)),$.fn.latLonSelector.hideMap())},$.fn.latLonSelector.handleMapClick=function(e){handleMapClick(e)},$.fn.latLonSelector.updateFormLatLon=function(lat,lon){lat=preciseRound(lat,6),lon=preciseRound(lon,6);var input=$.fn.latLonSelector._currentInput,latField=findFormField(input,"latitude"),lonField=findFormField(input,"longitude");return $(latField).val(lat),$(lonField).val(lon),$.fn.latLonSelector.updateFormScale(),$.fn.latLonSelector.updateFormExact(),!1},$.fn.latLonSelector.updateFormScale=function(scale){var input=$.fn.latLonSelector._currentInput,scale=scale||$.fn.latLonSelector._map.getZoom(),scaleField=findFormField(input,"map_scale");$(scaleField).val(scale)},$.fn.latLonSelector.updateFormExact=function(isExact){var input=$.fn.latLonSelector._currentInput,isExact=isExact||1==$("#latLonSelector").find("#latLonSelectorExactFlag:checked").length,locExactField=findFormField(input,"location_is_exact");$(locExactField).get(0)&&($(locExactField).val(isExact),$(locExactField).get(0).checked=isExact)},$.fn.latLonSelector.updateFormAccuracy=function(accuracy,options){options=options||{},accuracy=parseInt(accuracy)||0;var input=$.fn.latLonSelector._currentInput,accuracyField=findFormField(input,"positional_accuracy"),methodField=findFormField(input,"positioning_method"),deviceField=findFormField(input,"positioning_device"),positioningMethod=options.positioningMethod||$(methodField).val(),positioningDevice=options.positioningDevice||$(deviceField).val();$(accuracyField).val(accuracy||""),$(methodField).val(positioningMethod||""),$(deviceField).val(positioningDevice||"")},$.fn.latLonSelector.showMap=function(input){var wrapper=$("#latLonSelector"),latField=findFormField(input,"latitude"),lonField=findFormField(input,"longitude"),scaleField=findFormField(input,"map_scale"),exactField=findFormField(input,"location_is_exact"),accuracyField=findFormField(input,"positional_accuracy"),mapDiv=$(".latLonSelectorMap:first");$.fn.latLonSelector._currentInput=input,$(wrapper).css({left:$(input).offset().left,top:$(input).offset().top+$(input).outerHeight()-1,width:$(input).innerWidth()}),$(wrapper).fadeIn(),"undefined"==typeof $.fn.latLonSelector._options.mapDiv&&($(mapDiv).css({width:$(input).innerWidth(),height:$(input).innerWidth()}),google.maps.event.trigger($.fn.latLonSelector._map,"resize"),$.fn.latLonSelector._map.setCenter(new google.maps.LatLng(0,0)));var isExact=$(exactField).get(0)?1==$(exactField).get(0).checked:!0,marker=getMarker({exact:isExact});setExact(isExact);var scale=parseInt($(scaleField).val());scale&&0!=scale&&(input._lastScale=input._lastScale||scale,$.fn.latLonSelector._map.setZoom(input._lastScale)),""!=$(latField).val()&&""!=$(lonField).val()?(marker.setPosition(new google.maps.LatLng($(latField).val(),$(lonField).val())),$.fn.latLonSelector._map.setCenter(marker.getPosition(),scale),accuracyField&&$(accuracyField).val()&&$.fn.latLonSelector.setAccuracy($(accuracyField).val())):marker.setVisible(!1)},$.fn.latLonSelector.hideMap=function(options){var options=$.extend({},options);options.effect&&"none"==options.effect?$("#latLonSelector").setVisible(!1):$("#latLonSelector").fadeOut()},$.fn.latLonSelector.lookup=function(q){$.fn.latLonSelector._map;var marker=getMarker({exact:!1}),parsedLatLon=$.fn.latLonSelector.parseLatLon(q),self=this;if(parsedLatLon){var point=new google.maps.LatLng(parsedLatLon[0],parsedLatLon[1]);return marker.setPosition(point),$.fn.latLonSelector._map.setCenter(point),$.fn.latLonSelector.updateFormLatLon(parsedLatLon[0],parsedLatLon[1]),setExact(!0),void 0}var geocoder=getGeocoder();geocoder.geocode({address:q},function(results,status){if(status!=google.maps.GeocoderStatus.OK)return alert("Google couldn't find '"+q+"'"),void 0;for(var result=results[0],re=new RegExp(q,"gi"),i=0;i<results.length;i++)if(results[i].formatted_address.match(re)){result=results[i];break}result.geometry.location_type==google.maps.GeocoderLocationType.ROOFTOP&&(marker=getMarker.call(self,{exact:!0}),setExact.call(self,!0));var point=result.geometry.location,viewport=result.geometry.viewport||result.geometry.bounds;if(marker.setPosition(point),$.fn.latLonSelector._map.fitBounds(viewport),$.fn.latLonSelector._map.setCenter(point),$.fn.latLonSelector.updateFormLatLon(marker.getPosition().lat(),marker.getPosition().lng()),viewport){var accuracy=$.fn.latLonSelector.boundsToAccuracy(viewport,point);$.fn.latLonSelector.setAccuracy(accuracy,{lat:point.lat(),lng:point.lng()}),$.fn.latLonSelector.updateFormAccuracy(accuracy,{positioningMethod:"google",positioningDevice:"google"})}})},$.fn.latLonSelector.boundsToAccuracy=function(bounds,point){point=point||bounds.getCenter();var dNorthEast=iNaturalist.Map.distanceInMeters(point.lat(),point.lng(),bounds.getNorthEast().lat(),bounds.getNorthEast().lng()),dSouthWest=iNaturalist.Map.distanceInMeters(point.lat(),point.lng(),bounds.getSouthWest().lat(),bounds.getSouthWest().lng());return Math.max(dNorthEast,dSouthWest)},$.fn.latLonSelector.updateAccuracyWithGeocoderResult=function(){var d=iNaturalist.Map.distanceInMeters(bounds.getCenter().lat(),bounds.getCenter().lng(),bounds.getNorthEast().lat(),bounds.getNorthEast().lng());$.fn.latLonSelector.setAccuracy(d,{lat:bounds.getCenter().lat(),lng:bounds.getCenter().lng()})},$.fn.latLonSelector.editAccuracy=function(){var options=$(getCurrentInput()).data("latLonSelectorOptions");if(!options.noAccuracy){$.fn.latLonSelector._circle||$.fn.latLonSelector.setAccuracy(null);var bounds=$.fn.latLonSelector._map.getBounds();if(bounds){var center=bounds.getCenter(),northEast=bounds.getNorthEast(),mapAcc=iNaturalist.Map.distanceInMeters(center.lat(),center.lng(),northEast.lat(),northEast.lng())/5,defaultAcc=Math.max(mapAcc,20),defaultAcc=Math.min(mapAcc,1e5),accuracyField=findFormField($.fn.latLonSelector._currentInput,"positional_accuracy"),acc=$(accuracyField).val()||defaultAcc;$.fn.latLonSelector.setAccuracy(acc),$.fn.latLonSelector.updateFormAccuracy($.fn.latLonSelector._circle.getRadius(),{positioningMethod:"manual",positioningDevice:"manual"}),$.fn.latLonSelector._circle.setOptions({editable:!0,visible:!0,fillOpacity:.35})}}},$.fn.latLonSelector.stopEditAccuracy=function(){$.fn.latLonSelector._circle&&$.fn.latLonSelector._circle.setOptions({editable:!1,fillOpacity:0})},$.fn.latLonSelector.toggleEditAccuracy=function(){$.fn.latLonSelector._circle&&$.fn.latLonSelector._circle.getEditable()?$.fn.latLonSelector.stopEditAccuracy():$.fn.latLonSelector.editAccuracy()},$.fn.latLonSelector.setAccuracy=function(accuracy,options){options=options||{};var inputOptions=$(getCurrentInput()).data("latLonSelectorOptions")||{};inputOptions.noAccuracy||($.fn.latLonSelector._circle||($.fn.latLonSelector._circle=new google.maps.Circle({strokeColor:"#882A28",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF6963",fillOpacity:0,editable:!1,map:$.fn.latLonSelector._map}),google.maps.event.addListener($.fn.latLonSelector._circle,"radius_changed",function(){this._nonManualRadiusChange||$.fn.latLonSelector.updateFormAccuracy(this.getRadius(),{positioningMethod:"manual",positioningDevice:"manual"}),this._nonManualRadiusChange=!1}),google.maps.event.addListener($.fn.latLonSelector._circle,"click",function(e){var circleBounds=this.getBounds(),mapBounds=$.fn.latLonSelector._map.getBounds();circleBounds.contains(mapBounds.getNorthEast())&&circleBounds.contains(mapBounds.getSouthWest())?handleMapClick(e):$.fn.latLonSelector.toggleEditAccuracy()})),accuracy=parseInt(accuracy),accuracy&&0!=accuracy?($.fn.latLonSelector._circle.setVisible(!0),$.fn.latLonSelector._circle._nonManualRadiusChange=!0,$.fn.latLonSelector._circle.setRadius(accuracy)):($.fn.latLonSelector._circle.setEditable(!1),$.fn.latLonSelector._circle.setVisible(!1)),$.fn.latLonSelector.currentMarker()&&$.fn.latLonSelector._circle.setCenter($.fn.latLonSelector.currentMarker().getPosition()))},$.fn.latLonSelector.zoomToAccuracy=function(){$.fn.latLonSelector._circle&&$.fn.latLonSelector._map.fitBounds($.fn.latLonSelector._circle.getBounds())},$.fn.latLonSelector.currentMarker=function(){return $.fn.latLonSelector._exactMarker.getVisible()?$.fn.latLonSelector._exactMarker:$.fn.latLonSelector._approxMarker},$.fn.latLonSelector.accuracyToZoom=function(accuracy){var dict={0:0,1:2,2:4,3:5,4:8,5:9,6:10,7:11,8:12,9:13};return dict[accuracy]},$.fn.latLonSelector.COORDINATE_REGEX=/[-+]?[0-9]*\.?[0-9]+/g,$.fn.latLonSelector.parseLatLon=function(latLon){if(latLon&&""!=latLon&&!latLon.match(/[a-cf-mo-rt-vx-z]/i)){var lat,lon,matches=latLon.match(this.COORDINATE_REGEX);switch(matches.length){case 2:lat=parseFloat(matches[0]),lon=parseFloat(matches[1]);break;case 4:lat=parseInt(matches[0])+parseFloat(matches[1])/60,lon=parseInt(matches[3])+parseFloat(matches[4])/60;case 6:lat=parseInt(matches[0])+parseInt(matches[1])/60+parseFloat(matches[2])/60/60,lon=parseInt(matches[3])+parseInt(matches[4])/60+parseFloat(matches[5])/60/60;break;default:return}return lat>0&&latLon.match(/s/i)&&(lat*=-1),lon>0&&latLon.match(/w/i)&&(lon*=-1),[lat,lon]}},$.fn.latLonSelector.defaults={buttonImgPath:"http://natusfera.gbif.es/assets/Gnome-emblem-web-16x16.png",wrapperCSS:{display:"none",position:"absolute","border-color":"#ccc","border-width":"1px","border-style":"solid","background-color":"white"},mapCSS:{width:"100%",height:"300px",overflow:"hidden",clear:"both","border-top":"1px solid #ccc","border-bottom":"1px solid #ccc"},buttonCSS:{position:"relative",top:"-1px","float":"left","font-weight":"bold","background-color":"white","border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","border-top":"1px solid white",padding:"0 0.5em"},closeCSS:{"background-color":"#ccc","font-weight":"bold","text-align":"center",padding:"2px 0.5em 3px"},closeText:"&times;"},$.fn.latLonSelector.defaults.containedWrapperCSS=$.extend({},$.fn.latLonSelector.defaults.wrapperCSS,{display:"block",position:"static"})}(jQuery);