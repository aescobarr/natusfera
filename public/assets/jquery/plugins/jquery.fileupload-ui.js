/*
 * jQuery File Upload User Interface Plugin 6.11
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
!function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],factory):factory(window.jQuery,window.tmpl,window.loadImage)}(function($,tmpl,loadImage){"use strict";$.widget("blueimp.fileupload",$.blueimp.fileupload,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:void 0,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",add:function(e,data){var that=$(this).data("fileupload"),options=that.options,files=data.files;$(this).fileupload("process",data).done(function(){that._adjustMaxNumberOfFiles(-files.length),data.maxNumberOfFilesAdjusted=!0,data.files.valid=data.isValidated=that._validate(files),data.context=that._renderUpload(files).data("data",data),options.filesContainer[options.prependFiles?"prepend":"append"](data.context),that._renderPreviews(files,data.context),that._forceReflow(data.context),that._transition(data.context).done(function(){that._trigger("added",e,data)!==!1&&(options.autoUpload||data.autoUpload)&&data.autoUpload!==!1&&data.isValidated&&data.submit()})})},send:function(e,data){var that=$(this).data("fileupload");return data.isValidated||(data.maxNumberOfFilesAdjusted||(that._adjustMaxNumberOfFiles(-data.files.length),data.maxNumberOfFilesAdjusted=!0),that._validate(data.files))?(data.context&&data.dataType&&"iframe"===data.dataType.substr(0,6)&&data.context.find(".progress").addClass(!$.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%"),that._trigger("sent",e,data)):!1},done:function(e,data){var template,that=$(this).data("fileupload");data.context?data.context.each(function(index){var file=$.isArray(data.result)&&data.result[index]||{error:"Empty file upload result"};file.error&&that._adjustMaxNumberOfFiles(1),that._transition($(this)).done(function(){var node=$(this);template=that._renderDownload([file]).replaceAll(node),that._forceReflow(template),that._transition(template).done(function(){data.context=$(this),that._trigger("completed",e,data)})})}):($.isArray(data.result)&&($.each(data.result,function(index,file){data.maxNumberOfFilesAdjusted&&file.error?that._adjustMaxNumberOfFiles(1):data.maxNumberOfFilesAdjusted||file.error||that._adjustMaxNumberOfFiles(-1)}),data.maxNumberOfFilesAdjusted=!0),template=that._renderDownload(data.result).appendTo(that.options.filesContainer),that._forceReflow(template),that._transition(template).done(function(){data.context=$(this),that._trigger("completed",e,data)}))},fail:function(e,data){var template,that=$(this).data("fileupload");data.maxNumberOfFilesAdjusted&&that._adjustMaxNumberOfFiles(data.files.length),data.context?data.context.each(function(index){if("abort"!==data.errorThrown){var file=data.files[index];file.error=file.error||data.errorThrown||!0,that._transition($(this)).done(function(){var node=$(this);template=that._renderDownload([file]).replaceAll(node),that._forceReflow(template),that._transition(template).done(function(){data.context=$(this),that._trigger("failed",e,data)})})}else that._transition($(this)).done(function(){$(this).remove(),that._trigger("failed",e,data)})}):"abort"!==data.errorThrown?(data.context=that._renderUpload(data.files).appendTo(that.options.filesContainer).data("data",data),that._forceReflow(data.context),that._transition(data.context).done(function(){data.context=$(this),that._trigger("failed",e,data)})):that._trigger("failed",e,data)},progress:function(e,data){if(data.context){var progress=parseInt(100*(data.loaded/data.total),10);data.context.find(".progress").attr("aria-valuenow",progress).find(".bar").css("width",progress+"%")}},progressall:function(e,data){var $this=$(this),progress=parseInt(100*(data.loaded/data.total),10),globalProgressNode=$this.find(".fileupload-progress"),extendedProgressNode=globalProgressNode.find(".progress-extended");extendedProgressNode.length&&extendedProgressNode.html($this.data("fileupload")._renderExtendedProgress(data)),globalProgressNode.find(".progress").attr("aria-valuenow",progress).find(".bar").css("width",progress+"%")},start:function(e){var that=$(this).data("fileupload");that._transition($(this).find(".fileupload-progress")).done(function(){that._trigger("started",e)})},stop:function(e){var that=$(this).data("fileupload");that._transition($(this).find(".fileupload-progress")).done(function(){$(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%"),$(this).find(".progress-extended").html("&nbsp;"),that._trigger("stopped",e)})},destroy:function(e,data){var that=$(this).data("fileupload");data.url&&($.ajax(data),that._adjustMaxNumberOfFiles(1)),that._transition(data.context).done(function(){$(this).remove(),that._trigger("destroyed",e,data)})}},_enableDragToDesktop:function(){var link=$(this),url=link.prop("href"),name=link.prop("download"),type="application/octet-stream";link.bind("dragstart",function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[type,name,url].join(":"))}catch(err){}})},_adjustMaxNumberOfFiles:function(operand){"number"==typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=operand,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(bytes){return"number"!=typeof bytes?"":bytes>=1e9?(bytes/1e9).toFixed(2)+" GB":bytes>=1e6?(bytes/1e6).toFixed(2)+" MB":(bytes/1e3).toFixed(2)+" KB"},_formatBitrate:function(bits){return"number"!=typeof bits?"":bits>=1e9?(bits/1e9).toFixed(2)+" Gbit/s":bits>=1e6?(bits/1e6).toFixed(2)+" Mbit/s":bits>=1e3?(bits/1e3).toFixed(2)+" kbit/s":bits+" bit/s"},_formatTime:function(seconds){var date=new Date(1e3*seconds),days=parseInt(seconds/86400,10);return days=days?days+"d ":"",days+("0"+date.getUTCHours()).slice(-2)+":"+("0"+date.getUTCMinutes()).slice(-2)+":"+("0"+date.getUTCSeconds()).slice(-2)},_formatPercentage:function(floatValue){return(100*floatValue).toFixed(2)+" %"},_renderExtendedProgress:function(data){return this._formatBitrate(data.bitrate)+" | "+this._formatTime(8*(data.total-data.loaded)/data.bitrate)+" | "+this._formatPercentage(data.loaded/data.total)+" | "+this._formatFileSize(data.loaded)+" / "+this._formatFileSize(data.total)},_hasError:function(file){return file.error?file.error:this.options.maxNumberOfFiles<0?"Maximum number of files exceeded":this.options.acceptFileTypes.test(file.type)||this.options.acceptFileTypes.test(file.name)?this.options.maxFileSize&&file.size>this.options.maxFileSize?"File is too big":"number"==typeof file.size&&file.size<this.options.minFileSize?"File is too small":null:"Filetype not allowed"},_validate:function(files){var that=this,valid=!!files.length;return $.each(files,function(index,file){file.error=that._hasError(file),file.error&&(valid=!1)}),valid},_renderTemplate:function(func,files){if(!func)return $();var result=func({files:files,formatFileSize:this._formatFileSize,options:this.options});return result instanceof $?result:$(this.options.templatesContainer).html(result).children()},_renderPreview:function(file,node){var that=this,options=this.options,dfd=$.Deferred();return(loadImage&&loadImage(file,function(img){node.append(img),that._forceReflow(node),that._transition(node).done(function(){dfd.resolveWith(node)}),$.contains(that.document[0].body,node[0])||dfd.resolveWith(node)},{maxWidth:options.previewMaxWidth,maxHeight:options.previewMaxHeight,canvas:options.previewAsCanvas})||dfd.resolveWith(node))&&dfd},_renderPreviews:function(files,nodes){var that=this,options=this.options;return nodes.find(".preview span").each(function(index,element){var file=files[index];options.previewSourceFileTypes.test(file.type)&&("number"!==$.type(options.previewSourceMaxFileSize)||file.size<options.previewSourceMaxFileSize)&&(that._processingQueue=that._processingQueue.pipe(function(){var dfd=$.Deferred();return that._renderPreview(file,$(element)).done(function(){dfd.resolveWith(that)}),dfd.promise()}))}),this._processingQueue},_renderUpload:function(files){return this._renderTemplate(this.options.uploadTemplate,files)},_renderDownload:function(files){return this._renderTemplate(this.options.downloadTemplate,files).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(e){e.preventDefault();var button=$(e.currentTarget),template=button.closest(".template-upload"),data=template.data("data");data&&data.submit&&!data.jqXHR&&data.submit()&&button.prop("disabled",!0)},_cancelHandler:function(e){e.preventDefault();var template=$(e.currentTarget).closest(".template-upload"),data=template.data("data")||{};data.jqXHR?data.jqXHR.abort():(data.errorThrown="abort",this._trigger("fail",e,data))},_deleteHandler:function(e){e.preventDefault();var button=$(e.currentTarget);this._trigger("destroy",e,$.extend({context:button.closest(".template-download"),type:"DELETE",dataType:this.options.dataType},button.data()))},_forceReflow:function(node){return $.support.transition&&node.length&&node[0].offsetWidth},_transition:function(node){var dfd=$.Deferred();return $.support.transition&&node.hasClass("fade")?node.bind($.support.transition.end,function(e){e.target===node[0]&&(node.unbind($.support.transition.end),dfd.resolveWith(node))}).toggleClass("in"):(node.toggleClass("in"),dfd.resolveWith(node)),dfd},_initButtonBarEventHandlers:function(){var fileUploadButtonBar=this.element.find(".fileupload-buttonbar"),filesList=this.options.filesContainer;this._on(fileUploadButtonBar.find(".start"),{click:function(e){e.preventDefault(),filesList.find(".start button").click()}}),this._on(fileUploadButtonBar.find(".cancel"),{click:function(e){e.preventDefault(),filesList.find(".cancel button").click()}}),this._on(fileUploadButtonBar.find(".delete"),{click:function(e){e.preventDefault(),filesList.find(".delete input:checked").siblings("button").click(),fileUploadButtonBar.find(".toggle").prop("checked",!1)}}),this._on(fileUploadButtonBar.find(".toggle"),{change:function(e){filesList.find(".delete input").prop("checked",$(e.currentTarget).is(":checked"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar button"),"click"),this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._super(),this._on(this.options.filesContainer,{"click .start button":this._startHandler,"click .cancel button":this._cancelHandler,"click .delete button":this._deleteHandler}),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers(),this._off(this.options.filesContainer,"click"),this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var options=this.options;options.templatesContainer=this.document[0].createElement(options.filesContainer.prop("nodeName")),tmpl&&(options.uploadTemplateId&&(options.uploadTemplate=tmpl(options.uploadTemplateId)),options.downloadTemplateId&&(options.downloadTemplate=tmpl(options.downloadTemplateId)))},_initFilesContainer:function(){var options=this.options;void 0===options.filesContainer?options.filesContainer=this.element.find(".files"):options.filesContainer instanceof $||(options.filesContainer=$(options.filesContainer))},_stringToRegExp:function(str){var parts=str.split("/"),modifiers=parts.pop();return parts.shift(),new RegExp(parts.join("/"),modifiers)},_initRegExpOptions:function(){var options=this.options;"string"===$.type(options.acceptFileTypes)&&(options.acceptFileTypes=this._stringToRegExp(options.acceptFileTypes)),"string"===$.type(options.previewSourceFileTypes)&&(options.previewSourceFileTypes=this._stringToRegExp(options.previewSourceFileTypes))},_initSpecialOptions:function(){this._super(),this._initFilesContainer(),this._initTemplates(),this._initRegExpOptions()},_create:function(){this._super(),this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId"),this._processingQueue||(this._processingQueue=$.Deferred().resolveWith(this).promise(),this.process=function(){return this._processingQueue})},enable:function(){var wasDisabled=!1;this.options.disabled&&(wasDisabled=!0),this._super(),wasDisabled&&(this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton())},disable:function(){this.options.disabled||(this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton()),this._super()}})});