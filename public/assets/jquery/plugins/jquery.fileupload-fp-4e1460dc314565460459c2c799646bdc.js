/*
 * jQuery File Upload File Processing Plugin 1.2.1
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2012, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
!function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","load-image","canvas-to-blob","./jquery.fileupload"],factory):factory(window.jQuery,window.loadImage)}(function($,loadImage){"use strict";$.widget("blueimp.fileupload",$.blueimp.fileupload,{options:{process:[],add:function(e,data){$(this).fileupload("process",data).done(function(){data.submit()})}},processActions:{load:function(data,options){var that=this,file=data.files[data.index],dfd=$.Deferred();return window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype.toBlob&&("number"!==$.type(options.maxFileSize)||file.size<options.maxFileSize)&&(!options.fileTypes||options.fileTypes.test(file.type))?loadImage(file,function(img){return img.src?(data.img=img,dfd.resolveWith(that,[data]),void 0):dfd.rejectWith(that,[data])}):dfd.rejectWith(that,[data]),dfd.promise()},resize:function(data,options){var canvas,img=data.img;return options=$.extend({canvas:!0},options),img&&(canvas=loadImage.scale(img,options),(canvas.width!==img.width||canvas.height!==img.height)&&(data.canvas=canvas)),data},save:function(data){if(!data.canvas)return data;var that=this,file=data.files[data.index],name=file.name,dfd=$.Deferred(),callback=function(blob){blob.name||(file.type===blob.type?blob.name=file.name:file.name&&(blob.name=file.name.replace(/\..+$/,"."+blob.type.substr(6)))),data.files[data.index]=blob,dfd.resolveWith(that,[data])};return data.canvas.mozGetAsFile?callback(data.canvas.mozGetAsFile(/^image\/(jpeg|png)$/.test(file.type)&&name||(name&&name.replace(/\..+$/,"")||"blob")+".png",file.type)):data.canvas.toBlob(callback,file.type),dfd.promise()}},_processFile:function(files,index,options){var that=this,dfd=$.Deferred().resolveWith(that,[{files:files,index:index}]),chain=dfd.promise();return that._processing+=1,$.each(options.process,function(i,settings){chain=chain.pipe(function(data){return that.processActions[settings.action].call(this,data,settings)})}),chain.always(function(){that._processing-=1,0===that._processing&&that.element.removeClass("fileupload-processing")}),1===that._processing&&that.element.addClass("fileupload-processing"),chain},process:function(data){var that=this,options=$.extend({},this.options,data);return options.process&&options.process.length&&this._isXHRUpload(options)&&$.each(data.files,function(index){that._processingQueue=that._processingQueue.pipe(function(){var dfd=$.Deferred();return that._processFile(data.files,index,options).always(function(){dfd.resolveWith(that)}),dfd.promise()})}),this._processingQueue},_create:function(){this._super(),this._processing=0,this._processingQueue=$.Deferred().resolveWith(this).promise()}})});