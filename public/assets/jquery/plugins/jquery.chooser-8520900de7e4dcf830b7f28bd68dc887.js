!function($){$.widget("ui.chooser",{options:{choiceClass:"ui-widget ui-widget-content ui-corner-left inlineblock ui-chooser-choice",inputClass:"ui-widget ui-widget-content ui-corner-left inlineblock ui-chooser-input",buttonClass:"ui-corner-right ui-chooser-button ui-button-icon inlineblock",queryParam:"term"},_create:function(){var self=this,collectionUrl=(this.options.source,this.options.collectionUrl),cache={},defaultSources=this.options.defaultSources||$.parseJSON($(this.element).attr("data-chooser-default-sources"));collectionUrl||"string"!=typeof this.options.source||(collectionUrl=this.options.collectionUrl=this.options.source),this.defaultSources=defaultSources=this.recordsToItems(defaultSources),this.options.chosen=this.options.chosen||$.parseJSON($(this.element).attr("data-chooser-chosen")),this.options.source=this.options.source||defaultSources;var markup=this.setupMarkup();if(this.selectDefault(),!this.options.collectionUrl&&0==this.options.source.length||"string"==typeof this.options.source[0]){var that=this;$(this.markup.input).blur(function(){$(that.markup.input).is(":visible")&&that.selectItem($(that.markup.input).val())})}markup.input.autocomplete({html:!0,minLength:0,select:function(ui,event){return event.item.forceRemote?(self.options.source=collectionUrl,$(ui.target).autocomplete("search",ui.target.value)):event.item.clear?($(self).data("previous",null),self.clear()):self.selectItem(event.item),!1},source:function(request,response){var source=self.options.source;if(""==request.term&&"string"==typeof source&&(source=self.options.source=self.defaultSources),"string"!=typeof source){var matcher=new RegExp($.ui.autocomplete.escapeRegex(request.term),"i"),selected=$.map(source,function(src){return src.forceRemote||matcher.test(src.label)?src:void 0});if(0!=selected.length)return collectionUrl&&""!=request.term&&selected.push({label:"<em>"+I18n.t("search_remote")+"</em>",value:request.term,forceRemote:!0}),selected.push({label:"<em>"+I18n.t("clear")+"</em>",value:request.term,clear:!0}),response(selected),void 0;response([])}return cache[request.term]?(response(cache[request.term]),void 0):(collectionUrl&&(markup.chooseButton.hide(),markup.loadingButton.showInlineBlock(),self.request&&self.request.abort(),self.request=$.getJSON(collectionUrl,self.options.queryParam+"="+request.term,function(json){markup.chooseButton.showInlineBlock(),markup.loadingButton.hide(),json=self.recordsToItems(json),json.push({label:"<em>"+I18n.t("clear")+"</em>",value:request.term,clear:!0}),cache[request.term]=json,response(json)})),void 0)}}),markup.clearButton.click(function(){self.clear()}),markup.input.bind("autocompleteclose",function(){!markup.input.is(":focus")&&$(self).data("previous")&&self.selectItem($(self).data("previous"),{blurring:!0})}),markup.input.bind("autocompleteopen",function(e){return $(e.currentTarget).is(":visible")?void 0:(markup.input.autocomplete("close"),void 0)}),markup.chooseButton.click(function(){return markup.input.autocomplete("widget").is(":visible")?(markup.input.autocomplete("close"),void 0):($(this).blur(),$(self).data("previous",$(self).data("selected")),self.clear(),markup.input.autocomplete("search",""),markup.input.focus(),void 0)}),$(markup.input).keypress(function(e){return 13==e.which?!1:void 0})},selectDefault:function(){var self=this;if(this.markup,this.options.chosen){var item=this.options.chosen;"string"!=typeof item&&(item=self.recordsToItems([item])[0]),this.selectItem(item)}else""!=$(this.element).val()&&this.options.resourceUrl&&this.selectId($(this.element).val())},selectId:function(id){var self=this,markup=this.markup;markup.chooseButton.hide(),markup.loadingButton.showInlineBlock();var resourceUrl=this.options.resourceUrl.replace(/\{\{id\}\}/,id);$.getJSON(resourceUrl,function(json){var item=self.recordsToItems([json])[0];markup.loadingButton.hide(),self.selectItem(item)})},recordsToItems:function(records){for(var items=[],records=records||[],i=0;i<records.length;i++)records[i]&&items.push($.extend(records[i],{label:records[i].label||records[i].html||records[i].title||records[i].name,value:records[i].value||records[i].title||records[i].name||records[i].id,recordId:records[i].id}));return items},selectItem:function(item,options){if(options=options||this.options||{},item){if("object"==typeof item){item.label||(item=this.recordsToItems([item])[0]);var itemLabel=item.label||item.html,itemValue=item.recordId||item.value||item.id}else var itemLabel=item,itemValue=item;$(this).data("selected",item),$(this).data("previous",null),$(this.markup.input).hide(),$(this.markup.choice).html(itemLabel).showInlineBlock(),$(this.markup.chooseButton).showInlineBlock(),$(this.markup.clearButton).height(this.markup.choice.outerHeight()-2),$(this.markup.chooseButton).height(this.markup.choice.outerHeight()-2),$(".ui-icon",this.markup.clearButton).css("margin-top","-"+Math.round(this.markup.choice.outerHeight()/2-6)+"px"),$(".ui-icon",this.markup.chooseButton).css("margin-top","-"+Math.round(this.markup.choice.outerHeight()/2-6)+"px"),$(this.markup.originalInput).val(itemValue).change()}else this.clear();options.blurring||"function"!=typeof this.options.afterSelect||this.options.afterSelect.apply(this,[item])},clear:function(clearOpts){var options=this.options||{},clearOpts=clearOpts||{},bubble=0==clearOpts.bubble?!1:!0;$(this).data("selected",null),$(this.markup.originalInput).val(""),!$(this).data("previous")&&bubble&&$(this.markup.originalInput).change(),$(this.markup.input).val("").showInlineBlock(),$(this.markup.choice).html("").hide(),$(this.markup.chooseButton).height(this.markup.input.outerHeight()),$(".ui-icon",this.markup.chooseButton).css("margin-top","-"+Math.round(this.markup.input.outerHeight()/2-6)+"px"),options.blurring||"function"!=typeof this.options.afterClear||this.options.afterClear()},setupMarkup:function(){var originalInput=this.element.hide();return this.markup={originalInput:originalInput,wrapper:$('<div class="inlineblock ui-chooser"></div>').attr("id",originalInput.attr("id")+"_chooser"),input:$('<input type="text"/>').addClass(this.options.inputClass).attr("placeholder",originalInput.attr("placeholder")),choice:$("<div></div>").addClass(this.options.choiceClass).hide(),chooseButton:$('<button type="button">&nbsp;</button>').button({icons:{primary:"ui-icon-triangle-1-s"},text:!1}).removeClass("ui-corner-all").addClass(this.options.buttonClass),clearButton:$('<button type="button">&nbsp;</button>').button({icons:{primary:"ui-icon-cancel"},text:!1}).removeClass("ui-corner-all").addClass(this.options.buttonClass).hide(),loadingButton:$('<button type="button" disabled="disabled">&nbsp;</button>').button({text:!1,disabled:!0}).removeClass("ui-corner-all").addClass(this.options.buttonClass+" ui-icon-loading").hide()},$(this.markup.originalInput).wrap(this.markup.wrapper),this.markup.originalInput.after(this.markup.input,this.markup.choice,this.markup.chooseButton,this.markup.loadingButton,this.markup.clearButton),this.markup.input.width(originalInput.width()-this.markup.chooseButton.width()-3),this.markup.choice.width(this.markup.input.width()),this.markup},destroy:function(){this.markup.input.remove(),this.markup.choice.remove(),this.markup.chooseButton.remove(),this.markup.loadingButton.remove(),this.markup.clearButton.remove(),this.element.show(),$.Widget.prototype.destroy.call(this)},getOptions:function(){return this.options},getSources:function(){return this.options.source},getItemById:function(id){for(var i=this.options.source.length-1;i>=0;i--)if(this.options.source[i].id==id)return this.options.source[i];return null},selected:function(){var selected=$(this).data("selected");return"undefined"==typeof selected?null:selected}})}(jQuery);