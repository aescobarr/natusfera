!function($){function setup(wrapper,options){$(wrapper).data("photoSelectorOptions",options),$(wrapper).addClass("photoSelector");var existing=$(wrapper).contents();options.noControls||buildControls(wrapper,options);var container=$('<div class="photoSelectorPhotos"></div>').css($.fn.photoSelector.defaults.containerCSS);container.addClass("clear"),$(wrapper).append(container),$(container).append(existing),options.queryOnLoad&&$(document).ready(function(){try{var defaultSourceData=options.sources[options.defaultSource];$.fn.photoSelector.changeBaseUrl(wrapper,defaultSourceData.url,options.defaultContext),"string"==typeof options.defaultQuery&&$.fn.photoSelector.queryPhotos(options.defaultQuery,wrapper)}catch(e){var q="";"string"==typeof options.defaultQuery&&(q=options.defaultQuery),$.fn.photoSelector.queryPhotos(q,wrapper)}})}function buildControls(wrapper,options){function updateSource(sourceOptions){$searchWrapper.hide(),$searchInput.val("");var newSource=sources[currentSource];if(sourceOptions=sourceOptions||{},sourceOptions.url=sourceOptions.url||newSource.url,sourceOptions.object_id=sourceOptions.object_id||!1,"undefined"==typeof newSource.$contextWrapper);else{var currentContextName=newSource.$contextWrapper.find("select").val();sourceOptions.context=currentContextName;for(var i=0;i<newSource.contexts.length;i++){var currentContext=newSource.contexts[i];if(newSource.contexts[i][0]==currentContextName)break}currentContext&&currentContext[currentContext.length-1].searchable?$searchWrapper.show():$searchWrapper.hide()}$.fn.photoSelector.changeBaseUrl(wrapper,sourceOptions.url,sourceOptions.context,sourceOptions.object_id)}if(options.bootstrap){var controls=$('<div class="photoSelectorControls"></div>').css($.fn.photoSelector.defaults.controlsCSS),$searchInput=$('<input type="text" placeholder="'+I18n.t("search")+'" />').css($.fn.photoSelector.defaults.formInputCSS),$searchButton=$('<a href="#" class="btn findbutton">'+I18n.t("find_photos")+"</a>").css($.fn.photoSelector.defaults.formInputCSS),$searchWrapper=$("<div class='photoSelectorSearch input-append pull-left'></div>");$searchWrapper.append($searchInput).append($searchButton);var $sourceWrapper=$('<span class="urlselect inter"><strong>'+I18n.t("source")+":</strong> </span>")}else{var controls=$('<div class="buttonrow photoSelectorControls"></div>').css($.fn.photoSelector.defaults.controlsCSS),$searchInput=$('<input type="text" class="text" placeholder="'+I18n.t("search")+'" />').css($.fn.photoSelector.defaults.formInputCSS),$searchButton=$('<a href="#" class="button findbutton">'+I18n.t("find_photos")+"</a>").css($.fn.photoSelector.defaults.formInputCSS),$searchWrapper=$("<span class='photoSelectorSearch'></span>");$searchWrapper.append($searchInput).append($searchButton);var $sourceWrapper=$('<span class="urlselect inter"><strong>'+I18n.t("source")+":</strong> </span>")}if($searchInput.attr("name","photoSelectorSearchField"),"undefined"!=typeof options.defaultQuery&&$searchInput.val(options.defaultQuery),"undefined"!=typeof options&&"undefined"!=typeof options.urls){var urlSelect=$('<select class="select" style="margin: 0 auto"></select>');urlSelect.change(function(){$.fn.photoSelector.changeBaseUrl(wrapper,urlSelect.val())});var urls=options.urls||[];options.skipLocal||urls.push({title:I18n.t("your_hard_drive"),url:"/photos/local_photo_fields"}),$.each(urls,function(){if(this.url)var title=this.title,url=this.url;else var title=this,url=this;var option=$('<option value="'+url+'">'+title+"</option>");url===options.baseURL&&$(option).attr("selected","selected"),$(urlSelect).append(option)}),$sourceWrapper.append(urlSelect)}if("undefined"!=typeof options&&"undefined"!=typeof options.sources){$searchWrapper.hide();var sources=options.sources||{},currentSource=options.defaultSource,$allContextWrappers=[];options.skipLocal||(sources.local={title:"Your computer",url:"/photos/local_photo_fields"});var $sourceSelect=$("<select class='select'></select>"),sourceIndex=0;$.each(sources,function(sourceKey,sourceData){var $sourceOption=$("<option value='"+sourceKey+"'>"+sourceData.title+"</option>");$sourceSelect.append($sourceOption);var $contextWrapper=$("<span style='display:none'></span>");if("undefined"!=typeof options.defaultSource?options.defaultSource==sourceKey&&($contextWrapper.css("display","inline-block"),$sourceOption.attr("selected","selected"),currentSource=sourceKey):0==sourceIndex&&(currentSource=sourceKey,$contextWrapper.css("display","inline-block")),sourceIndex+=1,sourceData.contexts=sourceData.contexts||[],sourceData.contexts.length>1){var $contextSelect=$("<select class='select'></select>").change(updateSource);$.each(sourceData.contexts,function(i,context){var $contextOption=$("<option value='"+context[1]+"'>"+context[0]+"</option>"),searchable=context[2]&&context[2].searchable;searchable&&$contextOption.data("searchable",!0),"undefined"!=typeof options.defaultContext&&options.defaultContext==context[1]&&($contextOption.attr("selected","selected"),searchable&&$searchWrapper.show()),$contextSelect.append($contextOption)}),$contextWrapper.append($contextSelect)}else if(1==sourceData.contexts.length){var context=sourceData.contexts[0],searchable=context[2]&&context[2].searchable;searchable&&$searchWrapper.show()}sources[sourceKey].$contextWrapper=$contextWrapper,$allContextWrappers.push($contextWrapper)}),$sourceSelect.change(function(){var sourceKey=$sourceSelect.val(),sourceData=sources[sourceKey];$.each($allContextWrappers,function(i,c){sourceData.$contextWrapper&&sourceData.$contextWrapper==c?c.show():c.hide()}),currentSource=sourceKey,updateSource()}),$sourceWrapper.append($sourceSelect),$.each($allContextWrappers,function(i,c){$sourceWrapper.append(c)})}$(".picasaAlbums .album",wrapper).live("click",function(){var aid=$(this).attr("data-aid");try{updateSource({url:"/picasa/album/"+aid,object_id:$(this).closest(".picasaAlbums").attr("data-friend_id")})}catch(e){$.fn.photoSelector.changeBaseUrl(wrapper,"/picasa/album/"+aid,"user",$(this).closest(".picasaAlbums").attr("data-friend_id"))}return!1}),$(".facebookAlbums .album",wrapper).live("click",function(){try{updateSource({url:"/facebook/album/"+$(this).attr("data-aid"),object_id:$(this).closest(".facebookAlbums").attr("data-friend_id")})}catch(e){$.fn.photoSelector.changeBaseUrl(wrapper,"/facebook/album/"+$(this).attr("data-aid"),"user",$(this).closest(".facebookAlbums").attr("data-friend_id"))}return!1}),$(".facebookGroups .group",wrapper).live("click",function(){try{updateSource({url:"/facebook/group/",object_id:$(this).attr("data-group_id")})}catch(e){$.fn.photoSelector.changeBaseUrl(wrapper,"/facebook/group/","group",$(this).attr("data-group_id"))}return!1}),$(".back_to_albums").live("click",function(){try{updateSource({object_id:$(this).attr("data-friend_id")})}catch(e){$.fn.photoSelector.changeBaseUrl(wrapper,urlSelect.val(),"user",$(this).attr("data-friend_id"))}return!1}),$(".back_to_friends").live("click",function(){try{updateSource()}catch(e){$.fn.photoSelector.changeBaseUrl(wrapper,urlSelect.val())}return!1}),$(".back_to_groups").live("click",function(){try{updateSource({object_id:$(this).attr("data-group_id")})}catch(e){$.fn.photoSelector.changeBaseUrl(wrapper,urlSelect.val(),"groups",$(this).attr("data-group_id"))}return!1}),$(".friendSelector .friend").live("click",function(){try{updateSource({object_id:$(this).attr("data-friend_id")})}catch(e){$.fn.photoSelector.changeBaseUrl(wrapper,urlSelect.val(),"user",$(this).attr("data-friend_id"))}return!1});var page=$('<input class="photoSelectorPage" type="hidden" value="1"/>');if(options.bootstrap)var prev=$('<button type="button" class="prevlink btn">&laquo; '+I18n.t("prev")+"</button>"),next=$('<button type="button" class="nextlink btn">'+I18n.t("next")+" &raquo;</button>");else var prev=$('<a href="#" class="prevlink button">&laquo; '+I18n.t("prev")+"</a>"),next=$('<a href="#" class="nextlink button">'+I18n.t("next")+" &raquo;</a>");if(prev.click(function(){var pagenum=parseInt($(wrapper).find(".photoSelectorPage").val());pagenum-=1,1>pagenum&&(pagenum=1);var prevOpts=$.extend({},$(wrapper).data("photoSelectorOptions"));return prevOpts.urlParams=$.extend({},prevOpts.urlParams,{page:pagenum}),$.fn.photoSelector.queryPhotos($searchInput.val(),wrapper,prevOpts),$(wrapper).find(".photoSelectorPage").val(pagenum),!1}),next.click(function(){var pagenum=parseInt($(wrapper).find(".photoSelectorPage").val());pagenum+=1;var nextOpts=$.extend({},$(wrapper).data("photoSelectorOptions"));return nextOpts.urlParams=$.extend({},nextOpts.urlParams,{page:pagenum}),$.fn.photoSelector.queryPhotos($searchInput.val(),wrapper,nextOpts),$(wrapper).find(".photoSelectorPage").val(pagenum),!1}),options.bootstrap)var allNoneLabel=$("<label>"+I18n.t("select")+"</label>"),selectAll=$('<button type="button" class="btn">'+I18n.t("all")+"</button>"),selectNone=$('<button type="button" class="btn">'+I18n.t("none")+"</button>");else var allNoneLabel=$('<label class="inter">'+I18n.t("select")+"</label>"),selectAll=$('<a href="#" class="inter">'+I18n.t("all")+"</a>"),selectNone=$('<a href="#" class="inter">'+I18n.t("none")+"</a>");if(selectAll.click(function(){return $(".photoSelectorPhotos input:checkbox",wrapper).not(".photoSelectorSelected input").attr("checked",!0),!1}),selectNone.click(function(){return $(".photoSelectorPhotos input:checkbox",wrapper).not(".photoSelectorSelected input").attr("checked",!1),!1}),$(controls).append($sourceWrapper),0==$sourceWrapper.find("select").length&&$sourceWrapper.hide(),options.bootstrap){var prevnext=$('<div class="btn-group pull-right"></div>');prevnext.append(prev,next);var allNone=$('<div class="allNone form-inline pull-right"></div>'),allNoneButtons=$('<div class="btn-group"></div>');allNoneLabel.addClass("checkbox"),allNoneButtons.append(selectAll,selectNone),allNone.append(allNoneLabel,allNoneButtons),$(controls).append($searchWrapper,prevnext,allNone,page)}else{var allNone=$('<span class="allNone"></span>');allNone.append(allNoneLabel,selectAll,selectNone),$(controls).append($searchWrapper,page,prev,next,allNone)}$(controls).append($("<div></div>").css({height:0,visibility:"hidden",clear:"both"})),$(wrapper).append(controls),options.baseURL&&options.baseURL.match(/local_photo/)&&0!=$sourceWrapper.find("select").length&&($(".nextlink, .prevlink, .allNone, .photoSelectorSearch",wrapper).hide(),$sourceWrapper.show()),$searchButton.click(function(){return $(wrapper).find(".photoSelectorPage").val(1),$.fn.photoSelector.queryPhotos($searchInput.val(),wrapper),!1}),$searchInput.keypress(function(e){if(13==e.which){try{$(wrapper).find(".photoSelectorPage").val(1),$.fn.photoSelector.queryPhotos($searchInput.val(),wrapper)}catch(e){alert(e)}return!1}})}$.fn.photoSelector=function(options){var options=$.extend(!0,{},$.fn.photoSelector.defaults,options);$(this).each(function(){setup(this,options)})},$.fn.photoSelector.changeBaseUrl=function(wrapper,url,context,object_id){var options=$(wrapper).data("photoSelectorOptions");options.baseURL=url,options.urlParams.context=context||"user",options.urlParams.object_id=object_id||null,$(wrapper).data("photoSelectorOptions",options),$.fn.photoSelector.queryPhotos($(wrapper).find(".photoSelectorSearchField").val(),wrapper)},$.fn.photoSelector.queryPhotos=function(q,wrapper,options){var ajax=$(wrapper).data("ajax");"undefined"!=typeof ajax&&ajax.abort();var options=$.extend({},$.fn.photoSelector.defaults,$(wrapper).data("photoSelectorOptions"),options),params=$.extend({},options.urlParams,{q:q}),baseURL=options.baseURL;params.licensed=options.licensed,$(wrapper).data("photoSelectorExisting")||$(wrapper).data("photoSelectorExisting",$(wrapper).find(".photoSelectorPhotos input:checked").parent().clone());var $photoSelectorPhotos=$(wrapper).find(".photoSelectorPhotos");return"hidden"!=$photoSelectorPhotos.data("previous-overflow-x")&&$photoSelectorPhotos.data("previous-overflow-x",$photoSelectorPhotos.css("overflow-x")),"hidden"!=$photoSelectorPhotos.data("previous-overflow-y")&&$photoSelectorPhotos.data("previous-overflow-y",$photoSelectorPhotos.css("overflow-y")),$photoSelectorPhotos.scrollTo(0,0),$photoSelectorPhotos.css("overflow","hidden"),$photoSelectorPhotos.loadingShades(I18n.t("loading"),{cssClass:"smallLoading centered",top:"20px"}),ajax=$.ajax({url:baseURL,data:$.param(params),success:function(response){$photoSelectorPhotos.html(response);var existing=$(wrapper).data("photoSelectorExisting"),existingValues=$(existing).find("input").map(function(){return $(this).val()});if($("input",$photoSelectorPhotos).each(function(){-1!=$.inArray($(this).val(),existingValues)&&$(this).parent().remove()}),existing&&existing.length>0){$photoSelectorPhotos.children().wrapAll('<div class="photoSelectorResults"></div>');var selectedPhotosWrapper=$('<div class="photoSelectorSelected"></div>'),header="<h4>"+I18n.t("selected_photos")+"</h4>";if(options.bootstrap){var row=$('<div class="row-fluid"></div>');row.append(existing),selectedPhotosWrapper.append(header,row)}else selectedPhotosWrapper.append(header,existing);$photoSelectorPhotos.prepend(selectedPhotosWrapper)}return $(wrapper).data("photoSelectorExisting",null),options.baseURL.match(/local_photo/)?($(".nextlink, .prevlink, .allNone, .photoSelectorSearch",wrapper).hide(),$(wrapper).find(".local_photos").show()):($(".nextlink, .prevlink, .allNone, .photoSelectorSearch",wrapper).show(),$(wrapper).find(".local_photos").hide()),navigator.platform.match(/^Win/)&&$.browser.webkit&&!navigator.userAgent.match(/Chrome/i)&&$("input[type=file]",wrapper).removeAttr("multiple"),$photoSelectorPhotos.shades("close"),"hidden"!=$photoSelectorPhotos.data("previous-overflow-x")&&$photoSelectorPhotos.css("overflow-x",$photoSelectorPhotos.data("previous-overflow-x")),"hidden"!=$photoSelectorPhotos.data("previous-overflow-y")&&$photoSelectorPhotos.css("overflow-y",$photoSelectorPhotos.data("previous-overflow-y")),"function"==typeof options.afterQueryPhotos&&options.afterQueryPhotos(q,wrapper,options),!0},complete:function(){"hidden"!=$photoSelectorPhotos.data("previous-overflow-x")&&$photoSelectorPhotos.css("overflow-x",$photoSelectorPhotos.data("previous-overflow-x")),"hidden"!=$photoSelectorPhotos.data("previous-overflow-y")&&$photoSelectorPhotos.css("overflow-y",$photoSelectorPhotos.data("previous-overflow-y"))}}),$(wrapper).data("ajax",ajax),!1},$.fn.photoSelector.defaults={baseURL:"/photos/local_photo_fields",queryOnLoad:!0,defaultSource:"local",formInputCSS:{"float":"left","margin-top":0},controlsCSS:{},containerCSS:{}}}(jQuery);