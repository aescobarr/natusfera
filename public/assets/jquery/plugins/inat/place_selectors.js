!function($){function setup(input,options){if($(input).addClass("latLonSelectorInput"),"undefined"!=typeof options.buttonImgPath){$(input).width($(input).width()-26),$(input).css({"margin-right":"10px","vertical-align":"middle"});var button=$('<img src="'+options.buttonImgPath+'">');$(button).addClass("latLonSelectorButton"),button.css({"vertical-align":"middle"}),$(button).insertAfter(input),$(button).click(function(e){try{0==$("#latLonSelector:visible").length?$(input).get(0).focus():$.fn.latLonSelector.hideMap()}catch(e){logMessage(e)}return!1})}$(input).focus(function(e){try{0==$("#latLonSelector:visible").length?$.fn.latLonSelector.showMap(input):$.fn.latLonSelector._currentInput!=input&&$.fn.latLonSelector.showMap(input)}catch(e){logMessage(e)}return!1}),$(input).keypress(function(e){if(13==e.which){try{$.fn.latLonSelector.lookup($(input).val())}catch(e){logMessage(e)}return!1}})}function findFormField(context,name,options){var options=$.extend({},options),tagName=options.tagName?options.tagName:"input",field=$(context).parents("form").find(tagName+'[name="'+name+'"]:first');return 0==$(field).length&&(field=$(context).parents("form").find(tagName+'[name*="['+name+']"]:first')),field}function logMessage(){if("undefined"==typeof console)return alert("Console not defined!"),alert.apply(null,arguments);try{return console.log.apply(null,arguments)}catch(e){alert.apply("An error occurred while logging an error: ",e)}return!1}function handleMapClick(overlay,point){$.fn.latLonSelector._map,$.fn.latLonSelector._currentInput;var marker=getMarker({exact:!0});marker.setLatLng(point),$.fn.latLonSelector.updateFormLatLon(point.lat(),point.lng())}function getMarker(options){var oldPoint,marker,options=$.extend({},options);return"undefined"==typeof options.exact?marker=$.fn.latLonSelector._exactMarker.isHidden()?$.fn.latLonSelector._approxMarker:$.fn.latLonSelector._exactMarker:1==options.exact?(setExact(!0),$.fn.latLonSelector._exactMarker.isHidden()&&(oldPoint=$.fn.latLonSelector._approxMarker.getPoint(),$.fn.latLonSelector._approxMarker.hide(),$.fn.latLonSelector._exactMarker.setLatLng(oldPoint)),marker=$.fn.latLonSelector._exactMarker):(setExact(!1),$.fn.latLonSelector._approxMarker.isHidden()&&(oldPoint=$.fn.latLonSelector._exactMarker.getPoint(),$.fn.latLonSelector._exactMarker.hide(),$.fn.latLonSelector._approxMarker.setLatLng(oldPoint)),marker=$.fn.latLonSelector._approxMarker),marker.show(),GEvent.clearListeners(marker,"dragend"),GEvent.addListener(marker,"dragend",function(){logMessage("DEBUG: dragend"),setExact(!0),getMarker({exact:!0}),$.fn.latLonSelector.updateFormLatLon(this.getLatLng().lat(),this.getLatLng().lng())}),marker}function getGeocoder(){return"undefined"==typeof $.fn.latLonSelector._geocoder&&($.fn.latLonSelector._geocoder=new GClientGeocoder),$.fn.latLonSelector._geocoder}function getCurrentInput(){return $.fn.latLonSelector._currentInput}function setExact(isExact){if(logMessage("DEBUG: Fired set exact.  isExact: ",isExact),"undefined"==typeof isExact){logMessage("DEBUG: isExact undefined.  Setting to true...");var isExact=!0}return $("#latLonSelector").find("#latLonSelectorExactFlag").get(0).checked=isExact,$.fn.latLonSelector.updateFormExact(isExact),!1}$.fn.latLonSelector=function(options){var options=$.extend({},$.fn.latLonSelector.defaults,options),mapDiv=$('<div id="latLonSelectorMap"></div>');$(mapDiv).text("i am a map!"),$(mapDiv).css(options.mapCSS),$("body").append(mapDiv),$(mapDiv).wrap('<div id="latLonSelector"></div>');var wrapper=$(mapDiv).parent();$(wrapper).css(options.wrapperCSS);var controls=$('<div id="latLonSelectorControls"></div>');$(controls).css({"text-align":"right"});var button=$('<a id="latLonSelectorSearchButton" href="#">Search</a>');$(button).css(options.buttonCSS),$(button).click(function(){var input=getCurrentInput();return $.fn.latLonSelector.lookup($(input).val()),!1});var clear=$('<a href="#">Clear</a>').css({"margin-right":"1em"});$(clear).click(function(){var input=getCurrentInput();return $.fn.latLonSelector.updateFormLatLon("",""),$(input).val(""),getMarker().hide(),!1});var close=$('<a href="#">'+options.closeText+"</a>").css(options.closeCSS);if($(close).click(function(){return $.fn.latLonSelector.hideMap(),!1}),$(controls).append(button,clear,close),$(wrapper).prepend(controls),"undefined"!=typeof options.map)var map=$.fn.latLonSelector._map=options.map;else{if(!GBrowserIsCompatible())throw"Google Maps doesn't work with this browser.";var map=$.fn.latLonSelector._map=new GMap2($(mapDiv).get(0));map.setCenter(new GLatLng(37.8,-122.2),13),map.addControl(new GSmallMapControl),map.addControl(new GMenuMapTypeControl)}if($(document.body).mousedown(function(e){var $target=$(e.target);0!=$target.parents("#latLonSelector").length||$target.hasClass("latLonSelectorInput")||$target.hasClass("latLonSelectorButton")||$.fn.latLonSelector.hideMap()}),GEvent.addListener(map,"click",handleMapClick),GEvent.addListener(map,"zoomend",function(oldZoom,newZoom){$.fn.latLonSelector.updateFormScale(newZoom)}),"undefined"!=typeof options.marker)$.fn.latLonSelector._exactMarker=options.marker;else{if(!GBrowserIsCompatible())throw"Google Maps doesn't work with this browser.";$.fn.latLonSelector._exactMarker=new GMarker(new GLatLng(0,0),{draggable:!0,bouncy:!0,autoPan:!0})}if($.fn.latLonSelector._map.addOverlay($.fn.latLonSelector._exactMarker),$.fn.latLonSelector._exactMarker.hide(),"undefined"!=typeof options.approxMarker)$.fn.latLonSelector._approxMarker=options.approxMarker;else{if(!GBrowserIsCompatible())throw"Google Maps doesn't work with this browser.";var circleIcon=new GIcon(G_DEFAULT_ICON,"http://maps.google.com/intl/en_us/mapfiles/circle.png");circleIcon.shadow="http://maps.google.com/intl/en_us/mapfiles/circle-shadow45.png",$.fn.latLonSelector._approxMarker=new GMarker(new GLatLng(0,0),{icon:circleIcon,draggable:!0,bouncy:!0,autoPan:!0})}$.fn.latLonSelector._map.addOverlay($.fn.latLonSelector._approxMarker),$.fn.latLonSelector._approxMarker.hide();var dataControls=$('<div id="latLonSelectorDataControls"></div>');$(dataControls).css({color:"#888"}),$(dataControls).append($('<input id="latLonSelectorExactFlag" type="checkbox"/>').click(function(){setExact(this.checked),getMarker({exact:this.checked})}),$('<label for="latLonSelectorExactFlag">Exact location</label>')),$(wrapper).append(dataControls),$(this).each(function(){setup(this,options)})},$.fn.latLonSelector.updateFormLatLon=function(lat,lon){var input=$.fn.latLonSelector._currentInput;logMessage("IM IN YR updateFormLatLon");var latField=findFormField(input,"latitude"),lonField=findFormField(input,"longitude");return $(latField).val(lat),$(lonField).val(lon),$.fn.latLonSelector.updateFormScale(),$.fn.latLonSelector.updateFormExact(),!1},$.fn.latLonSelector.updateFormScale=function(scale){var input=$.fn.latLonSelector._currentInput,scale=scale||$.fn.latLonSelector._map.getZoom(),scaleField=findFormField(input,"map_scale");$(scaleField).val(scale)},$.fn.latLonSelector.updateFormExact=function(isExact){var input=$.fn.latLonSelector._currentInput,isExact=isExact||1==$("#latLonSelector").find("#latLonSelectorExactFlag:checked").length,locExactField=findFormField(input,"location_is_exact");$(locExactField).val(isExact)},$.fn.latLonSelector.showMap=function(input){var wrapper=$("#latLonSelector"),latField=findFormField(input,"latitude"),lonField=findFormField(input,"longitude"),scaleField=findFormField(input,"map_scale"),exactField=findFormField(input,"location_is_exact"),mapDiv=$("#latLonSelectorMap");$.fn.latLonSelector._currentInput=input,$(wrapper).css({left:$(input).offset().left,top:$(input).offset().top+$(input).outerHeight()-1,width:$(input).innerWidth()}),$(mapDiv).css({width:$(input).innerWidth(),height:$(input).innerWidth()}),$(wrapper).fadeIn(),$.fn.latLonSelector._map.checkResize();var isExact="true"==$(exactField).val(),marker=getMarker({exact:isExact});setExact(isExact),logMessage("DEBUG: scaleField: ",scaleField),logMessage("DEBUG: $(scaleField).val(): ",$(scaleField).val());var scale;if(""!=$(scaleField).val())var scale=parseInt($(scaleField).val());""!=$(latField).val()&&""!=$(lonField).val()?(marker.setLatLng(new GLatLng($(latField).val(),$(lonField).val())),$.fn.latLonSelector._map.setCenter(marker.getLatLng(),scale)):marker.hide()},$.fn.latLonSelector.hideMap=function(options){var options=$.extend({},options);options.effect&&"none"==options.effect?$("#latLonSelector").hide():$("#latLonSelector").fadeOut()},$.fn.latLonSelector.lookup=function(q){$.fn.latLonSelector._map;var marker=getMarker({exact:!1}),geocoder=getGeocoder();geocoder.getLocations(q,function(response){if(602==response.Status.code&&alert("Google couldn't find '"+q+"'"),response.Placemark){var point=new GLatLng(response.Placemark[0].Point.coordinates[1],response.Placemark[0].Point.coordinates[0]),zoom=$.fn.latLonSelector.accuracyToZoom(response.Placemark[0].AddressDetails.Accuracy);marker.setLatLng(point),$.fn.latLonSelector._map.setCenter(point,zoom),$.fn.latLonSelector.updateFormLatLon(marker.getLatLng().lat(),marker.getLatLng().lng())}})},$.fn.latLonSelector.accuracyToZoom=function(accuracy){var dict={0:0,1:2,2:4,3:5,4:8,5:9,6:10,7:11,8:12,9:13};return dict[accuracy]},$.fn.latLonSelector.defaults={buttonImgPath:"http://natusfera.gbif.es/assets/silk/world.png",wrapperCSS:{display:"none",position:"absolute","border-color":"#ccc","border-width":"1px","border-style":"solid","background-color":"white"},mapCSS:{width:"100%",height:"300px",overflow:"hidden",clear:"both","border-top":"1px solid #ccc","border-bottom":"1px solid #ccc"},buttonCSS:{position:"relative",top:"-1px","float":"left","font-weight":"bold","background-color":"white","border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","border-top":"1px solid white",padding:"0 0.5em"},closeCSS:{"background-color":"#ccc","font-weight":"bold","text-align":"center",padding:"2px 0.5em 3px"},closeText:"&times;"}}(jQuery);