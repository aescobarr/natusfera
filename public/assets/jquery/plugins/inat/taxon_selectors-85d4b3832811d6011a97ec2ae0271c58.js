!function($){function setup(input,options){$(input).wrap($('<div class="simpleTaxonSelector clear"></div>'));var wrapper=$(input).parent();$(wrapper).css({position:"relative",width:options.inputWidth,"margin-bottom":$(input).css("margin-bottom")}),$(wrapper).data("simpleTaxonSelectorOptions",options);var taxon_id=getTaxonID(wrapper,options),imageURL="http://natusfera.gbif.es/assets/iconic_taxa/unknown-32px-f48dac108e14bfc26773fef3fc44330f.png";"undefined"!=typeof $(taxon_id).attr("rel")&&""!=$(taxon_id).attr("rel")&&(imageURL=$(taxon_id).attr("rel"));var image=$('<img src="'+imageURL+'" class="simpleTaxonSelectorImage"/>');$(wrapper).prepend(image);var button=$('<input type="button" class="button" />');$(button).css({margin:0,"float":"left"}).val(options.buttonText),$(button).height(options.inputHeight),$(wrapper).append(button),$(input).width(options.inputWidth-$(button).outerWidth()-57),$(input).css({"float":"left","margin-right":"5px","margin-bottom":"3px"}),$(button).click(function(){try{$.fn.simpleTaxonSelector.lookup(wrapper,options)}catch(e){}return!1}),$(input).keypress(function(e){if(13==e.which){try{$.fn.simpleTaxonSelector.lookup(wrapper,options)}catch(e){}return!1}}),$(input).blur(function(){""==$.trim($(this).val())&&$.fn.simpleTaxonSelector.unSelectTaxon(wrapper,options)});var status=$('<div class="status">'+I18n.t("species_unknown")+"</div>");$(status).css($.extend($.fn.simpleTaxonSelector.styles.statuses["default"],$.fn.simpleTaxonSelector.styles.statuses.unmatched)),$(wrapper).append(status),($(input).val()&&""!=$(input).val()||$(taxon_id).val()&&""!=$(taxon_id).val())&&(""!=$(taxon_id).val()?$(taxon_id).attr("alt")&&""!=$(taxon_id).attr("alt")?$.fn.simpleTaxonSelector.setStatus(wrapper,"matched",$(taxon_id).attr("alt")):$.fn.simpleTaxonSelector.selectTaxonFromId(wrapper,$(taxon_id).val(),options):$.fn.simpleTaxonSelector.lookup(wrapper,options))}function handleTaxa(wrapper,taxa,options){var searchEverywhereLink,searchEverywhereNotice,options=$.extend({},options),input=$(wrapper).find("input[type=text]:first"),q=$(input).attr("value"),searchExternalLink=$('<a href="#">'+I18n.t("search_external_name_providers")+" &raquo;</a>").css({"font-weight":"bold"}).click(function(){return $.fn.simpleTaxonSelector.lookup(wrapper,$.extend(options,{includeExternal:!0})),!1}),lastLookupOptions=$(wrapper).data("lastOptions")||{};if(options.placeName&&(lastLookupOptions.everywhere?(searchEverywhereLink=$('<a href="#">'+I18n.t("show_taxa_from_place",{place:options.placeName})+"</a>").click(function(){return $.fn.simpleTaxonSelector.lookup(wrapper,$.extend(options,{everywhere:!1})),!1}),searchEverywhereNotice=$("<div></div>").append(I18n.t("showing_taxa_from_everywhere")," (",searchEverywhereLink,")")):(searchEverywhereLink=$('<a href="#">'+I18n.t("show_taxa_from_everywhere")+"</a>").click(function(){return $.fn.simpleTaxonSelector.lookup(wrapper,$.extend(options,{everywhere:!0})),!1}),searchEverywhereNotice=$("<div></div>").append(I18n.t("showing_taxa_from_place",{place:options.placeName})," (",searchEverywhereLink,")"))),0==taxa.length){var status=$("<span>"+I18n.t("no_results_for")+'"'+q+'".<br/></span>');$(input).focus(),options.includeSearchExternal&&$(status).append(searchExternalLink),$.fn.simpleTaxonSelector.setStatus(wrapper,"unmatched",status)}else if(1==taxa.length&&taxa[0].taxon_names.map(function(n){return n.name.toLowerCase()}).indexOf(q.toLowerCase())>=0)$.fn.simpleTaxonSelector.selectTaxon(wrapper,taxa[0],$.extend(!0,options,{selectedName:q}));else{var message=$("<span>"+I18n.t("did_you_mean")+"</span>"),list=$('<ul class="matches"></ul>').css({"margin-bottom":"3px"});$(taxa).each(function(i,taxon){var chosenTaxonName=$.fn.simpleTaxonSelector.chosenTaxonNameFor(q,taxon);if(chosenTaxonName&&chosenTaxonName.name!=taxon.name)var t=$.fn.simpleTaxonSelector.taxonNameToS(chosenTaxonName,$.extend(!0,options,{taxon:taxon}));else var t=$.fn.simpleTaxonSelector.taxonNameToS(taxon.default_name,$.extend(!0,options,{taxon:taxon}));var link=$("<a>"+I18n.t("view")+"</a>").attr("href","/taxa/"+taxon.id).addClass("small");$(link).click(function(){return window.open($(this).attr("href"),"_blank"),!1}),$(t).append(" ",link);var li=$("<li></li>").append(t);list.append(li),$(t).click(function(){return $.fn.simpleTaxonSelector.selectTaxon(wrapper,taxon,options),!1})}),message.append(list);var links=[];links.push(searchEverywhereNotice),options.includeSearchExternal&&links.push(searchExternalLink),links.length>0&&message.append(links),$.fn.simpleTaxonSelector.setStatus(wrapper,"choice",message)}}function getTaxonID(wrapper,options){var options=$.extend({},options);if("undefined"!=typeof options.taxonIDField)return $(options.taxonIDField);var taxon_id=$(wrapper).siblings('input[name="taxon_id"]:first');return 0==$(taxon_id).length&&(taxon_id=$(wrapper).siblings('input[name*="[taxon_id]"]:first')),taxon_id}$.fn.simpleTaxonSelector=function(options){var options=$.extend({},$.fn.simpleTaxonSelector.defaults,options);"undefined"==typeof options.inputWidth&&(options.inputWidth=$(this).outerWidth()),options.inputHeight=jQuery.browser.mozilla?$(this).height():$(this).outerHeight(),options.placeName=options.placeName||("object"==typeof SITE_PLACE&&SITE_PLACE?SITE_PLACE.name:null);var instances=[];return this.each(function(){instances.push(setup(this,options))}),instances},$.fn.simpleTaxonSelector.setStatus=function(wrapper,statusType,message){var status=$(wrapper).find(".status:first");$.each($.fn.simpleTaxonSelector.styles.statuses,function(statusKey){$(status).removeClass(statusKey)}),$(status).addClass(statusType),$(status).css($.fn.simpleTaxonSelector.styles.statuses[statusType]),"undefined"!=typeof message&&($(status).empty(),$(status).append(message))},$.fn.simpleTaxonSelector.lookup=function(wrapper,options){var options=$.extend({},$(wrapper).data("simpleTaxonSelectorOptions"),options),input=$(wrapper).find("input[type=text]:first"),q=$(input).attr("value"),url="/taxa/search.json?per_page=10&q="+q;return options.includeExternal&&(url+="&include_external=1"),options.forceExternal&&(url+="&force_external=1"),options.isActive&&(url+="&is_active="+String(options.isActive)),options.everywhere&&(url+="&everywhere="+String(options.everywhere)),""==q?($.fn.simpleTaxonSelector.unSelectTaxon(wrapper,options),!1):($(wrapper).data("lastUrl",url),$(wrapper).data("lastOptions",options),$.ajax({url:url,type:"GET",dataType:"json",beforeSend:function(){$.fn.simpleTaxonSelector.setStatus(wrapper,"loading",I18n.t("loading"))},success:function(data){data.status&&$.fn.simpleTaxonSelector.setStatus(wrapper,"error",data.status),handleTaxa(wrapper,data,options)},error:function(){}}),void 0)},$.fn.simpleTaxonSelector.unSelectTaxon=function(wrapper,options){var options=$.extend({},$(wrapper).data("simpleTaxonSelectorOptions"),options),input=$(wrapper).find("input[type=text]:first"),taxon_id=getTaxonID(wrapper,options),image=$(wrapper).find(".simpleTaxonSelectorImage:first");$(taxon_id).val(""),$(input).val(""),$.fn.simpleTaxonSelector.setStatus(wrapper,"unmatched",I18n.t("species_unknown")),$(image).attr("src","http://natusfera.gbif.es/assets/iconic_taxa/unknown-32px-f48dac108e14bfc26773fef3fc44330f.png"),$(wrapper).data("taxon",null),"function"==typeof options.afterUnselect&&options.afterUnselect(wrapper,name,options)},$.fn.simpleTaxonSelector.selectTaxon=function(wrapper,taxon,options){var options=$.extend({},$(wrapper).data("simpleTaxonSelectorOptions"),options),input=$(wrapper).find("input[type=text]:first"),q=$(input).attr("value");if("function"==typeof options.beforeSelect&&0==options.beforeSelect(wrapper,taxon,options))return!1;var input=$(wrapper).find("input[type=text]:first"),taxon_id=getTaxonID(wrapper,options),chosenTaxonName=$.fn.simpleTaxonSelector.chosenTaxonNameFor(q,taxon);if($(taxon_id).val(taxon.id),"undefined"!=typeof options.selectedName?$(input).val(options.selectedName):"undefined"!=typeof chosenTaxonName?$(input).val(chosenTaxonName.name):$(input).val(taxon.name),chosenTaxonName&&chosenTaxonName.name!=taxon.name)var message=$.fn.simpleTaxonSelector.taxonNameToS(chosenTaxonName,$.extend(!0,options,{taxon:taxon}));else if(taxon.default_name)var message=$.fn.simpleTaxonSelector.taxonNameToS(taxon.default_name,$.extend(!0,options,{taxon:taxon}));else var message=$.fn.simpleTaxonSelector.taxonToS(taxon,options);$.fn.simpleTaxonSelector.setStatus(wrapper,"matched",message),"undefined"!=typeof taxon.image_url&&$(wrapper).find(".simpleTaxonSelectorImage").attr("src",taxon.image_url),$(wrapper).data("taxon",taxon),"function"==typeof options.afterSelect&&options.afterSelect(wrapper,taxon,options)},$.fn.simpleTaxonSelector.selectTaxonFromId=function(wrapper,taxonId,options){var options=$.extend({},options);$.fn.simpleTaxonSelector.setStatus(wrapper,"loading",I18n.t("loading")),jQuery.getJSON("/taxa/"+taxonId+".json",function(taxon){$.fn.simpleTaxonSelector.selectTaxon(wrapper,taxon,options)})},$.fn.simpleTaxonSelector.taxonNameToS=function(name,options){var options=$.extend({},options),taxon="undefined"==typeof name.taxon?options.taxon:name.taxon,formatted=$('<span class="taxon"></span>');taxon.iconic_taxon&&"undefined"!=typeof taxon.iconic_taxon?formatted.addClass(taxon.iconic_taxon.name):formatted.addClass("Unknown");var formattedSciName=$.fn.simpleTaxonSelector.taxonToS(taxon,$.extend(!0,options,{skipClasses:!0}));return"Scientific Names"==name.lexicon?name.is_valid?$(formatted).append(formattedSciName):($(formatted).append(I18n.t("all_taxa."+name.name.toLowerCase().replace(/ /g,"_").replace(/-/g,"_"),{defaultValue:name.name})+" (="),$(formatted).append(formattedSciName),$(formatted).append(")")):($(formatted).append(I18n.t("all_taxa."+name.name.toLowerCase().replace(/ /g,"_").replace(/-/g,"_"),{defaultValue:name.name})+" ("),$(formatted).append(formattedSciName),$(formatted).append(")")),$(formatted).get(0)},$.fn.simpleTaxonSelector.taxonToS=function(taxon,options){var options=$.extend({},options),formatted=$("<span></span>").append(taxon.name);return"species"==taxon.rank||"infraspecies"==taxon.rank||"genus"==taxon.rank?$(formatted).wrapInner("<i></i>"):"undefined"!=typeof $.string?$(formatted).prepend(I18n.t("all_taxa.rank."+$.string(taxon.rank).str.toLowerCase(),{defaultValue:$.string(taxon.rank).capitalize().str})+" "):$(formatted).prepend(taxon.rank+" "),options.skipClasses||(formatted.addClass("taxon"),taxon.iconic_taxon?formatted.addClass(taxon.iconic_taxon.name):formatted.addClass("Unknown")),options.includeID&&formatted.append(" "+taxon.id),"any"==options.isActive&&(formatted.addClass(taxon.is_active?"active":"inactive"),0==taxon.is_active&&formatted.append(" [inactive]")),$(formatted).get(0)},$.fn.simpleTaxonSelector.taxonNameMatchesLocale=function(taxonName){var lexicon=taxonName.lexicon||"";return"scientific names"==lexicon.toLowerCase()?!0:"en"==I18n.locale&&"English"==lexicon?!0:I18n.locale&&I18n.locale.match(/^es/)&&"Spanish"==lexicon?!0:!1},$.fn.simpleTaxonSelector.chosenTaxonNameFor=function(q,taxon){for(var i=taxon.taxon_names.length-1;i>=0;i--){var tn=taxon.taxon_names[i];if(tn&&q&&tn.name.toLowerCase()==q.toLowerCase()&&$.fn.simpleTaxonSelector.taxonNameMatchesLocale(tn))return tn}for(var i=taxon.taxon_names.length-1;i>=0;i--){var tn=taxon.taxon_names[i];if(tn&&q&&tn.name.toLowerCase()==q.toLowerCase()&&"Scientific Names"!=tn.lexicon)return tn}for(var i=taxon.taxon_names.length-1;i>=0;i--){var tn=taxon.taxon_names[i];if(tn&&q&&tn.is_valid&&tn.name.toLowerCase().indexOf(q.toLowerCase())>=0&&$.fn.simpleTaxonSelector.taxonNameMatchesLocale(tn))return tn}for(var i=taxon.taxon_names.length-1;i>=0;i--){var tn=taxon.taxon_names[i];if(tn&&q&&tn.name.toLowerCase().indexOf(q.toLowerCase())>=0&&$.fn.simpleTaxonSelector.taxonNameMatchesLocale(tn))return tn}return taxon.default_name},$.fn.simpleTaxonSelector.styles={},$.fn.simpleTaxonSelector.styles.statuses={},$.fn.simpleTaxonSelector.styles.statuses["default"]={padding:"0 0 0 20px",margin:0,border:0,clear:"both"},$.fn.simpleTaxonSelector.styles.statuses.matched=$.extend({},$.fn.simpleTaxonSelector.styles.statuses["default"],{color:"green",background:"transparent none",padding:0}),$.fn.simpleTaxonSelector.styles.statuses.unmatched=$.extend({},$.fn.simpleTaxonSelector.styles.statuses["default"],{color:"#888",background:"url(http://natusfera.gbif.es/assets/logo-grey-15px-799c7fb68fbd4b402a7c18896588999b.png) 0 3px no-repeat"}),$.fn.simpleTaxonSelector.styles.statuses.choice=$.extend({},$.fn.simpleTaxonSelector.styles.statuses.unmatched,{}),$.fn.simpleTaxonSelector.styles.statuses.error=$.extend({},$.fn.simpleTaxonSelector.styles.statuses["default"],{color:"DeepPink",background:"url('http://natusfera.gbif.es/assets/logo-DeepPink-15px-error-673ba7ff46a2e55d8b74cb169d5e4e2b.png') 0 3px no-repeat"}),$.fn.simpleTaxonSelector.styles.statuses.loading=$.extend({},$.fn.simpleTaxonSelector.styles.statuses["default"],{color:"#888",background:"url(http://natusfera.gbif.es/assets/spinner-small-80b95fc44c80e83e7a4d226fa06d6148.gif) 0 3px no-repeat"}),$.fn.simpleTaxonSelector.defaults={buttonText:I18n.t("lookup"),includeSearchExternal:!0}}(jQuery);