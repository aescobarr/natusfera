function incrementLoadingStatus(options){options=options||{};var status=$(".bigloading.status").text(),matches=status.match(/ (\d+) of (\d+)/),current=parseInt(matches[1]),total=matches[2],verb=options.verb||"Saving";$(".bigloading.status").text(verb+" "+(current+1)+" of "+total+"...")}function saveListedTaxon(options){var options=options||{},container=$(this).parents(".listed_taxon_row:first"),params=container.find(":input").serialize(),listedTaxonId=$(container).data("listed-taxon-id"),listId=$(container).data("list-id"),nextMethod=function(){if(options.chain){var link=container.next().has("input[type=checkbox]:checked").find(".savelink").get(0);link?(incrementLoadingStatus(),saveListedTaxon.apply(link,[options])):$("table").shades("close")}};listedTaxonId&&""!=listedTaxonId?(params+="&_method=PUT",url="/listed_taxa/"+listedTaxonId):(params+="&list_id="+listId,url="/listed_taxa"),params+="&partial=batch_edit_row",$.post(url,params,function(data){if(container.addClass("success"),container.removeClass("error"),container.find(".message").hide(),!listedTaxonId||""==listedTaxonId){$(data.html).addClass("success");var newRow=$(container).after(data.html).next();newRow.addClass("success").setupListedTaxonRow(),$(container).hasClass("selected")&&newRow.find("input[type=checkbox]").prop("checked",!0),$(container).remove(),newRow.effect("highlight",{color:"lightgreen"},1e3)}var row=newRow||container;row&&nextMethod()},"json").error(function(xhr){var json=eval("("+xhr.responseText+")");if(container.removeClass("success"),container.addClass("error"),json.full_messages)errors=json.full_messages;else{var errors="";for(var key in json.errors)errors+=key.replace(/_/," ")+" "+json.errors[key]}container.find(".message td").html(errors),container.effect("highlight",{color:"lightpink"},1e3),nextMethod()})}function deleteListedTaxon(options){var options=options||{},container=$(this).parents(".listed_taxon_row:first"),params=container.find(":input").serialize(),listedTaxonId=$(container).data("listed-taxon-id"),listId=$(container).data("list-id"),nextMethod=function(){if(options.chain){var link=container.next().has("input[type=checkbox]:checked").find(".savelink").get(0);link?(incrementLoadingStatus({verb:"Deleting"}),deleteListedTaxon.apply(link,[options])):$("table").shades("close")}};return listedTaxonId&&""!=listedTaxonId?(params+="&_method=DELETE",url="/listed_taxa/"+listedTaxonId,$.post(url,params,function(){container.hide(),nextMethod(),container.remove()},"json").error(function(xhr){var json=eval("("+xhr.responseText+")");if(container.removeClass("success"),container.addClass("error"),json.full_messages)errors=json.full_messages;else{var errors="";for(var key in json.errors)errors+=key.replace(/_/," ")+" "+json.errors[key]}container.find(".message td").html(errors),container.effect("highlight",{color:"lightpink"},1e3),nextMethod()}),void 0):(container.hide(),nextMethod(),container.remove(),void 0)}function applyOccurrenceStatus(){var val=$("th.occurrence_status select").val();$("tr").has("input[type=checkbox]:checked").find(".occurrence_status select").val(val)}function applyEstablishmentMeans(){var val=$("th.establishment_means select").val();$("tr").has("input[type=checkbox]:checked").find(".establishment_means select").val(val)}function saveSelected(){$selection=$("tr").has("input[type=checkbox]:checked");var msg="Saving 1 of "+$selection.length+"...";$("table").shades("open",{css:{"background-color":"white"},content:'<center style="margin: 100px;"><span class="loading bigloading status inlineblock">'+msg+"</span></center>"});var link=$selection.find(".savelink:first").get(0);saveListedTaxon.apply(link,[{chain:!0}])}function removeSelected(){if(confirm("Are you sure you want to remove these taxa?")){$selection=$("tr").has("input[type=checkbox]:checked");var msg="Deleting 1 of "+$selection.length+"...";$("table").shades("open",{css:{"background-color":"white"},content:'<center style="margin: 100px;"><span class="loading bigloading status inlineblock">'+msg+"</span></center>"});var link=$selection.find(".removelink:first").get(0);deleteListedTaxon.apply(link,[{chain:!0}])}}$.fn.setupListedTaxonRow=function(){$(".removelink",this).bind("ajax:beforeSend",function(){$(this).parents("tr:first").fadeOut()}).bind("ajax:complete",function(){$(this).parents("tr:first").remove()}),$("input[type=checkbox]",this).click(function(){$(this).is(":checked")?$(this).parents(".listed_taxon_row").addClass("selected"):$(this).parents(".listed_taxon_row").removeClass("selected"),$(".meta .count").html($("input[type=checkbox]:checked").length)})},$.fn.selectRows=function(checked){this.prop("checked",checked).change(),checked?this.parents(".listed_taxon_row").addClass("selected"):this.parents(".listed_taxon_row").removeClass("selected"),$(".meta .count").html(checked?this.length:0)},$(document).ready(function(){$(".listed_taxon_row").setupListedTaxonRow(),$.waypoints.settings.scrollThrottle=30,$("thead").waypoint(function(event,direction){$(this).toggleClass("sticky","down"===direction),event.stopPropagation()})});