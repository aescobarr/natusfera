/*
    Stream Reader from Gordon.JS
    Copyright (c) 2010 Tobias Schneider

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
    THE SOFTWARE.
*/
var win=self,doc=win.document,fromCharCode=String.fromCharCode,push=Array.prototype.push,min=Math.min,max=Math.max;!function(window,undefined){function buildHuffTable(bitLengths){for(var numLengths=bitLengths.length,blCount=[],maxBits=max.apply(Math,bitLengths),nextCode=[],code=0,table={},i=numLengths;i--;){var len=bitLengths[i];blCount[len]=(blCount[len]||0)+(len>0)}for(var i=1;maxBits>=i;i++){var len=i-1;undefined==blCount[len]&&(blCount[len]=0),code=code+blCount[i-1]<<1,nextCode[i]=code}for(var i=0;numLengths>i;i++){var len=bitLengths[i];len&&(table[nextCode[len]]={length:len,symbol:i},nextCode[len]++)}return table}function decodeSymbol(s,table){for(var code=0,len=0;;){code=code<<1|s.readUB(1,!0),len++;var entry=table[code];if(undefined!=entry&&entry.length==len)return entry.symbol}}window.Gordon={};var DEFLATE_CODE_LENGTH_ORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],DEFLATE_CODE_LENGHT_MAP=[[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],[0,9],[0,10],[1,11],[1,13],[1,15],[1,17],[2,19],[2,23],[2,27],[2,31],[3,35],[3,43],[3,51],[3,59],[4,67],[4,83],[4,99],[4,115],[5,131],[5,163],[5,195],[5,227],[0,258]],DEFLATE_DISTANCE_MAP=[[0,1],[0,2],[0,3],[0,4],[1,5],[1,7],[2,9],[2,13],[3,17],[3,25],[4,33],[4,49],[5,65],[5,97],[6,129],[6,193],[7,257],[7,385],[8,513],[8,769],[9,1025],[9,1537],[10,2049],[10,3073],[11,4097],[11,6145],[12,8193],[12,12289],[13,16385],[13,24577]];Gordon.Stream=function(data){var buff=[],t=this,i=t.length=data.length;t.offset=0;for(var i=0;data[i];i++)buff.push(fromCharCode(255&data.charCodeAt(i)));t._buffer=buff.join(""),t._bitBuffer=null,t._bitOffset=8},Gordon.Stream.prototype={readByteAt:function(pos){return this._buffer.charCodeAt(pos)},readNumber:function(numBytes,bigEnd){var t=this,val=0;if(bigEnd)for(;numBytes--;)val=val<<8|t.readByteAt(t.offset++);else{for(var o=t.offset,i=o+numBytes;i>o;)val=val<<8|t.readByteAt(--i);t.offset+=numBytes}return t.align(),val},readSNumber:function(numBytes,bigEnd){var val=this.readNumber(numBytes,bigEnd),numBits=8*numBytes;return val>>numBits-1&&(val-=Math.pow(2,numBits)),val},readSI8:function(){return this.readSNumber(1)},readSI16:function(bigEnd){return this.readSNumber(2,bigEnd)},readSI32:function(bigEnd){return this.readSNumber(4,bigEnd)},readUI8:function(){return this.readNumber(1)},readUI16:function(bigEnd){return this.readNumber(2,bigEnd)},readUI24:function(bigEnd){return this.readNumber(3,bigEnd)},readUI32:function(bigEnd){return this.readNumber(4,bigEnd)},readFixed:function(){return this._readFixedPoint(32,16)},_readFixedPoint:function(numBits,precision){return this.readSB(numBits)*Math.pow(2,-precision)},readFixed8:function(){return this._readFixedPoint(16,8)},readFloat:function(){return this._readFloatingPoint(8,23)},_readFloatingPoint:function(numEBits,numSBits){var numBits=1+numEBits+numSBits,numBytes=numBits/8,t=this,val=0;if(numBytes>4){for(var i=Math.ceil(numBytes/4);i--;)for(var buff=[],o=t.offset,j=o+(numBytes>=4?4:numBytes%4);j>o;)buff.push(t.readByteAt(--j)),numBytes--,t.offset++;for(var s=new Gordon.Stream(fromCharCode.apply(String,buff)),sign=s.readUB(1),expo=s.readUB(numEBits),mantis=0,i=numSBits;i--;)s.readBool()&&(mantis+=Math.pow(2,i))}else var sign=t.readUB(1),expo=t.readUB(numEBits),mantis=t.readUB(numSBits);if(sign||expo||mantis){var maxExpo=Math.pow(2,numEBits),bias=~~((maxExpo-1)/2),scale=Math.pow(2,numSBits),fract=mantis/scale;bias?val=maxExpo>bias?Math.pow(2,expo-bias)*(1+fract):fract?0/0:1/0:fract&&(val=Math.pow(2,1-bias)*fract),0/0!=val&&sign&&(val*=-1)}return val},readFloat16:function(){return this._readFloatingPoint(5,10)},readDouble:function(){return this._readFloatingPoint(11,52)},readEncodedU32:function(){for(var val=0,i=0;5>i;i++){var num=this.readByteAt(this._offset++);if(val|=(127&num)<<7*i,!(128&num))break}return val},readSB:function(numBits){var val=this.readUB(numBits);return val>>numBits-1&&(val-=Math.pow(2,numBits)),val},readUB:function(numBits,lsb){for(var t=this,val=0,i=0;numBits>i;i++)8==t._bitOffset&&(t._bitBuffer=t.readUI8(),t._bitOffset=0),lsb?val|=(t._bitBuffer&1<<t._bitOffset++?1:0)<<i:val=val<<1|(t._bitBuffer&128>>t._bitOffset++?1:0);return val},readFB:function(numBits){return this._readFixedPoint(numBits,16)},readString:function(numChars){var t=this,b=t._buffer;if(undefined!=numChars){var str=b.substr(t.offset,numChars);t.offset+=numChars}else{for(var chars=[],i=t.length-t.offset;i--;){var code=t.readByteAt(t.offset++);if(!code)break;chars.push(fromCharCode(code))}var str=chars.join("")}return str},readBool:function(numBits){return!!this.readUB(numBits||1)},seek:function(offset,absolute){var t=this;return t.offset=(absolute?0:t.offset)+offset,t.align(),t},align:function(){return this._bitBuffer=null,this._bitOffset=8,this},readLanguageCode:function(){return this.readUI8()},readRGB:function(){return{red:this.readUI8(),green:this.readUI8(),blue:this.readUI8()}},readRGBA:function(){var rgba=this.readRGB();return rgba.alpha=this.readUI8()/255,rgba},readARGB:function(){var alpha=this.readUI8()/255,rgba=this.readRGB();return rgba.alpha=alpha,rgba},readRect:function(){var t=this;return numBits=t.readUB(5),rect={left:t.readSB(numBits),right:t.readSB(numBits),top:t.readSB(numBits),bottom:t.readSB(numBits)},t.align(),rect},readMatrix:function(){var t=this,hasScale=t.readBool();if(hasScale)var numBits=t.readUB(5),scaleX=t.readFB(numBits),scaleY=t.readFB(numBits);else var scaleX=scaleY=1;var hasRotation=t.readBool();if(hasRotation)var numBits=t.readUB(5),skewX=t.readFB(numBits),skewY=t.readFB(numBits);else var skewX=skewY=0;var numBits=t.readUB(5);return matrix={scaleX:scaleX,scaleY:scaleY,skewX:skewX,skewY:skewY,moveX:t.readSB(numBits),moveY:t.readSB(numBits)},t.align(),matrix},readCxform:function(){return this._readCxf()},readCxformA:function(){return this._readCxf(!0)},_readCxf:function(withAlpha){var t=this;if(hasAddTerms=t.readBool(),hasMultTerms=t.readBool(),numBits=t.readUB(4),hasMultTerms)var multR=t.readSB(numBits)/256,multG=t.readSB(numBits)/256,multB=t.readSB(numBits)/256,multA=withAlpha?t.readSB(numBits)/256:1;else var multR=multG=multB=multA=1;if(hasAddTerms)var addR=t.readSB(numBits),addG=t.readSB(numBits),addB=t.readSB(numBits),addA=withAlpha?t.readSB(numBits)/256:0;else var addR=addG=addB=addA=0;var cxform={multR:multR,multG:multG,multB:multB,multA:multA,addR:addR,addG:addG,addB:addB,addA:addA};return t.align(),cxform},decompress:function(){var t=this,b=t._buffer,o=t.offset,data=b.substr(0,o)+t.unzip();return t.length=data.length,t.offset=o,t._buffer=data,t},unzip:function uz(raw){var t=this,buff=[],o=DEFLATE_CODE_LENGTH_ORDER,m=DEFLATE_CODE_LENGHT_MAP,d=DEFLATE_DISTANCE_MAP;t.seek(2);do{var isFinal=t.readUB(1,!0),type=t.readUB(2,!0);if(type){if(1==type){var distTable=uz.fixedDistTable,litTable=uz.fixedLitTable;if(!distTable){for(var bitLengths=[],i=0;32>i;i++)bitLengths.push(5);distTable=uz.fixedDistTable=buildHuffTable(bitLengths)}if(!litTable){for(var bitLengths=[],i=0;143>=i;i++)bitLengths.push(8);for(;255>=i;i++)bitLengths.push(9);for(;279>=i;i++)bitLengths.push(7);for(;287>=i;i++)bitLengths.push(8);litTable=uz.fixedLitTable=buildHuffTable(bitLengths)}}else{for(var numLitLengths=t.readUB(5,!0)+257,numDistLengths=t.readUB(5,!0)+1,numCodeLenghts=t.readUB(4,!0)+4,codeLengths=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=0;numCodeLenghts>i;i++)codeLengths[o[i]]=t.readUB(3,!0);for(var codeTable=buildHuffTable(codeLengths),litLengths=[],prevCodeLen=0,maxLengths=numLitLengths+numDistLengths;litLengths.length<maxLengths;){var sym=decodeSymbol(t,codeTable);switch(sym){case 16:for(var i=t.readUB(2,!0)+3;i--;)litLengths.push(prevCodeLen);break;case 17:for(var i=t.readUB(3,!0)+3;i--;)litLengths.push(0);break;case 18:for(var i=t.readUB(7,!0)+11;i--;)litLengths.push(0);break;default:15>=sym&&(litLengths.push(sym),prevCodeLen=sym)}}var distTable=buildHuffTable(litLengths.splice(numLitLengths,numDistLengths)),litTable=buildHuffTable(litLengths)}do{var sym=decodeSymbol(t,litTable);if(256>sym)buff.push(raw?sym:fromCharCode(sym));else if(sym>256)for(var lengthMap=m[sym-257],len=lengthMap[1]+t.readUB(lengthMap[0],!0),distMap=d[decodeSymbol(t,distTable)],dist=distMap[1]+t.readUB(distMap[0],!0),i=buff.length-dist;len--;)buff.push(buff[i++])}while(256!=sym)}else{t.align();var len=t.readUI16();if(t.readUI16(),raw)for(;len--;)buff.push(t.readUI8());else buff.push(t.readString(len))}}while(!isFinal);return t.seek(4),raw?buff:buff.join("")}}}(this),function(window){if(window.document&&window.Worker){var worker=null,Shapefile=function(o,callback){var t=this,o="string"==typeof o?{shp:o}:o;if(worker)var w=worker;else var path=(o.jsRoot||"")+"/assets/dragdrop/shapefile.js",w=worker=this.worker=new Worker(path);w.onmessage=function(e){t.data=e.date,callback&&callback(e.data)},w.postMessage(["Load",o]),o.dbf&&(this.dbf=new DBF(o.dbf,function(data){w.postMessage(["Add DBF Attributes",data])}))};return window.Shapefile=Shapefile,void 0}var IN_WORKER=!window.document;IN_WORKER&&(importScripts("/assets/dragdrop/stream.js"),onmessage=function(e){switch(e.data[0]){case"Load":window.shapefile=new Shapefile(e.data[1]);break;case"Add DBF Attributes":window.shapefile.addDBFDataToGeoJSON(e.data[1]),window.shapefile._postMessage()}});var SHAPE_TYPES={0:"Null Shape",1:"Point",3:"PolyLine",5:"Polygon",8:"MultiPoint",11:"PointZ",13:"PolyLineZ",15:"PolygonZ",18:"MultiPointZ",21:"PointM",23:"PolyLineM",25:"PolygonM",28:"MultiPointM",31:"MultiPatch"},Shapefile=function(o,callback){var o="string"==typeof o?{shp:o}:o;this.callback=callback,o.shp.lastModifiedDate?this.handleFile(o):this.handleUri(o)};Shapefile.prototype={constructor:Shapefile,handleUri:function(o){var xhr=new XMLHttpRequest,that=this;if(xhr.open("GET",o.shp,!1),xhr.overrideMimeType("text/plain; charset=x-user-defined"),xhr.send(),200!=xhr.status)throw"Unable to load "+o.shp+" status: "+xhr.status;this.url=o.shp,this.stream=new Gordon.Stream(xhr.responseText),this.readFileHeader(),this.readRecords(),this.formatIntoGeoJson(),o.dbf?this.dbf=IN_WORKER?null:new DBF(o.dbf,function(data){that.addDBFDataToGeoJSON(data),that._postMessage()}):this._postMessage()},handleFile:function(o){if(this.options=o,window.FileReader)var reader=new FileReader;else var reader=new FileReaderSync;reader.onload=function(that){return function(e){that.onFileLoad(e.target.result)}}(this),window.FileReader?reader.readAsBinaryString(o.shp):this.onFileLoad(reader.readAsBinaryString(o.shp))},onFileLoad:function(data){this.stream=new Gordon.Stream(data),this.readFileHeader(),this.readRecords(),this.formatIntoGeoJson(),this.options.dbf?this.dbf=IN_WORKER?null:new DBF(this.options.dbf,function(data){that.addDBFDataToGeoJSON(data),that._postMessage()}):this._postMessage()},_postMessage:function(){var data={header:this.header,records:this.records,dbf:this.dbf,geojson:this.geojson};IN_WORKER?postMessage(data):this.callback&&this.callback(data)},readFileHeader:function(){var s=this.stream,header=this.header={};if(100>s)throw"Invalid Header Length";if(header.fileCode=s.readSI32(!0),header.fileCode!=parseInt(9994))throw"Invalid File Code";s.offset+=20,header.fileLength=2*s.readSI32(!0),header.version=s.readSI32(),header.shapeType=SHAPE_TYPES[s.readSI32()],this._readBounds(header),header.rangeZ={min:s.readDouble(),max:s.readDouble()},header.rangeM={min:s.readDouble(),max:s.readDouble()}},readRecords:function(){for(var record,s=this.stream,records=this.records=[];;){if(record={},record.id=s.readSI32(!0),0==record.id)break;record.length=2*s.readSI32(!0),record.shapeType=SHAPE_TYPES[s.readSI32()],this["_read"+record.shapeType](record),records.push(record)}},_readBounds:function(object){var s=this.stream;return object.bounds={left:s.readDouble(),bottom:s.readDouble(),right:s.readDouble(),top:s.readDouble()},object},_readParts:function(record){var nparts,s=this.stream,parts=[];for(nparts=record.numParts=s.readSI32(),record.numPoints=s.readSI32();nparts--;)parts.push(s.readSI32());return record.parts=parts,record},_readPoint:function(record){var s=this.stream;return record.x=s.readDouble(),record.y=s.readDouble(),record},_readPoints:function(record){for(var s=this.stream,points=[],npoints=record.numPoints||(record.numPoints=s.readSI32());npoints--;)points.push({x:s.readDouble(),y:s.readDouble()});return record.points=points,record},_readMultiPoint:function(record){return this.stream,this._readBounds(record),this._readPoints(record),record},_readPolygon:function(record){return this.stream,this._readBounds(record),this._readParts(record),this._readPoints(record),record},_readPolyLine:function(record){return this._readPolygon(record)},formatIntoGeoJson:function(){var feature,geometry,points,fbounds,gcoords,parts,point,bounds=this.header.bounds,records=this.records,features=[],geojson={};geojson.type="FeatureCollection",geojson.bbox=[bounds.left,bounds.bottom,bounds.right,bounds.top],geojson.features=features;for(var record,r=0;record=records[r];r++){switch(feature={},fbounds=record.bounds,points=record.points,parts=record.parts,feature.type="Feature","Point"!==record.shapeType&&(feature.bbox=[fbounds.left,fbounds.bottom,fbounds.right,fbounds.top]),geometry=feature.geometry={},record.shapeType){case"Point":geometry.type="Point",geometry.coordinates=[record.x,record.y];break;case"MultiPoint":case"PolyLine":geometry.type="PolyLine"==record.shapeType?"LineString":"MultiPoint",gcoords=geometry.coordinates=[];for(var p=0;p<points.length;p++){var point=points[p];gcoords.push([point.x,point.y])}break;case"Polygon":geometry.type="Polygon",gcoords=geometry.coordinates=[];for(var pt=0;pt<parts.length;pt++){for(var point,partIndex=parts[pt],part=[],p=partIndex;p<(parts[pt+1]||points.length);p++)point=points[p],part.push([point.x,point.y]);gcoords.push(part)}}features.push(feature)}this.geojson=geojson,this._addDataAfterLoad&&this.addDBFDataToGeoJSON(this._addDataAfterLoad)},addDBFDataToGeoJSON:function(dbfData){if(!this.geojson)return this._addDataAfterLoad=dbfData;this.dbf=dbfData;for(var features=this.geojson.features,len=features.length,records=dbfData.records;len--;)features[len].properties=records[len]}},window.Shapefile=Shapefile}(self),function(window){if(window.document&&window.Worker){var worker=new Worker("/assets/dragdrop/dbf.js"),DBF=function(url,callback){var w=this._worker=worker,t=this;w.onmessage=function(e){t.data=e.data,callback&&callback(e.data)},w.postMessage(url)};return window.DBF=DBF,void 0}var IN_WORKER=!window.document;IN_WORKER&&(importScripts("stream.js"),onmessage=function(e){new DBF(e.data)});var DBASE_LEVEL={3:"dBASE Level 5",4:"dBase Level 7"},DBASE_FIELD_TYPE={N:"Number",C:"Character",L:"Logical",D:"Date",M:"Memo",F:"Floating point",B:"Binary",G:"General",P:"Picture",Y:"Currency",T:"DateTime",I:"Integer",V:"VariField",X:"Variant","@":"Timestamp",O:"Double","+":"Autoincrement",O:"Double","@":"Timestamp"},DBF=function(url,callback){url.lastModifiedDate?this.handleFile(url,callback):this.handleUri(url,callback)};DBF.prototype={constructor:DBF,handleFile:function(file,callback){if(this.callback=callback,window.FileReader)var reader=new FileReader;else var reader=new FileReaderSync;reader.onload=function(that){return function(e){that.onFileLoad(e.target.result)}}(this),window.FileReader?reader.readAsBinaryString(file):this.onFileLoad(reader.readAsBinaryString(file))},onFileLoad:function(data){this.stream=new Gordon.Stream(data),this.readFileHeader(),this.readFieldDescriptions(),this.readRecords(),this._postMessage()},handleUri:function(url,callback){var xhr=new XMLHttpRequest;if(xhr.open("GET",url,!1),xhr.overrideMimeType("text/plain; charset=x-user-defined"),xhr.send(),200!=xhr.status)throw"Unable to load "+url+" status: "+xhr.status;this.stream=new Gordon.Stream(xhr.responseText),this.callback=callback,this.readFileHeader(),this.readFieldDescriptions(),this.readRecords(),this._postMessage()},_postMessage:function(){var data={header:this.header,fields:this.fields,records:this.records};IN_WORKER?postMessage(data):this.callback&&this.callback(data)},readFileHeader:function(){var s=this.stream,header=this.header={},date=new Date;header.version=DBASE_LEVEL[s.readSI8()],date.setUTCFullYear(1900+s.readSI8()),date.setUTCMonth(s.readSI8()),date.setUTCDate(s.readSI8()),header.lastUpdated=date,header.numRecords=s.readSI32(),header.firstRecordPosition=s.readSI16(),header.recordLength=s.readSI16(),s.offset+=16,header.flags=s.readSI8(),header.codePageMark=s.readSI8(),s.offset+=2},readFieldDescriptions:function(){for(var field,s=this.stream,fields=[];13!=s.readSI8();)s.offset--,field={},field.name=s.readString(11).replace(/\u0000/g,""),field.type=DBASE_FIELD_TYPE[s.readString(1)],field.fieldDisplacement=s.readSI32(),field.fieldLength=s.readUI8(),field.decimals=s.readSI8(),field.flags=s.readSI8(),field.autoincrementNextValue=s.readSI32(),field.autoincrementStepValue=s.readSI8(),s.offset+=8,fields.push(field);this.fields=fields},readRecords:function(){for(var field,record,s=this.stream,numRecords=this.header.numRecords,recordsOffset=this.header.firstRecordPosition,recordSize=this.header.recordLength,fields=this.fields,numFields=fields.length,records=[],index=0;numRecords>index;index++){s.offset=recordsOffset+index*recordSize,record={},record._isDeleted=42==s.readSI8();for(var i=0;numFields>i;i++)field=fields[i],record[field.name]=s.readString(field.fieldLength).trim();records.push(record)}this.records=records}},window.DBF=DBF}(self);