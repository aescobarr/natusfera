var TaxonGuide={IGNORE_PARAMS:["test","utf8","size","grid","labeled","bgcolor","multiselect_colorsFilter","multiselect_colorsFilter[]","multiselect_colorchooser","multiselect_colorchooser[]","multiselect_establishmentFilter"],OVERRIDE_EXISTING:0,RESPECT_EXISTING:1,REPLACE_EXISTING:2,cleanParamString:function(s){s=decodeURIComponent(s);for(var re,i=TaxonGuide.IGNORE_PARAMS.length-1;i>=0;i--)re=new RegExp(TaxonGuide.IGNORE_PARAMS[i]+"=[^&]*&?","g"),s=s.replace(re,"");if(""==$.trim(s))return s;for(var params=s.split("&"),uniqueParams={},muiltiParams=[],i=0;i<params.length;i++){var kv=params[i].split("=");kv[0].match(/\[.*\]/)?muiltiParams.push(params[i]):uniqueParams[kv[0]]=kv[1]}return s=$.param(uniqueParams),muiltiParams.length>0&&(s+="&"+muiltiParams.join("&")),s},init:function(context,options){function replaceParams(){var href=$(this).attr("href")||$(this).serialize();href=href.match(/\?(.+)/)[1],href=TaxonGuide.cleanParamString(href);var state=href.match(/[\?\&=]/)?$.deparam.querystring(href):{};return $.bbq.pushState(state,TaxonGuide.REPLACE_EXISTING),!1}function filterParams(){var href=$(this).attr("href")||$(this).serialize();return href=TaxonGuide.cleanParamString(href),$.bbq.pushState($.deparam.querystring(href)),!1}options=options||{},window.taxa=window.taxa||{},jQuery.param.fragment.noEscape(",/[]"),$("#observedchart").parent().hide(),$("#filters select[multiple]").multiselect({header:!1,noneSelectedText:I18n.t("colors"),minWidth:130,height:"auto",selectedText:function(selected,total,elts){if(selected>2)return"<strong>"+selected+" "+I18n.t("colors")+"</strong>";for(var html="",i=0;i<elts.length;i++)html+='<span class="colorfield '+elts[i].value+'">'+I18n.t(elts[i].value)+"</span>";return html}}),$("#filters .establishmentfilter select").multiselect({header:!1,noneSelectedText:"Native/endemic/inroduced",minWidth:110,height:"auto",multiple:!1,selectedText:function(selected,total,elts){return elts[0].value?"<strong>"+elts[0].title+"</strong>":elts[0].title}}),$("#filters select, #filters input:checkbox, #filters .inter").siblings("input.button").hide(),$("#filters select, #filters input:checkbox").change(function(){$(this).parents("form:first").submit()}),$("#browsingtaxa a, #controls form.searchfilter a").click(replaceParams),$("#controls form").each(function(){$(this).hasClass("searchfilter")?$(this).submit(replaceParams):$(this).submit(filterParams)}),$("#controls form.colorfilter a").click(function(){return $.bbq.removeState("colors"),!1}),$("#controls form.establishmentfilter a").click(function(){return $.bbq.removeState("establishment_means"),!1}),$("#controls form.threatenedfilter input:checkbox").change(function(){return this.checked||$.bbq.removeState("threatened"),!1}),$(window).bind("hashchange",function(){var taxon=$.bbq.getState("taxon");$("#browsingtaxa a").removeClass("selected"),taxon?$("#browsingtaxa a.taxon_"+taxon).addClass("selected"):$("#browsingtaxa a.default_taxon").addClass("selected"),$("#controls form.searchfilter input[type=text]").val($.bbq.getState("q")),$("#controls form.colorfilter select").val($.bbq.getState("colors")),$("#controls form.establishmentfilter select").val($.bbq.getState("establishment_means")),$("#controls form.threatenedfilter input:checkbox").attr("checked","1"==$.bbq.getState("threatened")),$("#controls select:hidden").multiselect("refresh"),$.bbq.getState("colors")?$("#controls form.colorfilter .pale.button").show():$("#controls form.colorfilter .pale.button").hide(),$.bbq.getState("establishment_means")?$("#controls form.establishmentfilter .pale.button").show():$("#controls form.establishmentfilter .pale.button").hide(),$.bbq.getState("q")?$("#controls form.searchfilter .pale.button").show():$("#controls form.searchfilter .pale.button").hide(),$("#sidecol .extralabel a").querystring($.bbq.getState(),TaxonGuide.REPLACE_EXISTING)}),$(window).bind("hashchange",function(){TaxonGuide.load(context,options)}),$(".listed_taxon",context).length>0&&TaxonGuide.ajaxify(context);var cleanQueryString=TaxonGuide.cleanParamString($.param.querystring());""!=cleanQueryString&&""==$.param.fragment()?$.bbq.pushState(cleanQueryString):0==$(".listed_taxon",context).length&&$(window).trigger("hashchange")},load:function(context,options){$(context).shades("open",{css:{"background-color":"white"},content:'<center style="margin: 100px;"><span class="loading bigloading status inlineblock">'+I18n.t("loading")+"</span></center>"});var options=options||{},url=options.url||$(context).attr("data-guide-url");url||(pieces=window.location.pathname.split("/"),placeId=pieces[pieces.length-1],url=window.location.origin+"/places/guide/"+placeId);var data=$.param.fragment();0==data.length&&options.cached_guide&&(url=url.replace("guide","cached_guide")),TaxonGuide.lastRequest&&TaxonGuide.lastRequest.abort(),TaxonGuide.lastRequest=$.ajax({url:url,type:"GET",data:data,dataType:"html"}).done(function(html){$("#taxa .guide_taxa").infinitescroll("destroy"),$(context).html(html),TaxonGuide.lastRequest=null,TaxonGuide.ajaxify(context),$("#taxa .guide_taxa .pagination").length>0&&$("#taxa .guide_taxa").infinitescroll({navSelector:".pagination",nextSelector:".pagination .next_page",itemSelector:".guide_taxa .listed_taxon",bufferPx:1e3,loading:{img:"http://natusfera.gbif.es/assets/spinner-small.gif",msgText:"",finishedMsg:'<span class="meta">'+I18n.t("no_more_taxa_to_load")+"</span>"}},function(){TaxonGuide.ajaxify(context)})})},updateConfirmedChart:function(context){TaxonGuide.updateBarchart(context,"#confirmedchart","data-confirmed-listed-taxa-count",{extraLabel:I18n.t("confirmed")})},updateObservedChart:function(context){return(values=TaxonGuide.updateBarchart(context,"#observedchart","data-current-user-observed-count"))?($("#sidecol .extralabel .value").text(values.valueWidth),$("#observedchart").parent().show(),void 0):($("#observedchart").parent().hide(),void 0)},updateBarchart:function(context,selector,countAttr,options){options=options||{};var count=$(".guide_taxa",context).attr(countAttr);if(!count)return!1;var total=$(".guide_taxa",context).attr("data-listed-taxa-count")||$(selector).attr("data-original-total")||0,labelText=" "+I18n.t("of")+" "+total,valueWidth=Math.round(0==total?0:100*(count/total)),remainderWidth=100-valueWidth,valueLabel="",remainderLabel="";return options.extraLabel&&(labelText+=" "+options.extraLabel),valueWidth>10?(valueLabel+=count,50>remainderWidth&&(valueLabel+=" "+labelText)):remainderLabel+=count,remainderWidth>=50&&(remainderLabel+=labelText),""==valueLabel.replace(/\s+/,"")&&(valueLabel="&nbsp;"),""==remainderLabel.replace(/\s+/,"")&&(remainderLabel="&nbsp;"),$(".value",selector).width(100*(count/total)+"%").find(".label").html(valueLabel),$(".remainder",selector).width(100-100*(count/total)+"%").find(".label").html(remainderLabel),{count:count,total:total,valueWidth:valueWidth}},ajaxify:function(context){var jsonContainer=$(context).find("code.json"),newTaxa=$.parseJSON(jsonContainer.text());newTaxa&&(window.taxa=$.extend({},window.taxa,newTaxa)),jsonContainer.remove(),TaxonGuide.updateConfirmedChart(context),TaxonGuide.updateObservedChart(context),$("[data-tip]",context).each(autoTip),$(".pagination a",context).click(function(){var href=$(this).attr("href");return $.bbq.pushState($.deparam.querystring(href)),!1}),$(".listed_taxon",context).not(".ajaxified").each(function(){$(this).addClass("ajaxified");var matches=$(this).attr("href").match(/listed_taxa\/(\d+)/);if(matches){var listedTaxonId=matches[1];if(listedTaxonId){var dialogId="listed_taxon_dialog_"+listedTaxonId,dialog=$("#"+dialogId),taxonElt=$(this).find('.taxon[id*="taxon_"]').get(0),taxonId=taxonElt?$(taxonElt).attr("id").split("_")[1]:null,taxon=window.taxa[taxonId];0==dialog.length&&(dialog=$('<div id="'+dialogId+'"></div>').addClass("dialog"),$("body").append(dialog),dialog.hide());var title="Taxon";taxon&&(title=taxon.common_name?taxon.common_name.name+" (<i>"+taxon.name+"</i>)":"<i>"+taxon.name+"</i>"),"undefined"!=typeof PLACE&&PLACE&&(title+=" in "+PLACE.display_name),$("#taxa").not(".fluid").find(".taxonimage img",this).not(".iconic").not(".centeredInContainer").waypoint(function(){$(this).centerInContainer({container:".taxonimage:first"})},{offset:"100%",triggerOnce:!0}),$(dialog).dialog({autoOpen:!1,width:"90%",title:title,open:function(){$(document.body).shades()},close:function(){$(document.body).shades("close")}}),$(this).click(function(){var dialog=$("#"+dialogId);return $(dialog).dialog("open"),""==$(dialog).html()&&($(dialog).append($('<span class="loading status">'+I18n.t("loading")+"</span>")),$(dialog).load($(this).attr("href")+"?partial=guide",function(){var dialog=$("#"+dialogId);$(dialog).centerDialog(),$(".map",this).taxonMap(),$(".side .photos a",this).has("img").click(function(){return $(this).parents(".listed_taxon_guide").find(".tabs").tabs("select",1),$(this).parents(".dialog:first").scrollTo('.tabs a[href="'+$(this).attr("href")+'"] img'),!1}),$(".desc",this).width()<$(".side",this).width()&&($(".listed_taxon_guide",this).addClass("compact"),google.maps.event.trigger($(".map",this).data("taxonMap"),"resize")),$(".comments",this).hide(),$(".tabs",this).tabs({ajaxOptions:{data:"partial=cached_component"},load:function(event,ui){""==$(ui.panel).text()?$(ui.panel).append($("<span>"+I18n.t("no_observations_from_this_place_yet")+"</span>").addClass("noresults meta")):$(ui.panel).append($('<a rel="nofollow">'+I18n.t("view_more")+"</a>").addClass("readmore").attr("href",$(ui.tab).attr("href")))}})})),!1})}}})}};