// Copyright 2006 Mikel Maron (email: mikel_maron yahoo com)
function GeoRssOverlay(rssurl,icon,proxyurl,options){this.rssurl=rssurl,this.icon=icon,this.proxyurl=proxyurl,this.visible=void 0==options.visible?!0:options.visible,this.listDiv=options.listDiv,this.contentDiv=options.contentDiv,this.listItemClass=options.listItemClass,this.limitItems=options.limit,this.request=!1,this.markers=[]}GeoRssOverlay.prototype=new GOverlay,GeoRssOverlay.prototype.initialize=function(map){this.map=map,this.load()},GeoRssOverlay.prototype.redraw=function(){},GeoRssOverlay.prototype.remove=function(){for(var i=0,len=this.markers.length;len>i;i++)this.map.removeOverlay(this.markers[i])},GeoRssOverlay.prototype.showHide=function(){if(this.visible){for(var i=0;i<this.markers.length;i++)this.map.removeOverlay(this.markers[i]);this.visible=!1}else{for(var i=0;i<this.markers.length;i++)this.map.addOverlay(this.markers[i]);this.visible=!0}},GeoRssOverlay.prototype.showMarker=function(id){var marker=this.markers[id];void 0!=marker&&GEvent.trigger(marker,"click")},GeoRssOverlay.prototype.copy=function(){var oCopy=new GeoRssOVerlay(this.rssurl,this.icon,this.proxyurl);oCopy.markers=[];for(var i=0,len=this.markers.length;len>i;i++)oCopy.markers.push(this.markers[i].copy());return oCopy},GeoRssOverlay.prototype.load=function(){if(0==this.request){this.request=GXmlHttp.create(),void 0!=this.proxyurl?this.request.open("GET",this.proxyurl+"?q="+encodeURIComponent(this.rssurl),!0):this.request.open("GET",this.rssurl,!0);var m=this;this.request.onreadystatechange=function(){m.callback()},this.request.send(null)}},GeoRssOverlay.prototype.callback=function(){if(4==this.request.readyState){if("200"==this.request.status){var xmlDoc=this.request.responseXML;if(0!=xmlDoc.documentElement.getElementsByTagName("item").length)var items=xmlDoc.documentElement.getElementsByTagName("item");else if(0!=xmlDoc.documentElement.getElementsByTagName("entry").length)var items=xmlDoc.documentElement.getElementsByTagName("entry");for(var i=0,len=this.limitItems?Math.min(this.limitItems,items.length):items.length;len>i;i++)try{var marker=this.createMarker(items[i],i);this.markers.push(marker),this.visible&&this.map.addOverlay(marker)}catch(e){}}this.request=!1}},GeoRssOverlay.prototype.createMarker=function(item,index){var title=item.getElementsByTagName("title")[0].childNodes[0].nodeValue;if(0!=item.getElementsByTagName("description").length)var description=item.getElementsByTagName("description")[0].childNodes[0].nodeValue,link=item.getElementsByTagName("link")[0].childNodes[0].nodeValue;else if(0!=item.getElementsByTagName("summary").length)var description=item.getElementsByTagName("summary")[0].childNodes[0].nodeValue,link=item.getElementsByTagName("link")[0].attributes[0].nodeValue;if(navigator.userAgent.toLowerCase().indexOf("msie")<0){if(0!=item.getElementsByTagNameNS("http://www.w3.org/2003/01/geo/wgs84_pos#","lat").length)var lat=item.getElementsByTagNameNS("http://www.w3.org/2003/01/geo/wgs84_pos#","lat")[0].childNodes[0].nodeValue,lng=item.getElementsByTagNameNS("http://www.w3.org/2003/01/geo/wgs84_pos#","long")[0].childNodes[0].nodeValue;else if(0!=item.getElementsByTagNameNS("http://www.georss.org/georss","point").length)var latlng=item.getElementsByTagNameNS("http://www.georss.org/georss","point")[0].childNodes[0].nodeValue.split(" "),lat=latlng[0],lng=latlng[1]}else if(0!=item.getElementsByTagName("geo:lat").length)var lat=item.getElementsByTagName("geo:lat")[0].childNodes[0].nodeValue,lng=item.getElementsByTagName("geo:long")[0].childNodes[0].nodeValue;else if(0!=item.getElementsByTagName("georss:point").length)var latlng=item.getElementsByTagName("georss:point")[0].childNodes[0].nodeValue.split(" "),lat=latlng[0],lng=latlng[1];var point=new GLatLng(parseFloat(lat),parseFloat(lng)),marker=new GMarker(point,{title:title}),html='<a href="'+link+'">'+title+"</a><p/>"+description;if(void 0==this.contentDiv)GEvent.addListener(marker,"click",function(){marker.openInfoWindowHtml(html)});else{var contentDiv=this.contentDiv;GEvent.addListener(marker,"click",function(){document.getElementById(contentDiv).innerHTML=html})}if(void 0!=this.listDiv){var a=document.createElement("a");a.innerHTML=title,a.setAttribute("href","#");var georss=this;a.onclick=function(){return georss.showMarker(index),!1};var div=document.createElement("div");void 0!=this.listItemClass&&div.setAttribute("class",this.listItemClass),div.appendChild(a),document.getElementById(this.listDiv).appendChild(div)}return marker};