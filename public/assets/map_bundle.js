!function(name,context,definition){"undefined"!=typeof module?module.exports=definition(name,context):"function"==typeof define&&"object"==typeof define.amd?define(definition):context[name]=definition(name,context)}("bean",this,function(name,context){var win=window,old=context[name],overOut=/over|out/,namespaceRegex=/[^\.]*(?=\..*)\.|.*/,nameRegex=/\..*/,addEvent="addEventListener",attachEvent="attachEvent",removeEvent="removeEventListener",detachEvent="detachEvent",doc=document||{},root=doc.documentElement||{},W3C_MODEL=root[addEvent],eventSupport=W3C_MODEL?addEvent:attachEvent,slice=Array.prototype.slice,mouseTypeRegex=/click|mouse(?!(.*wheel|scroll))|menu|drag|drop/i,mouseWheelTypeRegex=/mouse.*(wheel|scroll)/i,textTypeRegex=/^text/i,touchTypeRegex=/^touch|^gesture/i,ONE={one:1},nativeEvents=function(hash,events,i){for(i=0;i<events.length;i++)hash[events[i]]=1;return hash}({},("click dblclick mouseup mousedown contextmenu mousewheel mousemultiwheel DOMMouseScroll mouseover mouseout mousemove selectstart selectend keydown keypress keyup orientationchange focus blur change reset select submit load unload beforeunload resize move DOMContentLoaded readystatechange error abort scroll "+(W3C_MODEL?"show input invalid touchstart touchmove touchend touchcancel gesturestart gesturechange gestureend message readystatechange pageshow pagehide popstate hashchange offline online afterprint beforeprint dragstart dragenter dragover dragleave drag drop dragend loadstart progress suspend emptied stalled loadmetadata loadeddata canplay canplaythrough playing waiting seeking seeked ended durationchange timeupdate play pause ratechange volumechange cuechange checking noupdate downloading cached updateready obsolete ":"")).split(" ")),customEvents=function(){function isDescendant(parent,node){for(;null!==(node=node.parentNode);)if(node===parent)return!0;return!1}function check(event){var related=event.relatedTarget;return related?related!==this&&"xul"!==related.prefix&&!/document/.test(this.toString())&&!isDescendant(this,related):null===related}return{mouseenter:{base:"mouseover",condition:check},mouseleave:{base:"mouseout",condition:check},mousewheel:{base:/Firefox/.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel"}}}(),fixEvent=function(){var commonProps="altKey attrChange attrName bubbles cancelable ctrlKey currentTarget detail eventPhase getModifierState isTrusted metaKey relatedNode relatedTarget shiftKey srcElement target timeStamp type view which".split(" "),mouseProps=commonProps.concat("button buttons clientX clientY dataTransfer fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" ")),mouseWheelProps=mouseProps.concat("wheelDelta wheelDeltaX wheelDeltaY wheelDeltaZ axis".split(" ")),keyProps=commonProps.concat("char charCode key keyCode keyIdentifier keyLocation".split(" ")),textProps=commonProps.concat(["data"]),touchProps=commonProps.concat("touches targetTouches changedTouches scale rotation".split(" ")),preventDefault="preventDefault",createPreventDefault=function(event){return function(){event[preventDefault]?event[preventDefault]():event.returnValue=!1}},stopPropagation="stopPropagation",createStopPropagation=function(event){return function(){event[stopPropagation]?event[stopPropagation]():event.cancelBubble=!0}},createStop=function(synEvent){return function(){synEvent[preventDefault](),synEvent[stopPropagation](),synEvent.stopped=!0}},copyProps=function(event,result,props){var i,p;for(i=props.length;i--;)p=props[i],!(p in result)&&p in event&&(result[p]=event[p])};return function(event,isNative){var result={originalEvent:event,isNative:isNative};if(!event)return result;var props,type=event.type,target=event.target||event.srcElement;return result[preventDefault]=createPreventDefault(event),result[stopPropagation]=createStopPropagation(event),result.stop=createStop(result),result.target=target&&3===target.nodeType?target.parentNode:target,isNative&&(-1!==type.indexOf("key")?(props=keyProps,result.keyCode=event.which||event.keyCode):mouseTypeRegex.test(type)?(props=mouseProps,result.rightClick=3===event.which||2===event.button,result.pos={x:0,y:0},event.pageX||event.pageY?(result.clientX=event.pageX,result.clientY=event.pageY):(event.clientX||event.clientY)&&(result.clientX=event.clientX+doc.body.scrollLeft+root.scrollLeft,result.clientY=event.clientY+doc.body.scrollTop+root.scrollTop),overOut.test(type)&&(result.relatedTarget=event.relatedTarget||event[("mouseover"===type?"from":"to")+"Element"])):touchTypeRegex.test(type)?props=touchProps:mouseWheelTypeRegex.test(type)?props=mouseWheelProps:textTypeRegex.test(type)&&(props=textProps),copyProps(event,result,props||commonProps)),result}}(),targetElement=function(element,isNative){return W3C_MODEL||isNative||element!==doc&&element!==win?element:root},RegEntry=function(){function entry(element,type,handler,original,namespaces){this.element=element,this.type=type,this.handler=handler,this.original=original,this.namespaces=namespaces,this.custom=customEvents[type],this.isNative=nativeEvents[type]&&element[eventSupport],this.eventType=W3C_MODEL||this.isNative?type:"propertychange",this.customType=!W3C_MODEL&&!this.isNative&&type,this.target=targetElement(element,this.isNative),this.eventSupport=this.target[eventSupport]}return entry.prototype={inNamespaces:function(checkNamespaces){var i,j;if(!checkNamespaces)return!0;if(!this.namespaces)return!1;for(i=checkNamespaces.length;i--;)for(j=this.namespaces.length;j--;)if(checkNamespaces[i]===this.namespaces[j])return!0;return!1},matches:function(checkElement,checkOriginal,checkHandler){return!(this.element!==checkElement||checkOriginal&&this.original!==checkOriginal||checkHandler&&this.handler!==checkHandler)}},entry}(),registry=function(){var map={},forAll=function(element,type,original,handler,fn){if(type&&"*"!==type){var l,i=0,list=map["$"+type],all="*"===element;if(!list)return;for(l=list.length;l>i;i++)if((all||list[i].matches(element,original,handler))&&!fn(list[i],list,i,type))return}else for(var t in map)"$"===t.charAt(0)&&forAll(element,t.substr(1),original,handler,fn)},has=function(element,type,original){var i,list=map["$"+type];if(list)for(i=list.length;i--;)if(list[i].matches(element,original,null))return!0;return!1},get=function(element,type,original){var entries=[];return forAll(element,type,original,null,function(entry){return entries.push(entry)}),entries},put=function(entry){return(map["$"+entry.type]||(map["$"+entry.type]=[])).push(entry),entry},del=function(entry){forAll(entry.element,entry.type,null,entry.handler,function(entry,list,i){return list.splice(i,1),0===list.length&&delete map["$"+entry.type],!1})},entries=function(){var t,entries=[];for(t in map)"$"===t.charAt(0)&&(entries=entries.concat(map[t]));return entries};return{has:has,get:get,put:put,del:del,entries:entries}}(),listener=W3C_MODEL?function(element,type,fn,add){element[add?addEvent:removeEvent](type,fn,!1)}:function(element,type,fn,add,custom){custom&&add&&null===element["_on"+custom]&&(element["_on"+custom]=0),element[add?attachEvent:detachEvent]("on"+type,fn)},nativeHandler=function(element,fn,args){return function(event){return event=fixEvent(event||((this.ownerDocument||this.document||this).parentWindow||win).event,!0),fn.apply(element,[event].concat(args))}},customHandler=function(element,fn,type,condition,args,isNative){return function(event){(condition?condition.apply(this,arguments):W3C_MODEL?!0:event&&event.propertyName==="_on"+type||!event)&&(event&&(event=fixEvent(event||((this.ownerDocument||this.document||this).parentWindow||win).event,isNative)),fn.apply(element,!event||args&&0!==args.length?slice.call(arguments,event?0:1).concat(args):arguments))}},once=function(rm,element,type,fn,originalFn){return function(){rm(element,type,originalFn),fn.apply(this,arguments)}},removeListener=function(element,orgType,handler,namespaces){var i,l,entry,type=orgType&&orgType.replace(nameRegex,""),handlers=registry.get(element,type,handler);for(i=0,l=handlers.length;l>i;i++)handlers[i].inNamespaces(namespaces)&&((entry=handlers[i]).eventSupport&&listener(entry.target,entry.eventType,entry.handler,!1,entry.type),registry.del(entry))},addListener=function(element,orgType,fn,originalFn,args){var entry,type=orgType.replace(nameRegex,""),namespaces=orgType.replace(namespaceRegex,"").split(".");return registry.has(element,type,fn)?element:("unload"===type&&(fn=once(removeListener,element,type,fn,originalFn)),customEvents[type]&&(customEvents[type].condition&&(fn=customHandler(element,fn,type,customEvents[type].condition,!0)),type=customEvents[type].base||type),entry=registry.put(new RegEntry(element,type,fn,originalFn,namespaces[0]&&namespaces)),entry.handler=entry.isNative?nativeHandler(element,entry.handler,args):customHandler(element,entry.handler,type,!1,args,!1),entry.eventSupport&&listener(entry.target,entry.eventType,entry.handler,!0,entry.customType),void 0)},del=function(selector,fn,$){return function(e){var target,i,array="string"==typeof selector?$(selector,this):selector;for(target=e.target;target&&target!==this;target=target.parentNode)for(i=array.length;i--;)if(array[i]===target)return fn.apply(target,arguments)}},remove=function(element,typeSpec,fn){var k,type,namespaces,i,rm=removeListener,isString=typeSpec&&"string"==typeof typeSpec;if(isString&&typeSpec.indexOf(" ")>0){for(typeSpec=typeSpec.split(" "),i=typeSpec.length;i--;)remove(element,typeSpec[i],fn);return element}if(type=isString&&typeSpec.replace(nameRegex,""),type&&customEvents[type]&&(type=customEvents[type].type),!typeSpec||isString)(namespaces=isString&&typeSpec.replace(namespaceRegex,""))&&(namespaces=namespaces.split(".")),rm(element,type,fn,namespaces);else if("function"==typeof typeSpec)rm(element,null,typeSpec);else for(k in typeSpec)typeSpec.hasOwnProperty(k)&&remove(element,k,typeSpec[k]);return element},add=function(element,events,fn,delfn,$){var type,types,i,args,originalFn=fn,isDel=fn&&"string"==typeof fn;if(events&&!fn&&"object"==typeof events)for(type in events)events.hasOwnProperty(type)&&add.apply(this,[element,type,events[type]]);else for(args=arguments.length>3?slice.call(arguments,3):[],types=(isDel?fn:events).split(" "),isDel&&(fn=del(events,originalFn=delfn,$))&&(args=slice.call(args,1)),this===ONE&&(fn=once(remove,element,events,fn,originalFn)),i=types.length;i--;)addListener(element,types[i],fn,originalFn,args);return element},one=function(){return add.apply(ONE,arguments)},fireListener=W3C_MODEL?function(isNative,type,element){var evt=doc.createEvent(isNative?"HTMLEvents":"UIEvents");evt[isNative?"initEvent":"initUIEvent"](type,!0,!0,win,1),element.dispatchEvent(evt)}:function(isNative,type,element){element=targetElement(element,isNative),isNative?element.fireEvent("on"+type,doc.createEventObject()):element["_on"+type]++},fire=function(element,type,args){var i,j,l,names,handlers,types=type.split(" ");for(i=types.length;i--;)if(type=types[i].replace(nameRegex,""),(names=types[i].replace(namespaceRegex,""))&&(names=names.split(".")),names||args||!element[eventSupport])for(handlers=registry.get(element,type),args=[!1].concat(args),j=0,l=handlers.length;l>j;j++)handlers[j].inNamespaces(names)&&handlers[j].handler.apply(element,args);else fireListener(nativeEvents[type],type,element);return element},clone=function(element,from,type){for(var i=0,handlers=registry.get(from,type),l=handlers.length;l>i;i++)handlers[i].original&&add(element,handlers[i].type,handlers[i].original);return element},bean={add:add,one:one,remove:remove,clone:clone,fire:fire,noConflict:function(){return context[name]=old,this}};if(win[attachEvent]){var cleanup=function(){var i,entries=registry.entries();for(i in entries)entries[i].type&&"unload"!==entries[i].type&&remove(entries[i].element,entries[i].type);win[detachEvent]("onunload",cleanup),win.CollectGarbage&&win.CollectGarbage()};win[attachEvent]("onunload",cleanup)}return bean});// Copyright Google Inc.
var html4={};html4.atype={NONE:0,URI:1,URI_FRAGMENT:11,SCRIPT:2,STYLE:3,ID:4,IDREF:5,IDREFS:6,GLOBAL_NAME:7,LOCAL_NAME:8,CLASSES:9,FRAME_TARGET:10},html4.ATTRIBS={"*::class":9,"*::dir":0,"*::id":4,"*::lang":0,"*::onclick":2,"*::ondblclick":2,"*::onkeydown":2,"*::onkeypress":2,"*::onkeyup":2,"*::onload":2,"*::onmousedown":2,"*::onmousemove":2,"*::onmouseout":2,"*::onmouseover":2,"*::onmouseup":2,"*::style":3,"*::title":0,"a::accesskey":0,"a::coords":0,"a::href":1,"a::hreflang":0,"a::name":7,"a::onblur":2,"a::onfocus":2,"a::rel":0,"a::rev":0,"a::shape":0,"a::tabindex":0,"a::target":10,"a::type":0,"area::accesskey":0,"area::alt":0,"area::coords":0,"area::href":1,"area::nohref":0,"area::onblur":2,"area::onfocus":2,"area::shape":0,"area::tabindex":0,"area::target":10,"bdo::dir":0,"blockquote::cite":1,"br::clear":0,"button::accesskey":0,"button::disabled":0,"button::name":8,"button::onblur":2,"button::onfocus":2,"button::tabindex":0,"button::type":0,"button::value":0,"canvas::height":0,"canvas::width":0,"caption::align":0,"col::align":0,"col::char":0,"col::charoff":0,"col::span":0,"col::valign":0,"col::width":0,"colgroup::align":0,"colgroup::char":0,"colgroup::charoff":0,"colgroup::span":0,"colgroup::valign":0,"colgroup::width":0,"del::cite":1,"del::datetime":0,"dir::compact":0,"div::align":0,"dl::compact":0,"font::color":0,"font::face":0,"font::size":0,"form::accept":0,"form::action":1,"form::autocomplete":0,"form::enctype":0,"form::method":0,"form::name":7,"form::onreset":2,"form::onsubmit":2,"form::target":10,"h1::align":0,"h2::align":0,"h3::align":0,"h4::align":0,"h5::align":0,"h6::align":0,"hr::align":0,"hr::noshade":0,"hr::size":0,"hr::width":0,"iframe::align":0,"iframe::frameborder":0,"iframe::height":0,"iframe::marginheight":0,"iframe::marginwidth":0,"iframe::width":0,"img::align":0,"img::alt":0,"img::border":0,"img::height":0,"img::hspace":0,"img::ismap":0,"img::name":7,"img::src":1,"img::usemap":11,"img::vspace":0,"img::width":0,"input::accept":0,"input::accesskey":0,"input::align":0,"input::alt":0,"input::autocomplete":0,"input::checked":0,"input::disabled":0,"input::ismap":0,"input::maxlength":0,"input::name":8,"input::onblur":2,"input::onchange":2,"input::onfocus":2,"input::onselect":2,"input::readonly":0,"input::size":0,"input::src":1,"input::tabindex":0,"input::type":0,"input::usemap":11,"input::value":0,"ins::cite":1,"ins::datetime":0,"label::accesskey":0,"label::for":5,"label::onblur":2,"label::onfocus":2,"legend::accesskey":0,"legend::align":0,"li::type":0,"li::value":0,"map::name":7,"menu::compact":0,"ol::compact":0,"ol::start":0,"ol::type":0,"optgroup::disabled":0,"optgroup::label":0,"option::disabled":0,"option::label":0,"option::selected":0,"option::value":0,"p::align":0,"pre::width":0,"q::cite":1,"select::disabled":0,"select::multiple":0,"select::name":8,"select::onblur":2,"select::onchange":2,"select::onfocus":2,"select::size":0,"select::tabindex":0,"table::align":0,"table::bgcolor":0,"table::border":0,"table::cellpadding":0,"table::cellspacing":0,"table::frame":0,"table::rules":0,"table::summary":0,"table::width":0,"tbody::align":0,"tbody::char":0,"tbody::charoff":0,"tbody::valign":0,"td::abbr":0,"td::align":0,"td::axis":0,"td::bgcolor":0,"td::char":0,"td::charoff":0,"td::colspan":0,"td::headers":6,"td::height":0,"td::nowrap":0,"td::rowspan":0,"td::scope":0,"td::valign":0,"td::width":0,"textarea::accesskey":0,"textarea::cols":0,"textarea::disabled":0,"textarea::name":8,"textarea::onblur":2,"textarea::onchange":2,"textarea::onfocus":2,"textarea::onselect":2,"textarea::readonly":0,"textarea::rows":0,"textarea::tabindex":0,"tfoot::align":0,"tfoot::char":0,"tfoot::charoff":0,"tfoot::valign":0,"th::abbr":0,"th::align":0,"th::axis":0,"th::bgcolor":0,"th::char":0,"th::charoff":0,"th::colspan":0,"th::headers":6,"th::height":0,"th::nowrap":0,"th::rowspan":0,"th::scope":0,"th::valign":0,"th::width":0,"thead::align":0,"thead::char":0,"thead::charoff":0,"thead::valign":0,"tr::align":0,"tr::bgcolor":0,"tr::char":0,"tr::charoff":0,"tr::valign":0,"ul::compact":0,"ul::type":0},html4.eflags={OPTIONAL_ENDTAG:1,EMPTY:2,CDATA:4,RCDATA:8,UNSAFE:16,FOLDABLE:32,SCRIPT:64,STYLE:128},html4.ELEMENTS={a:0,abbr:0,acronym:0,address:0,applet:16,area:2,b:0,base:18,basefont:18,bdo:0,big:0,blockquote:0,body:49,br:2,button:0,canvas:0,caption:0,center:0,cite:0,code:0,col:2,colgroup:1,dd:1,del:0,dfn:0,dir:0,div:0,dl:0,dt:1,em:0,fieldset:0,font:0,form:0,frame:18,frameset:16,h1:0,h2:0,h3:0,h4:0,h5:0,h6:0,head:49,hr:2,html:49,i:0,iframe:4,img:2,input:2,ins:0,isindex:18,kbd:0,label:0,legend:0,li:1,link:18,map:0,menu:0,meta:18,nobr:0,noembed:4,noframes:20,noscript:20,object:16,ol:0,optgroup:0,option:1,p:1,param:18,pre:0,q:0,s:0,samp:0,script:84,select:0,small:0,span:0,strike:0,strong:0,style:148,sub:0,sup:0,table:0,tbody:1,td:1,textarea:8,tfoot:1,th:1,thead:1,title:24,tr:1,tt:0,u:0,ul:0,"var":0},html4.ueffects={NOT_LOADED:0,SAME_DOCUMENT:1,NEW_DOCUMENT:2},html4.URIEFFECTS={"a::href":2,"area::href":2,"blockquote::cite":0,"body::background":1,"del::cite":0,"form::action":2,"img::src":1,"input::src":1,"ins::cite":0,"q::cite":0},html4.ltypes={UNSANDBOXED:2,SANDBOXED:1,DATA:0},html4.LOADERTYPES={"a::href":2,"area::href":2,"blockquote::cite":2,"body::background":1,"del::cite":2,"form::action":2,"img::src":1,"input::src":1,"ins::cite":2,"q::cite":2};// Copyright (C) 2006 Google Inc.
var html=function(html4){function lookupEntity(name){if(name=lcase(name),ENTITIES.hasOwnProperty(name))return ENTITIES[name];var m=name.match(decimalEscapeRe);return m?String.fromCharCode(parseInt(m[1],10)):(m=name.match(hexEscapeRe))?String.fromCharCode(parseInt(m[1],16)):""}function decodeOneEntity(_,name){return lookupEntity(name)}function stripNULs(s){return s.replace(nulRe,"")}function unescapeEntities(s){return s.replace(entityRe,decodeOneEntity)}function escapeAttrib(s){return s.replace(ampRe,"&amp;").replace(ltRe,"&lt;").replace(gtRe,"&gt;").replace(quotRe,"&#34;").replace(eqRe,"&#61;")}function normalizeRCData(rcdata){return rcdata.replace(looseAmpRe,"&amp;$1").replace(ltRe,"&lt;").replace(gtRe,"&gt;")}function makeSaxParser(handler){return function(htmlText,param){htmlText=String(htmlText);var htmlLower=null,inTag=!1,attribs=[],tagName=void 0,eflags=void 0,openTag=void 0;for(handler.startDoc&&handler.startDoc(param);htmlText;){var m=htmlText.match(inTag?INSIDE_TAG_TOKEN:OUTSIDE_TAG_TOKEN);if(htmlText=htmlText.substring(m[0].length),inTag){if(m[1]){var decodedValue,attribName=lcase(m[1]);if(m[2]){var encodedValue=m[3];switch(encodedValue.charCodeAt(0)){case 34:case 39:encodedValue=encodedValue.substring(1,encodedValue.length-1)}decodedValue=unescapeEntities(stripNULs(encodedValue))}else decodedValue=attribName;attribs.push(attribName,decodedValue)}else if(m[4]){if(void 0!==eflags&&(openTag?handler.startTag&&handler.startTag(tagName,attribs,param):handler.endTag&&handler.endTag(tagName,param)),openTag&&eflags&(html4.eflags.CDATA|html4.eflags.RCDATA)){htmlLower=null===htmlLower?lcase(htmlText):htmlLower.substring(htmlLower.length-htmlText.length);var dataEnd=htmlLower.indexOf("</"+tagName);0>dataEnd&&(dataEnd=htmlText.length),dataEnd&&(eflags&html4.eflags.CDATA?handler.cdata&&handler.cdata(htmlText.substring(0,dataEnd),param):handler.rcdata&&handler.rcdata(normalizeRCData(htmlText.substring(0,dataEnd)),param),htmlText=htmlText.substring(dataEnd))}tagName=eflags=openTag=void 0,attribs.length=0,inTag=!1}}else if(m[1])handler.pcdata&&handler.pcdata(m[0],param);else if(m[3])openTag=!m[2],inTag=!0,tagName=lcase(m[3]),eflags=html4.ELEMENTS.hasOwnProperty(tagName)?html4.ELEMENTS[tagName]:void 0;else if(m[4])handler.pcdata&&handler.pcdata(m[4],param);else if(m[5]&&handler.pcdata){var ch=m[5];handler.pcdata("<"===ch?"&lt;":">"===ch?"&gt;":"&amp;",param)}}handler.endDoc&&handler.endDoc(param)}}function makeHtmlSanitizer(sanitizeAttributes){var stack,ignoring;return makeSaxParser({startDoc:function(){stack=[],ignoring=!1},startTag:function(tagName,attribs,out){if(!ignoring&&html4.ELEMENTS.hasOwnProperty(tagName)){var eflags=html4.ELEMENTS[tagName];if(!(eflags&html4.eflags.FOLDABLE)){if(eflags&html4.eflags.UNSAFE)return ignoring=!(eflags&html4.eflags.EMPTY),void 0;if(attribs=sanitizeAttributes(tagName,attribs)){eflags&html4.eflags.EMPTY||stack.push(tagName),out.push("<",tagName);for(var i=0,n=attribs.length;n>i;i+=2){var attribName=attribs[i],value=attribs[i+1];null!==value&&void 0!==value&&out.push(" ",attribName,'="',escapeAttrib(value),'"')}out.push(">")}}}},endTag:function(tagName,out){if(ignoring)return ignoring=!1,void 0;if(html4.ELEMENTS.hasOwnProperty(tagName)){var eflags=html4.ELEMENTS[tagName];if(!(eflags&(html4.eflags.UNSAFE|html4.eflags.EMPTY|html4.eflags.FOLDABLE))){var index;if(eflags&html4.eflags.OPTIONAL_ENDTAG)for(index=stack.length;--index>=0;){var stackEl=stack[index];if(stackEl===tagName)break;if(!(html4.ELEMENTS[stackEl]&html4.eflags.OPTIONAL_ENDTAG))return}else for(index=stack.length;--index>=0&&stack[index]!==tagName;);if(0>index)return;for(var i=stack.length;--i>index;){var stackEl=stack[i];html4.ELEMENTS[stackEl]&html4.eflags.OPTIONAL_ENDTAG||out.push("</",stackEl,">")}stack.length=index,out.push("</",tagName,">")}}},pcdata:function(text,out){ignoring||out.push(text)},rcdata:function(text,out){ignoring||out.push(text)},cdata:function(text,out){ignoring||out.push(text)},endDoc:function(out){for(var i=stack.length;--i>=0;)out.push("</",stack[i],">");stack.length=0}})}function sanitize(htmlText,opt_uriPolicy,opt_nmTokenPolicy){var out=[];return makeHtmlSanitizer(function(tagName,attribs){for(var i=0;i<attribs.length;i+=2){var attribKey,attribName=attribs[i],value=attribs[i+1],atype=null;if(attribKey=tagName+"::"+attribName,(html4.ATTRIBS.hasOwnProperty(attribKey)||(attribKey="*::"+attribName,html4.ATTRIBS.hasOwnProperty(attribKey)))&&(atype=html4.ATTRIBS[attribKey]),null!==atype)switch(atype){case html4.atype.NONE:break;case html4.atype.SCRIPT:case html4.atype.STYLE:value=null;break;case html4.atype.ID:case html4.atype.IDREF:case html4.atype.IDREFS:case html4.atype.GLOBAL_NAME:case html4.atype.LOCAL_NAME:case html4.atype.CLASSES:value=opt_nmTokenPolicy?opt_nmTokenPolicy(value):value;break;case html4.atype.URI:var parsedUri=(""+value).match(URI_SCHEME_RE);value=parsedUri?!parsedUri[1]||WHITELISTED_SCHEMES.test(parsedUri[1])?opt_uriPolicy&&opt_uriPolicy(value):null:null;break;case html4.atype.URI_FRAGMENT:value&&"#"===value.charAt(0)?(value=opt_nmTokenPolicy?opt_nmTokenPolicy(value):value,value&&(value="#"+value)):value=null;break;default:value=null}else value=null;attribs[i+1]=value}return attribs})(htmlText,out),out.join("")}var lcase;lcase="script"==="SCRIPT".toLowerCase()?function(s){return s.toLowerCase()}:function(s){return s.replace(/[A-Z]/g,function(ch){return String.fromCharCode(32|ch.charCodeAt(0))})};var ENTITIES={lt:"<",gt:">",amp:"&",nbsp:"Â ",quot:'"',apos:"'"},WHITELISTED_SCHEMES=/^(?:https?|mailto|data)$/i,decimalEscapeRe=/^#(\d+)$/,hexEscapeRe=/^#x([0-9A-Fa-f]+)$/,nulRe=/\0/g,entityRe=/&(#\d+|#x[0-9A-Fa-f]+|\w+);/g,ampRe=/&/g,looseAmpRe=/&([^a-z#]|#(?:[^0-9x]|x(?:[^0-9a-f]|$)|$)|$)/gi,ltRe=/</g,gtRe=/>/g,quotRe=/\"/g,eqRe=/\=/g,INSIDE_TAG_TOKEN=new RegExp("^\\s*(?:(?:([a-z][a-z-]*)(\\s*=\\s*(\"[^\"]*\"|'[^']*'|(?=[a-z][a-z-]*\\s*=)|[^>\"'\\s]*))?)|(/?>)|[\\s\\S][^a-z\\s>]*)","i"),OUTSIDE_TAG_TOKEN=new RegExp("^(?:&(\\#[0-9]+|\\#[x][0-9a-f]+|\\w+);|<!--[\\s\\S]*?-->|<!\\w[^>]*>|<\\?[^>*]*>|<(/)?([a-z][a-z0-9]*)|([^<&>]+)|([<&>]))","i"),URI_SCHEME_RE=new RegExp("^(?:([^:/?#]+):)?");return{escapeAttrib:escapeAttrib,makeHtmlSanitizer:makeHtmlSanitizer,makeSaxParser:makeSaxParser,normalizeRCData:normalizeRCData,sanitize:sanitize,unescapeEntities:unescapeEntities}}(html4),html_sanitize=html.sanitize;"undefined"!=typeof window&&(window.html=html,window.html_sanitize=html_sanitize),html4.ATTRIBS["*::style"]=0,html4.ELEMENTS.style=0,html4.ATTRIBS["a::target"]=0,html4.ELEMENTS.video=0,html4.ATTRIBS["video::src"]=0,html4.ATTRIBS["video::poster"]=0,html4.ATTRIBS["video::controls"]=0,html4.ELEMENTS.audio=0,html4.ATTRIBS["audio::src"]=0,html4.ATTRIBS["video::autoplay"]=0,html4.ATTRIBS["video::controls"]=0;var Mustache;!function(exports){"undefined"!=typeof module&&module.exports?module.exports=exports:"function"==typeof define?define(exports):Mustache=exports}(function(){function testRe(re,string){return RegExp.prototype.test.call(re,string)}function isWhitespace(string){return!testRe(nonSpaceRe,string)}function escapeRe(string){return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function escapeHtml(string){return String(string).replace(/[&<>"'\/]/g,function(s){return entityMap[s]})}function Scanner(string){this.string=string,this.tail=string,this.pos=0}function Context(view,parent){this.view=view,this.parent=parent,this.clearCache()}function Writer(){this.clearCache()}function sectionBounds(token){for(var tokens,start=token[3],end=start;(tokens=token[4])&&tokens.length;)token=tokens[tokens.length-1],end=token[3];return[start,end]}function compileTokens(tokens){function subRender(i,tokens,template){if(!subRenders[i]){var fn=compileTokens(tokens);subRenders[i]=function(writer,context){return fn(writer,context,template)}}return subRenders[i]}function renderFunction(writer,context,template){for(var token,sectionText,buffer="",i=0,len=tokens.length;len>i;++i)switch(token=tokens[i],token[0]){case"#":sectionText=template.slice.apply(template,sectionBounds(token)),buffer+=writer._section(token[1],context,sectionText,subRender(i,token[4],template));break;case"^":buffer+=writer._inverted(token[1],context,subRender(i,token[4],template));break;case">":buffer+=writer._partial(token[1],context);break;case"&":buffer+=writer._name(token[1],context);break;case"name":buffer+=writer._escaped(token[1],context);break;case"text":buffer+=token[1]}return buffer}var subRenders={};return renderFunction}function nestTokens(tokens){for(var token,section,tree=[],collector=tree,sections=[],i=0;i<tokens.length;++i)switch(token=tokens[i],token[0]){case"#":case"^":token[4]=[],sections.push(token),collector.push(token),collector=token[4];break;case"/":if(0===sections.length)throw new Error("Unopened section: "+token[1]);if(section=sections.pop(),section[1]!==token[1])throw new Error("Unclosed section: "+section[1]);collector=sections.length>0?sections[sections.length-1][4]:tree;break;default:collector.push(token)}if(section=sections.pop())throw new Error("Unclosed section: "+section[1]);return tree}function squashTokens(tokens){for(var token,lastToken,i=0;i<tokens.length;++i)token=tokens[i],lastToken&&"text"===lastToken[0]&&"text"===token[0]?(lastToken[1]+=token[1],lastToken[3]=token[3],tokens.splice(i--,1)):lastToken=token}function escapeTags(tags){if(2!==tags.length)throw new Error("Invalid tags: "+tags.join(" "));return[new RegExp(escapeRe(tags[0])+"\\s*"),new RegExp("\\s*"+escapeRe(tags[1]))]}var exports={};exports.name="mustache.js",exports.version="0.7.0",exports.tags=["{{","}}"],exports.Scanner=Scanner,exports.Context=Context,exports.Writer=Writer;var whiteRe=/\s*/,spaceRe=/\s+/,nonSpaceRe=/\S/,eqRe=/\s*=/,curlyRe=/\s*\}/,tagRe=/#|\^|\/|>|\{|&|=|!/,isArray=Array.isArray||function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};exports.escape=escapeHtml,Scanner.prototype.eos=function(){return""===this.tail},Scanner.prototype.scan=function(re){var match=this.tail.match(re);return match&&0===match.index?(this.tail=this.tail.substring(match[0].length),this.pos+=match[0].length,match[0]):""},Scanner.prototype.scanUntil=function(re){var match,pos=this.tail.search(re);switch(pos){case-1:match=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:match="";break;default:match=this.tail.substring(0,pos),this.tail=this.tail.substring(pos),this.pos+=pos}return match},Context.make=function(view){return view instanceof Context?view:new Context(view)},Context.prototype.clearCache=function(){this._cache={}},Context.prototype.push=function(view){return new Context(view,this)},Context.prototype.lookup=function(name){var value=this._cache[name];if(!value){if("."===name)value=this.view;else for(var context=this;context;){if(name.indexOf(".")>0){var names=name.split("."),i=0;for(value=context.view;value&&i<names.length;)value=value[names[i++]]}else value=context.view[name];if(null!=value)break;context=context.parent}this._cache[name]=value}return"function"==typeof value&&(value=value.call(this.view)),value},Writer.prototype.clearCache=function(){this._cache={},this._partialCache={}},Writer.prototype.compile=function(template,tags){return this._compile(this._cache,template,template,tags)},Writer.prototype.compilePartial=function(name,template,tags){return this._compile(this._partialCache,name,template,tags)},Writer.prototype.render=function(template,view,partials){return this.compile(template)(view,partials)},Writer.prototype._compile=function(cache,key,template,tags){if(!cache[key]){var tokens=exports.parse(template,tags),fn=compileTokens(tokens),self=this;cache[key]=function(view,partials){if(partials)if("function"==typeof partials)self._loadPartial=partials;else for(var name in partials)self.compilePartial(name,partials[name]);return fn(self,Context.make(view),template)}}return cache[key]},Writer.prototype._section=function(name,context,text,callback){var value=context.lookup(name);switch(typeof value){case"object":if(isArray(value)){for(var buffer="",i=0,len=value.length;len>i;++i)buffer+=callback(this,context.push(value[i]));return buffer}return value?callback(this,context.push(value)):"";case"function":var self=this,scopedRender=function(template){return self.render(template,context)};return value.call(context.view,text,scopedRender)||"";default:if(value)return callback(this,context)}return""},Writer.prototype._inverted=function(name,context,callback){var value=context.lookup(name);return!value||isArray(value)&&0===value.length?callback(this,context):""},Writer.prototype._partial=function(name,context){name in this._partialCache||!this._loadPartial||this.compilePartial(name,this._loadPartial(name));var fn=this._partialCache[name];return fn?fn(context):""},Writer.prototype._name=function(name,context){var value=context.lookup(name);return"function"==typeof value&&(value=value.call(context.view)),null==value?"":String(value)},Writer.prototype._escaped=function(name,context){return exports.escape(this._name(name,context))},exports.parse=function(template,tags){function stripSpace(){if(hasTag&&!nonSpace)for(;spaces.length;)tokens.splice(spaces.pop(),1);else spaces=[];hasTag=!1,nonSpace=!1}tags=tags||exports.tags;for(var start,type,value,chr,tagRes=escapeTags(tags),scanner=new Scanner(template),tokens=[],spaces=[],hasTag=!1,nonSpace=!1;!scanner.eos();){if(start=scanner.pos,value=scanner.scanUntil(tagRes[0]))for(var i=0,len=value.length;len>i;++i)chr=value.charAt(i),isWhitespace(chr)?spaces.push(tokens.length):nonSpace=!0,tokens.push(["text",chr,start,start+1]),start+=1,"\n"===chr&&stripSpace();if(start=scanner.pos,!scanner.scan(tagRes[0]))break;if(hasTag=!0,type=scanner.scan(tagRe)||"name",scanner.scan(whiteRe),"="===type)value=scanner.scanUntil(eqRe),scanner.scan(eqRe),scanner.scanUntil(tagRes[1]);else if("{"===type){var closeRe=new RegExp("\\s*"+escapeRe("}"+tags[1]));value=scanner.scanUntil(closeRe),scanner.scan(curlyRe),scanner.scanUntil(tagRes[1]),type="&"}else value=scanner.scanUntil(tagRes[1]);if(!scanner.scan(tagRes[1]))throw new Error("Unclosed tag at "+scanner.pos);tokens.push([type,value,start,scanner.pos]),("name"===type||"{"===type||"&"===type)&&(nonSpace=!0),"="===type&&(tags=value.split(spaceRe),tagRes=escapeTags(tags))}return squashTokens(tokens),nestTokens(tokens)};var _writer=new Writer;return exports.clearCache=function(){return _writer.clearCache()},exports.compile=function(template,tags){return _writer.compile(template,tags)},exports.compilePartial=function(name,template,tags){return _writer.compilePartial(name,template,tags)},exports.render=function(template,view,partials){return _writer.render(template,view,partials)},exports.to_html=function(template,view,partials,send){var result=exports.render(template,view,partials);return"function"!=typeof send?result:(send(result),void 0)},exports}()),!function(e,t){"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):this[e]=t()}("reqwest",function(){function handleReadyState(e,t,n){return function(){e&&4==e[readyState]&&(twoHundo.test(e.status)?t(e):n(e))}}function setHeaders(e,t){var r,n=t.headers||{};n.Accept=n.Accept||defaultHeaders.accept[t.type]||defaultHeaders.accept["*"],!t.crossOrigin&&!n[requestedWith]&&(n[requestedWith]=defaultHeaders.requestedWith),n[contentType]||(n[contentType]=t.contentType||defaultHeaders.contentType);for(r in n)n.hasOwnProperty(r)&&e.setRequestHeader(r,n[r])}function setCredentials(e,t){"undefined"!=typeof t.withCredentials&&"undefined"!=typeof e.withCredentials&&(e.withCredentials=!!t.withCredentials)}function generalCallback(e){lastValue=e}function urlappend(e,t){return e+(/\?/.test(e)?"&":"?")+t}function handleJsonp(e,t,n,r){var i=uniqid++,s=e.jsonpCallback||"callback",o=e.jsonpCallbackName||reqwest.getcallbackPrefix(i),u=new RegExp("((^|\\?|&)"+s+")=([^&]+)"),a=r.match(u),f=doc.createElement("script"),l=0,c=-1!==navigator.userAgent.indexOf("MSIE 10.0");a?"?"===a[3]?r=r.replace(u,"$1="+o):o=a[3]:r=urlappend(r,s+"="+o),win[o]=generalCallback,f.type="text/javascript",f.src=r,f.async=!0,"undefined"!=typeof f.onreadystatechange&&!c&&(f.event="onclick",f.htmlFor=f.id="_reqwest_"+i),f.onload=f.onreadystatechange=function(){return f[readyState]&&"complete"!==f[readyState]&&"loaded"!==f[readyState]||l?!1:(f.onload=f.onreadystatechange=null,f.onclick&&f.onclick(),e.success&&e.success(lastValue),lastValue=void 0,head.removeChild(f),l=1,void 0)},head.appendChild(f)}function getRequest(e,t,n){var o,r=(e.method||"GET").toUpperCase(),i="string"==typeof e?e:e.url,s=e.processData!==!1&&e.data&&"string"!=typeof e.data?reqwest.toQueryString(e.data):e.data||null;return("jsonp"==e.type||"GET"==r)&&s&&(i=urlappend(i,s),s=null),"jsonp"==e.type?handleJsonp(e,t,n,i):(o=xhr(),o.open(r,i,!0),setHeaders(o,e),setCredentials(o,e),o.onreadystatechange=handleReadyState(o,t,n),e.before&&e.before(o),o.send(s),o)}function Reqwest(e,t){this.o=e,this.fn=t,init.apply(this,arguments)}function setType(e){var t=e.match(/\.(json|jsonp|html|xml)(\?|$)/);return t?t[1]:"js"}function init(o,fn){function complete(e){for(o.timeout&&clearTimeout(self.timeout),self.timeout=null;self._completeHandlers.length>0;)self._completeHandlers.shift()(e)}function success(resp){var r=resp.responseText;if(r)switch(type){case"json":try{resp=win.JSON?win.JSON.parse(r):eval("("+r+")")}catch(err){return error(resp,"Could not parse JSON in response",err)}break;case"js":resp=eval(r);break;case"html":resp=r;break;case"xml":resp=resp.responseXML}for(self._responseArgs.resp=resp,self._fulfilled=!0,fn(resp);self._fulfillmentHandlers.length>0;)self._fulfillmentHandlers.shift()(resp);complete(resp)}function error(e,t,n){for(self._responseArgs.resp=e,self._responseArgs.msg=t,self._responseArgs.t=n,self._erred=!0;self._errorHandlers.length>0;)self._errorHandlers.shift()(e,t,n);complete(e)}this.url="string"==typeof o?o:o.url,this.timeout=null,this._fulfilled=!1,this._fulfillmentHandlers=[],this._errorHandlers=[],this._completeHandlers=[],this._erred=!1,this._responseArgs={};var self=this,type=o.type||setType(this.url);fn=fn||function(){},o.timeout&&(this.timeout=setTimeout(function(){self.abort()},o.timeout)),o.success&&this._fulfillmentHandlers.push(function(){o.success.apply(o,arguments)}),o.error&&this._errorHandlers.push(function(){o.error.apply(o,arguments)}),o.complete&&this._completeHandlers.push(function(){o.complete.apply(o,arguments)}),this.request=getRequest(o,success,error)}function reqwest(e,t){return new Reqwest(e,t)}function normalize(e){return e?e.replace(/\r?\n/g,"\r\n"):""}function serial(e,t){var n=e.name,r=e.tagName.toLowerCase(),i=function(e){e&&!e.disabled&&t(n,normalize(e.attributes.value&&e.attributes.value.specified?e.value:e.text))};if(!e.disabled&&n)switch(r){case"input":if(!/reset|button|image|file/i.test(e.type)){var s=/checkbox/i.test(e.type),o=/radio/i.test(e.type),u=e.value;(!s&&!o||e.checked)&&t(n,normalize(s&&""===u?"on":u))}break;case"textarea":t(n,normalize(e.value));break;case"select":if("select-one"===e.type.toLowerCase())i(e.selectedIndex>=0?e.options[e.selectedIndex]:null);else for(var a=0;e.length&&a<e.length;a++)e.options[a].selected&&i(e.options[a])}}function eachFormElement(){var t,n,r,e=this,i=function(t,n){for(var i=0;i<n.length;i++){var s=t[byTag](n[i]);for(r=0;r<s.length;r++)serial(s[r],e)}};for(n=0;n<arguments.length;n++)t=arguments[n],/input|select|textarea/i.test(t.tagName)&&serial(t,e),i(t,["input","select","textarea"])}function serializeQueryString(){return reqwest.toQueryString(reqwest.serializeArray.apply(null,arguments))}function serializeHash(){var e={};return eachFormElement.apply(function(t,n){t in e?(e[t]&&!isArray(e[t])&&(e[t]=[e[t]]),e[t].push(n)):e[t]=n},arguments),e}var win=window,doc=document,twoHundo=/^20\d$/,byTag="getElementsByTagName",readyState="readyState",contentType="Content-Type",requestedWith="X-Requested-With",head=doc[byTag]("head")[0],uniqid=0,callbackPrefix="reqwest_"+ +new Date,lastValue,xmlHttpRequest="XMLHttpRequest",isArray="function"==typeof Array.isArray?Array.isArray:function(e){return e instanceof Array},defaultHeaders={contentType:"application/x-www-form-urlencoded",requestedWith:xmlHttpRequest,accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",js:"application/javascript, text/javascript"}},xhr=win[xmlHttpRequest]?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")};return Reqwest.prototype={abort:function(){this.request.abort()},retry:function(){init.call(this,this.o,this.fn)},then:function(e,t){return this._fulfilled?e(this._responseArgs.resp):this._erred?t(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(e),this._errorHandlers.push(t)),this},always:function(e){return this._fulfilled||this._erred?e(this._responseArgs.resp):this._completeHandlers.push(e),this},fail:function(e){return this._erred?e(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(e),this}},reqwest.serializeArray=function(){var e=[];return eachFormElement.apply(function(t,n){e.push({name:t,value:n})},arguments),e},reqwest.serialize=function(){if(0===arguments.length)return"";var e,t,n=Array.prototype.slice.call(arguments,0);return e=n.pop(),e&&e.nodeType&&n.push(e)&&(e=null),e&&(e=e.type),t="map"==e?serializeHash:"array"==e?reqwest.serializeArray:serializeQueryString,t.apply(null,n)},reqwest.toQueryString=function(e){var n,t="",r=encodeURIComponent,i=function(e,n){t+=r(e)+"="+r(n)+"&"};if(isArray(e))for(n=0;e&&n<e.length;n++)i(e[n].name,e[n].value);else for(var s in e)if(Object.hasOwnProperty.call(e,s)){var o=e[s];if(isArray(o))for(n=0;n<o.length;n++)i(s,o[n]);else i(s,e[s])}return t.replace(/&$/,"").replace(/%20/g,"+")},reqwest.getcallbackPrefix=function(){return callbackPrefix},reqwest.compat=function(e,t){return e&&(e.type&&(e.method=e.type)&&delete e.type,e.dataType&&(e.type=e.dataType),e.jsonpCallback&&(e.jsonpCallbackName=e.jsonpCallback)&&delete e.jsonpCallback,e.jsonp&&(e.jsonpCallback=e.jsonp)),new Reqwest(e,t)},reqwest}),wax=wax||{},wax.attribution=function(){var a={},container=document.createElement("div");return container.className="map-attribution",a.content=function(x){return"undefined"==typeof x?container.innerHTML:(container.innerHTML=wax.u.sanitize(x),this)},a.element=function(){return container},a.init=function(){return this},a},wax=wax||{},wax.bwdetect=function(options,callback){function bwTest(){wax.bw=-1;var im=new Image;im.src=testImage;var first=!0,timeout=setTimeout(function(){first&&-1==wax.bw&&(detector.bw(0),first=!1)},threshold);im.onload=function(){first&&-1==wax.bw&&(clearTimeout(timeout),detector.bw(1),first=!1)}}var detector={},threshold=options.threshold||400,testImage="http://a.tiles.mapbox.com/mapbox/1.0.0/blue-marble-topo-bathy-jul/0/0/0.png?preventcache="+ +new Date,bw=1,auto=void 0===options.auto?!0:options.auto;return detector.bw=function(x){return arguments.length?(wax.bwlisteners&&wax.bwlisteners.length&&function(){for(listeners=wax.bwlisteners,wax.bwlisteners=[],i=0;listeners>i;i++)listeners[i](x)}(),wax.bw=x,bw!=(bw=x)&&callback(x),void 0):bw},detector.add=function(){return auto&&bwTest(),this},-1==wax.bw?(wax.bwlisteners=wax.bwlisteners||[],wax.bwlisteners.push(detector.bw)):void 0!==wax.bw?detector.bw(wax.bw):detector.add(),detector},wax.formatter=function(x){var formatter={},f;if(x&&"string"==typeof x)try{eval("f = "+x)}catch(e){console&&console.log(e)}else f=x&&"function"==typeof x?x:function(){};return formatter.format=function(options,data){try{return wax.u.sanitize(f(options,data))}catch(e){console&&console.log(e)}},formatter},wax.gi=function(grid_tile,options){function resolveCode(key){return key>=93&&key--,key>=35&&key--,key-=32}options=options||{};var instance={},resolution=options.resolution||4,tileSize=options.tileSize||256;return instance.grid_tile=function(){return grid_tile},instance.getKey=function(x,y){return!grid_tile||!grid_tile.grid||0>y||0>x||Math.floor(y)>=tileSize||Math.floor(x)>=tileSize?void 0:resolveCode(grid_tile.grid[Math.floor(y/resolution)].charCodeAt(Math.floor(x/resolution)))},instance.gridFeature=function(x,y){var key=this.getKey(x,y),keys=grid_tile.keys;return keys&&keys[key]&&grid_tile.data[keys[key]]?grid_tile.data[keys[key]]:void 0},instance.tileFeature=function(x,y,tile_element){if(grid_tile){var offset=wax.u.offset(tile_element);return feature=this.gridFeature(x-offset.left,y-offset.top)}},instance},wax.gm=function(){function templatedGridUrl(template){return"string"==typeof template&&(template=[template]),function(url){if(url){var rx=new RegExp("/(\\d+)\\/(\\d+)\\/(\\d+)\\.[\\w\\._]+"),xyz=rx.exec(url);if(xyz)return template[parseInt(xyz[2],10)%template.length].replace(/\{z\}/g,xyz[1]).replace(/\{x\}/g,xyz[2]).replace(/\{y\}/g,xyz[3])}}}var tilejson,formatter,minZoom,maxZoom,resolution=4,manager={},gridUrl=function(url){return url?url.replace(/(\.png|\.jpg|\.jpeg)(\d*)/,".grid.json"):void 0};return manager.formatter=function(x){return arguments.length?(formatter=wax.formatter(x),manager):formatter},manager.template=function(x){return arguments.length?(formatter=wax.template(x),manager):formatter},manager.minZoom=function(x){return arguments.length?(minZoom=x,manager):minZoom},manager.maxZoom=function(x){return arguments.length?(maxZoom=x,manager):maxZoom},manager.gridUrl=function(x){return arguments.length?(gridUrl=x?"function"==typeof x?x:templatedGridUrl(x):function(){return null},manager):gridUrl},manager.getGrid=function(url,callback){var gurl=gridUrl(url);return formatter&&gurl?(wax.request.get(gurl,function(err,t){return err?callback(err,null):(callback(null,wax.gi(t,{formatter:formatter,resolution:resolution})),void 0)}),manager):callback(null,null)},manager.tilejson=function(x){return arguments.length?(x.template?manager.template(x.template):x.formatter?manager.formatter(x.formatter):formatter=void 0,manager.gridUrl(x.grids),manager.minZoom(x.gridminzoom||0),manager.maxZoom(x.gridmaxzoom||22),x.resolution&&(resolution=x.resolution),tilejson=x,manager):tilejson},manager},wax=wax||{},wax.hash=function(options){function getState(){return location.hash.substring(1)}function pushState(state){var l=window.location;l.replace(l.toString().replace(l.hash||/$/,"#"+state))}function parseHash(s){for(var args=s.split("/"),i=0;i<args.length;i++)if(args[i]=Number(args[i]),isNaN(args[i]))return!0;return args.length<3?!0:(3==args.length&&options.setCenterZoom(args),void 0)}function move(){var s1=options.getCenterZoom();s0!==s1&&(s0=s1,pushState(s0))}function stateChange(state){state!==s0&&parseHash(s0=state)&&move()}options=options||{};var s0,hash={},_move=wax.u.throttle(move,500);return hash.add=function(){return stateChange(getState()),options.bindChange(_move),hash},hash.remove=function(){return options.unbindChange(_move),hash},hash},wax=wax||{},wax.interaction=function(){function getTile(e){for(var g=grid(),i=0;i<g.length;i++)if(g[i][0]<e.y&&g[i][0]+256>e.y&&g[i][1]<e.x&&g[i][1]+256>e.x)return g[i][2];return!1}function killTimeout(){return _clickTimeout?(window.clearTimeout(_clickTimeout),_clickTimeout=null,!0):!1}function onMove(e){if(!_downLock){var pos=wax.u.eventoffset(e);interaction.screen_feature(pos,function(feature){feature?bean.fire(interaction,"on",{parent:parent(),data:feature,formatter:gm.formatter().format,e:e}):bean.fire(interaction,"off")})}}function dragEnd(){_downLock=!1}function onDown(e){_downLock=!0,_d=wax.u.eventoffset(e),"mousedown"===e.type?(bean.add(document.body,"click",onUp),bean.add(document.body,"mouseup",dragEnd)):"touchstart"===e.type&&1===e.touches.length&&(bean.fire(interaction,"off"),bean.add(e.srcElement,touchEnds))}function touchCancel(e){bean.remove(e.srcElement,touchEnds),_downLock=!1}function onUp(e){var evt={},pos=wax.u.eventoffset(e);_downLock=!1;for(var key in e)evt[key]=e[key];return bean.remove(document.body,"mouseup",onUp),bean.remove(e.srcElement,touchEnds),"touchend"===e.type?interaction.click(e,_d):Math.round(pos.y/tol)===Math.round(_d.y/tol)&&Math.round(pos.x/tol)===Math.round(_d.x/tol)&&(_clickTimeout?killTimeout():_clickTimeout=window.setTimeout(function(){_clickTimeout=null,interaction.click(evt,pos)},300)),onUp}var _d,grid,attach,detach,parent,map,gm=wax.gm(),interaction={},_downLock=!1,_clickTimeout=null,tol=4,defaultEvents={mousemove:onMove,touchstart:onDown,mousedown:onDown},touchEnds={touchend:onUp,touchmove:onUp,touchcancel:touchCancel};return interaction.click=function(e,pos){interaction.screen_feature(pos,function(feature){feature&&bean.fire(interaction,"on",{parent:parent(),data:feature,formatter:gm.formatter().format,e:e})})},interaction.screen_feature=function(pos,callback){var zoom=map.getZoom(),ignoreThisZoom=zoom<gm.minZoom()||zoom>gm.maxZoom(),tile=ignoreThisZoom?"undefined":getTile(pos);tile||callback(null),gm.getGrid(tile.src,function(err,g){if(err||!g)return callback(null);var feature=g.tileFeature(pos.x,pos.y,tile);callback(feature)})},interaction.attach=function(x){return arguments.length?(attach=x,interaction):attach},interaction.detach=function(x){return arguments.length?(detach=x,interaction):detach},interaction.map=function(x){return arguments.length?(map=x,attach&&attach(map),bean.add(parent(),defaultEvents),bean.add(parent(),"touchstart",onDown),interaction):map},interaction.grid=function(x){return arguments.length?(grid=x,interaction):grid},interaction.remove=function(){return detach&&detach(map),bean.remove(parent(),defaultEvents),bean.fire(interaction,"remove"),interaction},interaction.tilejson=function(x){return arguments.length?(gm.tilejson(x),interaction):gm.tilejson()},interaction.formatter=function(){return gm.formatter()},interaction.on=function(ev,fn){return bean.add(interaction,ev,fn),interaction},interaction.off=function(ev,fn){return bean.remove(interaction,ev,fn),interaction},interaction.gridmanager=function(x){return arguments.length?(gm=x,interaction):gm},interaction.parent=function(x){return parent=x,interaction},interaction};var wax=wax||{};wax.legend=function(){var element,container,legend={};return legend.element=function(){return container},legend.content=function(content){return arguments.length?(element.innerHTML=wax.u.sanitize(content),element.style.display="block",""===element.innerHTML&&(element.style.display="none"),legend):element.innerHTML},legend.add=function(){return container=document.createElement("div"),container.className="map-legends wax-legends",element=container.appendChild(document.createElement("div")),element.className="map-legend wax-legend",element.style.display="none",legend},legend.add()};var wax=wax||{};wax.location=function(){function on(o){if("mousemove"!==o.e.type&&o.e.type){var loc=o.formatter({format:"location"},o.data);loc&&(window.top.location.href=loc)}}var t={};return t.events=function(){return{on:on}},t};var wax=wax||{};wax.movetip={},wax.movetip=function(){function moveTooltip(e){var eo=wax.u.eventoffset(e);_tooltipOffset.height+eo.y>_contextOffset.top+_contextOffset.height&&_contextOffset.height>_tooltipOffset.height&&(eo.y-=_tooltipOffset.height,tooltip.className+=" flip-y"),_tooltipOffset.width+eo.x>_contextOffset.left+_contextOffset.width&&(eo.x-=_tooltipOffset.width,tooltip.className+=" flip-x"),tooltip.style.left=eo.x+"px",tooltip.style.top=eo.y+"px"}function getTooltip(feature){var tooltip=document.createElement("div");return tooltip.className="map-tooltip map-tooltip-0",tooltip.innerHTML=feature,tooltip}function hide(){tooltip&&(tooltip.parentNode.removeChild(tooltip),tooltip=null)}function on(o){var content;if(!popped){if("mousemove"!==o.e.type&&o.e.type){if(content=o.formatter({format:"teaser"},o.data),!content)return;hide();var tt=document.body.appendChild(getTooltip(content));tt.className+=" map-popup";var close=tt.appendChild(document.createElement("a"));close.href="#close",close.className="close",close.innerHTML="Close",popped=!0,tooltip=tt,_tooltipOffset=wax.u.offset(tooltip),_contextOffset=wax.u.offset(parent),moveTooltip(o.e),bean.add(close,"click touchend",function(e){e.stop(),hide(),popped=!1})}else{if(content=o.formatter({format:"teaser"},o.data),!content)return;hide(),parent.style.cursor="pointer",tooltip=document.body.appendChild(getTooltip(content))}tooltip&&(_tooltipOffset=wax.u.offset(tooltip),_contextOffset=wax.u.offset(parent),moveTooltip(o.e))}}function off(){parent.style.cursor="default",popped||hide()}var _tooltipOffset,_contextOffset,tooltip,parent,popped=!1,t={};return t.parent=function(x){return arguments.length?(parent=x,t):parent},t.events=function(){return{on:on,off:off}},t};var wax=wax||{};if(wax.request={cache:{},locks:{},promises:{},get:function(url,callback){if(this.cache[url])return callback(this.cache[url][0],this.cache[url][1]);
if(this.promises[url]=this.promises[url]||[],this.promises[url].push(callback),!this.locks[url]){var that=this;this.locks[url]=!0,reqwest({url:url+(~url.indexOf("?")?"&":"?")+"callback=?",type:"jsonp",success:function(data){that.locks[url]=!1,that.cache[url]=[null,data];for(var i=0;i<that.promises[url].length;i++)that.promises[url][i](that.cache[url][0],that.cache[url][1])},error:function(err){that.locks[url]=!1,that.cache[url]=[err,null];for(var i=0;i<that.promises[url].length;i++)that.promises[url][i](that.cache[url][0],that.cache[url][1])}})}}},wax.template=function(x){var template={};return template.format=function(options,data){var clone={};for(var key in data)clone[key]=data[key];return options.format&&(clone["__"+options.format+"__"]=!0),wax.u.sanitize(Mustache.to_html(x,clone))},template},!wax)var wax={};wax.tilejson=function(url,callback){reqwest({url:url+(~url.indexOf("?")?"&":"?")+"callback=?",type:"jsonp",success:callback,error:callback})};var wax=wax||{};wax.tooltip={},wax.tooltip=function(){function getTooltip(feature){var tooltip=document.createElement("div");return tooltip.className="map-tooltip map-tooltip-0 wax-tooltip",tooltip.innerHTML=feature,tooltip}function remove(){this.parentNode&&this.parentNode.removeChild(this)}function hide(){for(var _ct;_ct=tooltips.pop();)animate&&transitionEvent?(bean.add(_ct,transitionEvent,remove),_ct.className+=" map-fade"):_ct.parentNode&&_ct.parentNode.removeChild(_ct)}function on(o){var content;if("mousemove"!==o.e.type&&o.e.type){if(content=o.content||o.formatter({format:"full"},o.data),!content&&(o.e.type&&o.e.type.match(/touch/)&&(content=o.content||o.formatter({format:"teaser"},o.data)),!content))return;hide(),parent.style.cursor="pointer";var tt=parent.appendChild(getTooltip(content));tt.className+=" map-popup wax-popup";var close=tt.appendChild(document.createElement("a"));close.href="#close",close.className="close",close.innerHTML="Close",popped=!0,tooltips.push(tt),bean.add(close,"touchstart mousedown",function(e){e.stop()}),bean.add(close,"click touchend",function(e){e.stop(),hide(),popped=!1})}else if(!popped){if(content=o.content||o.formatter({format:"teaser"},o.data),!content||content==_currentContent)return;hide(),parent.style.cursor="pointer",tooltips.push(parent.appendChild(getTooltip(content))),_currentContent=content}}function off(){parent.style.cursor="default",_currentContent=null,popped||hide()}var _currentContent,transitionEvent,parent,popped=!1,animate=!1,t={},tooltips=[];return void 0!==document.body.style["-webkit-transition"]?transitionEvent="webkitTransitionEnd":void 0!==document.body.style.MozTransition&&(transitionEvent="transitionend"),t.parent=function(x){return arguments.length?(parent=x,t):parent},t.animate=function(x){return arguments.length?(animate=x,t):animate},t.events=function(){return{on:on,off:off}},t};var wax=wax||{};wax.u={offset:function(el){var width=el.offsetWidth||parseInt(el.style.width,10),height=el.offsetHeight||parseInt(el.style.height,10),doc_body=document.body,top=0,left=0,calculateOffset=function(el){if(el!==doc_body&&el!==document.documentElement){top+=el.offsetTop,left+=el.offsetLeft;var style=el.style.transform||el.style.WebkitTransform||el.style.OTransform||el.style.MozTransform||el.style.msTransform;if(style){var match;if(match=style.match(/translate\((.+)[px]?, (.+)[px]?\)/))top+=parseInt(match[2],10),left+=parseInt(match[1],10);else if(match=style.match(/translate3d\((.+)[px]?, (.+)[px]?, (.+)[px]?\)/))top+=parseInt(match[2],10),left+=parseInt(match[1],10);else if(match=style.match(/matrix3d\(([\-\d,\s]+)\)/)){var pts=match[1].split(",");top+=parseInt(pts[13],10),left+=parseInt(pts[12],10)}else(match=style.match(/matrix\(.+, .+, .+, .+, (.+), (.+)\)/))&&(top+=parseInt(match[2],10),left+=parseInt(match[1],10))}}};if("undefined"!=typeof el.getBoundingClientRect){var body=document.body,doc=el.ownerDocument.documentElement,clientTop=document.clientTop||body.clientTop||0,clientLeft=document.clientLeft||body.clientLeft||0,scrollTop=window.pageYOffset||doc.scrollTop,scrollLeft=window.pageXOffset||doc.scrollLeft,box=el.getBoundingClientRect();top=box.top+scrollTop-clientTop,left=box.left+scrollLeft-clientLeft}else{calculateOffset(el);try{for(;el=el.offsetParent;)calculateOffset(el)}catch(e){}}top+=doc_body.offsetTop,left+=doc_body.offsetLeft,top+=doc_body.parentNode.offsetTop,left+=doc_body.parentNode.offsetLeft;var htmlComputed=document.defaultView?window.getComputedStyle(doc_body.parentNode,null):doc_body.parentNode.currentStyle;return doc_body.parentNode.offsetTop===parseInt(htmlComputed.marginTop,10)||isNaN(parseInt(htmlComputed.marginTop,10))||(top+=parseInt(htmlComputed.marginTop,10),left+=parseInt(htmlComputed.marginLeft,10)),{top:top,left:left,height:height,width:width}},$:function(x){return"string"==typeof x?document.getElementById(x):x},eventoffset:function(e){return e||(e=window.event),e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:e.clientX||e.clientY?{x:e.clientX,y:e.clientY}:e.touches&&1===e.touches.length?{x:e.touches[0].pageX,y:e.touches[0].pageY}:void 0},limit:function(func,wait,debounce){var timeout;return function(){var context=this,args=arguments,throttler=function(){timeout=null,func.apply(context,args)};debounce&&clearTimeout(timeout),(debounce||!timeout)&&(timeout=setTimeout(throttler,wait))}},throttle:function(func,wait){return this.limit(func,wait,!1)},sanitize:function(content){function urlX(url){return/^(https?:\/\/|data:image)/.test(url)?url:void 0}function idX(id){return id}return content?html_sanitize(content,urlX,idX):""}},wax=wax||{},wax.g=wax.g||{},wax.g.attribution=function(map,tilejson){tilejson=tilejson||{};var a,attribution={};return attribution.element=function(){return a.element()},attribution.appendTo=function(elem){return wax.u.$(elem).appendChild(a.element()),this},attribution.init=function(){return a=wax.attribution(),a.content(tilejson.attribution),a.element().className="map-attribution map-g",this},attribution.init()},wax=wax||{},wax.g=wax.g||{},wax.g.bwdetect=function(map,options){options=options||{};var lowpng=options.png||".png128",lowjpg=options.jpg||".jpg70";if(!map.mapTypes["mb-low"]){for(var mb=map.mapTypes.mb,tilejson={tiles:[],scheme:mb.options.scheme,blankImage:mb.options.blankImage,minzoom:mb.minZoom,maxzoom:mb.maxZoom,name:mb.name,description:mb.description},i=0;i<mb.options.tiles.length;i++)tilejson.tiles.push(mb.options.tiles[i].replace(".png",lowpng).replace(".jpg",lowjpg));m.mapTypes.set("mb-low",new wax.g.connector(tilejson))}return wax.bwdetect(options,function(bw){map.setMapTypeId(bw?"mb":"mb-low")})},wax=wax||{},wax.g=wax.g||{},wax.g.hash=function(map){return wax.hash({getCenterZoom:function(){var center=map.getCenter(),zoom=map.getZoom(),precision=Math.max(0,Math.ceil(Math.log(zoom)/Math.LN2));return[zoom.toFixed(2),center.lat().toFixed(precision),center.lng().toFixed(precision)].join("/")},setCenterZoom:function(args){map.setCenter(new google.maps.LatLng(args[1],args[2])),map.setZoom(args[0])},bindChange:function(fn){google.maps.event.addListener(map,"idle",fn)},unbindChange:function(fn){google.maps.event.removeListener(map,"idle",fn)}})},wax=wax||{},wax.g=wax.g||{},wax.g.interaction=function(){function setdirty(){dirty=!0}function grid(){if(!dirty&&_grid)return _grid;_grid=[];var zoom=map.getZoom();wax.u.offset(map.getDiv());var get=function(mapType){if(mapType&&mapType.interactive)for(var key in mapType.cache)if(key.split("/")[0]==zoom){var tileOffset=wax.u.offset(mapType.cache[key]);_grid.push([tileOffset.top,tileOffset.left,mapType.cache[key]])}};for(var i in map.mapTypes)get(map.mapTypes[i]);return map.overlayMapTypes.forEach(get),_grid}function attach(x){return arguments.length?(map=x,tileloadListener=google.maps.event.addListener(map,"tileloaded",setdirty),idleListener=google.maps.event.addListener(map,"idle",setdirty),void 0):map}function detach(){tileloadListener&&google.maps.event.removeListener(tileloadListener),idleListener&&google.maps.event.removeListener(idleListener)}var _grid,map,dirty=!1,tileloadListener=null,idleListener=null;return wax.interaction().attach(attach).detach(detach).parent(function(){return map.getDiv()}).grid(grid)},wax=wax||{},wax.g=wax.g||{},wax.g.legend=function(map,tilejson){tilejson=tilejson||{};var l,legend={};return legend.add=function(){return l=wax.legend().content(tilejson.legend||""),legend},legend.element=function(){return l.element()},legend.appendTo=function(elem){return wax.u.$(elem).appendChild(l.element()),legend},legend.add()};var wax=wax||{};wax.g=wax.g||{},wax.g.connector=function(options){options=options||{},this.options={tiles:options.tiles,scheme:options.scheme||"xyz",blankImage:options.blankImage||"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},this.minZoom=options.minzoom||0,this.maxZoom=options.maxzoom||22,this.name=options.name||"",this.description=options.description||"",this.interactive=!0,this.tileSize=new google.maps.Size(256,256),this.cache={}},wax.g.connector.prototype.getTile=function(coord,zoom){var key=zoom+"/"+coord.x+"/"+coord.y;if(!this.cache[key]){var img=this.cache[key]=new Image(256,256);zoom<this.minZoom||zoom>this.maxZoom?(this.cache[key].src=this.options.blankImage,this.cache[key].style.display="none"):this.cache[key].src=this.getTileUrl(coord,zoom),this.cache[key].setAttribute("gTileKey",key),this.cache[key].onerror=function(){img.style.display="none"}}return this.cache[key]},wax.g.connector.prototype.releaseTile=function(tile){var key=tile.getAttribute("gTileKey");this.cache[key]&&delete this.cache[key],tile.parentNode&&tile.parentNode.removeChild(tile)},wax.g.connector.prototype.getTileUrl=function(coord,z){var mod=Math.pow(2,z),y="tms"===this.options.scheme?mod-1-coord.y:coord.y,x=coord.x%mod;return x=0>x?coord.x%mod+mod:x,0>y?this.options.blankImage:this.options.tiles[parseInt(x+y,10)%this.options.tiles.length].replace(/\{z\}/g,z).replace(/\{x\}/g,x).replace(/\{y\}/g,y)},function(){/**
 * iNaturalist map object
 * Copyright (c) iNaturalist, 2007-2008
 * 
 * @created: 2008-01-01
 * @updated: 2008-04-12
 * @author: n8agrin
 * @author: kueda
 */
if("undefined"==typeof google||"undefined"==typeof google.maps)throw"The Google Maps libraries must be loaded to use the iNaturalist Map extensions.";var deselectText=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()};google.maps.Marker.prototype.observation_id=null,google.maps.Map.prototype.observations={},google.maps.Map.prototype.places={},google.maps.Map.prototype.lastUnsavedMarker=null,google.maps.Map.prototype.infoWindow=null,google.maps.Map.prototype.createMarker=function(lat,lng,options){return options=options||{},options.position=new google.maps.LatLng(lat,lng),new google.maps.Marker(options)},google.maps.Map.prototype.removeMarker=function(marker){google.maps.event.clearInstanceListeners(marker),this.removeOverlay(marker)},google.maps.Map.prototype.addNewCenteredMarker=function(options){return this.addNewUnsavedMarker(this.getCenter().lat(),this.getCenter().lng(),options)},google.maps.Map.prototype.addNewUnsavedMarker=function(lat,lng,options){return this.removeLastUnsavedMarker(),this.lastUnsavedMarker=this.createMarker(lat,lng,options),this.lastUnsavedMarker.setMap(this),this.lastUnsavedMarker},google.maps.Map.prototype.removeLastUnsavedMarker=function(){return this.lastUnsavedMarker?(this.removeMarker(this.lastUnsavedMarker),this.lastUnsavedMarker=null,!0):!1},google.maps.Map.prototype.addObservation=function(observation,options){options=options||{};var lat=observation.private_latitude||observation.latitude,lon=observation.private_longitude||observation.longitude;if(!lat||!lon)return!1;options.icon||(options.icon=iNaturalist.Map.createObservationIcon({observation:observation}));var marker=this.createMarker(lat,lon,options);this.observations[observation.id]=marker,("undefined"==typeof options.clickable||0!=options.clickable)&&(marker.message=this.buildObservationInfoWindow(observation),google.maps.event.addListener(marker,"click",this.openInfoWindow));var bounds=this.getObservationBounds();if(bounds.extend(new google.maps.LatLng(lat,lon)),this.setObservationBounds(bounds),marker.setMap(this),observation.marker=marker,options.showAccuracy&&(observation.coordinates_obscured||observation.positional_accuracy&&observation.positional_accuracy>0)){var accuracy=parseInt(observation.positional_accuracy)||0;if(observation.coordinates_obscured&&(accuracy+=1e4),0==accuracy)return;var iconicTaxonName=observation.iconic_taxon_name;!iconicTaxonName&&observation.iconic_taxon&&(iconicTaxonName=observation.iconic_taxon.name);var color=iconicTaxonName?iNaturalist.Map.ICONIC_TAXON_COLORS[iconicTaxonName]:"#333333",circle=new google.maps.Circle({strokeColor:color,strokeOpacity:.8,strokeWeight:2,fillColor:color,fillOpacity:.35,map:this,center:marker.getPosition(),radius:accuracy});observation._circle=circle,google.maps.event.addListener(this,"zoom_changed",function(){var mapBounds=this.getBounds(),circleBounds=circle.getBounds();circleBounds.contains(mapBounds.getNorthEast())&&circleBounds.contains(mapBounds.getSouthWest())?circle.setVisible(!1):circle.setVisible(!0)})}return observation},google.maps.Map.prototype.removeObservation=function(observation){this.removeMarker(this.observations[observation.id]),this.observations[observation.id]&&this.observations[observation.id].setMap(null),delete this.observations[observation.id]},google.maps.Map.prototype.addObservations=function(observations,options){var map=this;$.each(observations,function(){map.addObservation(this,options)})},google.maps.Map.prototype.removeObservations=function(observations){var map=this;"undefined"==typeof observations?$.each(map.observations,function(k,v){map.removeMarker(v),v.setMap(null),delete map.observations[k],delete map.observationBounds}):$.each(observations,function(){map.removeObservation(this)})},google.maps.Map.prototype.getObservationBounds=function(){return this.observationBounds||(this.observationBounds=new google.maps.LatLngBounds),this.observationBounds},google.maps.Map.prototype.setObservationBounds=function(bounds){this.observationBounds=bounds},google.maps.Map.prototype.zoomToObservations=function(){this.fitBounds(this.getObservationBounds())},google.maps.Map.prototype.addPlaces=function(places){for(var i=places.length-1;i>=0;i--)this.addPlace(places[i])},google.maps.Map.prototype.addPlace=function(place,options){if("undefined"==typeof options)var options={};"undefined"==typeof options.icon&&(options.icon=iNaturalist.Map.createPlaceIcon());var marker=this.createMarker(place.latitude,place.longitude,options);this.places[place.id]=marker;var placesLength=0;for(var key in this.places)placesLength+=1;if(1==placesLength&&null!=place.swlat&&""!=place.swlat)var bounds=new google.maps.LatLngBounds(new google.maps.LatLng(place.swlat,place.swlng),new google.maps.LatLng(place.nelat,place.nelng));else{var bounds=this.getPlaceBounds();place.swlat?(bounds.extend(new google.maps.LatLng(place.swlat,place.swlng)),bounds.extend(new google.maps.LatLng(place.nelat,place.nelng))):bounds.extend(new google.maps.LatLng(place.latitude,place.longitude))}return this.setPlaceBounds(bounds),marker.setMap(this),place.marker=marker,place},google.maps.Map.prototype.setPlace=function(place,options){if(options=options||{},place.swlat){var bounds=new google.maps.LatLngBounds(new google.maps.LatLng(place.swlat,place.swlng),new google.maps.LatLng(place.nelat,place.nelng));this.fitBounds(bounds)}else this.setCenter(new google.maps.LatLng(place.latitude,place.longitude))},google.maps.Map.prototype.removePlace=function(place){this.removeMarker(this.places[place.id]),delete this.places[place.id]},google.maps.Map.prototype.removePlaces=function(places){var map=this;"undefined"==typeof places?$.each(map.places,function(){map.removeMarker(this),delete this}):$.each(places,function(){map.removePlace(this)}),this.placeBounds=new google.maps.LatLngBounds},google.maps.Map.prototype.zoomToPlaces=function(){this.fitBounds(this.getPlaceBounds())},google.maps.Map.prototype.getPlaceBounds=function(){return"undefined"==typeof this.placeBounds&&(this.placeBounds=new google.maps.LatLngBounds),this.placeBounds},google.maps.Map.prototype.setPlaceBounds=function(bounds){this.placeBounds=bounds},google.maps.Map.prototype.openInfoWindow=function(){iNaturalist.Map.infowWindow=iNaturalist.Map.infowWindow||new google.maps.InfoWindow,iNaturalist.Map.infowWindow.setContent(this.message),iNaturalist.Map.infowWindow.open(this.map,this)},google.maps.Map.prototype.buildObservationInfoWindow=function(observation){var existing=document.getElementById("observation-"+observation.id);if("undefined"!=typeof existing&&null!=existing){var infowinobs=$(existing).clone().get(0);$(infowinobs).find(".details").show();var wrapper=$('<div class="compact mini infowindow observations"></div>').append(infowinobs);return $(wrapper).get(0)}var photoURL,wrapper=$('<div class="observation"></div>');return"undefined"!=typeof observation.image_url&&null!=observation.image_url?photoURL=observation.image_url:"undefined"!=typeof observation.obs_image_url&&null!=observation.obs_image_url?photoURL=observation.obs_image_url:"undefined"!=typeof observation.photos&&observation.photos.length>0&&(photoURL=observation.photos[0].square_url),photoURL&&wrapper.append($('<img width="75" height="75"></img>').attr("src",photoURL).addClass("left")),wrapper.append($('<div class="readable attribute inlineblock"></div>').append($('<a href="/observations/'+observation.id+'"></a>').append(observation.species_guess))),observation.user?wrapper.append(", by ",$('<a href="/people/'+observation.user.login+'"></a>').append(observation.user.login)):"undefined"!=typeof observation.identifications&&observation.identifications.length>0&&"undefined"!=typeof observation.identifications[0].user&&wrapper.append(", by ",$('<a href="/people/'+observation.identifications[0].user.login+'"></a>').append(observation.identifications[0].user.login)),"undefined"!=typeof observation.short_description&&null!=observation.short_description?wrapper.append($('<div class="description"></div>').append(observation.short_description)):wrapper.append($('<div class="description"></div>').append(observation.description)),wrapper=$('<div class="compact observations mini infowindow"></div>').append(wrapper),wrapper.get(0)},google.maps.Map.prototype.showAllObsOverlay=function(){if("undefined"==typeof this._allObsOverlay){var myCopyright=new google.maps.CopyrightCollection,allObsLyr=new ObservationsTileLayer(myCopyright,0,18,{isPNG:!0,tileUrlTemplate:this._observationsTileServer+"/{Z}/{X}/{Y}.png"});this._allObsOverlay=new google.maps.TileLayerOverlay(allObsLyr);var baseIcon=new google.maps.MarkerImage;baseIcon.size=new google.maps.Size(20,20),baseIcon.anchor=new google.maps.Point(10,10),this._allObsMarker=new google.maps.Marker(new google.maps.LatLng(35,-90),{icon:baseIcon}),this._allObsMarker.setVisible(!1),google.maps.event.addListener(this._allObsMarker,"click",function(){var observation=this._observation,maxContentDiv=$('<div class="observations mini maxinfowindow"></div>').append($('<div class="loading status">'+I18n.t("loading")+"</div>")).get(0);this.openInfoWindowHtml(map.buildObservationInfoWindow(observation),{maxContent:maxContentDiv,maxTitle:"More about this observation"});var infoWindow=map.getInfoWindow();google.maps.event.addListener(infoWindow,"maximizeclick",function(){google.maps.DownloadUrl("/observations/"+observation.id+"?partial=observation",function(data){maxContentDiv.innerHTML=data,$(maxContentDiv).find(".details").show(),"undefined"!=typeof $.jqm&&$("#modal_image_box").jqmAddTrigger(".maxinfowindow a.modal_image_link")})})}),this._allObsMarker.map=map}this._allObsOverlay.map=map,this._mouseMoveListenerHandle=google.maps.event.addListener(map,"mousemove",this._mouseMoveListener)},google.maps.Map.prototype.hideAllObsOverlay=function(){"undefined"!=typeof this._allObsOverlay&&(this.removeOverlay(this._allObsOverlay),google.maps.event.removeListener(this._mouseMoveListenerHandle))},google.maps.Map.prototype._mouseMoveListener=function(e){e.latLng;var zoom=this.getZoom(),mousePx=e.pixel,tileKey=iNaturalist.Map.obsTilePointsURL(Math.floor(mousePx.x/256),Math.floor(mousePx.y/256),zoom);if(window.tilePoints=window.tilePoints||{},"undefined"!=typeof window.tilePoints[tileKey]&&0!=window.tilePoints[tileKey].length)for(var observations=window.tilePoints[tileKey],i=observations.length-1;i>=0;i--){var obsPx=G_NORMAL_MAP.getProjection().fromLatLngToPixel(new google.maps.LatLng(observations[i].latitude,observations[i].longitude),zoom),distance=Math.sqrt(Math.pow(mousePx.x-obsPx.x,2)+Math.pow(mousePx.y-obsPx.y,2));if(10>distance)return this._allObsMarker.setLatLng(new google.maps.LatLng(observations[i].latitude,observations[i].longitude)),this._allObsMarker._observation=observations[i],this._allObsMarker.show(),void 0;this._allObsMarker._observation=null,this._allObsMarker.setVisible(!1)}},"undefined"==typeof iNaturalist&&(this.iNaturalist={}),"undefined"==typeof iNaturalist.Map&&(this.iNaturalist.Map={}),iNaturalist.Map.createMap=function(options){options=options||{},options=$.extend({},{div:"map",center:new google.maps.LatLng(options.lat||0,options.lng||0),zoom:1,minZoom:1,mapTypeId:google.maps.MapTypeId.TERRAIN,streetViewControl:!1,observationsTileServer:"http://localhost:8000"},options);var map;if(map="string"==typeof options.div?new google.maps.Map(document.getElementById(options.div),options):new google.maps.Map(options.div,options),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(new iNaturalist.FullScreenControl(map)),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(new iNaturalist.DragDropShapeControl(map)),map._observationsTileServer=options.observationsTileServer,options.bounds)if("function"==typeof options.bounds.getCenter)map.setBounds(options.bounds);else{var bounds=new google.maps.LatLngBounds(new google.maps.LatLng(options.bounds.swlat,options.bounds.swlng),new google.maps.LatLng(options.bounds.nelat,options.bounds.nelng));map.fitBounds(bounds)}return map},iNaturalist.Map.createPlaceIcon=function(options){var options=options||{},iconPath="http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_";iconPath+=options.color?options.color:"DeepPink",options.character&&(iconPath+="_"+options.character),iconPath+=".png";var place=new google.maps.MarkerImage(iconPath);return place.size=new google.maps.Size(20,20),place.anchor=new google.maps.Point(10,10),place},iNaturalist.Map.createObservationIcon=function(options){if("undefined"==typeof options)var options={};var iconPath;if(options.observation){var iconSet=options.observation.coordinates_obscured?"STEMLESS_ICONS":"ICONS",iconicTaxonIconsSet=options.observation.coordinates_obscured?"STEMLESS_ICONIC_TAXON_ICONS":"ICONIC_TAXON_ICONS",iconicTaxonName=options.observation.iconic_taxon_name;return!iconicTaxonName&&options.observation.iconic_taxon&&(iconicTaxonName=options.observation.iconic_taxon.name),iconPath=iconicTaxonName?iNaturalist.Map[iconicTaxonIconsSet][iconicTaxonName]:iNaturalist.Map[iconSet].unknown34}return iconPath="http://natusfera.gbif.es/assets/mapMarkers/mm_34_",iconPath+=options.stemless?"stemless_":"",iconPath+=options.color||"HotPink",iconPath+=options.character?"_"+options.character:"",iconPath+=".png"},iNaturalist.Map.obsTilePointsURL=function(x,y,zoom){return"/observations/tile_points/"+zoom+"/"+x+"/"+y+".json"},iNaturalist.Map.buildObservationsMapType=function(map){var tileUrlTemplate=map._observationsTileServer?map._observationsTileServer+"/{Z}/{X}/{Y}.png":"http://localhost:8000/{Z}/{X}/{Y}.png";return new google.maps.ImageMapType({getTileUrl:function(tilePoint,zoom){var tileUrl=tileUrlTemplate;return tileUrl=tileUrl.replace("{Z}",zoom).replace("{X}",tilePoint.x).replace("{Y}",tilePoint.y)},tileSize:new google.maps.Size(256,256),isPng:!0,name:"Observations"})},iNaturalist.Map.distanceInMeters=function(lat1,lon1,lat2,lon2){var earthRadius=6370997,degreesPerRadian=57.2958,dLat=(lat2-lat1)/degreesPerRadian,dLon=(lon2-lon1)/degreesPerRadian,lat1=lat1/degreesPerRadian,lat2=lat2/degreesPerRadian,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=earthRadius*c;return d},iNaturalist.DragDropShapeControl=function(map){var controlDiv=$(document.createElement("div"));controlDiv[0].style.zIndex="1",controlDiv[0].style.padding="5px";var controlUI=$(document.createElement("div"));$(controlUI).addClass("ddUI"),$(controlUI).addClass("gmapv3control"),controlUI[0].style.textAlign="center",$(controlDiv).append(controlUI);var controlText=$(document.createElement("div"));return $(controlText).addClass("ddText"),$(controlText).addClass("gm-style"),controlText.prop("innerHTML","Drag shapefiles here!"),$(controlUI).append(controlText),zoomToShape=function(map){var bounds=new google.maps.LatLngBounds;map.data.forEach(function(feature){processPoints(feature.getGeometry(),bounds.extend,bounds)}),map.fitBounds(bounds)},processPoints=function(geometry,callback,thisArg){geometry instanceof google.maps.LatLng?callback.call(thisArg,geometry):geometry instanceof google.maps.Data.Point?callback.call(thisArg,geometry.get()):geometry.getArray().forEach(function(g){processPoints(g,callback,thisArg)})},loadGeoJsonString=function(geoString){var geojson=JSON.parse(geoString);map.data.addGeoJson(geojson),zoomToShape(map)},handleDragLeave=function(e){return e.stopPropagation(),e.preventDefault(),!1},handleDragOver=function(e){return e.stopPropagation(),e.preventDefault(),!1},handleDrop=function(e){e.preventDefault(),e.stopPropagation();var files=e.dataTransfer.files;if(files.length){for(var shape,file,db=null,i=0;file=files[i];i++)file.name.indexOf("dbf")>-1&&(db=file),file.name.indexOf("shp")>-1&&(shape=file);db&&shape?new Shapefile({shp:shape,dbf:db},function(data){var jsonString=JSON.stringify(data.geojson);loadGeoJsonString(jsonString)}):!db&&shape&&new Shapefile({shp:shape},function(data){var jsonString=JSON.stringify(data.geojson);loadGeoJsonString(jsonString)})}else{var plainText=e.dataTransfer.getData("text/plain");plainText&&loadGeoJsonString(plainText)}return!1},controlDiv[0].addEventListener("dragover",handleDragOver,!1),controlDiv[0].addEventListener("drop",handleDrop,!1),controlDiv[0].addEventListener("dragleave",handleDragLeave,!1),controlDiv[0]},iNaturalist.FullScreenControl=function(map){var controlDiv=document.createElement("DIV"),enter='<span class="ui-icon ui-icon-extlink">Full screen</span>',exit='<span class="ui-icon ui-icon-arrow-1-sw inlineblock"></span> '+I18n.t("exit_full_screen");controlDiv.style.padding="5px";var controlUI=$("<div></div>").html(enter).addClass("gmapv3control");controlDiv.appendChild(controlUI.get(0));var exitFullScreen=function(){var oldCenter=map.getCenter();$(this).html(enter).css("font-weight","normal"),$(map.getDiv()).removeClass("fullscreen"),google.maps.event.trigger(map,"resize"),map.setCenter(oldCenter)};window.fullscreenEscapeHandler=function(e){27===e.keyCode&&controlUI.click(),$(document).unbind("keyup",window.fullscreenEscapeHandler)};var enterFullScreen=function(){var oldCenter=map.getCenter();$(this).html(exit).css("font-weight","bold"),$(map.getDiv()).addClass("fullscreen"),google.maps.event.trigger(map,"resize"),map.setCenter(oldCenter),$(document).bind("keyup",window.fullscreenEscapeHandler)};return controlUI.toggle(enterFullScreen,exitFullScreen),controlDiv},iNaturalist.OverlayControl=function(map,options){options=options||{};var controlDiv=options.div||document.createElement("DIV");controlDiv.style.padding="5px";var controlUI=$("<div>"+I18n.t("taxon_map.overlays")+"</div>").addClass("gmapv3control overlaycontrol"),controlUI=$('<div><span class="ui-icon inat-icon ui-icon-layers">'+I18n.t("taxon_map.overlays")+"</span></div>").addClass("gmapv3control overlaycontrol"),ul=$("<ul></ul>").addClass("inat-overlay").hide();if(controlUI.append(ul),controlUI.hover(function(){$(this).addClass("open"),$("ul",this).show(),$(this).parent().css("z-index",1)},function(){$(this).removeClass("open"),$("ul",this).hide(),$(this).parent().css("z-index",0)}),controlDiv.appendChild(controlUI.get(0)),this.div=controlDiv,this.map=map,map.overlays)for(var i=0;i<map.overlays.length;i++)this.addOverlay(map.overlays[i]);return this},iNaturalist.OverlayControl.prototype.addWindshaftOverlayControl=function(layers,options){if(_.isArray(layers)&&0!==layers.length){var map=this.map,ul=$("ul",this.div),id="layer_"+layers[0].layerID,title=options.title||"Layer",description=options.description,checkbox=$("<input type='checkbox'/>"),label=$("<label/>").attr("for",id).html(title),li=$("<li/>");checkbox.attr("id",id).attr("name",title).attr("checked",!options.disabled),li.append(checkbox,label),checkbox.click(function(){var checked=this.checked;_.each(layers,function(layerData){map.overlayMapTypes.setAt(layerData.layerID-1,checked?layerData.layer:null)})}),description&&li.append($("<div/>").addClass("small meta").html(description)),ul.append(li),map._overlayControlDisplayed||(map.controls[google.maps.ControlPosition.TOP_RIGHT].push(map._overlayControl.div),map._overlayControlDisplayed=!0)}},iNaturalist.OverlayControl.prototype.addOverlay=function(lyr){var map=this.map,ul=$("ul",this.div);name=lyr.name,id=lyr.id||name,overlay=lyr.overlay,checkbox=$('<input type="checkbox"></input>'),label=$("<label></label>").attr("for",id).html(name),li=$("<li></li>"),checkbox.attr("id",id).attr("name",name).attr("checked",overlay.getMap()),checkbox.click(function(){var name=$(this).attr("name"),overlay=map.getOverlay(name).overlay;overlay.setMap(overlay.getMap()?null:map)}),li.append(checkbox,label),lyr.description&&li.append($("<div></div>").addClass("small meta").html(lyr.description)),ul.append(li)},google.maps.Map.prototype.addOverlay=function(name,overlay,options){options=options||{},this.overlays=this.overlays||[];var overlayOpts={name:name,overlay:overlay,id:options.id,description:options.description};this.overlays.push(overlayOpts),overlay.setMap&&!options.hidden&&overlay.setMap(this),this._overlayControl&&this._overlayControl.addOverlay(overlayOpts)},google.maps.Map.prototype.removeOverlay=function(name){if(this.overlays)for(var i=0;i<this.overlays.length;i++)this.overlays[i].name==name&&(this.overlays[i].overlay.setMap(null),this.overlays.splice(i))},google.maps.Map.prototype.getOverlay=function(name){if(this.overlays)for(var i=0;i<this.overlays.length;i++)if(this.overlays[i].name==name)return this.overlays[i]},google.maps.Map.prototype.addPlaceLayer=function(options){this.setTilt(0);var options=options||{},tiles_url=options.tiles_url||"http://193.146.75.173:4000",placeTileUrl=tiles_url+"/places/"+options.place.id+"/{z}/{x}/{y}.png",tilejson={tiles:[placeTileUrl]};return this.addLayerAndControl(tilejson,_.extend(options,{description:options.place.name}))},google.maps.Map.prototype.addTaxonRangeLayer=function(options){this.setTilt(0);var options=options||{},tiles_url=options.tiles_url||"http://193.146.75.173:4000",rangeTileUrl=tiles_url+"/taxon_ranges/"+options.taxon.id+"/{z}/{x}/{y}.png",tilejson={tiles:[rangeTileUrl]};return this.addLayerAndControl(tilejson,options)},google.maps.Map.prototype.addLayerAndControl=function(tilejson,options){options=options||{};var layer=new wax.g.connector(tilejson),layerID=this.overlayMapTypes.push(layer);return this._overlayControl&&this._overlayControl.addWindshaftOverlayControl([{layer:layer,layerID:layerID}],options),layerID},google.maps.Map.prototype.addObservationsLayer=function(options){this.setTilt(0),options.color&&(options.grid_color=null,options.point_color=null);var options=options||{},tiles_url=options.tiles_url||"http://193.146.75.173:4000",gridTileUrl=tiles_url+"/observations/grid/{z}/{x}/{y}.png",pointTileUrl=tiles_url+"/observations/points/{z}/{x}/{y}.png",gridmaxzoom=options.gridmaxzoom||9,gridParamKeys=["taxon_id","user_id","place_id","project_id","ttl","color","opacity","border_opacity"],pointParamKeys=gridParamKeys.concat(["observation_id"]),gridParams={},pointParams={};_.each(options,function(value,key){gridKey=key.replace("grid_",""),pointKey=key.replace("point_",""),_.contains(gridParamKeys,gridKey)&&(gridParams[gridKey]=value),_.contains(pointParamKeys,pointKey)&&(pointParams[pointKey]=value)}),gridParams&&(gridTileUrl+="?"+$.param(gridParams)),pointParams&&(pointTileUrl+="?"+$.param(pointParams)),gridLayer=this.addTileLayer(gridTileUrl,{maxzoom:gridmaxzoom,interactivity:!1,disabled:options.disabled}),pointLayer=this.addTileLayer(pointTileUrl,{interactivity:options.interactivity===!1?!1:"id,taxon_id,species_guess,latitude,longitude,positional_accuracy,captive,quality_grade,iconic_taxon_id",minzoom:gridmaxzoom+1,gridminzoom:gridmaxzoom+1,disabled:options.disabled}),this._overlayControl&&this._overlayControl.addWindshaftOverlayControl([gridLayer,pointLayer],options)},google.maps.Map.prototype.getInfoWindow=function(){return this.infoWindow||(this.infoWindow=new google.maps.InfoWindow({content:$('<div class="loading status">'+I18n.t("loading")+"</div>").get(0),position:new google.maps.LatLng(0,0)})),this.infoWindow},google.maps.Map.prototype.addTileLayer=function(tileURL,options){var options=options||{};options.interactivity,options.interactivity&&(options.grids=[this.interactivityURL(tileURL,options.interactivity)]);var tilejson=$.extend(!0,{},{tiles:[tileURL],template:"{{species_guess}}"},options),layer=new wax.g.connector(tilejson),layerID=this.overlayMapTypes.push(layer);return options.disabled&&this.overlayMapTypes.setAt(layerID-1,null),options.interactivity&&this.addTileInteractivity(tilejson),{layer:layer,layerID:layerID}},google.maps.Map.prototype.interactivityURL=function(tileURL,interactivity){return utfgridURL=tileURL.replace(/\.png/,".grid.json"),utfgridURL+=utfgridURL.indexOf("?")<0?"?":"&",utfgridURL+"interactivity="+interactivity},google.maps.Map.prototype.addTileInteractivity=function(tilejson){var map=this;wax.g.interaction().map(map).tilejson(tilejson).on({on:function(o){if(document.body.style.cursor="pointer","click"==o.e.type){if($(".gm-style-iw").parent().find(o.e.target).length>0)return!1;if(o.data.latitude){var latLng=new google.maps.LatLng(o.data.latitude,o.data.longitude);$.ajax({url:"/observations/"+o.data.id+".html?partial=cached_component",type:"GET",dataType:"html",beforeSend:function(){var iw=map.getInfoWindow();iw.position=latLng,iw.content=$('<div class="loading status">'+I18n.t("loading")+"</div>").get(0),iw.open(map),deselectText()},success:function(data){var iw=map.getInfoWindow();iw.position=latLng,iw.content=$('<div class="compact mini infowindow observations"></div>').append(data).get(0),iw.open(map),$(iw).focus(),deselectText()},error:function(jqXHR,textStatus){console.log(textStatus)}})}}else"mousemove"==o.e.type&&map.setOptions({draggableCursor:"pointer"})},off:function(){map.setOptions({draggableCursor:"url(http://maps.google.com/mapfiles/openhand.cur), move"})}})},iNaturalist.Map.ICONS={DodgerBlue34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_DodgerBlue.png"),DeepPink34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_DeepPink.png"),iNatGreen34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_iNatGreen.png"),OrangeRed34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_OrangeRed.png"),DarkMagenta34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_DarkMagenta.png"),unknown34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_unknown.png"),ChromistaBrown34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_ChromistaBrown.png")},iNaturalist.Map.STEMLESS_ICONS={DodgerBlue34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_DodgerBlue.png"),DeepPink34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_DeepPink.png"),iNatGreen34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_iNatGreen.png"),OrangeRed34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_OrangeRed.png"),DarkMagenta34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_DarkMagenta.png"),unknown34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_unknown.png"),ChromistaBrown34:new google.maps.MarkerImage("http://natusfera.gbif.es/assets/mapMarkers/mm_34_stemless_ChromistaBrown.png")},iNaturalist.Map.ICONIC_TAXON_ICONS={Protozoa:iNaturalist.Map.ICONS.DarkMagenta34,Animalia:iNaturalist.Map.ICONS.DodgerBlue34,Plantae:iNaturalist.Map.ICONS.iNatGreen34,Fungi:iNaturalist.Map.ICONS.DeepPink34,Amphibia:iNaturalist.Map.ICONS.DodgerBlue34,Reptilia:iNaturalist.Map.ICONS.DodgerBlue34,Aves:iNaturalist.Map.ICONS.DodgerBlue34,Mammalia:iNaturalist.Map.ICONS.DodgerBlue34,Actinopterygii:iNaturalist.Map.ICONS.DodgerBlue34,Mollusca:iNaturalist.Map.ICONS.OrangeRed34,Insecta:iNaturalist.Map.ICONS.OrangeRed34,Arachnida:iNaturalist.Map.ICONS.OrangeRed34,Chromista:iNaturalist.Map.ICONS.ChromistaBrown34},iNaturalist.Map.STEMLESS_ICONIC_TAXON_ICONS={Protozoa:iNaturalist.Map.STEMLESS_ICONS.DarkMagenta34,Animalia:iNaturalist.Map.STEMLESS_ICONS.DodgerBlue34,Plantae:iNaturalist.Map.STEMLESS_ICONS.iNatGreen34,Fungi:iNaturalist.Map.STEMLESS_ICONS.DeepPink34,Amphibia:iNaturalist.Map.STEMLESS_ICONS.DodgerBlue34,Reptilia:iNaturalist.Map.STEMLESS_ICONS.DodgerBlue34,Aves:iNaturalist.Map.STEMLESS_ICONS.DodgerBlue34,Mammalia:iNaturalist.Map.STEMLESS_ICONS.DodgerBlue34,Actinopterygii:iNaturalist.Map.STEMLESS_ICONS.DodgerBlue34,Mollusca:iNaturalist.Map.STEMLESS_ICONS.OrangeRed34,Insecta:iNaturalist.Map.STEMLESS_ICONS.OrangeRed34,Arachnida:iNaturalist.Map.STEMLESS_ICONS.OrangeRed34,Chromista:iNaturalist.Map.STEMLESS_ICONS.ChromistaBrown34},iNaturalist.Map.ICONIC_TAXON_COLORS={Protozoa:"#8B008B",Animalia:"#1E90FF",Plantae:"#73AC13",Fungi:"#FF1493",Amphibia:"#1E90FF",Reptilia:"#1E90FF",Aves:"#1E90FF",Mammalia:"#1E90FF",Actinopterygii:"#1E90FF",Mollusca:"#FF4500",Insecta:"#FF4500",Arachnida:"#FF4500",Chromista:"#993300"}}(),jQuery.url=function(){var segments={},parsed={},options={url:window.location,strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},parseUri=function(){str=decodeURI(options.url);for(var m=options.parser[options.strictMode?"strict":"loose"].exec(str),uri={},i=14;i--;)uri[options.key[i]]=m[i]||"";return uri[options.q.name]={},uri[options.key[12]].replace(options.q.parser,function($0,$1,$2){$1&&(uri[options.q.name][$1]=$2)}),uri},key=function(key){return parsed.length||setUp(),"base"==key?null!==parsed.port&&""!==parsed.port?parsed.protocol+"://"+parsed.host+":"+parsed.port+"/":parsed.protocol+"://"+parsed.host+"/":""===parsed[key]?null:parsed[key]},param=function(item){return parsed.length||setUp(),null===parsed.queryKey[item]?null:parsed.queryKey[item]},setUp=function(){parsed=parseUri(),getSegments()},getSegments=function(){var p=parsed.path;segments=[],segments=1==parsed.path.length?{}:("/"==p.charAt(p.length-1)?p.substring(1,p.length-1):path=p.substring(1)).split("/")};return{setMode:function(mode){return strictMode="strict"==mode?!0:!1,this},setUrl:function(newUri){return options.url=void 0===newUri?window.location:newUri,setUp(),this},segment:function(pos){return parsed.length||setUp(),void 0===pos?segments.length:""===segments[pos]||void 0===segments[pos]?null:segments[pos]},attr:key,param:param}}(),/*
 * jqModal - Minimalist Modaling with jQuery
 *   (http://dev.iceburg.net/jquery/jqModal/)
 *
 * Copyright (c) 2007,2008 Brice Burgess <bhb@iceburg.net>
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 * 
 * $Version: 07/06/2008 +r13
 */
function($){$.fn.jqm=function(o){var p={overlay:50,overlayClass:"jqmOverlay",closeClass:"jqmClose",trigger:".jqModal",ajax:F,ajaxText:"",target:F,modal:F,toTop:F,onShow:F,onHide:F,onLoad:F};return this.each(function(){return this._jqm?H[this._jqm].c=$.extend({},H[this._jqm].c,o):(s++,this._jqm=s,H[s]={c:$.extend(p,$.jqm.params,o),a:F,w:$(this).addClass("jqmID"+s),s:s},p.trigger&&$(this).jqmAddTrigger(p.trigger),void 0)})},$.fn.jqmAddClose=function(e){return hs(this,e,"jqmHide")},$.fn.jqmAddTrigger=function(e){return hs(this,e,"jqmShow")},$.fn.jqmShow=function(t){return this.each(function(){$.jqm.open(this._jqm,t)})},$.fn.jqmHide=function(t){return this.each(function(){$.jqm.close(this._jqm,t)})},$.jqm={hash:{},open:function(s,t){var h=H[s],c=h.c,cc="."+c.closeClass,z=parseInt(h.w.css("z-index")),z=z>0?z:3e3,o=$("<div></div>").css({height:"100%",width:"100%",position:"fixed",left:0,top:0,"z-index":z-1,opacity:c.overlay/100});if(h.a)return F;if(h.t=t,h.a=!0,h.w.css("z-index",z),c.modal?(A[0]||L("bind"),A.push(s)):c.overlay>0?h.w.jqmAddClose(o):o=F,h.o=o?o.addClass(c.overlayClass).prependTo("body"):F,ie6&&($("html,body").css({height:"100%",width:"100%"}),o)){o=o.css({position:"absolute"})[0];for(var y in{Top:1,Left:1})o.style.setExpression(y.toLowerCase(),"(_=(document.documentElement.scroll"+y+" || document.body.scroll"+y+"))+'px'")}if(c.ajax){var r=c.target||h.w,u=c.ajax,r="string"==typeof r?$(r,h.w):$(r),u="@"==u.substr(0,1)?$(t).attr(u.substring(1)):u;r.html(c.ajaxText).load(u,function(){c.onLoad&&c.onLoad.call(this,h),cc&&h.w.jqmAddClose($(cc,h.w)),e(h)})}else cc&&h.w.jqmAddClose($(cc,h.w));return c.toTop&&h.o&&h.w.before('<span id="jqmP'+h.w[0]._jqm+'"></span>').insertAfter(h.o),c.onShow?c.onShow(h):h.w.show(),e(h),F},close:function(s){var h=H[s];return h.a?(h.a=F,A[0]&&(A.pop(),A[0]||L("unbind")),h.c.toTop&&h.o&&$("#jqmP"+h.w[0]._jqm).after(h.w).remove(),h.c.onHide?h.c.onHide(h):(h.w.hide(),h.o&&h.o.remove()),F):F},params:{}};var s=0,H=$.jqm.hash,A=[],ie6=$.browser.msie&&"6.0"==$.browser.version,F=!1,i=$('<iframe src="javascript:false;document.write(\'\');" class="jqm"></iframe>').css({opacity:0}),e=function(h){ie6&&(h.o?h.o.html('<p style="width:100%;height:100%"/>').prepend(i):$("iframe.jqm",h.w)[0]||h.w.prepend(i)),f(h)},f=function(h){try{$(":input:visible",h.w)[0].focus()}catch(_){}},L=function(t){$()[t]("keypress",m)[t]("keydown",m)[t]("mousedown",m)},m=function(e){var h=H[A[A.length-1]],r=!$(e.target).parents(".jqmID"+h.s)[0];return r&&f(h),!r},hs=function(w,t,c){return w.each(function(){var s=this._jqm;$(t).each(function(){this[c]||(this[c]=[],$(this).click(function(){for(var i in{jqmShow:1,jqmHide:1})for(var s in this[i])H[this[i][s]]&&H[this[i][s]].w[i](this);return F})),this[c].push(s)})})}}(jQuery),$(document).ready(function(){$("#modal_image_box").jqm({closeClass:"close",ajax:"@data-photo-path",trigger:"a.modal_image_link",onShow:function(h){h.w.append($('<div class="loading status">Loading...</div>')),h.w.fadeIn(500),iNaturalist.modalCenter(h.w)},onLoad:function(h){iNaturalist.modalCenter(h.w)},onHide:function(h){h.w.fadeOut(500,function(){h.o.remove()})}})});var inatTaxonMap={};!function($){$.fn.taxonMap=function(options){options=options||{},$(this).each(function(){"fit"==options?inatTaxonMap.fit(this):inatTaxonMap.setup(this,options)})}}(jQuery),inatTaxonMap.setup=function(elt,options){var options=$.extend({},options);options.taxon=$(elt).data("taxon"),options.latitude=options.latitude||$(elt).data("latitude"),options.longitude=options.longitude||$(elt).data("longitude"),options.mapType=$(elt).data("map-type"),options.zoomLevel=parseInt($(elt).data("zoom-level")),options.gbifKmlUrl=$(elt).data("gbif-kml"),options.showRange=$(elt).data("show-range"),options.place=$(elt).data("place"),options.minX=$(elt).data("min-x"),options.minY=$(elt).data("min-y"),options.maxX=$(elt).data("max-x"),options.maxY=$(elt).data("max-y"),options.flagLetters=$(elt).data("flag-letters"),options.windshaftProjectID=$(elt).data("windshaft-project-id"),options.windshaftUserID=$(elt).data("windshaft-user-id"),options.observations=options.observations||$(elt).data("observations"),options.mapTypeControl=$(elt).data("map-type-control"),options.showAllLayer=options.showAllLayer||$(elt).data("show-all-layer")||!0,options.featuredLayerLabel=options.featuredLayerLabel||$(elt).data("featured-layer-label"),options.placeLayerLabel=options.placeLayerLabel||$(elt).data("place-layer-label"),options.taxonRangeLayerLabel=options.taxonRangeLayerLabel||$(elt).data("taxon-range-layer-label"),options.taxonRangeLayerDescription=options.taxonRangeLayerDescription||$(elt).data("taxon-range-layer-description"),options.allLayerLabel=options.allLayerLabel||$(elt).data("all-layer-label"),options.allLayerDescription=options.allLayerDescription||$(elt).data("all-layer-description"),options.observations&&(options.observations=_.map(options.observations,function(observation){return jQuery.parseJSON(observation)})),""===options.gbifKmlUrl&&(options.gbifKmlUrl=null),0===options.zoomLevel&&(options.zoomLevel=null),$(elt).data("taxonMapOptions",options),inatTaxonMap.setupGoogle(elt)},inatTaxonMap.fit=function(elt){inatTaxonMap.fitGoogle(elt)},inatTaxonMap.setupGoogle=function(elt){var options=$(elt).data("taxonMapOptions"),map=iNaturalist.Map.createMap({div:elt,mapTypeControl:options.mapTypeControl!==!1}),preserveViewport=options.preserveViewport;options.minX?(map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(options.minY,options.minX),new google.maps.LatLng(options.maxY,options.maxX))),preserveViewport=!0):((options.latitude||options.longitude)&&map.setCenter(new google.maps.LatLng(options.latitude||0,options.longitude||0)),options.zoomLevel&&map.setZoom(options.zoomLevel)),options.mapType&&map.setMapTypeId(options.mapType),map._overlayControl=new iNaturalist.OverlayControl(map),options.showAllLayer&&map.addObservationsLayer({title:options.allLayerLabel,description:options.allLayerDescription,disabled:"enabled"!==options.showAllLayer,ttl:86400}),options.showRange&&options.taxon&&map.addTaxonRangeLayer({taxon:options.taxon,title:options.taxonRangeLayerLabel,description:options.taxonRangeLayerDescription}),options.place&&map.addPlaceLayer({place:options.place,title:options.placeLayerLabel});var windshaftOptions={};options.taxon&&(windshaftOptions.taxon_id=options.taxon.id),options.windshaftUserID&&(windshaftOptions.user_id=options.windshaftUserID),options.windshaftProjectID&&(windshaftOptions.project_id=options.windshaftProjectID),_.isEmpty(windshaftOptions)||(options.observations&&(windshaftOptions.point_observation_id=_.map(options.observations,function(o){return o.id}).join(",")),windshaftOptions.title=options.featuredLayerLabel,map.addObservationsLayer(windshaftOptions)),inatTaxonMap.addObservationsToMap(options,map,preserveViewport),inatTaxonMap.addGBIFKml(options,map),preserveViewport||inatTaxonMap.fit(elt),$(elt).data("taxonMap",map)},inatTaxonMap.addGBIFKml=function(options,map){if(options.gbifKmlUrl){var gbifLyr=new google.maps.KmlLayer(options.gbifKmlUrl,{suppressInfoWindows:!0,preserveViewport:!0});map.addOverlay(I18n.t("taxon_map.gbif_occurrences"),gbifLyr,{id:"gbif-"+options.taxon.id,hidden:!0,description:I18n.t("taxon_map.it_may_take_google_a_while_to")+' <a target="_blank" href="'+options.gbifKmlUrl.replace(/&format=kml/,"")+'">'+I18n.t("taxon_map.data_url")+"</a>"}),google.maps.event.addListener(gbifLyr,"click",function(e){window.kmlInfoWindows||(window.kmlInfoWindows={});for(var k in window.kmlInfoWindows)window.kmlInfoWindows[k].close();var win=window.kmlInfoWindows[e.featureData.id];if(!win){var content=(e.featureData.description||"").replace(/(<a.+?>)<a.+?>(.+?)<\/a><\/a>/g,"$1$2</a>");content=content.replace(/&lt;\/a/g,""),content=content.replace(/&gt;/g,""),content=content.replace(/<\/a"/g,'"'),win=window.kmlInfoWindows[e.featureData.id]=new google.maps.InfoWindow({content:content,position:e.latLng,pixelOffset:e.pixelOffset})}return win.open(map),!1})}},inatTaxonMap.addObservationsToMap=function(options,map,preserveViewport){if(options.observations){var letter_counter=0,letters="ABCDEFGHIJKLMNOPQRSTUVWXYZ";if(iNaturalist.Map.createObservationIcon({color:"HotPink"}),iNaturalist.Map.createObservationIcon({color:"DeepPink"}),_.each(options.observations,function(o){var icon_div=$("#observation-"+o.id+" .icon").get(0);if(!(o.latitude&&o.longitude||o.private_latitude&&o.private_longitude)&&options.appendMarkerToList){var icon_img=$('<img src="http://natusfera.gbif.es/assets/mapMarkers/questionmarker.png"/>');return $(icon_div).text("").append(icon_img),void 0}if(observationOptions={clickable:options.clickable,showAccuracy:options.showAccuracy},options.flagLetters&&(observationOptions.icon=iNaturalist.Map.createObservationIcon({color:"HotPink",character:letters[letter_counter],stemless:o.coordinates_obscured})),map.addObservation(o,observationOptions),!o.map_scale&&o.positional_accuracy&&new google.maps.Circle({center:new google.maps.LatLng(o.latitude,o.longitude),radius:10*o.positional_accuracy}),options.appendMarkerToList&&o.marker){o.marker;var src=o.marker.getIcon();src.url&&(src=src.url);var icon_img=$("<img/>").attr("src",src).addClass("marker");$(icon_div).text("").append(icon_img),$(icon_img).click(function(){map.openInfoWindow.apply(o.marker)})}letter_counter++}),!preserveViewport)if(1===options.observations.length){o=options.observations[0];var center=new google.maps.LatLng(o.private_latitude||o.latitude,o.private_longitude||o.longitude);map.setCenter(center)}else map.zoomToObservations()}},inatTaxonMap.fitGoogle=function(elt){var options=$(elt).data("taxonMapOptions"),map=$(elt).data("taxonMap");if(map){if(options.minX)return map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(options.minY,options.minX),new google.maps.LatLng(options.maxY,options.maxX))),void 0;map.setCenter(new google.maps.LatLng(0,0)),map.setZoom(1)}},/*
jQuery Waypoints - v1.1.7
Copyright (c) 2011-2012 Caleb Troughton
Dual licensed under the MIT license and GPL license.
https://github.com/imakewebthings/jquery-waypoints/blob/master/MIT-license.txt
https://github.com/imakewebthings/jquery-waypoints/blob/master/GPL-license.txt
*/
function($,k,m,i){var e=$(i),g="waypoint.reached",b=function(o,n){o.element.trigger(g,n),o.options.triggerOnce&&o.element[k]("destroy")},h=function(p,o){if(!o)return-1;for(var n=o.waypoints.length-1;n>=0&&o.waypoints[n].element[0]!==p[0];)n-=1;return n},f=[],l=function(n){$.extend(this,{element:$(n),oldScroll:0,waypoints:[],didScroll:!1,didResize:!1,doScroll:$.proxy(function(){var q=this.element.scrollTop(),p=q>this.oldScroll,s=this,r=$.grep(this.waypoints,function(u){return p?u.offset>s.oldScroll&&u.offset<=q:u.offset<=s.oldScroll&&u.offset>q}),o=r.length;this.oldScroll&&q||$[m]("refresh"),this.oldScroll=q,o&&(p||r.reverse(),$.each(r,function(u,t){(t.options.continuous||u===o-1)&&b(t,[p?"down":"up"])}))},this)}),$(n).bind("scroll.waypoints",$.proxy(function(){this.didScroll||(this.didScroll=!0,i.setTimeout($.proxy(function(){this.doScroll(),this.didScroll=!1},this),$[m].settings.scrollThrottle))},this)).bind("resize.waypoints",$.proxy(function(){this.didResize||(this.didResize=!0,i.setTimeout($.proxy(function(){$[m]("refresh"),this.didResize=!1},this),$[m].settings.resizeThrottle))},this)),e.load($.proxy(function(){this.doScroll()},this))},j=function(n){var o=null;return $.each(f,function(p,q){return q.element[0]===n?(o=q,!1):void 0}),o},c={init:function(o,n){return this.each(function(){var q,u=$.fn[k].defaults.context,t=$(this);n&&n.context&&(u=n.context),$.isWindow(u)||(u=t.closest(u)[0]),q=j(u),q||(q=new l(u),f.push(q));var p=h(t,q),s=0>p?$.fn[k].defaults:q.waypoints[p].options,r=$.extend({},s,n);r.offset="bottom-in-view"===r.offset?function(){var v=$.isWindow(u)?$[m]("viewportHeight"):$(u).height();return v-$(this).outerHeight()}:r.offset,0>p?q.waypoints.push({element:t,offset:null,options:r}):q.waypoints[p].options=r,o&&t.bind(g,o),n&&n.handler&&t.bind(g,n.handler)}),$[m]("refresh"),this},remove:function(){return this.each(function(o,p){var n=$(p);$.each(f,function(r,s){var q=h(n,s);q>=0&&(s.waypoints.splice(q,1),s.waypoints.length||(s.element.unbind("scroll.waypoints resize.waypoints"),f.splice(r,1)))})})},destroy:function(){return this.unbind(g)[k]("remove")}},a={refresh:function(){$.each(f,function(r,s){var q=$.isWindow(s.element[0]),n=q?0:s.element.offset().top,p=q?$[m]("viewportHeight"):s.element.height(),o=q?0:s.element.scrollTop();$.each(s.waypoints,function(u,x){if(x){var t=x.options.offset,w=x.offset;if("function"==typeof x.options.offset)t=x.options.offset.apply(x.element);else if("string"==typeof x.options.offset){var v=parseFloat(x.options.offset);t=x.options.offset.indexOf("%")?Math.ceil(p*(v/100)):v}x.offset=x.element.offset().top-n+o-t,x.options.onlyOnScroll||(null!==w&&s.oldScroll>w&&s.oldScroll<=x.offset?b(x,["up"]):null!==w&&s.oldScroll<w&&s.oldScroll>=x.offset?b(x,["down"]):!w&&s.element.scrollTop()>x.offset&&b(x,["down"]))}}),s.waypoints.sort(function(u,t){return u.offset-t.offset})})},viewportHeight:function(){return i.innerHeight?i.innerHeight:e.height()},aggregate:function(){var n=$();return $.each(f,function(o,p){$.each(p.waypoints,function(q,r){n=n.add(r.element)})}),n}};$.fn[k]=function(n){return c[n]?c[n].apply(this,Array.prototype.slice.call(arguments,1)):"function"!=typeof n&&n?"object"==typeof n?c.init.apply(this,[null,n]):($.error("Method "+n+" does not exist on jQuery "+k),void 0):c.init.apply(this,arguments)},$.fn[k].defaults={continuous:!0,offset:0,triggerOnce:!1,context:i},$[m]=function(n){return a[n]?a[n].apply(this):a.aggregate()},$[m].settings={resizeThrottle:200,scrollThrottle:100},e.load(function(){$[m]("refresh")})}(jQuery,"waypoint","waypoints",window),/*
 * jQuery BBQ: Back Button & Query Library - v1.2.1 - 2/17/2010
 * http://benalman.com/projects/jquery-bbq-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
function($,p){function E(F){return"string"==typeof F}function B(G){var F=m.call(arguments,1);return function(){return G.apply(this,F.concat(m.call(arguments)))}}function n(F){return F.replace(/^[^#]*#?(.*)$/,"$1")}function o(F){return F.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function f(H,M,F,I,G){var O,L,K,N,J;return I!==i?(K=F.match(H?/^([^#]*)\#?(.*)$/:/^([^#?]*)\??([^#]*)(#?.*)/),J=K[3]||"",2===G&&E(I)?L=I.replace(H?w:x,""):(N=l(K[2]),I=E(I)?l[H?D:A](I):I,L=2===G?I:1===G?$.extend({},I,N):$.extend({},N,I),L=a(L),H&&(L=L.replace(h,r))),O=K[1]+(H?"#":L||!K[1]?"?":"")+L+J):O=M(F!==i?F:p[g][k]),O}function z(H,F,G){return F===i||"boolean"==typeof F?(G=F,F=a[H?D:A]()):F=E(F)?F.replace(H?w:x,""):F,l(F,G)}function s(I,G,H,F){return E(H)||"object"==typeof H||(F=H,H=G,G=i),this.each(function(){var L=$(this),J=G||j()[(this.nodeName||"").toLowerCase()]||"",K=J&&L.attr(J)||"";L.attr(J,a[I](K,H,F))})}var i,c,l,v,q,u,j,h,m=Array.prototype.slice,r=decodeURIComponent,a=$.param,b=$.bbq=$.bbq||{},e=$.event.special,d="hashchange",A="querystring",D="fragment",y="elemUrlAttr",g="location",k="href",t="src",x=/^.*\?|#.*$/g,w=/^.*\#/,C={};a[A]=B(f,0,o),a[D]=c=B(f,1,n),c.noEscape=function(G){G=G||"";var F=$.map(G.split(""),encodeURIComponent);h=new RegExp(F.join("|"),"g")},c.noEscape(",/"),$.deparam=l=function(I,F){var H={},G={"true":!0,"false":!1,"null":null};return $.each(I.replace(/\+/g," ").split("&"),function(L,Q){var J,K=Q.split("="),P=r(K[0]),O=H,M=0,R=P.split("]["),N=R.length-1;if(/\[/.test(R[0])&&/\]$/.test(R[N])?(R[N]=R[N].replace(/\]$/,""),R=R.shift().split("[").concat(R),N=R.length-1):N=0,2===K.length)if(J=r(K[1]),F&&(J=J&&!isNaN(J)?+J:"undefined"===J?i:G[J]!==i?G[J]:J),N)for(;N>=M;M++)P=""===R[M]?O.length:R[M],O=O[P]=N>M?O[P]||(R[M+1]&&isNaN(R[M+1])?{}:[]):J;else $.isArray(H[P])?H[P].push(J):H[P]=H[P]!==i?[H[P],J]:J;else P&&(H[P]=F?i:"")}),H},l[A]=B(z,0),l[D]=v=B(z,1),$[y]||($[y]=function(F){return $.extend(C,F)})({a:k,base:k,iframe:t,img:t,input:t,form:"action",link:k,script:t}),j=$[y],$.fn[A]=B(s,A),$.fn[D]=B(s,D),b.pushState=q=function(I,F){E(I)&&/^#/.test(I)&&F===i&&(F=2);var H=I!==i,G=c(p[g][k],H?I:{},H?F:2);p[g][k]=G+(/#/.test(G)?"":"#")},b.getState=u=function(F,G){return F===i||"boolean"==typeof F?v(F):v(G)[F]},b.removeState=function(F){var G={};F!==i&&(G=u(),$.each($.isArray(F)?F:arguments,function(I,H){delete G[H]})),q(G,2)},e[d]=$.extend(e[d],{add:function(F){function G(J){var I=J[D]=c();J.getState=function(K,L){return K===i||"boolean"==typeof K?l(I,K):l(I,L)[K]},H.apply(this,arguments)}var H;return $.isFunction(F)?(H=F,G):(H=F.handler,F.handler=G,void 0)}})}(jQuery,this),/*
 * jQuery hashchange event - v1.2 - 2/11/2010
 * http://benalman.com/projects/jquery-hashchange-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
function($,i,b){function a(m){return m=m||i[c][l],m.replace(/^[^#]*#?(.*)$/,"$1")}var j,k=$.event.special,c="location",d="hashchange",l="href",f=$.browser,g=document.documentMode,h=f.msie&&(g===b||8>g),e="on"+d in i&&!h;$[d+"Delay"]=100,k[d]=$.extend(k[d],{setup:function(){return e?!1:($(j.start),void 0)},teardown:function(){return e?!1:($(j.stop),void 0)}}),j=function(){function p(){o=q=function(s){return s},h&&(n=$('<iframe src="javascript:0"/>').hide().insertAfter("body")[0].contentWindow,q=function(){return a(n.document[c][l])},o=function(u,s){if(u!==s){var t=n.document;t.open().close(),t[c].hash="#"+u}},o(a()))}var r,n,o,q,m={};return m.start=function(){if(!r){var t=a();o||p(),function s(){var v=a(),u=q(t);v!==t?(o(t=v,u),$(i).trigger(d)):u!==t&&(i[c][l]=i[c][l].replace(/#.*/,"")+"#"+u),r=setTimeout(s,$[d+"Delay"])}()}},m.stop=function(){n||(r&&clearTimeout(r),r=0)},m}()}(jQuery,this);/*
    Stream Reader from Gordon.JS
    Copyright (c) 2010 Tobias Schneider

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
    THE SOFTWARE.
*/
var win=self,doc=win.document,fromCharCode=String.fromCharCode,push=Array.prototype.push,min=Math.min,max=Math.max;!function(window,undefined){function buildHuffTable(bitLengths){for(var numLengths=bitLengths.length,blCount=[],maxBits=max.apply(Math,bitLengths),nextCode=[],code=0,table={},i=numLengths;i--;){var len=bitLengths[i];blCount[len]=(blCount[len]||0)+(len>0)}for(var i=1;maxBits>=i;i++){var len=i-1;undefined==blCount[len]&&(blCount[len]=0),code=code+blCount[i-1]<<1,nextCode[i]=code}for(var i=0;numLengths>i;i++){var len=bitLengths[i];len&&(table[nextCode[len]]={length:len,symbol:i},nextCode[len]++)}return table}function decodeSymbol(s,table){for(var code=0,len=0;;){code=code<<1|s.readUB(1,!0),len++;var entry=table[code];if(undefined!=entry&&entry.length==len)return entry.symbol}}window.Gordon={};var DEFLATE_CODE_LENGTH_ORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],DEFLATE_CODE_LENGHT_MAP=[[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],[0,9],[0,10],[1,11],[1,13],[1,15],[1,17],[2,19],[2,23],[2,27],[2,31],[3,35],[3,43],[3,51],[3,59],[4,67],[4,83],[4,99],[4,115],[5,131],[5,163],[5,195],[5,227],[0,258]],DEFLATE_DISTANCE_MAP=[[0,1],[0,2],[0,3],[0,4],[1,5],[1,7],[2,9],[2,13],[3,17],[3,25],[4,33],[4,49],[5,65],[5,97],[6,129],[6,193],[7,257],[7,385],[8,513],[8,769],[9,1025],[9,1537],[10,2049],[10,3073],[11,4097],[11,6145],[12,8193],[12,12289],[13,16385],[13,24577]];Gordon.Stream=function(data){var buff=[],t=this,i=t.length=data.length;t.offset=0;for(var i=0;data[i];i++)buff.push(fromCharCode(255&data.charCodeAt(i)));t._buffer=buff.join(""),t._bitBuffer=null,t._bitOffset=8},Gordon.Stream.prototype={readByteAt:function(pos){return this._buffer.charCodeAt(pos)},readNumber:function(numBytes,bigEnd){var t=this,val=0;if(bigEnd)for(;numBytes--;)val=val<<8|t.readByteAt(t.offset++);else{for(var o=t.offset,i=o+numBytes;i>o;)val=val<<8|t.readByteAt(--i);t.offset+=numBytes}return t.align(),val},readSNumber:function(numBytes,bigEnd){var val=this.readNumber(numBytes,bigEnd),numBits=8*numBytes;return val>>numBits-1&&(val-=Math.pow(2,numBits)),val},readSI8:function(){return this.readSNumber(1)},readSI16:function(bigEnd){return this.readSNumber(2,bigEnd)},readSI32:function(bigEnd){return this.readSNumber(4,bigEnd)},readUI8:function(){return this.readNumber(1)},readUI16:function(bigEnd){return this.readNumber(2,bigEnd)},readUI24:function(bigEnd){return this.readNumber(3,bigEnd)},readUI32:function(bigEnd){return this.readNumber(4,bigEnd)},readFixed:function(){return this._readFixedPoint(32,16)},_readFixedPoint:function(numBits,precision){return this.readSB(numBits)*Math.pow(2,-precision)},readFixed8:function(){return this._readFixedPoint(16,8)},readFloat:function(){return this._readFloatingPoint(8,23)},_readFloatingPoint:function(numEBits,numSBits){var numBits=1+numEBits+numSBits,numBytes=numBits/8,t=this,val=0;if(numBytes>4){for(var i=Math.ceil(numBytes/4);i--;)for(var buff=[],o=t.offset,j=o+(numBytes>=4?4:numBytes%4);j>o;)buff.push(t.readByteAt(--j)),numBytes--,t.offset++;for(var s=new Gordon.Stream(fromCharCode.apply(String,buff)),sign=s.readUB(1),expo=s.readUB(numEBits),mantis=0,i=numSBits;i--;)s.readBool()&&(mantis+=Math.pow(2,i))}else var sign=t.readUB(1),expo=t.readUB(numEBits),mantis=t.readUB(numSBits);if(sign||expo||mantis){var maxExpo=Math.pow(2,numEBits),bias=~~((maxExpo-1)/2),scale=Math.pow(2,numSBits),fract=mantis/scale;bias?val=maxExpo>bias?Math.pow(2,expo-bias)*(1+fract):fract?0/0:1/0:fract&&(val=Math.pow(2,1-bias)*fract),0/0!=val&&sign&&(val*=-1)}return val},readFloat16:function(){return this._readFloatingPoint(5,10)},readDouble:function(){return this._readFloatingPoint(11,52)},readEncodedU32:function(){for(var val=0,i=0;5>i;i++){var num=this.readByteAt(this._offset++);if(val|=(127&num)<<7*i,!(128&num))break}return val},readSB:function(numBits){var val=this.readUB(numBits);return val>>numBits-1&&(val-=Math.pow(2,numBits)),val},readUB:function(numBits,lsb){for(var t=this,val=0,i=0;numBits>i;i++)8==t._bitOffset&&(t._bitBuffer=t.readUI8(),t._bitOffset=0),lsb?val|=(t._bitBuffer&1<<t._bitOffset++?1:0)<<i:val=val<<1|(t._bitBuffer&128>>t._bitOffset++?1:0);return val},readFB:function(numBits){return this._readFixedPoint(numBits,16)},readString:function(numChars){var t=this,b=t._buffer;if(undefined!=numChars){var str=b.substr(t.offset,numChars);t.offset+=numChars}else{for(var chars=[],i=t.length-t.offset;i--;){var code=t.readByteAt(t.offset++);if(!code)break;chars.push(fromCharCode(code))}var str=chars.join("")}return str},readBool:function(numBits){return!!this.readUB(numBits||1)},seek:function(offset,absolute){var t=this;return t.offset=(absolute?0:t.offset)+offset,t.align(),t},align:function(){return this._bitBuffer=null,this._bitOffset=8,this},readLanguageCode:function(){return this.readUI8()},readRGB:function(){return{red:this.readUI8(),green:this.readUI8(),blue:this.readUI8()}},readRGBA:function(){var rgba=this.readRGB();return rgba.alpha=this.readUI8()/255,rgba},readARGB:function(){var alpha=this.readUI8()/255,rgba=this.readRGB();return rgba.alpha=alpha,rgba},readRect:function(){var t=this;return numBits=t.readUB(5),rect={left:t.readSB(numBits),right:t.readSB(numBits),top:t.readSB(numBits),bottom:t.readSB(numBits)},t.align(),rect},readMatrix:function(){var t=this,hasScale=t.readBool();if(hasScale)var numBits=t.readUB(5),scaleX=t.readFB(numBits),scaleY=t.readFB(numBits);else var scaleX=scaleY=1;var hasRotation=t.readBool();if(hasRotation)var numBits=t.readUB(5),skewX=t.readFB(numBits),skewY=t.readFB(numBits);else var skewX=skewY=0;var numBits=t.readUB(5);return matrix={scaleX:scaleX,scaleY:scaleY,skewX:skewX,skewY:skewY,moveX:t.readSB(numBits),moveY:t.readSB(numBits)},t.align(),matrix},readCxform:function(){return this._readCxf()},readCxformA:function(){return this._readCxf(!0)},_readCxf:function(withAlpha){var t=this;if(hasAddTerms=t.readBool(),hasMultTerms=t.readBool(),numBits=t.readUB(4),hasMultTerms)var multR=t.readSB(numBits)/256,multG=t.readSB(numBits)/256,multB=t.readSB(numBits)/256,multA=withAlpha?t.readSB(numBits)/256:1;else var multR=multG=multB=multA=1;if(hasAddTerms)var addR=t.readSB(numBits),addG=t.readSB(numBits),addB=t.readSB(numBits),addA=withAlpha?t.readSB(numBits)/256:0;else var addR=addG=addB=addA=0;var cxform={multR:multR,multG:multG,multB:multB,multA:multA,addR:addR,addG:addG,addB:addB,addA:addA};return t.align(),cxform},decompress:function(){var t=this,b=t._buffer,o=t.offset,data=b.substr(0,o)+t.unzip();return t.length=data.length,t.offset=o,t._buffer=data,t},unzip:function uz(raw){var t=this,buff=[],o=DEFLATE_CODE_LENGTH_ORDER,m=DEFLATE_CODE_LENGHT_MAP,d=DEFLATE_DISTANCE_MAP;t.seek(2);do{var isFinal=t.readUB(1,!0),type=t.readUB(2,!0);if(type){if(1==type){var distTable=uz.fixedDistTable,litTable=uz.fixedLitTable;if(!distTable){for(var bitLengths=[],i=0;32>i;i++)bitLengths.push(5);distTable=uz.fixedDistTable=buildHuffTable(bitLengths)}if(!litTable){for(var bitLengths=[],i=0;143>=i;i++)bitLengths.push(8);for(;255>=i;i++)bitLengths.push(9);for(;279>=i;i++)bitLengths.push(7);for(;287>=i;i++)bitLengths.push(8);litTable=uz.fixedLitTable=buildHuffTable(bitLengths)}}else{for(var numLitLengths=t.readUB(5,!0)+257,numDistLengths=t.readUB(5,!0)+1,numCodeLenghts=t.readUB(4,!0)+4,codeLengths=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=0;numCodeLenghts>i;i++)codeLengths[o[i]]=t.readUB(3,!0);for(var codeTable=buildHuffTable(codeLengths),litLengths=[],prevCodeLen=0,maxLengths=numLitLengths+numDistLengths;litLengths.length<maxLengths;){var sym=decodeSymbol(t,codeTable);switch(sym){case 16:for(var i=t.readUB(2,!0)+3;i--;)litLengths.push(prevCodeLen);break;case 17:for(var i=t.readUB(3,!0)+3;i--;)litLengths.push(0);break;case 18:for(var i=t.readUB(7,!0)+11;i--;)litLengths.push(0);break;default:15>=sym&&(litLengths.push(sym),prevCodeLen=sym)}}var distTable=buildHuffTable(litLengths.splice(numLitLengths,numDistLengths)),litTable=buildHuffTable(litLengths)}do{var sym=decodeSymbol(t,litTable);if(256>sym)buff.push(raw?sym:fromCharCode(sym));else if(sym>256)for(var lengthMap=m[sym-257],len=lengthMap[1]+t.readUB(lengthMap[0],!0),distMap=d[decodeSymbol(t,distTable)],dist=distMap[1]+t.readUB(distMap[0],!0),i=buff.length-dist;len--;)buff.push(buff[i++])}while(256!=sym)}else{t.align();var len=t.readUI16();if(t.readUI16(),raw)for(;len--;)buff.push(t.readUI8());else buff.push(t.readString(len))}}while(!isFinal);return t.seek(4),raw?buff:buff.join("")}}}(this),function(window){if(window.document&&window.Worker){var worker=null,Shapefile=function(o,callback){var t=this,o="string"==typeof o?{shp:o}:o;if(worker)var w=worker;else var path=(o.jsRoot||"")+"/assets/dragdrop/shapefile.js",w=worker=this.worker=new Worker(path);w.onmessage=function(e){t.data=e.date,callback&&callback(e.data)},w.postMessage(["Load",o]),o.dbf&&(this.dbf=new DBF(o.dbf,function(data){w.postMessage(["Add DBF Attributes",data])}))};return window.Shapefile=Shapefile,void 0}var IN_WORKER=!window.document;IN_WORKER&&(importScripts("/assets/dragdrop/stream.js"),onmessage=function(e){switch(e.data[0]){case"Load":window.shapefile=new Shapefile(e.data[1]);break;case"Add DBF Attributes":window.shapefile.addDBFDataToGeoJSON(e.data[1]),window.shapefile._postMessage()}});var SHAPE_TYPES={0:"Null Shape",1:"Point",3:"PolyLine",5:"Polygon",8:"MultiPoint",11:"PointZ",13:"PolyLineZ",15:"PolygonZ",18:"MultiPointZ",21:"PointM",23:"PolyLineM",25:"PolygonM",28:"MultiPointM",31:"MultiPatch"},Shapefile=function(o,callback){var o="string"==typeof o?{shp:o}:o;this.callback=callback,o.shp.lastModifiedDate?this.handleFile(o):this.handleUri(o)};Shapefile.prototype={constructor:Shapefile,handleUri:function(o){var xhr=new XMLHttpRequest,that=this;if(xhr.open("GET",o.shp,!1),xhr.overrideMimeType("text/plain; charset=x-user-defined"),xhr.send(),200!=xhr.status)throw"Unable to load "+o.shp+" status: "+xhr.status;this.url=o.shp,this.stream=new Gordon.Stream(xhr.responseText),this.readFileHeader(),this.readRecords(),this.formatIntoGeoJson(),o.dbf?this.dbf=IN_WORKER?null:new DBF(o.dbf,function(data){that.addDBFDataToGeoJSON(data),that._postMessage()}):this._postMessage()},handleFile:function(o){if(this.options=o,window.FileReader)var reader=new FileReader;else var reader=new FileReaderSync;reader.onload=function(that){return function(e){that.onFileLoad(e.target.result)}}(this),window.FileReader?reader.readAsBinaryString(o.shp):this.onFileLoad(reader.readAsBinaryString(o.shp))},onFileLoad:function(data){this.stream=new Gordon.Stream(data),this.readFileHeader(),this.readRecords(),this.formatIntoGeoJson(),this.options.dbf?this.dbf=IN_WORKER?null:new DBF(this.options.dbf,function(data){that.addDBFDataToGeoJSON(data),that._postMessage()}):this._postMessage()},_postMessage:function(){var data={header:this.header,records:this.records,dbf:this.dbf,geojson:this.geojson};IN_WORKER?postMessage(data):this.callback&&this.callback(data)},readFileHeader:function(){var s=this.stream,header=this.header={};if(100>s)throw"Invalid Header Length";if(header.fileCode=s.readSI32(!0),header.fileCode!=parseInt(9994))throw"Invalid File Code";s.offset+=20,header.fileLength=2*s.readSI32(!0),header.version=s.readSI32(),header.shapeType=SHAPE_TYPES[s.readSI32()],this._readBounds(header),header.rangeZ={min:s.readDouble(),max:s.readDouble()},header.rangeM={min:s.readDouble(),max:s.readDouble()}},readRecords:function(){for(var record,s=this.stream,records=this.records=[];;){if(record={},record.id=s.readSI32(!0),0==record.id)break;record.length=2*s.readSI32(!0),record.shapeType=SHAPE_TYPES[s.readSI32()],this["_read"+record.shapeType](record),records.push(record)}},_readBounds:function(object){var s=this.stream;return object.bounds={left:s.readDouble(),bottom:s.readDouble(),right:s.readDouble(),top:s.readDouble()},object},_readParts:function(record){var nparts,s=this.stream,parts=[];for(nparts=record.numParts=s.readSI32(),record.numPoints=s.readSI32();nparts--;)parts.push(s.readSI32());return record.parts=parts,record},_readPoint:function(record){var s=this.stream;return record.x=s.readDouble(),record.y=s.readDouble(),record},_readPoints:function(record){for(var s=this.stream,points=[],npoints=record.numPoints||(record.numPoints=s.readSI32());npoints--;)points.push({x:s.readDouble(),y:s.readDouble()});return record.points=points,record},_readMultiPoint:function(record){return this.stream,this._readBounds(record),this._readPoints(record),record},_readPolygon:function(record){return this.stream,this._readBounds(record),this._readParts(record),this._readPoints(record),record},_readPolyLine:function(record){return this._readPolygon(record)},formatIntoGeoJson:function(){var feature,geometry,points,fbounds,gcoords,parts,point,bounds=this.header.bounds,records=this.records,features=[],geojson={};geojson.type="FeatureCollection",geojson.bbox=[bounds.left,bounds.bottom,bounds.right,bounds.top],geojson.features=features;for(var record,r=0;record=records[r];r++){switch(feature={},fbounds=record.bounds,points=record.points,parts=record.parts,feature.type="Feature","Point"!==record.shapeType&&(feature.bbox=[fbounds.left,fbounds.bottom,fbounds.right,fbounds.top]),geometry=feature.geometry={},record.shapeType){case"Point":geometry.type="Point",geometry.coordinates=[record.x,record.y];break;case"MultiPoint":case"PolyLine":geometry.type="PolyLine"==record.shapeType?"LineString":"MultiPoint",gcoords=geometry.coordinates=[];for(var p=0;p<points.length;p++){var point=points[p];gcoords.push([point.x,point.y])}break;case"Polygon":geometry.type="Polygon",gcoords=geometry.coordinates=[];for(var pt=0;pt<parts.length;pt++){for(var point,partIndex=parts[pt],part=[],p=partIndex;p<(parts[pt+1]||points.length);p++)point=points[p],part.push([point.x,point.y]);gcoords.push(part)}}features.push(feature)}this.geojson=geojson,this._addDataAfterLoad&&this.addDBFDataToGeoJSON(this._addDataAfterLoad)},addDBFDataToGeoJSON:function(dbfData){if(!this.geojson)return this._addDataAfterLoad=dbfData;this.dbf=dbfData;for(var features=this.geojson.features,len=features.length,records=dbfData.records;len--;)features[len].properties=records[len]}},window.Shapefile=Shapefile}(self),function(window){if(window.document&&window.Worker){var worker=new Worker("/assets/dragdrop/dbf.js"),DBF=function(url,callback){var w=this._worker=worker,t=this;w.onmessage=function(e){t.data=e.data,callback&&callback(e.data)},w.postMessage(url)};return window.DBF=DBF,void 0}var IN_WORKER=!window.document;IN_WORKER&&(importScripts("stream.js"),onmessage=function(e){new DBF(e.data)});var DBASE_LEVEL={3:"dBASE Level 5",4:"dBase Level 7"},DBASE_FIELD_TYPE={N:"Number",C:"Character",L:"Logical",D:"Date",M:"Memo",F:"Floating point",B:"Binary",G:"General",P:"Picture",Y:"Currency",T:"DateTime",I:"Integer",V:"VariField",X:"Variant","@":"Timestamp",O:"Double","+":"Autoincrement",O:"Double","@":"Timestamp"},DBF=function(url,callback){url.lastModifiedDate?this.handleFile(url,callback):this.handleUri(url,callback)};DBF.prototype={constructor:DBF,handleFile:function(file,callback){if(this.callback=callback,window.FileReader)var reader=new FileReader;else var reader=new FileReaderSync;reader.onload=function(that){return function(e){that.onFileLoad(e.target.result)}}(this),window.FileReader?reader.readAsBinaryString(file):this.onFileLoad(reader.readAsBinaryString(file))},onFileLoad:function(data){this.stream=new Gordon.Stream(data),this.readFileHeader(),this.readFieldDescriptions(),this.readRecords(),this._postMessage()},handleUri:function(url,callback){var xhr=new XMLHttpRequest;if(xhr.open("GET",url,!1),xhr.overrideMimeType("text/plain; charset=x-user-defined"),xhr.send(),200!=xhr.status)throw"Unable to load "+url+" status: "+xhr.status;this.stream=new Gordon.Stream(xhr.responseText),this.callback=callback,this.readFileHeader(),this.readFieldDescriptions(),this.readRecords(),this._postMessage()},_postMessage:function(){var data={header:this.header,fields:this.fields,records:this.records};IN_WORKER?postMessage(data):this.callback&&this.callback(data)},readFileHeader:function(){var s=this.stream,header=this.header={},date=new Date;header.version=DBASE_LEVEL[s.readSI8()],date.setUTCFullYear(1900+s.readSI8()),date.setUTCMonth(s.readSI8()),date.setUTCDate(s.readSI8()),header.lastUpdated=date,header.numRecords=s.readSI32(),header.firstRecordPosition=s.readSI16(),header.recordLength=s.readSI16(),s.offset+=16,header.flags=s.readSI8(),header.codePageMark=s.readSI8(),s.offset+=2},readFieldDescriptions:function(){for(var field,s=this.stream,fields=[];13!=s.readSI8();)s.offset--,field={},field.name=s.readString(11).replace(/\u0000/g,""),field.type=DBASE_FIELD_TYPE[s.readString(1)],field.fieldDisplacement=s.readSI32(),field.fieldLength=s.readUI8(),field.decimals=s.readSI8(),field.flags=s.readSI8(),field.autoincrementNextValue=s.readSI32(),field.autoincrementStepValue=s.readSI8(),s.offset+=8,fields.push(field);this.fields=fields},readRecords:function(){for(var field,record,s=this.stream,numRecords=this.header.numRecords,recordsOffset=this.header.firstRecordPosition,recordSize=this.header.recordLength,fields=this.fields,numFields=fields.length,records=[],index=0;numRecords>index;index++){s.offset=recordsOffset+index*recordSize,record={},record._isDeleted=42==s.readSI8();for(var i=0;numFields>i;i++)field=fields[i],record[field.name]=s.readString(field.fieldLength).trim();records.push(record)}this.records=records}},window.DBF=DBF}(self);