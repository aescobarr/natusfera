function num2letterID(num){return alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZ",ID=alphabet[num%26],25>=num?ID:alphabet[Math.floor(num/26)-1]+ID}function clickTip(obj,txt){obj.value==txt&&(obj.value=""),obj.className="formInput"}function blurTip(obj,txt){""==obj.value&&(obj.className="formInputTip",obj.value=txt)}function toggleHeaderSubnav(link){$(link).parents(".subnavtab").hasClass("open")?closeHeaderSubnav(link):openHeaderSubnav(link)}function openHeaderSubnav(link){$(".subnav").hide(),$(".subnavtab").removeClass("open"),$(link).parents(".subnavtab").addClass("open"),$(link).parents("li").find(".subnav").show(),$(document).click(subnavClickOff)}function closeHeaderSubnav(link){$(link).parents(".subnavtab").removeClass("open"),$(link).parents("li").find(".subnav").hide(),$(document).unbind("click",subnavClickOff)}function subnavClickOff(e){0==$(e.target).parents(".subnavwrapper").length&&($(".subnav").hide(),$(".subnavtab").removeClass("open"))}function loadingClickForLink(){var txt=$(this).attr("data-loading-click");"true"==$.trim($(this).attr("data-loading-click"))&&(txt=I18n.t("loading"));var loading=$(this).siblings(".loadingclick:first");0==loading.length&&(loading=$(this).clone(!1),loading.unbind(),loading.attr("onclick","return false;"),loading.attr("href","#"),loading.attr("id","").addClass("loadingclick disabled").css("padding-left","25px").html(txt),loading.click(function(e){return e.preventDefault(),!1}),""==txt&&loading.find("span").html(".").css("visibility","hidden").css("width","0px"),$(this).before(loading)),$(this).hide(),$(loading).show();var link=this;$(this).attr("data-loading-click-bound")||($(this).bind("ajax:complete",function(){$(link).show(),loading.hide()}),$(this).attr("data-loading-click-bound",!0))}function loadingClickForButton(options){options=options||{},$(this).data("original-value",$(this).val());var txt=$.trim($(this).attr("data-loading-click"));"true"==$.trim($(this).attr("data-loading-click"))&&(txt=I18n.t("saving")),$(this).data("original-value",$(this).val()),$(this).addClass("disabled description").val(txt);var link=this;$(this).attr("data-loading-click-bound")||0==options.ajax||($(this).parents("form").bind("ajax:complete",function(){$(link).attr("disabled",!1).removeClass("disabled description"),$(link).val($(link).data("original-value"))}),$(this).attr("data-loading-click-bound",!0)),$(link).attr("disabled",!0)}function buildHelpTips(){if("undefined"!=typeof $().qtip){var options=$.extend(!0,{},QTIP_DEFAULTS,{show:{event:"click"},hide:{event:"unfocus"}});$(".helptip").not(".helptipified").each(function(){$(this).addClass("helptipified");var content;content=$(this).attr("rel")&&$(this).attr("rel").match(/^#/)?$($(this).attr("rel")).html():$(this).attr("rel");var tipOptions=$.extend(!0,{},options,{content:{text:content,title:$(this).attr("data-helptip-title")}});$(this).attr("data-helptip-width")&&(tipOptions.style=tipOptions.style||{},tipOptions.style.width=$(this).attr("data-helptip-width")),$(this).qtip(tipOptions)})}}function checkFormForRequiredFields(e){var inputs=$("input[required]:visible").filter(function(){return!$(this).val()});if(0==inputs.length)return!0;var viewport=$(this).parents(".ui-dialog-content:first").get(0)||!1,container=$(this).parents(".ui-dialog-content:first").get(0)||document.body;return inputs.css({"border-color":"DeepPink"}).qtip({content:"This field is required",style:{classes:"ui-tooltip-light ui-tooltip-shadow ui-tooltip-required"},position:{viewport:viewport?$(viewport):!1,container:$(container)}}).qtip("show"),e.preventDefault(),e.stopImmediatePropagation(),$(window).scrollTo(inputs[0]),!1}function checkDelayedLink(url){return window.delayedLinkTries>20?($("#delayedlinknotice").dialog("close"),alert("Your request for "+url+" seems to be taking forever.  Please try again later."),void 0):($.ajax({url:url,type:"get",statusCode:{202:function(){setTimeout('checkDelayedLink("'+url+'")',5e3)},200:function(){$("#delayedlinknotice").dialog("close"),window.location=url}}}),void 0)}function autoTip(){content=$(this).attr("data-tip").match(/^#/)?$($(this).attr("data-tip")).html():$(this).attr("data-tip");var tipOptions=$.extend(!0,{},QTIP_DEFAULTS);tipOptions.content=$(this).attr("data-tip-title")?{text:content,title:$(this).attr("data-helptip-title")}:content,$(this).attr("data-tip-show-delay")&&(tipOptions.show=tipOptions.show||{},tipOptions.show.delay=parseInt($(this).attr("data-tip-show-delay"))),$(this).attr("data-tip-width")&&(tipOptions.style=tipOptions.style||{},tipOptions.style.width=$(this).attr("data-tip-width")),$(this).attr("data-tip-style-classes")&&(tipOptions.style=tipOptions.style||{},tipOptions.style.classes=$(this).attr("data-tip-style-classes")),$(this).attr("data-tip-position-at")&&(tipOptions.position=tipOptions.position||{},tipOptions.position.at=$(this).attr("data-tip-position-at")),$(this).attr("data-tip-hide-delay")&&(tipOptions.hide=tipOptions.hide||{},tipOptions.hide.delay=$(this).attr("data-tip-hide-delay")),$(this).qtip(tipOptions),navigator.platform.match(/^Win/)&&$.browser.webkit&&!navigator.userAgent.match(/Chrome/i)&&$("input[type=file]").removeAttr("multiple")}function currentTimeZone(){var now=new Date,nowString=now.toString(),timeZoneAbbr=nowString.match(/\(([A-Z]{3,4})\)$/)[1],timeZoneOffset=nowString.match(/[+-]\d\d\d\d/)[0],timeZoneOffsetHours=nowString.match(/([+-]\d\d)(\d\d)/)[1],timeZoneOffsetMinutes=nowString.match(/([+-]\d\d)(\d\d)/)[2];return{abbreviation:timeZoneAbbr,offset:timeZoneOffset,offsetHours:parseInt(timeZoneOffsetHours),offsetMinutes:parseInt(timeZoneOffsetMinutes)}}function setUpdatesCount(count,options){options=options||{},count>0?(options.skipAnimation?$("#header .updates").addClass("alert"):$("#header .updates").switchClass("","alert"),$("#header .updates .count").html(count)):(options.skipAnimation?$("#header .updates").removeClass("alert"):$("#header .updates").switchClass("alert",""),$("#header .updates .count").html(0))}function getUpdatesCount(){$.get("/users/updates_count",function(data){setUpdatesCount(data.count)})}function setMessagesCount(count,options){options=options||{},count>0?(options.skipAnimation?$("#header .messages").addClass("alert"):$("#header .messages").switchClass("","alert"),$("#header .messages .count").html(count)):(options.skipAnimation?$("#header .messages").removeClass("alert"):$("#header .messages").switchClass("alert",""),$("#header .messages .count").html(0))}function getMessagesCount(){$.get("/messages/count",function(data){setMessagesCount(data.count)})}function serialID(){return window._serialID=window._serialID?window._serialID+1:1,window._serialID}function setPreference(pref,value){var url=$("#usersubnav .profile_link:first").attr("href");if(url&&pref&&value){var data={authenticity_token:$("meta[name=csrf-token]").attr("content"),_method:"PUT"};data["user[preferred_"+pref+"]"]=value,$.ajax(url,{type:"POST",data:data,dataType:"json"})}}function showJoinProjectDialog(projectId,options){options=options||{};var url=options.url||"/projects/"+projectId+"/join?partial=join",title=options.title||I18n.t("join_project"),originalInput=options.originalInput,dialog=$("<div></div>").addClass("dialog").html('<div class="loading status">'+I18n.t("loading")+"</div>");dialog.load(url,function(){var button=$(".default.button",this),diag=this;button.click(function(){var joinUrl=$(this).attr("href");return $.post(joinUrl).done(function(){$(diag).dialog("close"),originalInput&&$(originalInput).click()}).fail(function(){alert("Failed to join project")}),!1}),$(this).centerDialog()}),dialog.dialog({modal:!0,title:title,width:600,maxHeight:.8*$(window).height()})}function preciseRound(num,decimals){return Math.round(num*Math.pow(10,decimals))/Math.pow(10,decimals)}function updateSession(params){$.ajax({url:"/users/update_session",data:params,type:"PUT"})}!function($){var cocoon_element_counter=0;$(".add_fields").live("click",function(e){e.preventDefault();var $this=$(this),assoc=$this.data("association"),assocs=$this.data("associations"),content=$this.data("association-insertion-template"),insertionMethod=$this.data("association-insertion-method")||$this.data("association-insertion-position")||"before";insertionNode=$this.data("association-insertion-node"),insertionTraversal=$this.data("association-insertion-traversal"),regexp_braced=new RegExp("\\[new_"+assoc+"\\](.*?\\s)","g"),regexp_underscord=new RegExp("_new_"+assoc+"_(\\w*)","g"),new_id=(new Date).getTime()+cocoon_element_counter++,newcontent_braced="["+new_id+"]",newcontent_underscord="_"+new_id+"_",new_content=content.replace(regexp_braced,"["+new_id+"]$1"),new_content==content&&(regexp_braced=new RegExp("\\[new_"+assocs+"\\](.*?\\s)","g"),regexp_underscord=new RegExp("_new_"+assocs+"_(\\w*)","g"),new_content=content.replace(regexp_braced,"["+new_id+"]$1")),new_content=new_content.replace(regexp_underscord,newcontent_underscord+"$1"),insertionNode=insertionNode?insertionTraversal?$this[insertionTraversal](insertionNode):"this"==insertionNode?$this:$(insertionNode):$this.parent();var contentNode=$(new_content);insertionNode.trigger("cocoon:before-insert",[contentNode]),insertionNode[insertionMethod](contentNode),insertionNode.trigger("cocoon:after-insert",[contentNode])}),$(".remove_fields.dynamic, .remove_fields.existing").live("click",function(e){var $this=$(this),node_to_delete=$this.closest(".nested-fields"),trigger_node=node_to_delete.parent();e.preventDefault(),trigger_node.trigger("cocoon:before-remove",[node_to_delete]);var timeout=trigger_node.data("remove-timeout")||0;setTimeout(function(){$this.hasClass("dynamic")?$this.closest(".nested-fields").remove():($this.prev("input[type=hidden]").val("1"),$this.closest(".nested-fields").hide()),trigger_node.trigger("cocoon:after-remove",[node_to_delete])},timeout)})}(jQuery);var QTIP_DEFAULTS={hide:{fixed:!0},style:{classes:"ui-tooltip-light ui-tooltip-shadow",width:"auto"},position:{viewport:$(window)}};if($("a[data-loading-click], input[data-loading-click][type=radio], input[data-loading-click][type=checkbox]").live("click",loadingClickForLink),$("input[data-loading-click][type=text], input[data-loading-click][type=submit]").live("click",function(){var button=this;$(this).parents("form").length>0?"true"!=$(this).attr("exception")&&$(this).parents("form").submit(function(){loadingClickForButton.apply(button)}):loadingClickForButton.apply(button)}),$("[data-autosubmit]").live("change",function(){$(this).parents("form").submit()}),$(document).ready(function(){function makeHeaderLinkCurrent(li){$(li).addClass("current").append($('<img src="http://natusfera.gbif.es/assets/active_tab_bottom-6649b4e2baf64e0b89077dcfa84bd049.gif">').css({position:"absolute",left:"50%",bottom:"-6px",marginLeft:"-5px"}))}window.location.pathname.match(/^\/observations/)?makeHeaderLinkCurrent("#mainnav .observationstab"):window.location.pathname.match(/^\/taxa/)?makeHeaderLinkCurrent("#mainnav .taxatab"):window.location.pathname.match(/^\/projects/)?makeHeaderLinkCurrent("#mainnav .projectstab"):window.location.pathname.match(/^\/places/)?makeHeaderLinkCurrent("#mainnav .placestab"):window.location.pathname.match(/^\/user/)||window.location.pathname.match(/^\/people/)?makeHeaderLinkCurrent("#mainnav .peopletab"):(window.location.pathname.match(/^\/guides/)||window.location.pathname.match(/^\/guides/))&&makeHeaderLinkCurrent("#mainnav .guidestab"),buildHelpTips(),$("#usernav .signin_link, #usernav .signup_link").click(function(){return""!=window.location.pathname&&"/"!=window.location.pathname?(window.location=$(this).attr("href")+"?return_to="+window.location,!1):void 0}),$(["http://natusfera.gbif.es/assets/spinner-f9ee3cb068e7907cc011480c542d2625.gif","http://natusfera.gbif.es/assets/spinner-small-80b95fc44c80e83e7a4d226fa06d6148.gif","http://natusfera.gbif.es/assets/spinner-small-ffffff_on_dedede-490ae301981eb68bcc4512386dfb4f16.gif","http://natusfera.gbif.es/assets/spinner-small-ffffff_on_aaaaaa-35d953ad4f911bbc0b00ca956474ebc6.gif"]).preload(),$("[data-tip]").each(autoTip),$(".source_nested_form_fields input.existing").chooser({collectionUrl:"/sources.json",resourceUrl:"/sources/{{id}}.json"}),$(".zoomable").zoomify(),$(".delayedlink").click(function(){window.delayedLinkTries=0;var dialog=$("#delayedlinknotice"),msg=$(this).attr("data-delayed-link-msg")||"Hold on while we generate that file...",status=$('<div class="loading status"></div>').html(msg);return 0==dialog.length&&(dialog=$('<div id="delayedlinknotice"></div>'),$(document.body).append(dialog)),dialog.html(status),dialog.dialog({modal:!0,title:"Hold on..."}),checkDelayedLink($(this).attr("href")),!1}),$("#headerupdatesnotice").click(function(){return toggleHeaderSubnav(this),$("#updatessubnav").data("loaded")||$("#updatessubnav").load("/users/new_updates",function(data){$(this).html(data),$("#updatessubnav").data("loaded",!0),setUpdatesCount(0,{skipAnimation:!0});var tipOptions=$.extend(!0,{},QTIP_DEFAULTS,{position:{my:"right center",at:"left center",target:"event"},content:{text:'<span class="loading status">'+I18n.t("loading")+"</span>",ajax:{type:"GET",data:{partial:"cached_component"}}}});tipOptions.style.classes+=" compact mini observations",tipOptions.style.width=250,$('li a[href*="/observations/"]',this).each(function(){tipOptions.position.target=$(this).parents("li:first"),tipOptions.content.ajax.url=$(this).attr("href"),$(this).qtip(tipOptions)})}),!1}),$("#headermessagesnotice").click(function(){return toggleHeaderSubnav(this),$("#messagessubnav").data("loaded")||$("#messagessubnav").load("/messages/new_messages",function(data){$(this).html(data),$("#messagessubnav").data("loaded",!0),setMessagesCount(0,{skipAnimation:!0})}),!1}),$(".commentpreviewbutton").click(function(){var button=this;return $.ajax($(this).attr("href"),{type:"POST",data:$(this).parents("form").serialize()+"&preview=true",dataType:"json",beforeSend:function(){$(button).hide(),$(button).nextAll(".loading").show()}}).done(function(data){$(button).show(),$(button).nextAll(".loading").hide();var html=data.html||data.body||"";html='<div class="dialog">'+html+"</div>",$(html).dialog({modal:!0,title:I18n.t("preview"),width:.7*$(window).width()})}),!1}),$(".identificationform").bind("ajax:before",function(){$(".default.button",this).hide(),$(".loading",this).show()}).bind("ajax:complete",function(){$(".default.button",this).show(),$(".loading",this).hide()}).bind("ajax:success",function(event,json){$(this).parents(".identification_form_wrapper:first").fadeOut(),$(this).parents(".identifications").find(".identifications-list").append(json.html),$(this).parents(".identifications").find(".identifications-list .identification:last").addClass("stacked")}).bind("ajax:error",function(event,request,settings){var json=eval("("+request.responseText+")");if(json.errors){var errors=json.errors.join(", ");alert("Failed to save identification: "+errors)}}),$(".friend_link").bind("ajax:before",function(){$(this).fadeOut(function(){$(this).siblings(".unfriend_link").fadeIn()})}),$(".unfriend_link").bind("ajax:before",function(){$(this).fadeOut(function(){$(this).siblings(".friend_link").fadeIn()})}),$(".commentform").bind("ajax:before",function(){$(this).siblings(".loading").show(),$(this).hide()}).bind("ajax:complete",function(){$(this).siblings(".loading").hide(),$(this).show(),$("input[type=submit]",this).val("Save comment").attr("disabled",!1)}).bind("ajax:success",function(e,json){$("textarea",this).val("");var wrapper=$(this).parents(".comments_wrapper:first");wrapper.find(".comments").show(),wrapper.find(".noresults").hide(),wrapper.find(".comments").append(json.html),$(".item .item_content",wrapper).width(function(){return $(this).parent().width()-58})}).bind("ajax:error",function(xhr,status,error){alert(error)}),$("form:has(input[required])").submit(checkFormForRequiredFields),$("body.browser .item .item_content").width(function(){return $(this).parent().width()-58}),setTimeout(function(){$(".identification:visible .identification_body").width(function(){return $(this).parent().outerWidth(!0)-$(this).siblings(".identification_image").outerWidth(!0)-25})},1e3),$(".add_matching_link").attr("confirm",null).data("confirm",null),$(".dna").dnaHighlight()}),jQuery.fn.autolink=function(){return this.each(function(){var re=/((http|https|ftp):\/\/[\w?=&.\/-;#~%-]+(?![\w\s?&.\/;#~%"=-]*>))/g;$(this).html($(this).html().replace(re,'<a href="$1">$1</a> '))})},$.fn.preload=function(){this.each(function(){$("<img/>")[0].src=this})},$(".ui-widget-overlay, .shades").live("click",function(){$(".dialog:visible").dialog("close")}),$.fn.shades=function(e,options){switch(options=options||{},elt=this[0],e){case"close":$(elt).find(".shades:last").hide();break;case"remove":$(elt).find(".shades:last").remove();break;default:var shades=$(elt).find(".shades:last")[0]||$('<div class="shades"></div>'),underlay=$('<div class="underlay"></div>'),overlay=$('<div class="overlay"></div>').html(options.content);$(shades).html("").append(underlay,overlay),options.css&&$(underlay).css(options.css),elt!=document.body&&($(elt).css("position","relative"),$(shades).css("position","absolute"),$(underlay).css("position","absolute")),$(elt).append(shades),$(shades).show()}},$.fn.loadingShades=function(e,options){if(options=options||{},e&&"close"==e)$(this).shades(e,options);else{var txt=e||"Loading...",cssClass=options.cssClass||"bigloading",msg='<div class="loadingShadesMsg"><span class="loading '+cssClass+' status inlineblock">'+txt+"</span></div>";options=$.extend(!0,options,{css:{"background-color":"white"},content:msg}),$(this).shades("open",options);var status=$(".shades .loading.status",this);status.css({position:"absolute",top:options.top||"50%",left:options.left||"50%",marginTop:-1*status.outerHeight()/2+"px",marginLeft:-1*status.outerWidth()/2+"px"})}},$.fn.showInlineBlock=function(){var opts={};return $.browser.msie&&$.browser.version<8?(opts.zoom=1,opts.display="inline",opts["*display"]="inline"):opts.display="inline-block",$(this).css(opts),this},$.fn.selectLocalTimeZone=function(){return $(this).each(function(){var option,tz=currentTimeZone();if(tz.abbreviation){var matches=$("option[data-time-zone-abbr='"+tz.abbreviation+"']",this);option=matches.first()}else if(timeZoneOffsetHour){var formattedOffset=tz.offsetHours+":"+tz.offsetMinutes,matches=$("option[data-time-zone-formatted-offset='"+formattedOffset+"']",this);option=matches.first()}option&&$(this).val(option.val())}),this},$.fn.disable=function(){return $(this).attr("disabled",!0).addClass("disabled"),this},$.fn.enable=function(){return $(this).attr("disabled",!1).removeClass("disabled"),this},$.fn.toggleDisabled=function(){$(this).hasClass("disabled")?$(this).enable():$(this).disable()},$.fn.lock=function(){$(this).each(function(){var replacement=$(this).clone();replacement.attr("name","").val($(this).val()).addClass("lock-replacement").disable(),$(this).after(replacement),$(this).hide().data("locked",!0)})},$.fn.unlock=function(){$(this).each(function(){$(this).nearest(".lock-replacement").remove(),$(this).show().data("locked",!1)})},$(document).ready(function(){$(":input[data-locked]").lock()}),$.fn.zoomify=function(){var selection=$(this).not(".zoomified");selection.addClass("zoomified").addClass("inlineblock").append('<img src="http://natusfera.gbif.es/assets/silk/magnifier-52ceef0cd08b2beff97e3a9963c14e36.png" class="zoom_icon"/>'),selection.click(function(){return 0==$("#zoomable_dialog").length&&$(document.body).append($("<div></div>").attr("id","zoomable_dialog").addClass("dialog")),$("#zoomable_dialog").html('<div class="loading status">'+I18n.t("loading")+"</div>"),$("#zoomable_dialog").load($(this).attr("href"),"partial=photo",function(){$("img",this).load(function(){var dialog=$("#zoomable_dialog"),newHeight=$(":first",dialog).height()+60,maxHeight=.8*$(window).height();newHeight>maxHeight&&(newHeight=maxHeight),$(dialog).dialog("option","height",newHeight),$(dialog).dialog("option","position",{my:"center",at:"center",of:$(window)})})}),$("#zoomable_dialog").dialog({modal:!0,title:$(this).attr("title")||$(this).attr("alt"),width:.8*$(window).width()}),!1})},$.fn.slideToggleWidth=function(){$(this).each(function(){$(this).attr("data-original-width")&&$(this).attr("data-original-width")!=$(this).width()?($(this).show(),$(this).animate({width:$(this).attr("data-original-width")},500)):($(this).attr("data-original-width",$(this).width()),$(this).animate({width:0},500,function(){$(this).hide()}))})},$.fn.centerInContainer=function(options){options=options||{};var containerSelector=options.container||":first";$(this).not(".centeredInContainer").each(function(){var container=$(this).parents(containerSelector),containerWidth=container.width(),containerHeight=container.height(),w=$(this).naturalWidth(),h=$(this).naturalHeight();if(w>h){var width=containerHeight/h*w;$(this).css({height:containerHeight,maxWidth:"none",position:"absolute"}),$(this).css({top:0,left:"50%",marginLeft:"-"+width/2+"px"})}else if(h>w){var height=containerWidth/w*h;$(this).css({width:$(this).parents(containerSelector).width(),maxHeight:"none",position:"absolute"}),$(this).css({left:0,top:"50%",marginTop:"-"+height/2+"px"})}else{if(0==w&&0==h){var that=this;return setTimeout(function(){$(that).centerInContainer(options)},500),void 0}$(this).css({width:$(this).parents(containerSelector).width(),maxWidth:"none",maxHeight:"none"}),$(this).css({left:0,top:0,marginTop:"0px"})}$(this).addClass("centeredInContainer")})},$.fn.observationsGrid=function(size){$(this).removeClass("mini map"),$(this).addClass("observations grid"),$(".observation",this).showInlineBlock(),$(".map",this).hide();var that=this;"medium"==size?($(this).addClass("medium"),$(".photos img[data-small-url]",this).each(function(){$(this).load(function(){$(this).centerInContainer({container:".observation:first"}),$(this).fadeIn(),$(this).unbind("load")}),$(this).attr("src",$(this).attr("data-small-url")),$.browser.msie||$(this).hide()}),$(".icon img[data-small-url]",this).each(function(){$(this).attr("src",$(this).attr("data-small-url"))})):($(that).removeClass("medium"),$(".photos img[data-square-url]",that).attr("style",""),$(".photos img[data-square-url]",that).removeClass("centeredInContainer"),$(".photos img[data-square-url]",that).attr("src",function(){return $(this).attr("data-square-url")}),$(".icon img[data-square-url]",that).attr("src",function(){return $(this).attr("data-square-url")}))},$.fn.observationsList=function(){$(".observation",this).show().css("display","block"),$(".map",this).hide(),$(this).removeClass("medium grid map"),$(this).addClass("mini"),$(".photos img[data-square-url]",this).attr("style",""),$(".photos img[data-square-url]",this).removeClass("centeredInContainer"),$(".photos img[data-square-url]",this).attr("src",function(){return $(this).attr("data-square-url")}),$(".icon img[data-square-url]",this).attr("src",function(){return $(this).attr("data-square-url")})},$.fn.observationsMap=function(){$(this).observationsList(),$(this).removeClass("medium grid mini"),$(this).addClass("map"),$(this).each(function(){if($(".map",this).length>0)return $(".map",this).show(),google.maps.event.trigger($(".map",this).get(0),"resize"),void 0;var w=$(this).width(),h=$(window).height()/$(window).width()*w,mapDiv=$("<div></div>");mapDiv.addClass("stacked map"),mapDiv.width(w),"this"==$(this).data("map-height")?mapDiv.height($(this).height()):mapDiv.height(h),$(this).prepend(mapDiv);var map=iNaturalist.Map.createMap({div:mapDiv.get(0)});$(".observation",this).each(function(){var o={id:$(this).attr("id").split("-")[1],latitude:$(this).attr("data-latitude"),longitude:$(this).attr("data-longitude"),coordinates_obscured:$(this).attr("data-coordinates-obscured"),taxonId:$(this).attr("data-taxon-id"),iconic_taxon:{name:$(this).attr("data-iconic-taxon-name")}};map.addObservation(o)}),map.zoomToObservations()}),$(".observation",this).hide()},$.fn.observationControls=function(options){var options=options||{};$(this).each(function(){var observations=options.div||$(this).parent().find(".observations"),gridButton=$(".gridbutton",this);options.skipGrid||0!=gridButton.length||(gridButton=$('<a href="#" class="gridbutton" title="'+I18n.t("grid_tooltip")+'"><span class="inat-icon ui-icon ui-icon-grid inlineblock">&nbsp;</span><label>'+I18n.t("grid")+"</label></a>"),gridButton.data("gridSize",$(observations).hasClass("medium")?"medium":null),gridButton.click(function(){return $(observations).observationsGrid($(this).data("gridSize")),$(this).siblings().addClass("disabled"),$(this).removeClass("disabled"),!1}));var listButton=$(".listbutton",this);options.skipList||0!=listButton.length||(listButton=$('<a href="#" class="listbutton" title="'+I18n.t("list_tooltip")+'"><span class="inat-icon ui-icon ui-icon-list inlineblock">&nbsp;</span><label>'+I18n.t("list")+"</label></a>"),listButton.click(function(){return $(observations).observationsList(),$(this).siblings().addClass("disabled"),$(this).removeClass("disabled"),!1}));var mapButton=$(".mapbutton",this);options.skipMap||0!=mapButton.length||(mapButton=$('<a href="#" class="mapbutton" title="'+I18n.t("map_tooltip")+'"><span class="inat-icon ui-icon ui-icon-map inlineblock">&nbsp;</span><label>'+I18n.t("map")+"</label></a>"),mapButton.click(function(){return $(observations).observationsMap(),$(this).siblings().addClass("disabled"),$(this).removeClass("disabled"),!1})),0==$(this).children().length&&$(this).append(" ",gridButton,listButton,mapButton),$(observations).hasClass("grid")?gridButton.click():$(observations).hasClass("map")?mapButton.click():listButton.click()})},$.fn.naturalWidth=function(){$(this).get(0);var fakeImg=new Image;return fakeImg.src=$(this).attr("src"),fakeImg.width},$.fn.naturalHeight=function(){$(this).get(0);var fakeImg=new Image;return fakeImg.src=$(this).attr("src"),fakeImg.height},$.fn.subscriptionSettings=function(){var options=$.extend(!0,{position:{my:"top right",at:"bottom center"},show:{event:"click"},hide:{event:"unfocus"},content:{text:'<span class="loading status">'+I18n.t("loading")+"</span>",ajax:{type:"GET",data:{partial:"edit_inline"},error:function(){this.set("content.text","<div class='meta'>You're no longer subscribed to that item.</div>")},success:function(data){this.set("content.text",data),$(".taxonchooser",this.elements.content).simpleTaxonSelector({afterSelect:function(wrapper){var form=$(wrapper).parents("form:first"),data=form.serialize()+"&format=json";$.ajax({url:form.attr("action"),type:"post",data:data})}}),$(".createdestroy form",this.elements.content).submit(function(){$(this).fadeOut(function(){$(this).siblings("form").fadeIn()});var data=$(this).serialize()+"&format=json",resourceType=$("input[name*=resource_type]",this).val(),resourceId=$("input[name*=resource_id]",this).val();return $.ajax({url:$(this).attr("action"),type:"post",data:data}),$(this).hasClass("unsubscribe")?$(".subscription_for_"+resourceType+"_"+resourceId).addClass("unsubscribed"):$(".subscription_for_"+resourceType+"_"+resourceId).removeClass("unsubscribed"),!1})}}}},QTIP_DEFAULTS);$(this).each(function(){options.content.ajax.url=$(this).attr("href"),$(this).qtip(options),$(this).click(function(){return!1})})},Array.prototype.unique=function(){var i,o={},l=this.length,r=[];for(i=0;l>i;i+=1)o[this[i]]=this[i];for(i in o)r.push(o[i]);return r},$.fn.serializeObject=function(){var o={},a=this.serializeArray();return $.each(a,function(){void 0!==o[this.name]?(o[this.name].push||(o[this.name]=[o[this.name]]),o[this.name].push(this.value||"")):o[this.name]=this.value||""}),o},$.fn.centerDialog=function(){if(1==$(this).children().length)var newHeight=$(":first",this).height()+100;else var newHeight=$(this).height()+100;var maxHeight=.8*$(window).height();newHeight>maxHeight&&(newHeight=maxHeight),$(this).dialog("option","height",newHeight),$(this).dialog("option","position",{my:"center",at:"center",of:$(window)})},$(".flaglink").live("click",function(){$("#flagdialog").remove();var dialog=$("<div></div>").attr("id","flagdialog").addClass("dialog").html('<div class="loading status">'+I18n.t("loading")+"</div>");return dialog.load($(this).attr("href"),"partial=dialog",function(){$(this).centerDialog(),$("input[type=radio]",this).change(function(){"other"==$(this).val()?($(this).parents(".dialog:first").find("textarea").show(),$(this).parents(".dialog:first").centerDialog()):($(this).parents(".dialog:first").find("textarea").hide(),$(this).parents(".dialog:first").centerDialog())})}),$(document.body).append(dialog),dialog.dialog({modal:!0,title:I18n.t("flag_an_item")}),!1}),$(".project_invitation .acceptlink").live("ajax:success",function(){$(this).hide(),$(this).siblings(".ignorelink").hide(),$(this).siblings(".removelink").show(),$(this).siblings(".status").html(I18n.t("added!")).show().addClass("success"),$(this).parents(".box:first").removeClass("notice")}),$(".project_user_invitation .acceptlink").live("ajax:success",function(){$(this).hide(),$(this).siblings(".status").html(I18n.t("joined!")).show().addClass("success").removeClass("loading")}),$(".project_user_invitation .acceptlink").live("ajax:before",function(){$(this).hide(),$(this).siblings(".status").html(I18n.t("loading")).show().addClass("loading")}),$(".project_invitation .removelink").live("ajax:success",function(){$(this).hide(),$(this).siblings(".acceptlink").show(),$(this).siblings(".status").html(I18n.t("removed!")).show().removeClass("success"),$(this).parents(".box:first").addClass("notice")}),$(".project_invitation .ignorelink").live("ajax:success",function(){var item=$(this).parents(".item:first").get(0),update=$(this).parents(".update:first").get(0),project_invitation=$(this).parents(".project_invitation:first").get(0),target=item||update||project_invitation;$(target).slideUp()}),$(".add_matching_link").live("click",function(e){var link=this,url=$(this).attr("href").replace(/add_matching/,"preview_matching"),projectId=url.match(/projects\/(.+?)\/preview_matching/)[1];e.preventDefault(),e.stopImmediatePropagation(),$("#add_matching_link_dialog").remove();var dialog=$("<div></div>").attr("id","add_matching_link_dialog").addClass("dialog").html('<div class="loading status">'+I18n.t("loading")+"</div>");return $.ajax({url:url,type:"get"}).success(function(data){dialog.html(data)}).fail(function(){dialog.dialog("close"),showJoinProjectDialog(projectId,{originalInput:link})}),$(document.body).append(dialog),dialog.dialog({modal:!0,title:"Add matching observations to project",width:400,height:400}),!1}),$.fn.loadObservations=function(options){var url=options.url||"/observations";url.match(/partial=/)||(url+=url.match(/\?/)?"&":"?",url+="partial=cached_component");var req,container=this;if(req=$.ajax({type:"GET",url:url,success:function(data,status){var html=data.replace(/\/div>[\s\n]+?<div/g,"/div><div"),oldObsId=$(".observation:first",container).attr("id");if(oldObsId){var r=new RegExp("^[^>]+"+oldObsId,"g");if(r.test(html))return}$(container).html(html),"list"==options.style?$(container).observationsList():"map"==options.style?$(container).observationsMap():$(container).observationsGrid("medium"),"function"==typeof options.success&&options.success(req,data,status)}}),options.refresh){var t=setTimeout(function(){container.loadObservations(options)},options.refresh);container.data("loadObservationsTimeout",t)}},$.fn.observationTaxonStats=function(options){var options=options||{},container=this,baseSearch="undefined"==typeof OBSERVATIONS_URL?window.location.search:"?"+OBSERVATIONS_URL.split("?")[1],limit=options.limit||5,url=options.url||"/observations/taxon_stats.json?limit"+limit;baseSearch=baseSearch.replace(/per_page=[^&]+/,""),baseSearch=baseSearch.replace(/page=[^&]+/,""),$.getJSON(url,function(json){var speciesCount;speciesCount=json.rank_counts.leaves?json.rank_counts.leaves:(json.rank_counts.species||0)+(json.rank_counts.subspecies||0)+(json.rank_counts.variety||0)+(json.rank_counts.form||0)+(json.rank_counts.hybrid||0);var speciesCountLink=$("<a>"+speciesCount+"</a>").attr("href","/observations/taxa"+baseSearch+"&rank=species");if($(".species .count",container).html(speciesCountLink),json.species_counts.length>0){var most;$(".most_observed table",container).html("");for(var i=0;i<json.species_counts.length;i++)if(json.species_counts[i].taxon){most=json.species_counts[i];var tr=$("<tr></tr>"),taxonTD=$('<td class="taxon"></td>'),imageTD=$('<td class="image"></td>');taxonTD.html($("<a></a>").addClass("nobr "+most.taxon.default_name.lexicon).attr("href","/taxa/"+most.taxon.id).html(most.taxon.default_name.name)),imageTD.append($("<img/>").attr("src",most.taxon.image_url)),taxonTD.append($('<div class="meta"></div>').append($("<a></a>").attr("href","/observations"+baseSearch+"&taxon_id="+most.taxon.id).html(most.count)," ",I18n.t("observation"+(1==most.count?"":"s")).toLowerCase())),tr.append(imageTD,taxonTD),$(".most_observed table",container).append(tr)
}}if(options.refresh){var t=setTimeout(function(){container.observationTaxonStats(options)},options.refresh);container.data("observationTaxonStatsTimeout",t)}})},$.fn.observationUserStats=function(options){var url=options.url||"/observations/taxon_stats.json",container=this,baseSearch="undefined"==typeof OBSERVATIONS_URL?window.location.search:"?"+OBSERVATIONS_URL.split("?")[1];baseSearch=baseSearch.replace(/per_page=[^&]+/,""),baseSearch=baseSearch.replace(/page=[^&]+/,""),$.getJSON(url,function(json){var total=json.total||0,totalLink=$("<a>"+total+"</a>").attr("href","/observations/user_stats"+baseSearch);if($(".people .count",container).html(totalLink),json.most_observations.length>0){$(".most_observations table",container).html("");for(var i=0;i<json.most_observations.length;i++){var most=json.most_observations[i],img_url=most.user.user_icon_url||"/attachment_defaults/users/icons/defaults/thumb.png",tr=$("<tr></tr>"),imageTD=$('<td class="image"></td>'),userTD=$('<td class="user"></td>');imageTD.append($("<img/>").attr("src",img_url)),userTD.html($("<a>"+most.user.login+"</a>").attr("href","/people/"+most.user.login)),userTD.append($("<div></div>").addClass("meta").html(I18n.t("x_observations_link_html",{count:most.count,url:"/observations"+baseSearch+"&user_id="+most.user.login}))),tr.append(imageTD,userTD),$(".most_observations table",container).append(tr)}}if(json.most_species.length>0){$(".most_species table",container).html("");for(var i=0;i<json.most_species.length;i++){var row=json.most_species[i];img_url=row.user.user_icon_url||"/attachment_defaults/users/icons/defaults/thumb.png",tr=$("<tr></tr>"),imageTD=$('<td class="image"></td>'),userTD=$('<td class="user"></td>'),imageTD.append($("<img/>").attr("src",img_url)),userTD.html($("<a>"+row.user.login+"</a>").attr("href","/people/"+row.user.login)),userTD.append($("<div></div>").addClass("meta").html(I18n.t("x_species_link_html",{count:row.count,url:"/observations/taxa"+baseSearch+"&user_id="+row.user.login}))),tr.append(imageTD,userTD),$(".most_species table",container).append(tr)}}if(options.refresh){var t=setTimeout(function(){container.observationTaxonStats(options)},options.refresh);container.data("observationUserStats",t)}})},$.fn.dnaHighlight=function(){$(this).each(function(){for(var newt="",oldt=$(this).text(),i=0;i<oldt.length;i++)switch(oldt[i]){case"A":newt+='<nt class="a">'+oldt[i]+"</nt>";break;case"T":newt+='<nt class="t">'+oldt[i]+"</nt>";break;case"C":newt+='<nt class="c">'+oldt[i]+"</nt>";break;case"G":newt+='<nt class="g">'+oldt[i]+"</nt>";break;default:newt+=oldt[i]}$(this).html(newt)})},$.fn.boldId=function(){$(this).each(function(){if(!($(".boldid",this).length>0)){var bolddb;if($(this).hasClass("bold-its")||$(this).hasClass("bold-matk")||(bolddb="COX1"),bolddb){var boldWrapper=$('<span class="boldid"><label><a href="http://www.boldsystems.org/">BOLD</a> DNA Match:</label></span>'),boldLink=$('<span class="button inline status"><a href="#">Load DNA-based identification from BOLD</a></span>');boldWrapper.append(" ",boldLink),boldLink.click(function(){return $(this).hide(),$(".status",boldWrapper).replaceWith('<span class="loading status inline">Loading BOLD ID...</span>'),$.get(url,function(data){var name=$("match:first taxonomicidentification",data).text(),similarity=$("match:first similarity",data).text(),specimenURL=$("match:first url",data).text();return similarity=preciseRound(100*parseFloat(similarity),2),name?($.getJSON("/taxa/search?q="+name,function(taxa){for(var taxon,i=0;i<taxa.length;i++)if(taxa[i].name==name){taxon=taxa[i];break}if(taxon){var cssClass="taxon "+[taxon.rank,taxon.iconic_taxon_name].join(" ");$(".status",boldWrapper).replaceWith('<span class="iconic_taxon_sprite '+taxon.iconic_taxon_name.toLowerCase()+' selected">&nbsp;</span> '+'<span class="'+cssClass+'"><a href="/taxa/'+taxon.id+'"><span class="sciname">'+name+"</span></span></span>")}else $(".status",boldWrapper).replaceWith('<span class="taxon"><span class="sciname">'+name+"</span></span>");$(boldWrapper).append(' <span class="meta">('+similarity+"% match)</span>"),$(boldWrapper).append(' <a href="'+specimenURL+'" class="readmore">View matching specimen on BOLD</a>')}),void 0):($(".status",boldWrapper).replaceWith('<span class="status">No matches</span>'),void 0)}),!1}),$(this).after(boldWrapper);var url="/identifications/bold.xml?db="+bolddb+"&sequence="+$(this).text()}}})},$(document).ready(function(){$(".bootstrap .button.default").addClass("btn btn-primary").removeClass("button default"),$(".bootstrap .inter").addClass("btn btn-link").removeClass("inter"),$(".bootstrap .button").addClass("btn").removeClass("button")}),"undefined"!=typeof $.fn.button&&"undefined"!=typeof $.fn.button.noConflict)var bootstrapButton=$.fn.button.noConflict();