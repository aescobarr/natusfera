function classifyCounties(e){classifyPlaces(e,{placeType:"county"})}function classifyStates(e){classifyPlaces(e,{placeType:"state"})}function classifyCountries(e){classifyPlaces(e,{placeType:"country"})}function classifyPlaces(e,options){for(var options=options||{},placeType=options.placeType||"county",i=e.features.length-1;i>=0;i--){var feature=e.features[i];if(feature.data.properties){var listing,placeId=feature.data.properties.place_id;switch(placeType){case"county":listing=countyListings[placeId];break;case"state":listing=stateListings[placeId];break;case"country":listing=countryListings[placeId]}if(listing){var placeClass="place_"+listing.place_id,cssClass=[placeType,placeClass,listing.establishment_means].join(" ");cssClass+=listing.last_observation_id?" confirmed":"absent"==listing.occurrence_status?" absent":" putative",feature.element.setAttribute("class",cssClass),feature.element.setAttribute("data-place-id",listing.place_id),$(feature.element).hover(function(){$("path.place_"+$(this).attr("data-place-id")).css("opacity",.7)},function(){$("path.place_"+$(this).attr("data-place-id")).css("opacity",.5)}),$(feature.element).qtip({style:{classes:"listed_taxon ui-tooltip-light ui-tooltip-shadow"},show:{event:"click",solo:!0},hide:{event:"unfocus"},position:{viewport:$(window),my:"bottom center",at:"center center"},content:{title:{text:"Listed taxon",button:!0},text:'<span class="meta loading status">Loading..</span>',ajax:{url:"/listed_taxa/"+listing.id,method:"GET",data:{partial:"place_tip"}}}})}}}}function handleObservations(e){for(var i=e.features.length-1;i>=0;i--){var feature=e.features[i];if(feature&&feature.element){feature.element.setAttribute("data-observation-id",feature.data.properties.observation_id||feature.data.properties.id);var cssClass=feature.data.properties.quality_grade;if(cssClass+="research"==feature.data.properties.quality_grade||"community"==feature.data.properties.quality_grade?" confirmed":" putative",feature.data.properties.coordinates_obscured){cssClass+=" obscured";var r=map.locationPoint({lat:0,lon:OBSCURATION_DISTANCE_IN_DEGREES}).x-map.locationPoint({lat:0,lon:0}).x;r>4.5&&feature.element.setAttribute("r",r)}else if(feature.data.properties.positional_accuracy){var accuracyInDegrees=feature.data.properties.positional_accuracy/PLANETARY_RADIUS*DEGREES_PER_RADIAN;feature.element.setAttribute("radius-meters",feature.data.properties.positional_accuracy);var r=map.locationPoint({lat:0,lon:accuracyInDegrees}).x-map.locationPoint({lat:0,lon:0}).x;r>4.5&&feature.element.setAttribute("r",r)}feature.element.setAttribute("class",cssClass),$(feature.element).qtip({style:{classes:"mini infowindow observations ui-tooltip-light ui-tooltip-shadow"},show:{event:"click",solo:!0},hide:{event:"unfocus"},position:{viewport:$(window),my:"bottom center",at:"center center"},content:{title:{text:"Observation",button:!0},text:'<span class="meta loading status">Loading..</span>',ajax:{url:"/observations/"+feature.data.properties.id,method:"GET",data:{partial:"cached_component"}}},events:{show:function(event,api){window.map.size().x<450?api.elements.tooltip.width("260px").addClass("compact"):api.elements.tooltip.width("425px").removeClass("compact")}}})}}}function styleRange(e,child){for(var fill=colorScale(child.id),stroke=d3.rgb(fill).darker().toString(),i=e.features.length-1;i>=0;i--){var feature=e.features[i];feature.element.setAttribute("fill",fill),feature.element.setAttribute("stroke",stroke)}}function styleObservations(e,child){var fill=colorScale(child.id);fill.darken()}function addPlaces(){layers.countries_simple=po.geoJson().id("countries_simple").visible(!1).url(TILESTACHE_SERVER+"/countries_simplified/{Z}/{X}/{Y}.geojson").on("load",classifyCountries),map.add(layers.countries_simple),layers.states_simple=po.geoJson().id("states_simple").visible(!1).zoom(function(z){return 4>z?($("#place_type_states").attr("disabled",!0),-100):($("#place_type_states").attr("disabled",!1),z)}).url(TILESTACHE_SERVER+"/states_simplified/{Z}/{X}/{Y}.geojson").on("load",classifyStates),map.add(layers.states_simple),layers.counties_simple=po.geoJson().id("counties_simple").visible(!1).zoom(function(z){return 7>z?($("#place_type_counties").attr("disabled",!0),-100):($("#place_type_counties").attr("disabled",!1),z)}).url(TILESTACHE_SERVER+"/counties_simplified/{Z}/{X}/{Y}.geojson").on("load",classifyCounties),map.add(layers.counties_simple),layers.counties=po.geoJson().id("counties").visible(!1).zoom(function(z){return 12>z?-100:z}).url(TILESTACHE_SERVER+"/counties/{Z}/{X}/{Y}.geojson").on("load",classifyCounties),map.add(layers.counties),window.map.on("move",onZoom),showPlacesByZoom()}function onZoom(){window.lastZoom!=map.zoom()&&(showPlacesByZoom(),window.lastZoom=map.zoom())}function showPlacesByZoom(options){if(options=options||{},options.force||$("#places_check").attr("checked")){var lyr;for(var lyrName in layers)switch(lyr=layers[lyrName],lyrName){case"countries_simple":map.zoom()<4?(lyr.visible(!0),$("#place_type_countries").attr("checked",!0)):lyr.visible(!1);break;case"states_simple":map.zoom()>=4&&map.zoom()<7?(lyr.visible(!0),$("#place_type_states").attr("checked",!0)):lyr.visible(!1);break;case"counties_simple":map.zoom()>=7&&map.zoom()<12?(lyr.visible(!0),$("#place_type_counties").attr("checked",!0)):lyr.visible(!1);break;case"counties":map.zoom()>=12?(lyr.visible(!0),$("#place_type_counties").attr("checked",!0)):lyr.visible(!1)}}}function addObservations(){layers.observations=po.geoJson().id("observations").url(observationsGeoJsonUrl).tile(!1).on("load",handleObservations).zoom(function(z){return $("#observations circle").each(function(){var r=parseFloat($(this).attr("r")),minDimension=Math.min(window.map.size().x,window.map.size().y);2*r>minDimension?$(this).hide():$(this).show()}),z}).clip(!1),map.add(layers.observations)}function scaleLegend(){if(!$("#legend").hasClass("collapsed")&&!$("#legend").hasClass("expanded")){var scaleWidth=$("#legend").data("originalOuterWidth")>$(window).width()/2,scaleHeight=$("#legend").data("originalOuterHeight")>$(window).height()/2;scaleWidth||scaleHeight?collapseLegend():expandLegend(),window.windowResized=null}}function loadLayers(){children&&children.length>0?loadLayersForTaxa(children):taxa&&taxa.length>0?loadLayersForTaxa(taxa):observationsJsonUrl&&loadSingleTaxonLayers(),placeGeoJsonUrl&&map.add(po.geoJson().id("place").url(placeGeoJsonUrl).on("load",classifyPlaces)),map.add(po.compass()),$("#legendcontent").data("originalWidth",$("#legendcontent").width()),$("#legendcontent").data("originalHeight",$("#legendcontent").height()),$("#legend").data("originalOuterWidth",$("#legend").outerWidth()),$("#legend").data("originalOuterHeight",$("#legend").outerHeight()),scaleLegend(),self!=top&&$("a").live("click",function(){"#"!=$(this).attr("href")&&$(this).attr("target","_blank")})}function loadLayersForTaxa(taxa){$("#legend ul").html("");var styling=po.stylist().style("visibility","visible").style("fill",function(f){return colorScale(f.properties.taxon_id)}).style("stroke",function(f){return d3.rgb(colorScale(f.properties.taxon_id)).darker().toString()}).attr("class","range"),names=taxa.map(function(t){return t.name}).unique(),addIds=names.length<taxa.length;$.each(taxa,function(){var taxon=this,rangeId="range_"+taxon.id,observationsId="observations_"+taxon.id;taxon.range_url&&(layers[rangeId]=po.geoJson().id(rangeId).url(taxon.range_url).tile(!1).clip(!1).on("load",styling),map.add(layers[rangeId]));var inputId="taxon_check_"+taxon.id,input=$('<input type="checkbox">').attr("id",inputId).attr("checked","checked").click(function(){layers[rangeId]&&layers[rangeId].visible(this.checked),layers[observationsId].visible(this.checked)}),symbol=$('<div class="symbol"></div>').css({backgroundColor:colorScale(taxon.id),borderColor:d3.rgb(colorScale(taxon.id)).darker().toString(),borderStyle:"solid",borderWidth:"1px"}),nameContent=addIds?taxon.name+" "+taxon.id:taxon.name,label=$("<label></label>").attr("for",inputId).html(nameContent);0==taxon.is_active&&label.addClass("inactive").attr("title","Inacive taxon concept");var link=$("<a></a>").attr("href","/taxa/"+taxon.id).html("(view)").addClass("small"),li=$("<li></li>").append(input," ",symbol," ",label," ",link);$("#legend ul").append(li)}),$.each(taxa,function(){var taxon=this,observationsId=("range_"+taxon.id,"observations_"+taxon.id);layers[observationsId]=po.geoJson().id(observationsId).url(taxon.observations_url).tile(!1).clip(!1).on("load",handleObservations).on("load",styling),map.add(layers[observationsId])})}function loadSingleTaxonLayers(){taxonRangeUrl&&(layers.range=po.geoJson().id("range").tile(!1).url(taxonRangeUrl),map.add(layers.range),$("#copyright").append($('<span id="range_attribution"></span>').append("Taxon range: ",taxonRange.source?taxonRange.source.citation||taxonRange.source.title:"unknown source").autolink())),addPlaces(),addObservations(),$("#legend li").each(function(){if($(this).attr("rel")){var targetLayers=$(this).attr("rel").split(" ");$(this).find("input[type=checkbox]").click(function(){if("places_check"==$(this).attr("id")&&this.checked)showPlacesByZoom({force:!0});else for(var i=targetLayers.length-1;i>=0;i--)layers[targetLayers[i]]&&layers[targetLayers[i]].visible(this.checked)})}});var radios=$("#legend input[type=radio]"),exclusiveLayers=radios.map(function(){return $(this).parents("li").attr("rel").split(" ")});radios.click(function(){for(var i=exclusiveLayers.length-1;i>=0;i--)layers[exclusiveLayers[i]].visible(!1);for(var targetLayers=$(this).parents("li").attr("rel").split(" "),i=targetLayers.length-1;i>=0;i--)layers[targetLayers[i]]&&layers[targetLayers[i]].visible(this.checked)})}function bingCallback(data){for(var resourceSets=data.resourceSets,i=0;i<resourceSets.length;i++)for(var resources=data.resourceSets[i].resources,j=0;j<resources.length;j++){var resource=resources[j];window.satLyr=po.image().url(Polymaps.bingUrlTemplate(resource.imageUrl,resource.imageUrlSubdomains)).id("satellite").visible(!1),map.add(satLyr).tileSize({x:resource.imageWidth,y:resource.imageHeight})}/* Display copyright notice. */
$("#copyright").append($('<span id="satlyr_attribution"></span>').append("Base layer: "+data.copyright).hide()),loadLayers(),bindControls(),window.mapLyr||$("#basemap_sat").click()}function bindControls(){$("#basemap_map").click(function(){window.mapLyr.visible(!0),window.satLyr.visible(!1),$("#maplyr_attribution").show(),$("#satlyr_attribution").hide()}),$("#basemap_sat").click(function(){"undefined"!=typeof mapLyr&&mapLyr.visible(!1),window.satLyr.visible(!0),$("#maplyr_attribution").hide(),$("#satlyr_attribution").show()})}function toggleLegend(){$("#legendcontent:visible").length>0?($("#legend").addClass("collapsed").removeClass("expanded"),collapseLegend()):($("#legend").removeClass("collapsed").addClass("expanded"),expandLegend())}function collapseLegend(){$("#togglecollapse").removeClass("ui-icon-arrow-1-sw").addClass("ui-icon-arrow-1-ne"),$("#legendcontent").animate({height:0}).animate({width:0},function(){$("#legendcontent").hide()})}function expandLegend(){$("#togglecollapse").addClass("ui-icon-arrow-1-sw").removeClass("ui-icon-arrow-1-ne"),$lc=$("#legendcontent"),$lc.css({display:"block",width:"auto",height:"auto"});var w=Math.max($lc.data("originalWidth"),$lc.prop("scrollWidth")),h=Math.max($lc.data("originalHeight"),$lc.prop("scrollHeight"));$lc.animate({height:h+"px",width:w+"px"})}window.colorScale=d3.scale.category10(),window.windowResizeHandler=function(){var now=(new Date).getTime();windowResized&&now-windowResized>400&&scaleLegend()},$(window).resize(function(){window.windowResized=(new Date).getTime(),setTimeout("windowResizeHandler()",500)}),$(document).ready(function(){if(window.layers={},window.po=org.polymaps,window.map=po.map().container($("#map").get(0).appendChild(po.svg("svg"))).zoomRange([2,15]).add(po.interact()),window.location.hash.length>0||(extent?map.extent(extent).zoomBy(-.5):map.center({lat:0,lon:0}).zoom(3)),map.add(po.hash()),CLOUDMADE_KEY?(window.mapLyr=po.image().url(po.url("http://{S}tile.cloudmade.com/"+CLOUDMADE_KEY+"/998/256/{Z}/{X}/{Y}.png").hosts(["a.","b.","c.",""])),map.add(cloudmadeLyr),$("#copyright").append($('<span id="cloudmade_attribution"></span>').append("Base map: &copy; <a href='http://www.openstreetmap.org/'>OpenStreetMap</a> contributors (<a href='http://opendatacommons.org/licenses/odbl/'>ODbL</a>), provided by <a href='http://cloudmade.com/'>CloudMade</a>"))):(window.mapLyr=po.image().url(po.url("http://otile{S}.mqcdn.com/tiles/1.0.0/map/{Z}/{X}/{Y}.jpg").hosts(["1","1","3","4"])),map.add(mapLyr),$("#copyright").append($('<span id="maplyr_attribution"></span>').append("Base map: &copy; <a href='http://www.openstreetmap.org/'>OpenStreetMap</a> contributors (<a href='http://opendatacommons.org/licenses/odbl/'>ODbL</a>), tiles courtesy of <a href='http://www.mapquest.com/'' target='_blank'>MapQuest</a> <img src='http://developer.mapquest.com/content/osm/mq_logo.png'>"))),BING_KEY){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.setAttribute("src","http://dev.virtualearth.net/REST/V1/Imagery/Metadata/AerialWithLabels?key="+BING_KEY+"&jsonp=bingCallback"),document.body.appendChild(script),window.mapLyr||$("#controls").hide()}else window.satLyr=po.image().url(po.url("http://otile{S}.mqcdn.com/tiles/1.0.0/sat/{Z}/{X}/{Y}.jpg").hosts(["1","1","3","4"])),map.add(satLyr),$("#copyright").append($('<div id="satlyr_attribution"></div>').append("Base map: portions courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency, tiles courtesy of <a href='http://www.mapquest.com/'' target='_blank'>MapQuest</a> <img src='http://developer.mapquest.com/content/osm/mq_logo.png'>")),loadLayers(),bindControls(),$("#basemap_map").click()});